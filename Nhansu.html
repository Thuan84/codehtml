<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý nhân sự</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        .data-table {
            width: 100%;
            overflow-x: auto;
        }
        table {
            min-width: 100%;
        }
        th {
            position: sticky;
            top: 0;
            background: #f8f9fa;
            z-index: 10;
            white-space: nowrap;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
        }
        .spinner {
            width: 3rem;
            height: 3rem;
        }
        .search-container {
            margin-bottom: 20px;
        }
        .pagination {
            justify-content: center;
        }
        td {
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <h1 class="text-center mb-4">Danh sách nhân sự</h1>
        
        <div class="search-container row">
            <div class="col-md-6">
                <div class="input-group mb-3">
                    <input type="text" id="searchInput" class="form-control" placeholder="Tìm kiếm theo tên, chức vụ, bộ phận...">
                    <button class="btn btn-outline-secondary" type="button" id="searchBtn">Tìm kiếm</button>
                </div>
            </div>
            <div class="col-md-6 text-end">
                <div class="btn-group">
                    <button class="btn btn-outline-primary" id="exportBtn">Xuất Excel</button>
                    <button class="btn btn-outline-secondary" id="refreshBtn">Làm mới</button>
                </div>
            </div>
        </div>

        <div class="data-table-container">
            <div class="loading" id="loading">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            <div class="data-table">
                <table class="table table-striped table-bordered table-hover" id="dataTable">
                    <thead class="table-dark">
                        <tr id="tableHeader"></tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            <nav aria-label="Page navigation">
                <ul class="pagination" id="pagination"></ul>
            </nav>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzHz-K7xb52vvmNBb43jbhhkZM-OmDJqL2N3_k11SNp2ceUe74-7ajT9R6707XKRXd_/exec';
        let allData = [];
        let filteredData = [];
        const itemsPerPage = 15;
        let currentPage = 1;

        // Danh sách các trường quan trọng cần hiển thị
        const IMPORTANT_FIELDS = [
            'ID', 'HỌ VÀ TÊN', 'GIỚI TÍNH', 'NĂM SINH', 'CHỨC VỤ', 
            'BỘ PHẬN', 'ĐIỆN THOẠI', 'EMAIL', 'TRÌNH ĐỘ CHUYÊN MÔN',
            'NGÀY VÀO CÔNG ĐOÀN', 'ĐẢNG VIÊN', 'TRẠNG THÁI LÀM VIỆC'
        ];

        document.addEventListener('DOMContentLoaded', function() {
            fetchData();
            
            document.getElementById('searchBtn').addEventListener('click', filterData);
            document.getElementById('searchInput').addEventListener('keyup', function(e) {
                if (e.key === 'Enter') filterData();
            });
            document.getElementById('refreshBtn').addEventListener('click', fetchData);
            document.getElementById('exportBtn').addEventListener('click', exportToExcel);
        });

        async function fetchData() {
            try {
                showLoading();
                const response = await axios.get(API_URL);
                allData = response.data;
                
                // Chuẩn hóa dữ liệu - đảm bảo mỗi item có đủ các trường quan trọng
                allData = allData.map(item => {
                    const normalizedItem = {};
                    IMPORTANT_FIELDS.forEach(field => {
                        normalizedItem[field] = item[field] || '';
                    });
                    return normalizedItem;
                });
                
                filteredData = [...allData];
                renderTable();
                renderPagination();
                hideLoading();
            } catch (error) {
                console.error('Error fetching data:', error);
                hideLoading();
                alert('Không thể tải dữ liệu. Vui lòng thử lại sau.');
            }
        }

        function filterData() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (!searchTerm) {
                filteredData = [...allData];
            } else {
                filteredData = allData.filter(item => {
                    // Tìm kiếm trong các trường quan trọng
                    return IMPORTANT_FIELDS.some(field => 
                        String(item[field] || '').toLowerCase().includes(searchTerm)
                    );
                });
            }
            currentPage = 1;
            renderTable();
            renderPagination();
        }

        function renderTable() {
            const tableHeader = document.getElementById('tableHeader');
            const tableBody = document.getElementById('tableBody');
            
            // Clear existing content
            tableHeader.innerHTML = '';
            tableBody.innerHTML = '';
            
            if (filteredData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="100" class="text-center">Không tìm thấy kết quả phù hợp</td></tr>';
                return;
            }
            
            // Chỉ hiển thị các trường quan trọng
            IMPORTANT_FIELDS.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                tableHeader.appendChild(th);
            });
            
            // Calculate pagination
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredData.length);
            const paginatedData = filteredData.slice(startIndex, endIndex);
            
            // Create rows
            paginatedData.forEach(item => {
                const tr = document.createElement('tr');
                
                IMPORTANT_FIELDS.forEach(header => {
                    const td = document.createElement('td');
                    let value = item[header] || '';
                    
                    // Format date values if needed
                    if (typeof value === 'string' && value.match(/^\d{4}-\d{2}-\d{2}/)) {
                        value = new Date(value).toLocaleDateString('vi-VN');
                    }
                    
                    // Định dạng trường boolean (ĐẢNG VIÊN)
                    if (header === 'ĐẢNG VIÊN') {
                        value = value ? 'Có' : 'Không';
                    }
                    
                    td.textContent = value;
                    tr.appendChild(td);
                });
                
                tableBody.appendChild(tr);
            });
        }

        function renderPagination() {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            if (totalPages <= 1) return;
            
            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = '<a class="page-link" href="#" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>';
            prevLi.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage > 1) {
                    currentPage--;
                    renderTable();
                    renderPagination();
                }
            });
            pagination.appendChild(prevLi);
            
            // Page numbers (chỉ hiển thị 5 trang xung quanh trang hiện tại)
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            if (startPage > 1) {
                const li = document.createElement('li');
                li.className = 'page-item';
                li.innerHTML = `<a class="page-link" href="#">1</a>`;
                li.addEventListener('click', (e) => {
                    e.preventDefault();
                    currentPage = 1;
                    renderTable();
                    renderPagination();
                });
                pagination.appendChild(li);
                
                if (startPage > 2) {
                    const ellipsis = document.createElement('li');
                    ellipsis.className = 'page-item disabled';
                    ellipsis.innerHTML = '<span class="page-link">...</span>';
                    pagination.appendChild(ellipsis);
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                li.addEventListener('click', (e) => {
                    e.preventDefault();
                    currentPage = i;
                    renderTable();
                    renderPagination();
                });
                pagination.appendChild(li);
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('li');
                    ellipsis.className = 'page-item disabled';
                    ellipsis.innerHTML = '<span class="page-link">...</span>';
                    pagination.appendChild(ellipsis);
                }
                
                const li = document.createElement('li');
                li.className = 'page-item';
                li.innerHTML = `<a class="page-link" href="#">${totalPages}</a>`;
                li.addEventListener('click', (e) => {
                    e.preventDefault();
                    currentPage = totalPages;
                    renderTable();
                    renderPagination();
                });
                pagination.appendChild(li);
            }
            
            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = '<a class="page-link" href="#" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>';
            nextLi.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTable();
                    renderPagination();
                }
            });
            pagination.appendChild(nextLi);
        }

        function exportToExcel() {
            if (filteredData.length === 0) {
                alert('Không có dữ liệu để xuất');
                return;
            }
            
            // Create CSV content
            let csvContent = IMPORTANT_FIELDS.join(',') + '\n';
            
            filteredData.forEach(item => {
                const row = IMPORTANT_FIELDS.map(header => {
                    let value = item[header] || '';
                    
                    // Định dạng giá trị cho CSV
                    if (typeof value === 'string') {
                        value = value.replace(/"/g, '""');
                        if (value.includes(',')) {
                            value = `"${value}"`;
                        }
                    }
                    
                    // Định dạng trường boolean (ĐẢNG VIÊN)
                    if (header === 'ĐẢNG VIÊN') {
                        value = value ? 'Có' : 'Không';
                    }
                    
                    return value;
                });
                csvContent += row.join(',') + '\n';
            });
            
            // Create download link
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'danh_sach_nhan_su.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
            document.querySelector('.data-table').style.display = 'none';
            document.getElementById('pagination').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            document.querySelector('.data-table').style.display = 'block';
            document.getElementById('pagination').style.display = 'flex';
        }
    </script>
</body>
</html>
