<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>B·∫£n ƒë·ªì m∆∞a Ninh Thu·∫≠n - Open-Meteo + Layer th·ªùi ti·∫øt</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    #map {
      height: 100vh;
      width: 100vw;
    }
    .map-title {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.9);
      padding: 8px 16px;
      border-radius: 999px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      font-weight: 600;
      z-index: 1000;
      font-size: 14px;
    }
    .leaflet-control.legend {
      background: white;
      padding: 8px 10px;
      font-size: 12px;
      line-height: 1.4;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
      border-radius: 6px;
    }
    .legend-row {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }
    .legend-color {
      width: 14px;
      height: 14px;
      border-radius: 3px;
      margin-right: 6px;
      border: 1px solid rgba(0,0,0,0.1);
    }
    .data-source {
      position: absolute;
      bottom: 6px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 11px;
      background: rgba(255,255,255,0.9);
      padding: 3px 8px;
      border-radius: 999px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.15);
      z-index: 1000;
    }

    /* N√∫t full m√†n h√¨nh */
    .fullscreen-btn {
      position: absolute;
      top: 50px;
      right: 10px;
      z-index: 1001;
      padding: 5px 10px;
      font-size: 11px;
      border-radius: 999px;
      border: none;
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      gap: 6px;
      backdrop-filter: blur(4px);
    }
    .fullscreen-btn:hover {
      background: rgba(30,64,175,0.95);
    }

    /* PANEL HUY·ªÜN/H·ªí + X√É ‚Äì g√≥c d∆∞·ªõi b√™n tr√°i */
    .station-panel {
      position: absolute;
      bottom: 10px;
      left: 10px;
      z-index: 1000;
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      gap: 8px;
      max-width: 100%;
      flex-wrap: wrap;
    }

    /* Card huy·ªán/h·ªì ‚Äì phong c√°ch Windy: n·ªÅn t·ªëi, ch·ªØ s√°ng, r·ªông h∆°n */
    .station-card {
      background: rgba(15,23,42,0.95); /* slate-900 */
      border-radius: 16px;
      padding: 6px 8px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.45);
      font-size: 11px;
      width: 320px; /* r·ªông h∆°n */
      color: #e5e7eb;
      border: 1px solid rgba(148,163,184,0.5);
    }
    .station-title {
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .station-title-main {
      font-weight: 700;
      font-size: 12px;
      color: #f9fafb;
    }
    .station-title span {
      font-size: 10px;
      color: #9ca3af;
      font-weight: 400;
    }
    .station-updated {
      font-size: 10px;
      color: #9ca3af;
      margin-top: 1px;
    }

    /* B·∫£ng huy·ªán ki·ªÉu list Windy */
    .station-table-wrapper {
      margin-top: 4px;
      border-radius: 12px;
      border: none;
      overflow: visible;
    }
    table.station-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 4px;
      font-size: 11px;
    }
    .station-table thead {
      display: none;
    }
    .station-table th,
    .station-table td {
      padding: 2px 6px;
      border: none;
      font-size: 11px;
    }
    .station-table tbody tr {
      background: rgba(15,23,42,0.95);
      color: #e5e7eb;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
      border-left: 3px solid transparent;
      cursor: pointer;
      transition: transform 0.07s ease, box-shadow 0.07s ease, background 0.07s ease;
    }
    .station-table tbody tr:hover {
      background: rgba(30,64,175,0.85);
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.5);
    }
    .station-table tr.selected {
      outline: 1px solid #facc15;
      outline-offset: 0;
    }
    .station-table td.value-loading {
      color: #9ca3af;
      font-style: italic;
    }
    .station-table td.value-error {
      color: #fecaca;
      font-style: italic;
    }
    .station-table td:first-child {
      width: 48%;
      font-weight: 600;
      font-size: 11px;
      white-space: normal;
    }
    .station-table td:last-child {
      width: 52%;
    }

    /* Card x√£ (gi·ªØ s√°ng cho d·ªÖ nh√¨n text) */
    #commune-panel {
      display: none;
    }
    .commune-card {
      background: rgba(255,255,255,0.96);
      border-radius: 12px;
      padding: 8px 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.16);
      font-size: 12px;
      border-left: 3px solid #16a34a;
      display: flex;
      flex-direction: column;
      width: 340px;
    }
    .commune-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    .commune-title {
      font-weight: 700;
      font-size: 13px;
      color: #111827;
    }
    .commune-subtitle {
      font-size: 11px;
      color: #6b7280;
    }
    .commune-close {
      border: none;
      background: #fee2e2;
      color: #b91c1c;
      font-size: 12px;
      border-radius: 999px;
      padding: 2px 7px;
      cursor: pointer;
    }
    .commune-close:hover {
      background: #fecaca;
    }
    .commune-table-wrapper {
      overflow-y: visible;
      margin-top: 4px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }
    .commune-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    .commune-table th,
    .commune-table td {
      padding: 4px 6px;
      border-bottom: 1px solid #e5e7eb;
    }
    .commune-table thead {
      background: linear-gradient(90deg,#16a34a,#22c55e);
      color: #ffffff;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .commune-table tbody tr:nth-child(even) {
      background: #f9fafb;
    }
    .commune-table td.value-loading {
      color: #9ca3af;
      font-style: italic;
    }
    .commune-table td.value-error {
      color: #b91c1c;
      font-style: italic;
    }

    /* badge tr·∫°ng th√°i m∆∞a ‚Äì h·ª£p n·ªÅn t·ªëi */
    .rain-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 1px 5px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 9px;
      border: 1px solid rgba(148,163,184,0.9);
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
    }
    .rain-badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
    }

    /* Icon marker */
    .marker-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 26px;
      height: 26px;
      border-radius: 999px;
      box-shadow: 0 0 0 2px rgba(255,255,255,0.8);
      font-size: 14px;
      color: #ffffff;
      font-weight: 700;
    }
    .marker-district {
      background: linear-gradient(135deg,#2563eb,#22c55e);
    }
    .marker-reservoir {
      background: linear-gradient(135deg,#0369a1,#22d3ee);
    }
    .leaflet-marker-icon,
    .leaflet-marker-shadow {
      background: transparent !important;
      border: none !important;
      padding: 0 !important;
      margin: 0 !important;
    }

    /* ===== MENU LAYER TH·ªúI TI·∫æT KI·ªÇU WINDY (b√™n ph·∫£i) ===== */
    .weather-layer-menu {
      position: absolute;
      top: 50%;
      right: 6px;
      transform: translateY(-50%);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .weather-layer-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px 4px 4px;
      border-radius: 999px;
      border: none;
      background: rgba(0,0,0,0.35);
      color: #fff;
      font-size: 11px;
      cursor: pointer;
      backdrop-filter: blur(4px);
      outline: none;
      transition: background 0.15s, transform 0.1s, box-shadow 0.1s;
      white-space: nowrap;
    }
    .weather-layer-item:hover {
      background: rgba(0,0,0,0.55);
      transform: translateX(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .weather-layer-item.active {
      background: rgba(234, 179, 8, 0.9);
      color: #111827;
    }
    .weather-layer-thumb {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      flex-shrink: 0;
      background-size: cover;
      background-position: center;
      border: 1px solid rgba(255,255,255,0.8);
    }
    .thumb-radar { background-image: linear-gradient(135deg,#22c55e,#0ea5e9); }
    .thumb-sat   { background-image: linear-gradient(135deg,#0f172a,#9ca3af); }
    .thumb-wind  { background-image: linear-gradient(135deg,#0ea5e9,#22d3ee); }
    .thumb-rain  { background-image: linear-gradient(135deg,#1d4ed8,#a855f7); }
    .thumb-temp  { background-image: linear-gradient(135deg,#f97316,#ef4444); }
  </style>
</head>
<body>
  
  <div id="map"></div>

  <!-- N√∫t full m√†n h√¨nh -->
  <button id="fullscreen-btn" class="fullscreen-btn">
    <span id="fullscreen-icon">‚õ∂</span>
    <span id="fullscreen-text">To√†n m√†n h√¨nh</span>
  </button>

  <!-- MENU LAYER TH·ªúI TI·∫æT B√äN PH·∫¢I -->
  <div class="weather-layer-menu" id="weather-layer-menu">
    <button class="weather-layer-item" data-layer="radar">
      <span class="weather-layer-thumb thumb-radar"></span>
      <span>Radar th·ªùi ti·∫øt</span>
    </button>
    <button class="weather-layer-item" data-layer="satellite">
      <span class="weather-layer-thumb thumb-sat"></span>
      <span>V·ªá tinh (m√¢y)</span>
    </button>
    <button class="weather-layer-item" data-layer="wind">
      <span class="weather-layer-thumb thumb-wind"></span>
      <span>Gi√≥ (b·∫£n ƒë·ªì m√†u)</span>
    </button>
    <button class="weather-layer-item" data-layer="rain">
      <span class="weather-layer-thumb thumb-rain"></span>
      <span>M∆∞a, s√©t</span>
    </button>
    <button class="weather-layer-item" data-layer="temp">
      <span class="weather-layer-thumb thumb-temp"></span>
      <span>Nhi·ªát ƒë·ªô</span>
    </button>
  </div>

  <!-- G√≥c d∆∞·ªõi tr√°i -->
  <div class="station-panel">
    <div class="station-card">
      <div class="station-title">
        <div>
          <div class="station-title-main">Danh s√°ch huy·ªán / h·ªì ch·ª©a</div>
          <div id="updated-time" class="station-updated">ƒêang c·∫≠p nh·∫≠t...</div>
        </div>
        <span>Click ƒë·ªÉ zoom & xem danh s√°ch x√£</span>
      </div>
      <div class="station-table-wrapper">
        <table class="station-table">
          <thead>
            <tr>
              <th>ƒêi·ªÉm</th>
              <th>M∆∞a / Gi√≥</th>
            </tr>
          </thead>
          <tbody id="station-tbody">
            <!-- JS sinh -->
          </tbody>
        </table>
      </div>
    </div>

    <div id="commune-panel"></div>
  </div>

  <div class="data-source">
    Ngu·ªìn: Open-Meteo (m∆∞a, gi√≥, tr·∫°ng th√°i) ¬∑ OpenWeatherMap (Radar, v·ªá tinh, gi√≥, m∆∞a, nhi·ªát ƒë·ªô d·∫°ng b·∫£n ƒë·ªì)
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // ====== CONFIG OPENWEATHERMAP CHO C√ÅC L·ªöP B·∫¢N ƒê·ªí ======
    const OWM_KEY = 'd26587d88a62abe31ad7941479dfb53e'; // ƒë·ªïi th√†nh API key c·ªßa anh

    // ===== 1. Map + l·ªõp n·ªÅn =====
    const map = L.map('map').setView([11.7, 108.9], 9);

    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; OpenStreetMap contributors'
    });

    const satellite = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      {
        maxZoom: 19,
        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, Earthstar Geographics, etc.'
      }
    );

    const rainLayer = L.layerGroup().addTo(map);
    osm.addTo(map);

    const baseMaps = {
      "N·ªÅn ƒë∆∞·ªùng ph·ªë (OSM)": osm,
      "V·ªá tinh (Esri Satellite)": satellite
    };
    const overlayMaps = {
      "M∆∞a hi·ªán t·∫°i (tr·∫°m)": rainLayer
    };
    L.control.layers(baseMaps, overlayMaps, { collapsed: false }).addTo(map);

    // ===== L·ªöP B·∫¢N ƒê·ªí TH·ªúI TI·∫æT (TILE) T·ª™ OPENWEATHERMAP =====
    const owmLayers = {
      radar: L.tileLayer(
        `https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=${OWM_KEY}`,
        { opacity: 0.95, zIndex: 500 }
      ),
      clouds: L.tileLayer(
        `https://tile.openweathermap.org/map/clouds_new/{z}/{x}/{y}.png?appid=${OWM_KEY}`,
        { opacity: 0.7, zIndex: 490 }
      ),
      wind: L.tileLayer(
        `https://tile.openweathermap.org/map/wind_new/{z}/{x}/{y}.png?appid=${OWM_KEY}`,
        { opacity: 0.9, zIndex: 480 }
      ),
      temp: L.tileLayer(
        `https://tile.openweathermap.org/map/temp_new/{z}/{x}/{y}.png?appid=${OWM_KEY}`,
        { opacity: 0.9, zIndex: 480 }
      )
    };

    function setBaseOpacityForRainMode(isRainMode) {
      if (isRainMode) {
        osm.setOpacity(0.7);
        satellite.setOpacity(0.5);
      } else {
        osm.setOpacity(1);
        satellite.setOpacity(1);
      }
    }

    function forceStreetBaseForRain() {
      if (!map.hasLayer(osm)) {
        osm.addTo(map);
      }
      if (map.hasLayer(satellite)) {
        map.removeLayer(satellite);
      }
    }

    // ===== MENU LAYER TH·ªúI TI·∫æT =====
    const menuEl = document.getElementById('weather-layer-menu');
    const layerButtons = menuEl.querySelectorAll('.weather-layer-item');

    L.DomEvent.disableClickPropagation(menuEl);

    function deactivateAllWeatherButtons() {
      layerButtons.forEach(btn => btn.classList.remove('active'));
    }
    function removeAllWeatherTileLayers() {
      Object.values(owmLayers).forEach(layer => {
        if (map.hasLayer(layer)) {
          map.removeLayer(layer);
        }
      });
      setBaseOpacityForRainMode(false);
    }

    layerButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const layerId = btn.dataset.layer;
        const isActive = btn.classList.contains('active');

        removeAllWeatherTileLayers();
        deactivateAllWeatherButtons();

        if (isActive) return;

        if (layerId === 'radar') {
          forceStreetBaseForRain();
          setBaseOpacityForRainMode(true);
          map.addLayer(owmLayers.radar);
          btn.classList.add('active');
        } else if (layerId === 'rain') {
          forceStreetBaseForRain();
          setBaseOpacityForRainMode(true);
          map.addLayer(owmLayers.radar);
          map.addLayer(owmLayers.clouds);
          btn.classList.add('active');
        } else if (layerId === 'satellite') {
          map.addLayer(owmLayers.clouds);
          btn.classList.add('active');
        } else if (layerId === 'wind') {
          map.addLayer(owmLayers.wind);
          btn.classList.add('active');
        } else if (layerId === 'temp') {
          map.addLayer(owmLayers.temp);
          btn.classList.add('active');
        }
      });
    });

    // ===== 2. Danh s√°ch huy·ªán/h·ªì + x√£/ph∆∞·ªùng =====
    const stations = [
      {
        id: "phan_rang",
        type: "city",
        name: "TP Phan Rang - Th√°p Ch√†m",
        lat: 11.5826,
        lon: 108.9912,
        communes: [
          { name: "Ph∆∞·ªùng B·∫£o An",    lat: 11.5826, lon: 108.9912 },
          { name: "Ph∆∞·ªùng ƒê√†i S∆°n",   lat: 11.5826, lon: 108.9912 },
          { name: "Ph∆∞·ªùng ƒê·∫°o Long",  lat: 11.5826, lon: 108.9912 },
          { name: "Ph∆∞·ªùng ƒê√¥ng H·∫£i",  lat: 11.5826, lon: 108.9912 },
          { name: "Ph∆∞·ªùng ƒê√¥ Vinh",   lat: 11.5826, lon: 108.9912 },
          { name: "Ph∆∞·ªùng Kinh Dinh", lat: 11.5826, lon: 108.9912 },
          { name: "Ph∆∞·ªùng M·ªπ B√¨nh",   lat: 11.5826, lon: 108.9912 },
          { name: "Ph∆∞·ªùng M·ªπ ƒê√¥ng",   lat: 11.5826, lon: 108.9912 },
          { name: "Ph∆∞·ªùng M·ªπ H·∫£i",    lat: 11.5826, lon: 108.9912 },
          { name: "Ph∆∞·ªùng M·ªπ H∆∞∆°ng",  lat: 11.5826, lon: 108.9912 },
          { name: "Ph∆∞·ªùng Ph·ªß H√†",    lat: 11.5826, lon: 108.9912 },
          { name: "Ph∆∞·ªùng Ph∆∞·ªõc M·ªπ",  lat: 11.5826, lon: 108.9912 },
          { name: "Ph∆∞·ªùng T·∫•n T√†i",   lat: 11.5826, lon: 108.9912 },
          { name: "Ph∆∞·ªùng Thanh S∆°n", lat: 11.5826, lon: 108.9912 },
          { name: "Ph∆∞·ªùng VƒÉn H·∫£i",   lat: 11.5826, lon: 108.9912 },
          { name: "X√£ Th√†nh H·∫£i",     lat: 11.5826, lon: 108.9912 }
        ]
      },
      {
        id: "ninh_hai",
        type: "district",
        name: "Huy·ªán Ninh H·∫£i (Kh√°nh H·∫£i)",
        lat: 11.5897,
        lon: 109.0335,
        communes: [
          { name: "Th·ªã tr·∫•n Kh√°nh H·∫£i", lat: 11.5897, lon: 109.0335 },
          { name: "X√£ H·ªô H·∫£i",          lat: 11.5897, lon: 109.0335 },
          { name: "X√£ Nh∆°n H·∫£i",        lat: 11.5897, lon: 109.0335 },
          { name: "X√£ Ph∆∞∆°ng H·∫£i",      lat: 11.5897, lon: 109.0335 },
          { name: "X√£ T√¢n H·∫£i",         lat: 11.5897, lon: 109.0335 },
          { name: "X√£ Thanh H·∫£i",       lat: 11.5897, lon: 109.0335 },
          { name: "X√£ Tri H·∫£i",         lat: 11.5897, lon: 109.0335 },
          { name: "X√£ Vƒ©nh H·∫£i",        lat: 11.5897, lon: 109.0335 },
          { name: "X√£ Xu√¢n H·∫£i",        lat: 11.5897, lon: 109.0335 }
        ]
      },
      {
        id: "ninh_phuoc",
        type: "district",
        name: "Huy·ªán Ninh Ph∆∞·ªõc (Ph∆∞·ªõc D√¢n)",
        lat: 11.5258,
        lon: 108.9266,
        communes: [
          { name: "Th·ªã tr·∫•n Ph∆∞·ªõc D√¢n", lat: 11.5258, lon: 108.9266 },
          { name: "X√£ An H·∫£i",          lat: 11.5258, lon: 108.9266 },
          { name: "X√£ Ph∆∞·ªõc H·∫£i",       lat: 11.5258, lon: 108.9266 },
          { name: "X√£ Ph∆∞·ªõc H·∫≠u",       lat: 11.5258, lon: 108.9266 },
          { name: "X√£ Ph∆∞·ªõc H·ªØu",       lat: 11.5258, lon: 108.9266 },
          { name: "X√£ Ph∆∞·ªõc S∆°n",       lat: 11.5258, lon: 108.9266 },
          { name: "X√£ Ph∆∞·ªõc Th√°i",      lat: 11.5258, lon: 108.9266 },
          { name: "X√£ Ph∆∞·ªõc Thu·∫≠n",     lat: 11.5258, lon: 108.9266 },
          { name: "X√£ Ph∆∞·ªõc Vinh",      lat: 11.5258, lon: 108.9266 }
        ]
      },
      {
        id: "ninh_son",
        type: "district",
        name: "Huy·ªán Ninh S∆°n",
        lat: 11.7083,
        lon: 108.7708,
        communes: [
          { name: "Th·ªã tr·∫•n T√¢n S∆°n", lat: 11.7083, lon: 108.7708 },
          { name: "X√£ H√≤a S∆°n",       lat: 11.7083, lon: 108.7708 },
          { name: "X√£ L√¢m S∆°n",       lat: 11.7083, lon: 108.7708 },
          { name: "X√£ L∆∞∆°ng S∆°n",     lat: 11.7083, lon: 108.7708 },
          { name: "X√£ Ma N·ªõi",        lat: 11.7083, lon: 108.7708 },
          { name: "X√£ M·ªπ S∆°n",        lat: 11.7083, lon: 108.7708 },
          { name: "X√£ Nh∆°n S∆°n",      lat: 11.7083, lon: 108.7708 },
          { name: "X√£ Qu·∫£ng S∆°n",     lat: 11.7083, lon: 108.7708 }
        ]
      },
      {
        id: "bac_ai",
        type: "district",
        name: "Huy·ªán B√°c √Åi",
        lat: 11.8334,
        lon: 108.8551,
        communes: [
          { name: "X√£ Ph∆∞·ªõc B√¨nh",  lat: 11.8334, lon: 108.8551 },
          { name: "X√£ Ph∆∞·ªõc Ch√≠nh", lat: 11.8334, lon: 108.8551 },
          { name: "X√£ Ph∆∞·ªõc ƒê·∫°i",   lat: 11.8334, lon: 108.8551 },
          { name: "X√£ Ph∆∞·ªõc H√≤a",   lat: 11.8334, lon: 108.8551 },
          { name: "X√£ Ph∆∞·ªõc T√¢n",   lat: 11.8334, lon: 108.8551 },
          { name: "X√£ Ph∆∞·ªõc Th·∫Øng", lat: 11.8334, lon: 108.8551 },
          { name: "X√£ Ph∆∞·ªõc Th√†nh", lat: 11.8334, lon: 108.8551 },
          { name: "X√£ Ph∆∞·ªõc Ti·∫øn",  lat: 11.8334, lon: 108.8551 },
          { name: "X√£ Ph∆∞·ªõc Trung", lat: 11.8334, lon: 108.8551 }
        ]
      },
      {
        id: "thuan_bac",
        type: "district",
        name: "Huy·ªán Thu·∫≠n B·∫Øc",
        lat: 11.73,
        lon: 109.02,
        communes: [
          { name: "X√£ B·∫Øc Phong",  lat: 11.73, lon: 109.02 },
          { name: "X√£ B·∫Øc S∆°n",    lat: 11.73, lon: 109.02 },
          { name: "X√£ C√¥ng H·∫£i",   lat: 11.73, lon: 109.02 },
          { name: "X√£ L·ª£i H·∫£i",    lat: 11.73, lon: 109.02 },
          { name: "X√£ Ph∆∞·ªõc Chi·∫øn",lat: 11.73, lon: 109.02 },
          { name: "X√£ Ph∆∞·ªõc Kh√°ng",lat: 11.73, lon: 109.02 }
        ]
      },
      {
        id: "thuan_nam",
        type: "district",
        name: "Huy·ªán Thu·∫≠n Nam",
        lat: 11.35,
        lon: 108.93,
        communes: [
          { name: "X√£ C√† N√°",       lat: 11.35, lon: 108.93 },
          { name: "X√£ Ph∆∞·ªõc Ninh",  lat: 11.35, lon: 108.93 },
          { name: "X√£ Ph∆∞·ªõc Di√™m",  lat: 11.35, lon: 108.93 },
          { name: "X√£ Ph∆∞·ªõc Nam",   lat: 11.35, lon: 108.93 },
          { name: "X√£ Ph∆∞·ªõc Dinh",  lat: 11.35, lon: 108.93 },
          { name: "X√£ Ph∆∞·ªõc Minh",  lat: 11.35, lon: 108.93 },
          { name: "X√£ Ph∆∞·ªõc H√†",    lat: 11.35, lon: 108.93 },
          { name: "X√£ Nh·ªã H√†",      lat: 11.35, lon: 108.93 }
        ]
      },
      { id: "ho_thanh_son", type: "reservoir", name: "H·ªì Th√†nh S∆°n", lat: 11.741500, lon: 109.031680 },
      { id: "ho_ong_kinh",  type: "reservoir", name: "H·ªì √îng Kinh",  lat: 11.607557, lon: 109.124561 },
      { id: "ho_nuoc_ngot", type: "reservoir", name: "H·ªì N∆∞·ªõc Ng·ªçt", lat: 11.689060, lon: 109.162849 },
      { id: "truong_sa", type: "reservoir", name: "ƒê·∫£o Tr∆∞·ªùng Sa l·ªõn", lat: 8.646076, lon: 111.919844 },
      { id: "hoang_sa", type: "reservoir", name: "ƒê·∫£o Ho√†ng Sa", lat: 16.5000, lon: 112.0000 },
      { id: "son_ca", type: "reservoir", name: "ƒê·∫£o Ho√†ng Sa", lat: 10.375, lon: 114.48 },
      { id: "son_tu_tay", type: "reservoir", name: "ƒê·∫£o Song T·ª≠ T√¢y", lat: 11.429444, lon: 114.331389 },
      { id: "nam_yet", type: "reservoir", name: "ƒê·∫£o Nam Y·∫øt", lat: 10.179444, lon: 114.366667 },
      { id: "phu_lam", type: "reservoir", name: "ƒê·∫£o Nam Y·∫øt", lat: 16.835278, lon: 112.338056 }
    ];

    const stationLayers = [];
    const stationTbody = document.getElementById("station-tbody");
    const communePanel = document.getElementById("commune-panel");

    // ===== 3. Ph√¢n lo·∫°i m∆∞a =====
    function classifyRain(mm) {
      if (mm === null || mm === undefined || isNaN(mm)) {
        return { label: "Kh√¥ng c√≥ d·ªØ li·ªáu", description: "", color: "#9ca3af" };
      }
      if (mm === 0) {
        return { label: "Kh√¥ng m∆∞a", description: "0 mm", color: "#9ca3af" };
      } else if (mm > 0 && mm < 16) {
        return { label: "M∆∞a nh·ªè", description: "< 16 mm", color: "#22d3ee" };
      } else if (mm >= 16 && mm < 51) {
        return { label: "M∆∞a v·ª´a", description: "16 ‚Äì < 51 mm", color: "#22c55e" };
      } else if (mm >= 51 && mm <= 100) {
        return { label: "M∆∞a to", description: "51 ‚Äì 100 mm", color: "#f97316" };
      } else {
        return { label: "M∆∞a r·∫•t to", description: "> 100 mm", color: "#ef4444" };
      }
    }

    function classifyDailyRain(mm) {
      if (mm === null || mm === undefined || isNaN(mm)) {
        return { label: "Kh√¥ng c√≥ d·ªØ li·ªáu", description: "", tag: "N/A", color: "#9ca3af" };
      }
      if (mm === 0) {
        return { label: "Kh√¥ng m∆∞a", description: "0 mm/ng√†y", tag: "R·∫•t t·ªët", color: "#9ca3af" };
      } else if (mm > 0 && mm < 16) {
        return { label: "M∆∞a nh·ªè", description: "< 16 mm/ng√†y", tag: "√çt ·∫£nh h∆∞·ªüng", color: "#22d3ee" };
      } else if (mm >= 16 && mm < 51) {
        return { label: "M∆∞a v·ª´a", description: "16 ‚Äì < 51 mm/ng√†y", tag: "C·∫ßn theo d√µi", color: "#22c55e" };
      } else if (mm >= 51 && mm <= 100) {
        return { label: "M∆∞a to", description: "51 ‚Äì 100 mm/ng√†y", tag: "Nguy c∆° cao", color: "#f97316" };
      } else {
        return { label: "M∆∞a r·∫•t to", description: "> 100 mm/ng√†y", tag: "R·∫•t nguy hi·ªÉm", color: "#ef4444" };
      }
    }

    // ===== 3b. M√¥ t·∫£ th·ªùi ti·∫øt & gi√≥ hi·ªán t·∫°i =====
    function describeWeatherCode(code) {
      if (code === null || code === undefined || isNaN(code)) {
        return "Kh√¥ng r√µ tr·∫°ng th√°i";
      }
      if (code === 0) return "Tr·ªùi quang m√¢y, n·∫Øng ƒë·∫πp";
      if (code === 1) return "Tr·ªùi h·∫ßu nh∆∞ quang m√¢y";
      if (code === 2) return "Tr·ªùi √≠t m√¢y";
      if (code === 3) return "Tr·ªùi nhi·ªÅu m√¢y, u √°m";
      if (code === 45 || code === 48) return "S∆∞∆°ng m√π / s∆∞∆°ng m√π ƒë√≥ng bƒÉng";

      if ([51,53,55].includes(code)) return "M∆∞a ph√πn";
      if ([56,57].includes(code)) return "M∆∞a ph√πn ƒë√≥ng bƒÉng";
      if ([61,63,65].includes(code)) return "M∆∞a";
      if ([66,67].includes(code)) return "M∆∞a ƒë√≥ng bƒÉng";
      if ([71,73,75,77].includes(code)) return "Tuy·∫øt / m∆∞a tuy·∫øt";

      if ([80,81,82].includes(code)) return "M∆∞a r√†o";
      if ([85,86].includes(code)) return "M∆∞a tuy·∫øt r√†o";

      if (code === 95) return "D√¥ng, c√≥ m∆∞a";
      if (code === 96 || code === 99) return "D√¥ng m·∫°nh, c√≥ kh·∫£ nƒÉng m∆∞a ƒë√°";

      return "Th·ªùi ti·∫øt kh√¥ng x√°c ƒë·ªãnh (m√£ " + code + ")";
    }

    function classifyWind(speedKmH) {
      if (speedKmH === null || speedKmH === undefined || isNaN(speedKmH)) {
        return { label: "Kh√¥ng r√µ gi√≥" };
      }
      if (speedKmH < 1)   return { label: "L·∫∑ng gi√≥" };
      if (speedKmH < 11)  return { label: "Gi√≥ nh·∫π" };
      if (speedKmH < 29)  return { label: "Gi√≥ v·ª´a" };
      if (speedKmH < 50)  return { label: "Gi√≥ m·∫°nh" };
      return { label: "Gi√≥ r·∫•t m·∫°nh (g·∫ßn c·∫•p b√£o)" };
    }

    function formatTimeVN(isoString) {
      if (!isoString) return "";
      const d = new Date(isoString);
      if (isNaN(d.getTime())) return isoString;
      const dd = String(d.getDate()).padStart(2, "0");
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const yyyy = d.getFullYear();
      const hh = String(d.getHours()).padStart(2, "0");
      const mi = String(d.getMinutes()).padStart(2, "0");
      return `${hh}:${mi} ${dd}/${mm}/${yyyy}`;
    }

    // ===== 4. Icon =====
    function createDistrictIcon() {
      return L.divIcon({
        className: '',
        html: '<div class="marker-icon marker-district">H</div>',
        iconSize: [26, 26],
        iconAnchor: [13, 13]
      });
    }

    function createReservoirIcon() {
      return L.divIcon({
        className: '',
        html: '<div class="marker-icon marker-reservoir">üíß</div>',
        iconSize: [26, 26],
        iconAnchor: [13, 13]
      });
    }

    // ===== 5. B·∫£ng huy·ªán/h·ªì =====
    function initStationTable() {
      stations.forEach((st, index) => {
        const tr = document.createElement("tr");
        tr.dataset.index = index;
        tr.innerHTML = `
          <td>${st.name}</td>
          <td class="rain-cell value-loading">ƒêang t·∫£i‚Ä¶</td>
        `;
        tr.addEventListener("click", () => {
          focusStation(index);
          highlightRow(index);
          showCommunesForDistrict(index);
        });
        stationTbody.appendChild(tr);
      });
    }

    function highlightRow(index) {
      const rows = stationTbody.querySelectorAll("tr");
      rows.forEach(r => r.classList.remove("selected"));
      const row = stationTbody.querySelector(`tr[data-index="${index}"]`);
      if (row) row.classList.add("selected");
    }

    function updateStationRow(index, html, isError = false) {
      const row = stationTbody.querySelector(`tr[data-index="${index}"]`);
      if (!row) return;
      const cell = row.querySelector(".rain-cell");
      if (!cell) return;
      cell.innerHTML = html;
      cell.classList.remove("value-loading", "value-error");
      if (isError) cell.classList.add("value-error");
    }

    initStationTable();

    function focusStation(index) {
      const st = stations[index];
      if (!st) return;
      map.setView([st.lat, st.lon], 11);
      const layer = stationLayers[index];
      if (layer && layer.marker) {
        layer.marker.openPopup();
      }
    }

    // ===== 6. M∆∞a + th·ªùi ti·∫øt & gi√≥ hi·ªán t·∫°i huy·ªán/h·ªì =====
    async function loadRainForStation(station, index) {
      const url =
        `https://api.open-meteo.com/v1/forecast` +
        `?latitude=${station.lat}` +
        `&longitude=${station.lon}` +
        `&daily=rain_sum,precipitation_sum,temperature_2m_max,temperature_2m_min` +
        `&hourly=temperature_2m,rain,precipitation,relative_humidity_2m,wind_speed_10m,weather_code` +
        `&current_weather=true` +
        `&timezone=auto&forecast_days=1`;

      try {
        const res = await fetch(url);
        const data = await res.json();

        const hourly = data.hourly || {};
        const times = hourly.time || [];
        const rainArr = (hourly.rain && hourly.rain.length ? hourly.rain : hourly.precipitation) || [];

        const cw = data.current_weather || {};
        const weatherCode = (typeof cw.weathercode === "number") ? cw.weathercode : null;
        const weatherDesc = describeWeatherCode(weatherCode);
        const windSpeed = (typeof cw.windspeed === "number") ? cw.windspeed : null; // km/h
        const windInfo = classifyWind(windSpeed);
        const windText = windSpeed === null ? "‚Äî" : windSpeed.toFixed(1).replace(".", ",");

        let rainMm = null;
        let timeStr = null;
        let idxClosest = -1;

        if (times.length && rainArr.length) {
          const now = new Date();
          let minDiff = Infinity;
          for (let i = 0; i < times.length; i++) {
            const t = new Date(times[i]);
            const diff = Math.abs(t - now);
            if (diff < minDiff) {
              minDiff = diff;
              idxClosest = i;
            }
          }
          if (idxClosest >= 0) {
            rainMm = typeof rainArr[idxClosest] === "number" ? rainArr[idxClosest] : null;
            timeStr = times[idxClosest];
          }
        }

        const cls = classifyRain(rainMm);
        const icon = station.type === "reservoir" ? createReservoirIcon() : createDistrictIcon();
        const marker = L.marker([station.lat, station.lon], { icon }).addTo(rainLayer);
        stationLayers[index] = { marker };

        const rainText = rainMm === null ? "‚Äî" : rainMm.toFixed(2).replace(".", ",");

        const popupHtml = `
          <div style="min-width:200px;font-size:12px;">
            <b>${station.name}</b><br/>
            M∆∞a: <b>${rainText} mm/gi·ªù</b> ‚Äì ${cls.label}<br/>
            Gi√≥: <b>${windText} km/h</b> ‚Äì ${windInfo.label}<br/>
            Th·ªùi ti·∫øt: ${weatherDesc}<br/>
            <span style="color:#6b7280;font-size:10px;">${formatTimeVN(timeStr)}</span><br/>
            <span style="font-size:10px;color:#9ca3af;">D·ªØ li·ªáu: Open-Meteo</span>
          </div>
        `;
        marker.bindPopup(popupHtml);

        const cellHtml = `
          <div style="font-size:11px;">
            <div class="rain-badge" style="border-color:${cls.color};">
              <span class="rain-badge-dot" style="background:${cls.color};"></span>
              ${cls.label}
            </div>
            <div>M∆∞a: ${rainText} mm/gi·ªù</div>
            <div>Gi√≥: ${windText} km/h ‚Äì ${windInfo.label}</div>
          </div>
        `;
        updateStationRow(index, cellHtml);

        const row = stationTbody.querySelector(`tr[data-index="${index}"]`);
        if (row) {
          row.style.borderLeftColor = cls.color;
        }

      } catch (err) {
        console.error("L·ªói l·∫•y m∆∞a cho", station.name, err);
        updateStationRow(index, "L·ªói d·ªØ li·ªáu", true);
      }
    }

    stations.forEach((st, idx) => loadRainForStation(st, idx));

    // ===== 7. B·∫£ng x√£ =====
    function hideCommunePanel() {
      communePanel.style.display = "none";
      communePanel.innerHTML = "";
    }
    window.hideCommunePanel = hideCommunePanel;

    function showCommunesForDistrict(index) {
      const st = stations[index];

      if (!st || !st.communes || !Array.isArray(st.communes) || st.communes.length === 0) {
        communePanel.style.display = "block";
        communePanel.innerHTML = `
          <div class="commune-card">
            <div class="commune-header">
              <div>
                <div class="commune-title">Danh s√°ch x√£ / ph∆∞·ªùng</div>
                <div class="commune-subtitle">ƒêi·ªÉm: ${st ? st.name : ""}</div>
              </div>
              <button class="commune-close" onclick="hideCommunePanel()">‚úï</button>
            </div>
            <div style="font-size:11px;color:#6b7280;">
              ƒêi·ªÉm n√†y l√† h·ªì ch·ª©a, ch∆∞a khai b√°o danh s√°ch x√£ chi ti·∫øt.
            </div>
          </div>
        `;
        return;
      }

      let rowsHtml = "";
      st.communes.forEach((c, i) => {
        rowsHtml += `
          <tr data-cindex="${i}">
            <td>${c.name}</td>
            <td class="commune-rain-cell value-loading">ƒêang t·∫£i‚Ä¶</td>
          </tr>
        `;
      });

      communePanel.style.display = "block";
      communePanel.innerHTML = `
        <div class="commune-card">
          <div class="commune-header">
            <div>
              <div class="commune-title">X√£ / Ph∆∞·ªùng thu·ªôc ${st.name}</div>
              <div class="commune-subtitle">M∆∞a ng√†y 24h (mm)</div>
            </div>
            <button class="commune-close" onclick="hideCommunePanel()">‚úï</button>
          </div>
          <div class="commune-table-wrapper">
            <table class="commune-table">
              <thead>
                <tr>
                  <th style="width:55%;">X√£ / Ph∆∞·ªùng</th>
                  <th style="width:45%;">M∆∞a ng√†y</th>
                </tr>
              </thead>
              <tbody id="commune-tbody">
                ${rowsHtml}
              </tbody>
            </table>
          </div>
        </div>
      `;

      loadDailyRainForCommunes(st);
    }

    async function loadDailyRainForCommunes(station) {
      const tbody = document.getElementById("commune-tbody");
      if (!tbody) return;

      station.communes.forEach(async (commune, idx) => {
        const url =
          `https://api.open-meteo.com/v1/forecast` +
          `?latitude=${commune.lat}` +
          `&longitude=${commune.lon}` +
          `&daily=rain_sum,precipitation_sum,temperature_2m_max,temperature_2m_min` +
          `&hourly=temperature_2m,rain,precipitation,relative_humidity_2m,wind_speed_10m` +
          `&timezone=auto&forecast_days=1`;

        try {
          const res = await fetch(url);
          const data = await res.json();
          const daily = data.daily || {};
          const arr = daily.precipitation_sum || [];
          const mm = typeof arr[0] === "number" ? arr[0] : null;

          const cls = classifyDailyRain(mm);
          const mmText = mm === null ? "‚Äî" : mm.toFixed(1).replace(".", ",");

          const row = tbody.querySelector(`tr[data-cindex="${idx}"]`);
          if (!row) return;
          const cell = row.querySelector(".commune-rain-cell");
          if (!cell) return;

          cell.classList.remove("value-loading", "value-error");
          cell.innerHTML = `
            <div class="rain-badge" style="border-color:${cls.color};">
              <span class="rain-badge-dot" style="background:${cls.color};"></span>
              <span>${cls.label}</span>
            </div>
            <div style="font-size:11px;margin-top:2px;">${mmText} mm/ng√†y</div>
          `;
        } catch (err) {
          console.error("L·ªói m∆∞a ng√†y cho x√£", commune.name, err);
          const row = tbody.querySelector(`tr[data-cindex="${idx}"]`);
          if (!row) return;
          const cell = row.querySelector(".commune-rain-cell");
          if (!cell) return;

          cell.textContent = "L·ªói d·ªØ li·ªáu";
          cell.classList.remove("value-loading");
          cell.classList.add("value-error");
        }
      });
    }

    // ===== 8. C·∫≠p nh·∫≠t gi·ªù =====
    function updateTimeNow() {
      const el = document.getElementById("updated-time");
      if (!el) return;

      const now = new Date();
      const dd = String(now.getDate()).padStart(2, '0');
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      const yyyy = now.getFullYear();
      const hh = String(now.getHours()).padStart(2, '0');
      const mi = String(now.getMinutes()).padStart(2, '0');

      el.innerHTML = `D·ªØ li·ªáu ƒë∆∞·ª£c c·∫≠p nh·∫≠t l√∫c ${hh}:${mi} ng√†y ${dd}/${mm}/${yyyy}`;
    }
    updateTimeNow();

    // ===== 9. Legend =====
    const legend = L.control({ position: "bottomright" });

    legend.onAdd = function () {
      const div = L.DomUtil.create("div", "legend leaflet-control");
      div.innerHTML = `
        <div style="font-weight: 600; margin-bottom: 4px;">M·ª©c m∆∞a (mm)</div>
        <div class="legend-row">
          <span class="legend-color" style="background:#9ca3af;"></span>
          <span>Kh√¥ng m∆∞a</span>
        </div>
        <div class="legend-row">
          <span class="legend-color" style="background:#22d3ee;"></span>
          <span>M∆∞a nh·ªè (m∆∞a nh·ªè h∆°n 16mm)</span>
        </div>
        <div class="legend-row">
          <span class="legend-color" style="background:#22c55e;"></span>
          <span>M∆∞a v·ª´a (m∆∞a t·ª´ 16mm ƒë·∫øn d∆∞·ªõi 51mm)</span>
        </div>
        <div class="legend-row">
          <span class="legend-color" style="background:#f97316;"></span>
          <span>M∆∞a to (m∆∞a t·ª´ 51mm ƒë·∫øn 100mm)</span>
        </div>
        <div class="legend-row" style="margin-bottom:0;">
          <span class="legend-color" style="background:#ef4444;"></span>
          <span>M∆∞a r·∫•t to (m∆∞a l·ªõn h∆°n 100mm)</span>
        </div>
      `;
      return div;
    };
    legend.addTo(map);

    // ===== 10. N√∫t FULLSCREEN =====
    const fsBtn = document.getElementById('fullscreen-btn');
    const fsIcon = document.getElementById('fullscreen-icon');
    const fsText = document.getElementById('fullscreen-text');

    function updateFsButton() {
      const isFull = !!document.fullscreenElement;
      if (isFull) {
        fsIcon.textContent = '‚§¢';
        fsText.textContent = 'Tho√°t full m√†n';
      } else {
        fsIcon.textContent = '‚õ∂';
        fsText.textContent = 'To√†n m√†n h√¨nh';
      }
    }

    fsBtn.addEventListener('click', () => {
      if (!document.fullscreenElement) {
        // cho to√†n b·ªô trang v√†o fullscreen
        document.documentElement.requestFullscreen?.();
      } else {
        document.exitFullscreen?.();
      }
    });

    document.addEventListener('fullscreenchange', updateFsButton);
  </script>
</body>
</html>
