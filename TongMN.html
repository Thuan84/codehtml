<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bảng Dữ Liệu Tối Ưu với Bộ Lọc</title>
  <style>
    /* ----- General Styles ----- */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #f7f8fa;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    .container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      background: #ffffff;
      padding: 25px 30px;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
    }
    h2 {
      text-align: center;
      color: #0d6efd;
      margin-top: 0;
      margin-bottom: 25px;
      font-weight: 600;
    }

    /* ----- Filters UI ----- */
    .filters-container {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-bottom: 25px;
      padding-bottom: 20px;
      border-bottom: 1px solid #dee2e6;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
      flex: 1 1 200px; /* Responsive flexbox */
    }
    .filter-group label {
      font-size: 13px;
      font-weight: 500;
      color: #555;
      margin-bottom: 6px;
    }
    .filter-group select, .filter-group input {
      padding: 9px 12px;
      border-radius: 6px;
      border: 1px solid #ced4da;
      font-size: 15px;
      background-color: #fff;
    }
    .filter-group select:focus, .filter-group input:focus {
      outline: none;
      border-color: #86b7fe;
      box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.25);
    }
    #clear-filters-btn {
      align-self: flex-end;
      padding: 9px 20px;
      border: none;
      background-color: #6c757d;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 15px;
      transition: background-color 0.2s;
    }
    #clear-filters-btn:hover {
      background-color: #5a6268;
    }

    /* ----- Table Styles ----- */
    .table-wrapper {
        overflow-x: auto; /* For responsive tables */
    }
    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 15px;
    }
    th, td {
      padding: 14px 18px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
      white-space: nowrap; /* Prevent text wrapping */
    }
    thead th {
      background-color: #f8f9fa;
      color: #343a40;
      font-weight: 600;
      font-size: 13px;
      letter-spacing: 0.5px;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    tbody tr:hover {
      background-color: #f1faff;
    }
    tbody tr:last-child td {
      border-bottom: none;
    }

    /* ----- Loader and Messages ----- */
    .status-message {
      text-align: center;
      padding: 50px;
      color: #6c757d;
      font-size: 16px;
    }
    .loader {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #0d6efd;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 40px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <div class="container">
    <h2>Bảng Dữ Liệu Tối Ưu</h2>
    
    <!-- Filter Controls -->
    <div class="filters-container" id="filters">
      <div class="filter-group">
        <label for="filter-lake">Lọc theo Tên Hồ</label>
        <select id="filter-lake"></select>
      </div>
      <div class="filter-group">
        <label for="filter-year">Lọc theo Năm Báo Cáo</label>
        <select id="filter-year"></select>
      </div>
      <div class="filter-group">
        <label for="filter-start-date">Từ Ngày</label>
        <input type="date" id="filter-start-date">
      </div>
      <div class="filter-group">
        <label for="filter-end-date">Đến Ngày</label>
        <input type="date" id="filter-end-date">
      </div>
      <button id="clear-filters-btn">Xoá bộ lọc</button>
    </div>

    <!-- Table Wrapper and Table -->
    <div class="table-wrapper">
      <table id="data-table">
        <thead id="table-head"></thead>
        <tbody id="table-body">
            <tr>
                <td colspan="100%" class="status-message"><div class="loader"></div>Đang tải dữ liệu...</td>
            </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- CONFIGURATION ---
      const API_URL = 'https://script.google.com/macros/s/AKfycbzSEUNyod3PxFUP_DlSeCT8KVwAeV0oYdxSif0SfeArAv7il53F05vJssWnjUOdpxJR/exec';
      const LAKE_COLUMN = 'Họ và tên'; // Đổi 'Tên hồ' thành 'Họ và tên' cho khớp dữ liệu
      const DATE_COLUMN = 'Ngày sinh'; // Đổi 'Ngày báo cáo' thành 'Ngày sinh'

      // --- DOM ELEMENTS ---
      const tableHead = document.getElementById('table-head');
      const tableBody = document.getElementById('table-body');
      const filterLake = document.getElementById('filter-lake');
      const filterYear = document.getElementById('filter-year');
      const filterStartDate = document.getElementById('filter-start-date');
      const filterEndDate = document.getElementById('filter-end-date');
      const clearFiltersBtn = document.getElementById('clear-filters-btn');

      // --- STATE ---
      let allData = []; // Cache for all data fetched from the API
      let headers = [];

      // --- UTILITY FUNCTIONS ---

      /**
       * Formats cell content. Formats decimal numbers to 3 decimal places.
       * @param {*} value - The value to format.
       * @returns {string} The formatted value.
       */
      const formatCellContent = (value) => {
        if (value === null || value === undefined) return '';
        if (typeof value === 'number' && value % 1 !== 0) {
          return value.toFixed(3);
        }
        return value;
      };

      /**
       * Renders the table with the provided data.
       * @param {Array<Object>} dataToRender - The array of data rows to display.
       */
      const renderTable = (dataToRender) => {
        if (dataToRender.length === 0) {
          tableBody.innerHTML = `<tr><td colspan="${headers.length}" class="status-message">Không tìm thấy kết quả phù hợp.</td></tr>`;
          return;
        }

        const tableBodyHTML = dataToRender.map(row => {
          const cells = headers.map(header => `<td>${formatCellContent(row[header])}</td>`).join('');
          return `<tr>${cells}</tr>`;
        }).join('');
        
        tableBody.innerHTML = tableBodyHTML;
      };

      /**
       * Populates the filter dropdowns based on the fetched data.
       */
      const populateFilters = () => {
        const lakes = new Set();
        const years = new Set();

        allData.forEach(row => {
          if (row[LAKE_COLUMN]) lakes.add(row[LAKE_COLUMN]);
          if (row[DATE_COLUMN]) {
            try {
              const date = new Date(row[DATE_COLUMN]);
              if (!isNaN(date)) {
                  years.add(date.getFullYear());
              }
            } catch(e) { /* ignore invalid dates */ }
          }
        });

        const sortedLakes = [...lakes].sort();
        const sortedYears = [...years].sort((a, b) => b - a); // Newest first

        filterLake.innerHTML = '<option value="">Tất cả Hồ</option>' + sortedLakes.map(lake => `<option value="${lake}">${lake}</option>`).join('');
        filterYear.innerHTML = '<option value="">Tất cả Năm</option>' + sortedYears.map(year => `<option value="${year}">${year}</option>`).join('');
      };

      /**
       * Applies all active filters to the data and re-renders the table.
       */
      const applyFiltersAndRender = () => {
        const selectedLake = filterLake.value;
        const selectedYear = filterYear.value;
        const startDate = filterStartDate.value ? new Date(filterStartDate.value) : null;
        const endDate = filterEndDate.value ? new Date(filterEndDate.value) : null;
        
        // Normalize time for date-only comparison
        if (startDate) startDate.setHours(0, 0, 0, 0);
        if (endDate) endDate.setHours(23, 59, 59, 999);

        const filteredData = allData.filter(row => {
          // Lake filter
          if (selectedLake && row[LAKE_COLUMN] !== selectedLake) return false;

          // Date based filters
          const rowDate = row[DATE_COLUMN] ? new Date(row[DATE_COLUMN]) : null;
          if (rowDate && !isNaN(rowDate)) {
             // Year filter
            if (selectedYear && rowDate.getFullYear() != selectedYear) return false;
            // Start date filter
            if (startDate && rowDate < startDate) return false;
            // End date filter
            if (endDate && rowDate > endDate) return false;
          } else {
             // If a date filter is set, rows without a valid date should be excluded
             if (selectedYear || startDate || endDate) return false;
          }

          return true; // Row passes all filters
        });

        renderTable(filteredData);
      };

      // --- INITIALIZATION ---

      /**
       * Main function to fetch data and initialize the application.
       */
      const initialize = async () => {
        try {
          const response = await fetch(API_URL);
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          
          const data = await response.json();
          if (!data || data.length === 0) {
             tableBody.innerHTML = `<tr><td colspan="1" class="status-message">Không có dữ liệu từ API.</td></tr>`;
             return;
          }

          allData = data;
          headers = Object.keys(allData[0]);

          // Render headers
          tableHead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
          
          populateFilters();
          renderTable(allData);

          // Add event listeners AFTER data is loaded
          filterLake.addEventListener('change', applyFiltersAndRender);
          filterYear.addEventListener('change', applyFiltersAndRender);
          filterStartDate.addEventListener('input', applyFiltersAndRender);
          filterEndDate.addEventListener('input', applyFiltersAndRender);
          clearFiltersBtn.addEventListener('click', () => {
              filterLake.value = '';
              filterYear.value = '';
              filterStartDate.value = '';
              filterEndDate.value = '';
              applyFiltersAndRender();
          });

        } catch (error) {
          console.error('Initialization failed:', error);
          tableBody.innerHTML = `<tr><td colspan="1" class="status-message">Lỗi tải dữ liệu. Vui lòng thử lại.</td></tr>`;
        }
      };

      initialize();
    });
  </script>

</body>
</html>
