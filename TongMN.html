<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TRA CỨU MỰC NƯỚC CÁC HỒ DO TRẠM THỦY NÔNG NINH HẢI QUẢN LÝ</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* ----- General Styles ----- */
    :root {
      --primary-color: #4361ee;
      --secondary-color: #3f37c9;
      --accent-color: #4895ef;
      --light-color: #f8f9fa;
      --dark-color: #343a40;
      --gray-color: #6c757d;
      --border-color: #dee2e6;
      --hover-color: #f1faff;
      --error-color: #e63946;
      --success-color: #2a9d8f;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #f7f8fa;
      margin: 0;
      padding: 20px;
      color: var(--dark-color);
      line-height: 1.6;
    }
    .container {
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      background: #ffffff;
      padding: 25px 30px;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
      position: relative;
      min-height: 300px;
    }
    h2 {
      text-align: center;
      color: var(--primary-color);
      margin-top: 0;
      margin-bottom: 25px;
      font-weight: 600;
      font-size: 28px;
    }

    /* ----- Loading Overlay ----- */
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 100;
      border-radius: 12px;
      transition: opacity 0.3s ease;
    }
    .loading-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .loading-text {
      margin-top: 15px;
      font-size: 16px;
      color: var(--gray-color);
    }

    /* ----- Filters UI ----- */
    .filters-container {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-bottom: 25px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border-color);
      align-items: flex-end;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
      flex: 1 1 220px;
      min-width: 200px;
    }
    .filter-group label {
      font-size: 14px;
      font-weight: 500;
      color: var(--gray-color);
      margin-bottom: 8px;
    }
    .filter-group select, 
    .filter-group input,
    .filter-group .search-input {
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      font-size: 15px;
      background-color: #fff;
      transition: all 0.2s ease;
      height: 40px;
      box-sizing: border-box;
    }
    .filter-group .search-input {
      display: flex;
      align-items: center;
      padding: 0;
    }
    .filter-group .search-input input {
      flex: 1;
      border: none;
      padding: 10px 12px;
      border-radius: 8px 0 0 8px;
      outline: none;
      height: 100%;
    }
    .filter-group .search-input button {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 0 12px;
      height: 100%;
      border-radius: 0 8px 8px 0;
      cursor: pointer;
      transition: background 0.2s;
    }
    .filter-group .search-input button:hover {
      background: var(--secondary-color);
    }
    .filter-group select:focus, 
    .filter-group input:focus,
    .filter-group .search-input input:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
    }
    .filter-actions {
      display: flex;
      gap: 10px;
      margin-left: auto;
    }
    .filter-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
      height: 40px;
    }
    #clear-filters-btn {
      background-color: var(--gray-color);
      color: white;
    }
    #clear-filters-btn:hover {
      background-color: #5a6268;
    }
    #apply-filters-btn {
      background-color: var(--primary-color);
      color: white;
    }
    #apply-filters-btn:hover {
      background-color: var(--secondary-color);
    }
    .filter-btn i {
      font-size: 14px;
    }

    /* ----- Table Styles ----- */
    .table-wrapper {
      overflow-x: auto;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      position: relative;
      min-height: 200px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 15px;
      min-width: 1000px;
    }
    th, td {
      padding: 14px 18px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }
    thead th {
      background-color: var(--light-color);
      color: var(--dark-color);
      font-weight: 600;
      font-size: 14px;
      letter-spacing: 0.3px;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    tbody tr:hover {
      background-color: var(--hover-color);
    }
    tbody tr:last-child td {
      border-bottom: none;
    }
    .hidden-column {
      display: none;
    }

    /* ----- Status Messages ----- */
    .status-message {
      text-align: center;
      padding: 50px;
      color: var(--gray-color);
      font-size: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    .status-message i {
      font-size: 24px;
    }
    .error-message {
      color: var(--error-color);
    }
    .success-message {
      color: var(--success-color);
    }
    .loader {
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--primary-color);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ----- Responsive Styles ----- */
    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
      .filter-group {
        flex: 1 1 100%;
      }
      .filter-actions {
        width: 100%;
        margin-top: 10px;
      }
      .filter-btn {
        flex: 1;
        justify-content: center;
      }
    }
  </style>
</head>
<body>

  <div class="container">
    <h2>Bảng Dữ Liệu Tối Ưu</h2>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
      <div class="loader"></div>
      <div class="loading-text">Đang tải dữ liệu...</div>
    </div>
    
    <!-- Filter Controls -->
    <div class="filters-container" id="filters">
      <div class="filter-group">
        <label for="filter-lake">Tìm kiếm theo Tên Hồ</label>
        <div class="search-input">
          <input type="text" id="filter-lake-search" placeholder="Nhập tên hồ...">
          <button id="search-lake-btn"><i class="fas fa-search"></i></button>
        </div>
      </div>
      <div class="filter-group">
        <label for="filter-lake">Lọc theo Tên Hồ</label>
        <select id="filter-lake">
          <option value="">Đang tải...</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="filter-year">Lọc theo Năm Báo Cáo</label>
        <select id="filter-year">
          <option value="">Đang tải...</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="filter-start-date">Từ Ngày</label>
        <input type="date" id="filter-start-date">
      </div>
      <div class="filter-group">
        <label for="filter-end-date">Đến Ngày</label>
        <input type="date" id="filter-end-date">
      </div>
      <div class="filter-actions">
        <button id="apply-filters-btn"><i class="fas fa-filter"></i> Áp dụng</button>
        <button id="clear-filters-btn"><i class="fas fa-broom"></i> Xoá bộ lọc</button>
      </div>
    </div>

    <!-- Table Wrapper and Table -->
    <div class="table-wrapper">
      <table id="data-table">
        <thead id="table-head">
          <tr>
            <th>Đang tải dữ liệu...</th>
          </tr>
        </thead>
        <tbody id="table-body">
          <tr>
            <td colspan="100%" class="status-message">
              <div class="loader"></div>
              <div>Đang tải dữ liệu...</div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- CONFIGURATION ---
      const API_URL = 'https://script.google.com/macros/s/AKfycbzSEUNyod3PxFUP_DlSeCT8KVwAeV0oYdxSif0SfeArAv7il53F05vJssWnjUOdpxJR/exec';
      const LAKE_COLUMN = 'Họ và tên';
      const DATE_COLUMN = 'Ngày sinh';
      const HIDDEN_COLUMNS = ['Tencot', 'id'];
      const CACHE_KEY = 'lake_data_cache';
      const CACHE_EXPIRY_DAYS = 1; // Số ngày lưu cache

      // --- DOM ELEMENTS ---
      const loadingOverlay = document.getElementById('loading-overlay');
      const tableHead = document.getElementById('table-head');
      const tableBody = document.getElementById('table-body');
      const filterLake = document.getElementById('filter-lake');
      const filterLakeSearch = document.getElementById('filter-lake-search');
      const searchLakeBtn = document.getElementById('search-lake-btn');
      const filterYear = document.getElementById('filter-year');
      const filterStartDate = document.getElementById('filter-start-date');
      const filterEndDate = document.getElementById('filter-end-date');
      const clearFiltersBtn = document.getElementById('clear-filters-btn');
      const applyFiltersBtn = document.getElementById('apply-filters-btn');

      // --- STATE ---
      let allData = [];
      let headers = [];
      let filteredLakes = [];

      // --- UTILITY FUNCTIONS ---

      // Kiểm tra và lấy dữ liệu từ cache nếu còn hiệu lực
      const getCachedData = () => {
        const cachedData = localStorage.getItem(CACHE_KEY);
        if (!cachedData) return null;
        
        const { data, timestamp } = JSON.parse(cachedData);
        const expiryDate = new Date(timestamp);
        expiryDate.setDate(expiryDate.getDate() + CACHE_EXPIRY_DAYS);
        
        return new Date() <= expiryDate ? data : null;
      };

      // Lưu dữ liệu vào cache
      const saveDataToCache = (data) => {
        const cacheData = {
          data: data,
          timestamp: new Date().toISOString()
        };
        localStorage.setItem(CACHE_KEY, JSON.stringify(cacheData));
      };

      // Format cell content
      const formatCellContent = (value) => {
        if (value === null || value === undefined) return '';
        if (typeof value === 'number' && value % 1 !== 0) {
          return value.toFixed(3);
        }
        return value;
      };

      // Render table
      const renderTable = (dataToRender) => {
        if (dataToRender.length === 0) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="${headers.length}" class="status-message">
                <i class="fas fa-info-circle"></i>
                <div>Không tìm thấy kết quả phù hợp.</div>
              </td>
            </tr>`;
          return;
        }

        const tableBodyHTML = dataToRender.map(row => {
          const cells = headers.map(header => {
            const isHidden = HIDDEN_COLUMNS.includes(header) ? 'hidden-column' : '';
            return `<td class="${isHidden}">${formatCellContent(row[header])}</td>`;
          }).join('');
          return `<tr>${cells}</tr>`;
        }).join('');
        
        tableBody.innerHTML = tableBodyHTML;
      };

      // Populate filters
      const populateFilters = () => {
        const lakes = new Set();
        const years = new Set();

        allData.forEach(row => {
          if (row[LAKE_COLUMN]) lakes.add(row[LAKE_COLUMN]);
          if (row[DATE_COLUMN]) {
            try {
              const date = new Date(row[DATE_COLUMN]);
              if (!isNaN(date)) {
                  years.add(date.getFullYear());
              }
            } catch(e) { /* ignore invalid dates */ }
          }
        });

        const sortedLakes = [...lakes].sort();
        filteredLakes = sortedLakes;
        const sortedYears = [...years].sort((a, b) => b - a);

        filterLake.innerHTML = '<option value="">Tất cả Hồ</option>' + 
          sortedLakes.map(lake => `<option value="${lake}">${lake}</option>`).join('');
        
        filterYear.innerHTML = '<option value="">Tất cả Năm</option>' + 
          sortedYears.map(year => `<option value="${year}">${year}</option>`).join('');

        // Set default date range to current year
        const currentYear = new Date().getFullYear();
        filterStartDate.value = `${currentYear}-01-01`;
        filterEndDate.value = `${currentYear}-12-31`;
      };

      // Apply filters
      const applyFilters = () => {
        const selectedLake = filterLake.value;
        const searchLakeText = filterLakeSearch.value.toLowerCase();
        const selectedYear = filterYear.value;
        const startDate = filterStartDate.value ? new Date(filterStartDate.value) : null;
        const endDate = filterEndDate.value ? new Date(filterEndDate.value) : null;
        
        if (startDate) startDate.setHours(0, 0, 0, 0);
        if (endDate) endDate.setHours(23, 59, 59, 999);

        const filteredData = allData.filter(row => {
          // Lake filter
          if (selectedLake && row[LAKE_COLUMN] !== selectedLake) return false;
          
          // Lake search
          if (searchLakeText && row[LAKE_COLUMN] && 
              !row[LAKE_COLUMN].toLowerCase().includes(searchLakeText)) {
            return false;
          }

          // Date based filters
          const rowDate = row[DATE_COLUMN] ? new Date(row[DATE_COLUMN]) : null;
          if (rowDate && !isNaN(rowDate)) {
             // Year filter
            if (selectedYear && rowDate.getFullYear() != selectedYear) return false;
            // Start date filter
            if (startDate && rowDate < startDate) return false;
            // End date filter
            if (endDate && rowDate > endDate) return false;
          } else {
             if (selectedYear || startDate || endDate) return false;
          }

          return true;
        });

        renderTable(filteredData);
      };

      // Search lake by text input
      const searchLake = () => {
        const searchText = filterLakeSearch.value.toLowerCase();
        if (!searchText) {
          filterLake.innerHTML = '<option value="">Tất cả Hồ</option>' + 
            filteredLakes.map(lake => `<option value="${lake}">${lake}</option>`).join('');
          return;
        }
        
        const filtered = filteredLakes.filter(lake => 
          lake.toLowerCase().includes(searchText)
        );
        
        filterLake.innerHTML = '<option value="">Tất cả Hồ</option>' + 
          filtered.map(lake => `<option value="${lake}">${lake}</option>`).join('');
      };

      // --- DATA FETCHING ---
      const fetchData = async () => {
        try {
          // Hiển thị loading
          loadingOverlay.classList.remove('hidden');
          
          // Kiểm tra cache trước
          const cachedData = getCachedData();
          if (cachedData) {
            allData = cachedData;
            headers = Object.keys(allData[0]);
            initializeUI();
            return;
          }

          // Nếu không có cache, fetch từ API
          const response = await fetch(API_URL);
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          
          const data = await response.json();
          if (!data || data.length === 0) {
            throw new Error('Không có dữ liệu từ API');
          }

          allData = data;
          headers = Object.keys(allData[0]);
          
          // Lưu vào cache
          saveDataToCache(data);
          
          initializeUI();
          
        } catch (error) {
          console.error('Error fetching data:', error);
          showError('Lỗi tải dữ liệu. Vui lòng thử lại.');
        } finally {
          loadingOverlay.classList.add('hidden');
        }
      };

      // Hiển thị thông báo lỗi
      const showError = (message) => {
        tableBody.innerHTML = `
          <tr>
            <td colspan="100%" class="status-message error-message">
              <i class="fas fa-exclamation-triangle"></i>
              <div>${message}</div>
              <button id="retry-btn" style="margin-top: 15px; padding: 8px 16px; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">
                <i class="fas fa-sync-alt"></i> Thử lại
              </button>
            </td>
          </tr>`;
        
        document.getElementById('retry-btn')?.addEventListener('click', fetchData);
      };

      // Khởi tạo UI sau khi có dữ liệu
      const initializeUI = () => {
        // Render headers with hidden columns
        tableHead.innerHTML = `<tr>${headers.map(h => 
          `<th class="${HIDDEN_COLUMNS.includes(h) ? 'hidden-column' : ''}">${h}</th>`
        ).join('')}</tr>`;
        
        populateFilters();
        applyFilters();

        // Add event listeners
        filterLake.addEventListener('change', applyFilters);
        filterYear.addEventListener('change', applyFilters);
        filterStartDate.addEventListener('input', applyFilters);
        filterEndDate.addEventListener('input', applyFilters);
        filterLakeSearch.addEventListener('input', searchLake);
        searchLakeBtn.addEventListener('click', searchLake);
        clearFiltersBtn.addEventListener('click', () => {
            filterLake.value = '';
            filterLakeSearch.value = '';
            filterYear.value = '';
            filterStartDate.value = '';
            filterEndDate.value = '';
            applyFilters();
            searchLake();
        });
        applyFiltersBtn.addEventListener('click', applyFilters);
      };

      // Bắt đầu tải dữ liệu
      fetchData();
    });
  </script>

</body>
</html>
