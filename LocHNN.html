<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>H·ªá th·ªëng quan tr·∫Øc h·ªì ch·ª©a n∆∞·ªõc ng·ªçt</title>

  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- @page ƒë·ªông cho in d·ªçc/ngang -->
  <style id="printStyle"></style>

  <style>
    :root{
      --ink:#0f172a;
      --muted:#64748b;
      --brand:#1EA48D;
      --line:#1EA48D;
      --bg:#ffffff;
      --radius:12px;
      --normal-color: #22c55e;
      --monitor-color: #f59e0b;
      --danger-color: #ef4444;
      --emergency-color: #a855f7;
      --sidebar-bg: #f8fafc;
      --sidebar-active: #e2f8f0;
      --sidebar-hover: #f0fdfa;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Inter,"Segoe UI",Roboto,Arial,sans-serif;
      color:var(--ink);
      background:#f8fafc;
      display: flex;
      overflow-x: hidden;
    }

    /* Toast Notification Styles */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .toast {
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 300px;
      max-width: 400px;
      animation: slideIn 0.3s ease-out;
      transition: opacity 0.3s, transform 0.3s;
    }
    
    .toast.success {
      border-left: 4px solid var(--normal-color);
    }
    
    .toast.info {
      border-left: 4px solid #3b82f6;
    }
    
    .toast.warning {
      border-left: 4px solid var(--monitor-color);
    }
    
    .toast.error {
      border-left: 4px solid var(--danger-color);
    }
    
    .toast-icon {
      font-size: 18px;
    }
    
    .toast.success .toast-icon {
      color: var(--normal-color);
    }
    
    .toast.info .toast-icon {
      color: #3b82f6;
    }
    
    .toast.warning .toast-icon {
      color: var(--monitor-color);
    }
    
    .toast.error .toast-icon {
      color: var(--danger-color);
    }
    
    .toast-message {
      flex: 1;
      font-size: 14px;
    }
    
    .toast-close {
      cursor: pointer;
      color: var(--muted);
      font-size: 16px;
    }
    
    .toast-progress {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      background-color: var(--brand);
      animation: progress 5s linear forwards;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes progress {
      from {
        width: 100%;
      }
      to {
        width: 0%;
      }
    }

    /* Loading Spinner */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(30, 164, 141, 0.2);
      border-radius: 50%;
      border-top-color: var(--brand);
      animation: spin 1s ease-in-out infinite;
      margin-bottom: 16px;
    }
    
    .loading-text {
      font-size: 16px;
      font-weight: 600;
      color: var(--ink);
    }
    
    .loading-progress {
      margin-top: 10px;
      width: 200px;
      height: 8px;
      background-color: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .loading-progress-bar {
      height: 100%;
      background-color: var(--brand);
      transition: width 0.3s ease;
    }
    
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Data Update Indicator */
    .data-update-indicator {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: var(--brand);
      color: white;
      padding: 10px 16px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 999;
      transform: translateY(100px);
      opacity: 0;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }
    
    .data-update-indicator.show {
      transform: translateY(0);
      opacity: 1;
    }
    
    .data-update-indicator i {
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    /* Sidebar */
    .sidebar {
      width: 260px;
      background: var(--sidebar-bg);
      border-right: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      height: 100vh;
      position: fixed;
      left: 0;
      top: 0;
      z-index: 100;
      box-shadow: 2px 0 8px rgba(0,0,0,0.05);
      transition: transform 0.3s ease;
    }

    .sidebar-header {
      padding: 16px;
      background: linear-gradient(135deg, #1EA48D 0%, #158572 100%);
      color: white;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sidebar-header h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
    }

    .sidebar-menu {
      flex: 1;
      overflow-y: auto;
      padding: 16px 0;
    }

    .menu-item {
      padding: 12px 20px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 500;
      color: var(--ink);
      border-left: 3px solid transparent;
    }

    .menu-item:hover {
      background: var(--sidebar-hover);
    }

    .menu-item.active {
      background: var(--sidebar-active);
      border-left-color: var(--brand);
      color: var(--brand);
    }

    .menu-item i {
      font-size: 18px;
      width: 24px;
      text-align: center;
    }

    .menu-text {
      font-size: 15px;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: 260px;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    /* Toolbar */
    .toolbar{
      position:sticky;
      top:0;
      z-index:20;
      display:flex;
      gap:10px;
      align-items:center;
      padding:10px 16px;
      background:#fff;
      border-bottom:1px solid #e5e7eb;
      flex-wrap:wrap;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
    }
    .dot{
      width:10px;
      height:10px;
      border-radius:50%;
      background:var(--brand);
      box-shadow:0 0 0 3px rgba(30,164,141,.15);
    }
    .spacer{ flex:1; }
    .btn{
      appearance:none;
      border-radius:10px;
      padding:8px 14px;
      font-weight:700;
      cursor:pointer;
      border:1px solid #e5e7eb;
      background:#fff;
      transition:.15s;
      font-size:13px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 6px 16px rgba(0,0,0,.06);
    }
    .btn.primary{ background:var(--brand); color:#fff; border-color:var(--brand); }

    /* N√∫t t√¥ m√†u */
    #btnCustomTime{ background:#6f42c1; color:#fff; border-color:#6f42c1; }
    #btnCustomTime:hover{ filter:brightness(.95); }
    #btnExcel{ background:#22c55e; color:#fff; border-color:#22c55e; }
    #btnExcel:hover{ filter:brightness(.95); }
    #btnPortrait{ background:#2563eb; color:#fff; border-color:#2563eb; }
    #btnPortrait:hover{ filter:brightness(.95); }
    #btnLandscape{ background:#8b5cf6; color:#fff; border-color:#8b5cf6; }
    #btnLandscape:hover{ filter:brightness(.95); }
    #btnDashboardSettings{ background:#f97316; color:#fff; border-color:#f97316; }
    #btnDashboardSettings:hover{ filter:brightness(.95); }
    #btnRefreshData{ background:#3b82f6; color:#fff; border-color:#3b82f6; }
    #btnRefreshData:hover{ filter:brightness(.95); }

    /* Content Area */
    .content-area {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: none;
    }

    .content-area.active {
      display: block;
    }

    .sheet{
      width:100%;
      min-height:calc(100vh - 56px);
      padding:20px 16px 24px;
      background:#f8fafc;
    }

    h1{
      margin:0 0 6px;
      text-align:center;
      font-size:22pt;
      line-height:1.25;
      font-weight:900;
      color:#0b1b23;
    }
    .subhead{
      text-align:center;
      font-size:12pt;
      color:var(--muted);
      margin-bottom:12px;
    }

    /* Map Container */
    .map-container {
      width: 100%;
      height: calc(100vh - 60px);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      page-break-inside: avoid;
      page-break-after: always;
    }

    .map-container iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* ===== H·ªÜ TH·ªêNG C·∫¢NH B√ÅO TH√îNG MINH ===== */
    .alert-system {
      margin-bottom: 24px;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      background: #fff;
      page-break-inside: avoid;
    }
    
    .alert-header {
      padding: 12px 16px;
      background: linear-gradient(135deg, #1EA48D 0%, #158572 100%);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .alert-header h2 {
      margin: 0;
      font-size: 16px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .alert-timestamp {
      font-size: 12px;
      opacity: 0.9;
    }
    
    .alert-content {
      padding: 16px;
    }
    
    .alert-status-container {
      display: flex;
      margin-bottom: 16px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .alert-status {
      flex: 1;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .alert-status.active {
      transform: scale(1.05);
      z-index: 2;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .alert-status.normal {
      background: linear-gradient(135deg, #e6f7ee 0%, #d4f1e4 100%);
      color: #166534;
    }
    
    .alert-status.monitor {
      background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
      color: #92400e;
    }
    
    .alert-status.danger {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      color: #b91c1c;
    }
    
    .alert-status.emergency {
      background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
      color: #7e22ce;
    }
    
    .alert-status i {
      font-size: 20px;
      margin-bottom: 4px;
      display: block;
    }
    
    .alert-status .status-title {
      font-weight: 700;
      font-size: 12px;
      margin-bottom: 2px;
    }
    
    .alert-status .status-value {
      font-size: 14px;
      font-weight: 800;
    }
    
    .alert-status .status-unit {
      font-size: 10px;
      font-weight: 400;
      opacity: 0.8;
    }
    
    .alert-message {
      padding: 12px;
      border-radius: 12px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 500;
      font-size: 14px;
      line-height: 1.5;
    }
    
    .alert-message.normal {
      background-color: rgba(34, 197, 94, 0.1);
      color: #166534;
      border-left: 4px solid var(--normal-color);
    }
    
    .alert-message.monitor {
      background-color: rgba(245, 158, 11, 0.1);
      color: #92400e;
      border-left: 4px solid var(--monitor-color);
    }
    
    .alert-message.danger {
      background-color: rgba(239, 68, 68, 0.1);
      color: #b91c1c;
      border-left: 4px solid var(--danger-color);
    }
    
    .alert-message.emergency {
      background-color: rgba(168, 85, 247, 0.1);
      color: #7e22ce;
      border-left: 4px solid var(--emergency-color);
    }
    
    .alert-message i {
      font-size: 20px;
    }
    
    .alert-visual {
      margin-bottom: 16px;
      position: relative;
      height: 100px;
      background: #f1f5f9;
      border-radius: 12px;
      overflow: hidden;
    }
    
    .water-level-visual {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 50%;
      background: linear-gradient(0deg, #0ea5e9 0%, #38bdf8 100%);
      transition: height 1s ease;
    }
    
    .level-markers {
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
    }
    
    .level-marker {
      position: absolute;
      left: 0;
      right: 0;
      height: 2px;
      display: flex;
      align-items: center;
    }
    
    .level-marker::before {
      content: '';
      position: absolute;
      left: 0;
      width: 16px;
      height: 2px;
    }
    
    .level-marker::after {
      content: attr(data-label);
      position: absolute;
      left: 24px;
      font-size: 11px;
      font-weight: 600;
      background: rgba(255,255,255,0.8);
      padding: 2px 6px;
      border-radius: 4px;
    }
    
    .level-marker.dead {
      bottom: 30%;
    }
    
    .level-marker.dead::before {
      background: #64748b;
    }
    
    .level-marker.normal {
      bottom: 50%;
    }
    
    .level-marker.normal::before {
      background: var(--normal-color);
    }
    
    .level-marker.danger {
      bottom: 70%;
    }
    
    .level-marker.danger::before {
      background: var(--danger-color);
    }
    
    .level-marker.emergency {
      bottom: 90%;
    }
    
    .level-marker.emergency::before {
      background: var(--emergency-color);
    }
    
    .current-level-indicator {
      position: absolute;
      left: 0;
      right: 0;
      height: 4px;
      background: #ff0000;
      z-index: 3;
      transition: bottom 1s ease;
      display: flex;
      justify-content: center;
    }
    
    .current-level-indicator::after {
      content: attr(data-label);
      position: absolute;
      top: -24px;
      background: #ff0000;
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
    }
    
    .alert-expandable {
      border-top: 1px solid #e5e7eb;
      padding-top: 12px;
      margin-top: 12px;
    }
    
    .expandable-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .expandable-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--ink);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .toggle-btn {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 6px;
      transition: all 0.2s;
    }
    
    .toggle-btn:hover {
      background: rgba(0,0,0,0.05);
      color: var(--ink);
    }
    
    .expandable-content {
      display: none;
    }
    
    .expandable-content.show {
      display: block;
    }
    
    .threshold-inputs {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .threshold-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .threshold-group label {
      font-weight: 600;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .threshold-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
    
    .indicator-normal {
      background-color: var(--normal-color);
    }
    
    .indicator-monitor {
      background-color: var(--monitor-color);
    }
    
    .indicator-danger {
      background-color: var(--danger-color);
    }
    
    .indicator-emergency {
      background-color: var(--emergency-color);
    }
    
    .threshold-group input {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    
    .threshold-group input:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(30,164,141,0.1);
    }
    
    .threshold-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    
    .threshold-actions button {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .btn-save {
      background-color: var(--brand);
      color: white;
    }
    
    .btn-save:hover {
      background-color: #158572;
    }
    
    .btn-reset {
      background-color: #64748b;
      color: white;
    }
    
    .btn-reset:hover {
      background-color: #475569;
    }
    
    .history-list {
      max-height: 200px;
      overflow-y: auto;
      background: #f8fafc;
      border-radius: 8px;
      padding: 12px;
    }
    
    .history-item {
      padding: 8px 12px;
      margin-bottom: 8px;
      border-radius: 6px;
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .history-item:last-child {
      margin-bottom: 0;
    }
    
    .history-item.normal {
      background-color: rgba(34, 197, 94, 0.1);
      color: #166534;
    }
    
    .history-item.monitor {
      background-color: rgba(245, 158, 11, 0.1);
      color: #92400e;
    }
    
    .history-item.danger {
      background-color: rgba(239, 68, 68, 0.1);
      color: #b91c1c;
    }
    
    .history-item.emergency {
      background-color: rgba(168, 85, 247, 0.1);
      color: #7e22ce;
    }
    
    .history-time {
      font-size: 12px;
      opacity: 0.7;
    }

    /* ===== PH√ÇN T√çCH AI ===== */
    .ai-analysis {
      margin-bottom: 24px;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      background: #fff;
      page-break-inside: avoid;
    }
    
    .ai-header {
      padding: 12px 16px;
      background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .ai-header h2 {
      margin: 0;
      font-size: 16px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .ai-timestamp {
      font-size: 12px;
      opacity: 0.9;
    }
    
    .ai-content {
      padding: 16px;
    }
    
    .ai-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .ai-tab {
      padding: 8px 16px;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      font-weight: 600;
      color: var(--muted);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .ai-tab.active {
      color: var(--ink);
      border-bottom-color: #6366f1;
    }
    
    .ai-tab:hover {
      color: var(--ink);
    }
    
    .ai-tab-content {
      display: none;
    }
    
    .ai-tab-content.active {
      display: block;
    }
    
    .ai-insight {
      background: #f8fafc;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 16px;
      border-left: 4px solid #6366f1;
    }
    
    .ai-insight-title {
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .ai-insight-content {
      font-size: 14px;
      line-height: 1.5;
    }
    
    .ai-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .ai-metric {
      background: #f8fafc;
      border-radius: 12px;
      padding: 12px;
      text-align: center;
    }
    
    .ai-metric-value {
      font-size: 24px;
      font-weight: 800;
      margin-bottom: 4px;
    }
    
    .ai-metric-label {
      font-size: 12px;
      color: var(--muted);
    }
    
    .ai-chart-container {
      height: 200px;
      margin-bottom: 16px;
    }
    
    .ai-recommendation {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 16px;
      border-left: 4px solid #0ea5e9;
    }
    
    .ai-recommendation-title {
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .ai-recommendation-content {
      font-size: 14px;
      line-height: 1.5;
    }
    
    .ai-prediction {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 16px;
      border-left: 4px solid #f59e0b;
    }
    
    .ai-prediction-title {
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .ai-prediction-content {
      font-size: 14px;
      line-height: 1.5;
    }

    /* Filters */
    .filters{
      display:flex;
      flex-wrap:wrap;
      gap:10px 14px;
      align-items:center;
      border:1px solid var(--brand);
      border-radius:12px;
      padding:10px 12px;
      background:#f5fffb;
      margin-bottom:12px;
      font-size:13px;
    }
    .filters .label{ font-weight:700; color:#0b1b23; }
    .filters select{
      appearance:none;
      padding:6px 10px;
      border:1px solid var(--brand);
      border-radius:10px;
      background:#fff;
      min-width:120px;
      font-weight:600;
      color:#0b1b23;
      font-size:13px;
    }

    /* Custom Time Panel */
    .custom-time-panel{
      display:none;
      padding:16px;
      background:#f8f9fa;
      border:1px solid #e5e7eb;
      border-radius:10px;
      margin-bottom:10px;
      font-size:13px;
    }
    .custom-time-panel .time-inputs{
      display:flex;
      gap:20px;
      align-items:flex-end;
      flex-wrap:wrap;
    }
    .custom-time-panel .input-group{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .custom-time-panel label{
      font-weight:bold;
      font-size:12px;
    }
    .custom-time-panel input{
      padding:6px 8px;
      border:1px solid #d1d5db;
      border-radius:8px;
      font-size:13px;
    }
    .custom-time-panel button{
      padding:8px 16px;
      border:none;
      border-radius:8px;
      cursor:pointer;
      font-weight:bold;
      font-size:13px;
    }
    #btnApplyCustom{ background:#1EA48D; color:#fff; }
    #btnClearCustom{ background:#6c757d; color:#fff; }

    /* KPI */
    .kpis{
      display:grid;
      gap:12px;
      grid-template-columns: repeat(6, minmax(140px,1fr));
      margin:12px 0 14px;
    }
    .kpi{
      border:1px solid #e5e7eb;
      border-radius:14px;
      padding:12px 12px 10px;
      background:#fff;
      position:relative;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
    }
    .kpi-icon{
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      margin-bottom: 8px;
      font-size: 24px; /* K√≠ch th∆∞·ªõc c·ªßa emoji */
    }
    .kpi .t{
      font-size:12px;
      color:#475569;
      margin-bottom:6px;
      font-weight:600;
    }
    .kpi .v{
      font-size:22px;
      font-weight:800;
      color:#0b1b23;
    }
    .kpi .s{
      font-size:12px;
      color:#64748b;
    }

    /* KPI pastel */
    .kpis .kpi{ border:1px solid transparent; }
    .kpis .kpi::after{
      content:"";
      position:absolute;
      left:0; right:0; bottom:0;
      height:6px;
    }
    .kpis .kpi:nth-child(1){ background:#EAFBF2; border-color:#BFEED7; }
    .kpis .kpi:nth-child(1)::after{ background:#22c55e; }
    .kpis .kpi:nth-child(2){ background:#ECF3FF; border-color:#D4E2FF; }
    .kpis .kpi:nth-child(2)::after{ background:#3b82f6; }
    .kpis .kpi:nth-child(3){ background:#FFEAF4; border-color:#FFD1E6; }
    .kpis .kpi:nth-child(3)::after{ background:#6366f1; }
    .kpis .kpi:nth-child(4){ background:#EAFDFF; border-color:#CFF6FA; }
    .kpis .kpi:nth-child(4)::after{ background:#06b6d4; }
    .kpis .kpi:nth-child(5){ background:#FFF4E6; border-color:#FFE0B2; }
    .kpis .kpi:nth-child(5)::after{ background:#ff9800; }
    .kpis .kpi:nth-child(6){ background:#F3E5F5; border-color:#E1BEE7; }
    .kpis .kpi:nth-child(6)::after{ background:#9c27b0; }

    /* Charts ‚Äì 1 chart full width */
    .charts{
      display:grid;
      grid-template-columns:minmax(0,1fr);
      gap:16px;
      margin-bottom:14px;
      align-items:stretch;
    }
    .card{
      border:1px solid var(--brand);
      border-radius:14px;
      background:#fff;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .card-header{
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      align-items:center;
      gap:4px;
      text-align:center;
    }
    .card h3{
      margin:0 0 2px;
      font-size:14pt;
      color:#0b1b23;
    }
    .chart-legend-hint{
      font-size:11px;
      color:#0f172a;
      white-space:normal;
      margin-top:4px;
      text-align:center;
    }
    #waterStatus{
      margin:0;
      font-weight:600;
      font-size:12px;
      color:#0f172a;
    }
    .chart-box{
      position:relative;
      height: clamp(260px, 34vh, 380px);
    }
    .chart-box canvas{
      position:absolute;
      inset:0;
      width:100% !important;
      height:100% !important;
    }

    /* B·∫£ng */
    .table-wrap{
      border-radius:14px;
      overflow:hidden;
    }
    table{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
      font-size:11pt;
      background:#fff;
      border:2px solid #1EA48D;
    }
    thead th{
      background:#1EA48D;
      color:#000;
      font-weight:800;
      padding:10px 8px;
      border:1px solid #fff;
    }
    tbody td{
      padding:8px 8px;
      text-align:center;
      vertical-align:middle;
      border:1px solid #e5e7eb;
    }
    tbody tr:nth-child(even){ background:#fcfffe; }
    tbody tr:hover{ background:#f2fbf8; }
    .state{
      text-align:center;
      padding:24px;
      color:#64748b;
      font-style:italic;
    }

    th.col-ngay, td.col-ngay{ white-space:nowrap; }
    th.col-gio,  td.col-gio { white-space:nowrap; }

    /* Ph√¢n trang thu g·ªçn */
    .pager{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      justify-content:center;
      margin:14px 0 4px;
      align-items:center;
      font-size:12px;
    }
    .page-btn{
      min-width:34px;
      padding:4px 8px;
      border:1px solid #cbd5e1;
      background:#fff;
      border-radius:10px;
      font-weight:700;
      color:#0b1b23;
      cursor:pointer;
      font-size:12px;
    }
    .page-btn:hover{
      border-color:var(--brand);
      box-shadow:0 2px 8px rgba(0,0,0,.06);
    }
    .page-btn.active{
      background:var(--brand);
      color:#fff;
      border-color:var(--brand);
    }
    .page-btn[disabled]{
      opacity:0.4;
      cursor:not-allowed;
      box-shadow:none;
    }
    .page-ellipsis{
      padding:0 4px;
      color:#94a3b8;
    }
    .pager-info{
      margin-left:4px;
      color:#64748b;
    }
    
    /* Modal for Dashboard Settings */
    .modal {
      display: none; /* Hidden by default */
      position: fixed; /* Stay in place */
      z-index: 1000; /* Sit on top */
      left: 0;
      top: 0;
      width: 100%; /* Full width */
      height: 100%; /* Full height */
      overflow: auto; /* Enable scroll if needed */
      background-color: rgb(0,0,0); /* Fallback color */
      background-color: rgba(0,0,0,0.5); /* Black w/ opacity */
    }
    .modal-content {
      background-color: #fefefe;
      margin: 10% auto; /* 10% from the top and centered */
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 500px;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }
    .modal-header h2 {
      margin: 0;
      font-size: 1.5rem;
      color: var(--ink);
    }
    .close-btn {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      line-height: 20px;
    }
    .close-btn:hover,
    .close-btn:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }
    .checkbox-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
    }
    .checkbox-group label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      cursor: pointer;
    }
    .checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    .modal-body h3 {
      margin-top: 20px;
      margin-bottom: 10px;
      font-size: 1.1rem;
      color: var(--ink);
    }

    /* ===== PRINT - QUAN TR·ªåNG NH·∫§T ===== */
    @media print{
      /* ·∫®n c√°c ph·∫ßn t·ª≠ kh√¥ng c·∫ßn in */
      .toolbar,
      .filters,
      .charts,
      .kpis,
      .pager,
      .custom-time-panel,
      .modal,
      .alert-system,
      .ai-analysis,
      .sidebar,
      .menu-toggle,
      .toast-container,
      .loading-overlay,
      .data-update-indicator {
        display:none !important;
      }
      
      /* S·ª¨A L·ªñI CH√çNH: Cho ph√©p cu·ªôn khi in */
      body {
        overflow: visible !important;
        height: auto !important;
      }
      
      /* X√≥a gi·ªõi h·∫°n chi·ªÅu cao c·ªßa main-content */
      .main-content {
        margin-left: 0 !important;
        overflow: visible !important;
        height: auto !important;
        display: block !important;
      }
      
      /* X√≥a gi·ªõi h·∫°n chi·ªÅu cao c·ªßa content-area */
      .content-area {
        
        overflow: visible !important;
        height: auto !important;
        padding: 10px !important;
      }
      
      /* Cho ph√©p sheet c√≥ chi·ªÅu cao t·ª± ƒë·ªông */
      .sheet {
        min-height: auto !important;
        height: auto !important;
        padding: 10px !important;
      }
      
      /* ƒê·∫£m b·∫£o b·∫£n ƒë·ªì kh√¥ng b·ªã c·∫Øt v√† chi·∫øm c·∫£ trang ƒë·∫ßu ti√™n */
      .map-container {
        height: auto !important;
        min-height: 70vh !important;
        page-break-inside: avoid !important;
        page-break-after: always !important;
        margin-bottom: 20px !important;
      }
      
      /* ƒê·ªãnh d·∫°ng b·∫£ng khi in */
      table{ 
        border:1.2px solid #000 !important;
        page-break-inside: auto;
      }
      thead th, tbody td{
        border:1px solid #000 !important;
        padding:4px 6px !important;
        word-wrap:break-word;
        white-space:normal !important;
        font-size: 10pt !important;
      }
      thead th{
        background:#fff !important;
        color:#000 !important;
        font-weight:800 !important;
      }
      th.col-ngay, td.col-ngay,
      th.col-gio,  td.col-gio{
        white-space:nowrap !important;
      }
      tr{
        page-break-inside:avoid;
        page-break-after:auto;
      }
      col.cw-day  { width:28mm; }
      col.cw-time { width:18mm; }
    }

    /* width c·ªôt tr√™n m√†n h√¨nh */
    col.cw-day  { width:120px; }
    col.cw-time { width:80px; }

    @media (min-width:1400px){
      .sheet{ padding-left:40px; padding-right:40px; }
    }

    @media (max-width:1024px){
      .kpis{
        grid-template-columns:repeat(3,minmax(0,1fr));
      }
    }
    @media (max-width:768px){
      .kpis{
        grid-template-columns:repeat(2,minmax(0,1fr));
      }
      .toolbar{
        justify-content:flex-start;
      }
      .chart-legend-hint{
        white-space:normal;
        text-align:center;
      }
      .threshold-inputs {
        grid-template-columns: 1fr;
      }
      .alert-status-container {
        flex-direction: column;
      }
      .alert-status {
        margin-bottom: 2px;
      }
      .ai-metrics {
        grid-template-columns: 1fr;
      }
      
      /* Responsive sidebar */
      .sidebar {
        transform: translateX(-100%);
      }
      
      .sidebar.open {
        transform: translateX(0);
      }
      
      .main-content {
        margin-left: 0;
      }
      
      .menu-toggle {
        display: block;
        position: fixed;
        top: 15px;
        left: 15px;
        z-index: 101;
        background: var(--brand);
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        font-size: 18px;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      }
    }
    
    @media (min-width:769px) {
      .menu-toggle {
        display: none;
      }
    }
  </style>
</head>
<body>
  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay" style="display: none;">
    <div class="loading-spinner"></div>
    <div class="loading-text" id="loadingText">ƒêang t·∫£i d·ªØ li·ªáu...</div>
    <div class="loading-progress">
      <div class="loading-progress-bar" id="loadingProgressBar" style="width: 0%"></div>
    </div>
  </div>

  <!-- Data Update Indicator -->
  <div class="data-update-indicator" id="dataUpdateIndicator">
    <i class="fas fa-sync-alt"></i>
    <span id="dataUpdateText">ƒêang c·∫≠p nh·∫≠t d·ªØ li·ªáu m·ªõi...</span>
  </div>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <i class="fas fa-water"></i>
      <h1>H·ªá th·ªëng quan tr·∫Øc</h1>
    </div>
    
    <div class="sidebar-menu">
      <div class="menu-item active" data-content="station">
        <i class="fas fa-map-marked-alt"></i>
        <span class="menu-text">Tr·∫°m ƒëo</span>
      </div>
      
      <div class="menu-item" data-content="monitoring">
        <i class="fas fa-chart-line"></i>
        <span class="menu-text">D·ªØ li·ªáu quan tr·∫Øc</span>
      </div>
      
      <div class="menu-item" data-content="analysis">
        <i class="fas fa-brain"></i>
        <span class="menu-text">C·∫£nh b√°o v√† ph√¢n t√≠ch</span>
      </div>
    </div>
  </div>
  
  <!-- Menu Toggle Button for Mobile -->
  <button class="menu-toggle" id="menuToggle">
    <i class="fas fa-bars"></i>
  </button>
  
  <!-- Main Content -->
  <div class="main-content">
    <!-- Toolbar -->
    <div class="toolbar">
      <div class="brand"><span class="dot"></span>H·ªá th·ªëng quan tr·∫Øc h·ªì ch·ª©a n∆∞·ªõc ng·ªçt</div>
      <div class="spacer"></div>
      <button class="btn" id="btnRefreshData"><i class="fas fa-sync-alt"></i> L√†m m·ªõi d·ªØ li·ªáu</button>
      <button class="btn" id="btnCustomTime"><i class="fas fa-clock"></i> Th·ªùi gian t√πy ch·ªânh</button>
      <button class="btn" id="btnExcel"><i class="fas fa-file-excel"></i> Xu·∫•t Excel</button>
      <button class="btn" id="btnPortrait"><i class="fas fa-file-alt"></i> In d·ªçc</button>
      <button class="btn" id="btnLandscape"><i class="fas fa-file-image"></i> In ngang</button>
      <button class="btn" id="btnDashboardSettings"><i class="fas fa-cog"></i> Setting</button>
    </div>
    
    <!-- Content Areas -->
    <div class="content-area active" id="station-content">
      <div class="map-container">
        <iframe src="https://thuan84.github.io/codehtml/tramdomua.html" title="B·∫£n ƒë·ªì tr·∫°m ƒëo"></iframe>
      </div>
    </div>
    
    <div class="content-area" id="monitoring-content">
      <div class="sheet">
        <h1>NH·∫¨T K√ù V·∫¨N H√ÄNH H·ªí CH·ª®A N∆Ø·ªöC NG·ªåT</h1>
        <div class="subhead" id="subTitle">Th√°ng ‚Ä¶/‚Ä¶</div>

        <!-- Filters -->
        <div class="filters">
          <span class="label">B·ªô l·ªçc:</span>
          <label for="yearSel">NƒÉm</label>
          <select id="yearSel"><option value="all">T·∫•t c·∫£</option></select>

          <label for="quarterSel">Qu√Ω</label>
          <select id="quarterSel">
            <option value="all">T·∫•t c·∫£</option>
            <option value="1">Qu√Ω 1</option>
            <option value="2">Qu√Ω 2</option>
            <option value="3">Qu√Ω 3</option>
            <option value="4">Qu√Ω 4</option>
          </select>

          <label for="monthSel">Th√°ng</label>
          <select id="monthSel">
            <option value="all">T·∫•t c·∫£</option>
            <script>for(let i=1;i<=12;i++) document.write(`<option value="${i}">Th√°ng ${i}</option>`);</script>
          </select>

          <label for="weekSel">Tu·∫ßn</label>
          <select id="weekSel">
            <option value="all">T·∫•t c·∫£</option>
          </select>

          <label for="dayNightSel">Ng√†y/ƒê√™m</label>
          <select id="dayNightSel">
            <option value="all">T·∫•t c·∫£</option>
            <option value="day">Ng√†y (7h-19h)</option>
            <option value="night">ƒê√™m (19h-7h)</option>
          </select>
        </div>

        <!-- Custom Time Panel -->
        <div class="custom-time-panel" id="customTimePanel">
          <div class="time-inputs">
            <div class="input-group">
              <label>T·ª´ ng√†y:</label>
              <input type="date" id="customFromDate">
            </div>
            <div class="input-group">
              <label>Gi·ªù:ph√∫t:gi√¢y</label>
              <input type="time" id="customFromTime" step="1" value="00:00:00">
            </div>
            <div class="input-group">
              <label>ƒê·∫øn ng√†y:</label>
              <input type="date" id="customToDate">
            </div>
            <div class="input-group">
              <label>Gi·ªù:ph√∫t:gi√¢y</label>
              <input type="time" id="customToTime" step="1" value="23:59:59">
            </div>
            <button id="btnApplyCustom">√Åp d·ª•ng</button>
            <button id="btnClearCustom">X√≥a</button>
          </div>
        </div>

        <!-- KPI: 6 √¥ -->
        <div class="kpis" id="kpisContainer">
            <div class="kpi" data-kpi-id="kpi_current_level">
                <span class="kpi-icon">üíß</span>
                <div class="t">M·ª±c n∆∞·ªõc hi·ªán t·∫°i (m)</div>
                <div class="v" id="kpiCurrentLevel">0</div>
            </div>
            <div class="kpi" data-kpi-id="kpi_current_volume">
                <span class="kpi-icon">üèûÔ∏è</span>
                <div class="t">Dung t√≠ch hi·ªán t·∫°i (Tri·ªáu m¬≥)</div>
                <div class="v" id="kpiCurrentVolume">0</div>
            </div>
            <div class="kpi" data-kpi-id="kpi_total_rain">
            <span class="kpi-icon">üí¶</span>
            <div class="t">T·ªïng l∆∞·ª£ng m∆∞a (k·ª≥ l·ªçc) (mm)</div>
            <div class="v" id="kpiTotalRain">0</div>
          </div>
          <div class="kpi" data-kpi-id="kpi_max_level">
            <span class="kpi-icon">‚ôí</span>
            <div class="t">M·ª±c n∆∞·ªõc l·ªõn nh·∫•t (m)</div>
            <div class="v" id="kpiMaxLevel">0</div>
          </div>
          <div class="kpi" data-kpi-id="kpi_max_rain">
            <span class="kpi-icon">‚õàÔ∏è</span>
            <div class="t">M∆∞a l·ªõn nh·∫•t (mm)</div>
            <div class="v">
              <span id="kpiMaxRain">0</span>
              <span class="s" id="kpiMaxRainDay"></span>
            </div>
          </div>
          <div class="kpi" data-kpi-id="kpi_max_q">
            <span class="kpi-icon">üåä</span>
            <div class="t">Q l·ªõn nh·∫•t (m¬≥/s)</div>
            <div class="v"><span id="kpiMaxQ">0</span></div>
          </div>
          
        </div>

        <!-- Chart g·ªôp m∆∞a + m·ª±c n∆∞·ªõc -->
        <div class="charts" id="chartsContainer">
          <div class="card">
            <div class="card-header">
              <h3>L∆∞·ª£ng m∆∞a &amp; m·ª±c n∆∞·ªõc theo ng√†y ‚Äì v√πng c·∫£nh b√°o m·ª±c n∆∞·ªõc</h3>
              <div id="waterStatus"></div>
              <div class="chart-legend-hint">
                üü¢ an to√†n ¬∑ üü° theo d√µi ¬∑ üü† c·∫£nh b√°o ¬∑ üî¥ nguy hi·ªÉm<br>
                ‚ïå MN ch·∫øt 50.6 m ¬∑ ‚ïå MN d√¢ng BT 58.78 m ¬∑ ‚ïå MN d√¢ng GC 60.76 m
              </div>
            </div>
            <div class="chart-box"><canvas id="comboChart"></canvas></div>
          </div>
        </div>

        <!-- B·∫£ng -->
        <div class="table-wrap">
          <table id="grid">
            <colgroup><col class="cw-day"><col class="cw-time"></colgroup>
            <thead>
              <tr>
                <th class="col-ngay" rowspan="2">Ng√†y</th>
                <th class="col-gio"  rowspan="2">Gi·ªù</th>
                <th rowspan="2">M·ª±c n∆∞·ªõc<br>(m)</th>
                <th rowspan="2">Dung t√≠ch<br>(Tri·ªáu m¬≥)</th>
                <th rowspan="2">L∆∞·ª£ng m∆∞a<br>(mm)</th>
                <th colspan="2">Th√¥ng s·ªë v·∫≠n h√†nh tr√†n t·ª± do</th>
                <th colspan="4">Th√¥ng s·ªë v·∫≠n h√†nh tr√†n s·ª± c·ªë</th>
                <th colspan="3">Th√¥ng s·ªë v·∫≠n h√†nh c·ªëng l·∫•y n∆∞·ªõc</th>
                <th rowspan="2" style="min-width:180px">H·ªç, t√™n ng∆∞·ªùi v·∫≠n h√†nh</th>
                <th rowspan="2" style="min-width:140px">Ch·ªØ k√Ω</th>
              </tr>
              <tr>
                <th>H tr√†n<br>(cm)</th>
                <th>Q tr√†n t·ª± do<br>(m¬≥/s)</th>
                <th>a1<br>(cm)</th>
                <th>a2<br>(cm)</th>
                <th>a3<br>(cm)</th>
                <th>Q tr√†n s·ª± c·ªë<br>(m¬≥/s)</th>
                <th>a<br>(cm)</th>
                <th>C·ªôt n∆∞·ªõc ƒë·∫ßu k√™nh<br>(m)</th>
                <th>Q c·ªëng<br>(m¬≥/s)</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <tr><td class="state" colspan="16">ƒêang t·∫£i d·ªØ li·ªáu‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Ph√¢n trang -->
        <div id="pager" class="pager"></div>
      </div>
    </div>
    
    <div class="content-area" id="analysis-content">
      <div class="sheet">
        <!-- H·ªá th·ªëng c·∫£nh b√°o th√¥ng minh -->
        <div class="alert-system">
          <div class="alert-header">
            <h2><i class="fas fa-exclamation-triangle"></i> H·ªá th·ªëng c·∫£nh b√°o th√¥ng minh</h2>
            <div class="alert-timestamp" id="alertTimestamp">C·∫≠p nh·∫≠t: --:--:-- --/--/----</div>
          </div>
          
          <div class="alert-content">
            <!-- Tr·∫°ng th√°i c·∫£nh b√°o -->
            <div class="alert-status-container">
              <div class="alert-status normal" data-status="normal">
                <i class="fas fa-check-circle"></i>
                <div class="status-title">B√¨nh th∆∞·ªùng</div>
                <div class="status-value"><span id="normalValue">56.5</span> <span class="status-unit">m</span></div>
              </div>
              <div class="alert-status monitor active" data-status="monitor">
                <i class="fas fa-eye"></i>
                <div class="status-title">Theo d√µi</div>
                <div class="status-value"><span id="monitorValue">58.78</span> <span class="status-unit">m</span></div>
              </div>
              <div class="alert-status danger" data-status="danger">
                <i class="fas fa-exclamation-triangle"></i>
                <div class="status-title">Nguy hi·ªÉm</div>
                <div class="status-value"><span id="dangerValue">60.3</span> <span class="status-unit">m</span></div>
              </div>
              <div class="alert-status emergency" data-status="emergency">
                <i class="fas fa-bell"></i>
                <div class="status-title">Kh·∫©n c·∫•p</div>
                <div class="status-value"><span id="emergencyValue">60.76</span> <span class="status-unit">m</span></div>
              </div>
            </div>
            
            <!-- Th√¥ng b√°o c·∫£nh b√°o -->
            <div class="alert-message normal" id="alertMessage">
              <i class="fas fa-info-circle"></i>
              <span id="alertText">M·ª±c n∆∞·ªõc (56,65 m) trong ng∆∞·ª°ng an to√†n (56,5 m). Ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng.</span>
            </div>
            
            <!-- Tr·ª±c quan h√≥a m·ª±c n∆∞·ªõc -->
            <div class="alert-visual">
              <div class="water-level-visual" id="waterLevelVisual"></div>
              <div class="level-markers">
                <div class="level-marker dead" data-label="M·ª±c n∆∞·ªõc ch·∫øt: 50.6 m"></div>
                <div class="level-marker normal" data-label="MN d√¢ng b√¨nh th∆∞·ªùng: 58.78 m"></div>
                <div class="level-marker danger" data-label="MN d√¢ng gia c∆∞·ªùng: 60.76 m"></div>
              </div>
              <div class="current-level-indicator" id="currentLevelIndicator" data-label="56.65 m"></div>
            </div>
            
            <!-- C√†i ƒë·∫∑t ng∆∞·ª°ng c·∫£nh b√°o (·∫©n/hi·ªán) -->
            <div class="alert-expandable">
              <div class="expandable-header">
                <div class="expandable-title">
                  <i class="fas fa-sliders-h"></i> C√†i ƒë·∫∑t ng∆∞·ª°ng c·∫£nh b√°o (m)
                </div>
                <button class="toggle-btn" id="toggleSettings">
                  <i class="fas fa-chevron-down"></i> Hi·ªán
                </button>
              </div>
              <div class="expandable-content" id="settingsContent">
                <div class="threshold-inputs">
                  <div class="threshold-group">
                    <label>
                      <span class="threshold-indicator indicator-normal"></span>
                      B√¨nh th∆∞·ªùng
                    </label>
                    <input type="number" id="normalThreshold" step="0.01" value="56.5">
                  </div>
                  <div class="threshold-group">
                    <label>
                      <span class="threshold-indicator indicator-monitor"></span>
                      Theo d√µi (MN d√¢ng BT)
                    </label>
                    <input type="number" id="monitorThreshold" step="0.01" value="58.78">
                  </div>
                  <div class="threshold-group">
                    <label>
                      <span class="threshold-indicator indicator-danger"></span>
                      Nguy hi·ªÉm
                    </label>
                    <input type="number" id="dangerThreshold" step="0.01" value="60.3">
                  </div>
                  <div class="threshold-group">
                    <label>
                      <span class="threshold-indicator indicator-emergency"></span>
                      Kh·∫©n c·∫•p (MN d√¢ng GC)
                    </label>
                    <input type="number" id="emergencyThreshold" step="0.01" value="60.76">
                  </div>
                </div>
                <div class="threshold-actions">
                  <button class="btn-reset" id="resetThresholds"><i class="fas fa-undo"></i> ƒê·∫∑t l·∫°i m·∫∑c ƒë·ªãnh</button>
                  <button class="btn-save" id="saveThresholds"><i class="fas fa-save"></i> L∆∞u c√†i ƒë·∫∑t</button>
                </div>
              </div>
            </div>
            
            <!-- L·ªãch s·ª≠ c·∫£nh b√°o (·∫©n/hi·ªán) -->
            <div class="alert-expandable">
              <div class="expandable-header">
                <div class="expandable-title">
                  <i class="fas fa-history"></i> L·ªãch s·ª≠ c·∫£nh b√°o
                </div>
                <button class="toggle-btn" id="toggleHistory">
                  <i class="fas fa-chevron-down"></i> Hi·ªán
                </button>
              </div>
              <div class="expandable-content" id="historyContent">
                <div class="history-list" id="historyList">
                  <div class="history-item normal">
                    <span>M·ª±c n∆∞·ªõc (56,65 m) trong ng∆∞·ª°ng an to√†n (56,5 m)</span>
                    <span class="history-time">10:30:25 15/06/2023</span>
                  </div>
                  <div class="history-item monitor">
                    <span>M·ª±c n∆∞·ªõc (58,90 m) ƒë√£ v∆∞·ª£t ng∆∞·ª°ng theo d√µi (58,78 m)</span>
                    <span class="history-time">09:15:10 15/06/2023</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Ph√¢n t√≠ch AI -->
        <div class="ai-analysis" id="aiAnalysis">
          <div class="ai-header">
            <h2><i class="fas fa-brain"></i> Ph√¢n t√≠ch AI</h2>
            <div class="ai-timestamp" id="aiTimestamp">C·∫≠p nh·∫≠t: --:--:-- --/--/----</div>
          </div>
          
          <div class="ai-content">
            <div class="ai-tabs">
              <button class="ai-tab active" data-tab="trend">Xu h∆∞·ªõng</button>
              <button class="ai-tab" data-tab="prediction">D·ª± b√°o</button>
              <button class="ai-tab" data-tab="recommendation">ƒê·ªÅ xu·∫•t</button>
              <button class="ai-tab" data-tab="pattern">Ph√¢n t√≠ch m·∫´u</button>
            </div>
            
            <div class="ai-tab-content active" id="trend-tab">
              <div class="ai-insight">
                <div class="ai-insight-title">
                  <i class="fas fa-chart-line"></i> Xu h∆∞·ªõng m·ª±c n∆∞·ªõc
                </div>
                <div class="ai-insight-content" id="waterLevelTrend">
                  ƒêang ph√¢n t√≠ch xu h∆∞·ªõng m·ª±c n∆∞·ªõc...
                </div>
              </div>
              
              <div class="ai-metrics">
                <div class="ai-metric">
                  <div class="ai-metric-value" id="trendDirection">--</div>
                  <div class="ai-metric-label">Xu h∆∞·ªõng</div>
                </div>
                <div class="ai-metric">
                  <div class="ai-metric-value" id="trendRate">--</div>
                  <div class="ai-metric-label">T·ªëc ƒë·ªô thay ƒë·ªïi (m/ng√†y)</div>
                </div>
                <div class="ai-metric">
                  <div class="ai-metric-value" id="trendConsistency">--</div>
                  <div class="ai-metric-label">ƒê·ªô ·ªïn ƒë·ªãnh (%)</div>
                </div>
              </div>
              
              <div class="ai-chart-container">
                <canvas id="trendChart"></canvas>
              </div>
            </div>
            
            <div class="ai-tab-content" id="prediction-tab">
              <div class="ai-prediction">
                <div class="ai-prediction-title">
                  <i class="fas fa-crystal-ball"></i> D·ª± b√°o m·ª±c n∆∞·ªõc 7 ng√†y t·ªõi
                </div>
                <div class="ai-prediction-content" id="waterLevelPrediction">
                  ƒêang ph√¢n t√≠ch d·ªØ li·ªáu l·ªãch s·ª≠ ƒë·ªÉ ƒë∆∞a ra d·ª± b√°o...
                </div>
              </div>
              
              <div class="ai-metrics">
                <div class="ai-metric">
                  <div class="ai-metric-value" id="predictionMin">--</div>
                  <div class="ai-metric-label">D·ª± b√°o th·∫•p nh·∫•t (m)</div>
                </div>
                <div class="ai-metric">
                  <div class="ai-metric-value" id="predictionMax">--</div>
                  <div class="ai-metric-label">D·ª± b√°o cao nh·∫•t (m)</div>
                </div>
                <div class="ai-metric">
                  <div class="ai-metric-value" id="predictionRisk">--</div>
                  <div class="ai-metric-label">R·ªßi ro v∆∞·ª£t ng∆∞·ª°ng</div>
                </div>
              </div>
              
              <div class="ai-chart-container">
                <canvas id="predictionChart"></canvas>
              </div>
            </div>
            
            <div class="ai-tab-content" id="recommendation-tab">
              <div class="ai-recommendation">
                <div class="ai-recommendation-title">
                  <i class="fas fa-lightbulb"></i> ƒê·ªÅ xu·∫•t v·∫≠n h√†nh
                </div>
                <div class="ai-recommendation-content" id="operationRecommendation">
                  ƒêang ph√¢n t√≠ch d·ªØ li·ªáu ƒë·ªÉ ƒë∆∞a ra ƒë·ªÅ xu·∫•t v·∫≠n h√†nh...
                </div>
              </div>
              
              <div class="ai-insight">
                <div class="ai-insight-title">
                  <i class="fas fa-tint"></i> Khuy·∫øn ngh·ªã x·∫£ n∆∞·ªõc
                </div>
                <div class="ai-insight-content" id="dischargeRecommendation">
                  ƒêang ph√¢n t√≠ch d·ªØ li·ªáu ƒë·ªÉ ƒë∆∞a ra khuy·∫øn ngh·ªã x·∫£ n∆∞·ªõc...
                </div>
              </div>
              
              <div class="ai-insight">
                <div class="ai-insight-title">
                  <i class="fas fa-exclamation-circle"></i> C√°c ƒëi·ªÉm c·∫ßn ch√∫ √Ω
                </div>
                <div class="ai-insight-content" id="attentionPoints">
                  ƒêang ph√¢n t√≠ch d·ªØ li·ªáu ƒë·ªÉ x√°c ƒë·ªãnh c√°c ƒëi·ªÉm c·∫ßn ch√∫ √Ω...
                </div>
              </div>
            </div>
            
            <div class="ai-tab-content" id="pattern-tab">
              <div class="ai-insight">
                <div class="ai-insight-title">
                  <i class="fas fa-cloud-rain"></i> Ph√¢n t√≠ch m·∫´u m∆∞a
                </div>
                <div class="ai-insight-content" id="rainPattern">
                  ƒêang ph√¢n t√≠ch m·∫´u l∆∞·ª£ng m∆∞a...
                </div>
              </div>
              
              <div class="ai-insight">
                <div class="ai-insight-title">
                  <i class="fas fa-water"></i> Ph√¢n t√≠ch m·∫´u m·ª±c n∆∞·ªõc theo m√πa
                </div>
                <div class="ai-insight-content" id="seasonalPattern">
                  ƒêang ph√¢n t√≠ch m·∫´u m·ª±c n∆∞·ªõc theo m√πa...
                </div>
              </div>
              
              <div class="ai-metrics">
                <div class="ai-metric">
                  <div class="ai-metric-value" id="rainCorrelation">--</div>
                  <div class="ai-metric-label">T∆∞∆°ng quan m∆∞a-m·ª±c n∆∞·ªõc</div>
                </div>
                <div class="ai-metric">
                  <div class="ai-metric-value" id="seasonalVariation">--</div>
                  <div class="ai-metric-label">Bi·∫øn ƒë·ªông theo m√πa (%)</div>
                </div>
              </div>
              
              <div class="ai-chart-container">
                <canvas id="patternChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Dashboard Settings Modal -->
  <div id="dashboardSettingsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>T√πy ch·ªânh Dashboard</h2>
        <span class="close-btn" id="closeSettingsModal">&times;</span>
      </div>
      <div class="modal-body">
        <h3>Ch·ªâ s·ªë hi·ªáu su·∫•t ch√≠nh (KPI)</h3>
        <div class="checkbox-group">
          <label><input type="checkbox" id="toggle_kpi_total_rain" checked> T·ªïng l∆∞·ª£ng m∆∞a</label>
          <label><input type="checkbox" id="toggle_kpi_max_level" checked> M·ª±c n∆∞·ªõc l·ªõn nh·∫•t</label>
          <label><input type="checkbox" id="toggle_kpi_max_rain" checked> M∆∞a l·ªõn nh·∫•t</label>
          <label><input type="checkbox" id="toggle_kpi_max_q" checked> Q l·ªõn nh·∫•t</label>
          <label><input type="checkbox" id="toggle_kpi_current_level" checked> M·ª±c n∆∞·ªõc hi·ªán t·∫°i</label>
          <label><input type="checkbox" id="toggle_kpi_current_volume" checked> Dung t√≠ch hi·ªán t·∫°i</label>
        </div>
        <h3>Bi·ªÉu ƒë·ªì</h3>
        <div class="checkbox-group">
          <label><input type="checkbox" id="toggle_chart" checked> Bi·ªÉu ƒë·ªì M∆∞a & M·ª±c n∆∞·ªõc</label>
        </div>
        <h3>H·ªá th·ªëng c·∫£nh b√°o</h3>
        <div class="checkbox-group">
          <label><input type="checkbox" id="toggle_alert_system" checked> H·ªá th·ªëng c·∫£nh b√°o th√¥ng minh</label>
        </div>
        <h3>Ph√¢n t√≠ch AI</h3>
        <div class="checkbox-group">
          <label><input type="checkbox" id="toggle_ai_analysis" checked> Ph√¢n t√≠ch AI</label>
        </div>
      </div>
    </div>
  </div>

  <script>
    const EXEC_URL = "https://script.google.com/macros/s/AKfycbxphwCkUk01I8TZ4LI_1bzEW1XdRPLLrGnbYGRkKbt8gJ-rmliZRzp_zoy0GpHhdSEv/exec";
    const API_URL  = `${EXEC_URL}?sheet=HoNuocNgot`;

    const printStyleEl = document.getElementById('printStyle');
    function setPage(size){
      printStyleEl.textContent = `@media print{ @page{ size:${size}; margin:8mm; } }`;
    }
    document.getElementById('btnPortrait').onclick  = () => { setPage('A4 portrait');  window.print(); };
    document.getElementById('btnLandscape').onclick = () => { setPage('A4 landscape'); window.print(); };
    setPage('A4 landscape'); // m·∫∑c ƒë·ªãnh

    const params   = new URLSearchParams(location.search);
    const subTitle = document.getElementById('subTitle');
    
    const yearSel    = document.getElementById('yearSel');
    const quarterSel = document.getElementById('quarterSel');
    const monthSel   = document.getElementById('monthSel');
    const weekSel    = document.getElementById('weekSel');
    const dayNightSel= document.getElementById('dayNightSel');
    const tbody      = document.getElementById('tbody');
    const pager      = document.getElementById('pager');

    // KPI DOM
    const kpiTotalRain   = document.getElementById('kpiTotalRain');
    const kpiMaxLevel    = document.getElementById('kpiMaxLevel');
    const kpiMaxRain     = document.getElementById('kpiMaxRain');
    const kpiMaxRainDay  = document.getElementById('kpiMaxRainDay');
    const kpiMaxQ        = document.getElementById('kpiMaxQ');
    const kpiCurrentLevel = document.getElementById('kpiCurrentLevel');
    const kpiCurrentVolume = document.getElementById('kpiCurrentVolume');
    const waterStatus    = document.getElementById('waterStatus');

    // Custom time
    const customTimePanel = document.getElementById('customTimePanel');
    const customFromDate  = document.getElementById('customFromDate');
    const customFromTime  = document.getElementById('customFromTime');
    const customToDate    = document.getElementById('customToDate');
    const customToTime    = document.getElementById('customToTime');
    const btnCustomTime   = document.getElementById('btnCustomTime');
    const btnApplyCustom  = document.getElementById('btnApplyCustom');
    const btnClearCustom  = document.getElementById('btnClearCustom');

    // Dashboard Settings
    const dashboardSettingsModal = document.getElementById('dashboardSettingsModal');
    const btnDashboardSettings = document.getElementById('btnDashboardSettings');
    const closeSettingsModal = document.getElementById('closeSettingsModal');
    const kpisContainer = document.getElementById('kpisContainer');
    const chartsContainer = document.getElementById('chartsContainer');
    const alertSystem = document.querySelector('.alert-system');
    const aiAnalysis = document.getElementById('aiAnalysis');

    // Alert System
    const alertStatuses = document.querySelectorAll('.alert-status');
    const alertMessage = document.getElementById('alertMessage');
    const alertText = document.getElementById('alertText');
    const alertTimestamp = document.getElementById('alertTimestamp');
    const normalThreshold = document.getElementById('normalThreshold');
    const monitorThreshold = document.getElementById('monitorThreshold');
    const dangerThreshold = document.getElementById('dangerThreshold');
    const emergencyThreshold = document.getElementById('emergencyThreshold');
    const saveThresholdsBtn = document.getElementById('saveThresholds');
    const resetThresholdsBtn = document.getElementById('resetThresholds');
    const historyList = document.getElementById('historyList');
    const waterLevelVisual = document.getElementById('waterLevelVisual');
    const currentLevelIndicator = document.getElementById('currentLevelIndicator');
    
    // Toggle buttons
    const toggleSettingsBtn = document.getElementById('toggleSettings');
    const toggleHistoryBtn = document.getElementById('toggleHistory');
    const settingsContent = document.getElementById('settingsContent');
    const historyContent = document.getElementById('historyContent');
    
    // Alert threshold values
    const normalValueEl = document.getElementById('normalValue');
    const monitorValueEl = document.getElementById('monitorValue');
    const dangerValueEl = document.getElementById('dangerValue');
    const emergencyValueEl = document.getElementById('emergencyValue');

    // AI Analysis
    const aiTimestamp = document.getElementById('aiTimestamp');
    const aiTabs = document.querySelectorAll('.ai-tab');
    const aiTabContents = document.querySelectorAll('.ai-tab-content');
    
    // AI Trend
    const waterLevelTrend = document.getElementById('waterLevelTrend');
    const trendDirection = document.getElementById('trendDirection');
    const trendRate = document.getElementById('trendRate');
    const trendConsistency = document.getElementById('trendConsistency');
    
    // AI Prediction
    const waterLevelPrediction = document.getElementById('waterLevelPrediction');
    const predictionMin = document.getElementById('predictionMin');
    const predictionMax = document.getElementById('predictionMax');
    const predictionRisk = document.getElementById('predictionRisk');
    
    // AI Recommendation
    const operationRecommendation = document.getElementById('operationRecommendation');
    const dischargeRecommendation = document.getElementById('dischargeRecommendation');
    const attentionPoints = document.getElementById('attentionPoints');
    
    // AI Pattern
    const rainPattern = document.getElementById('rainPattern');
    const seasonalPattern = document.getElementById('seasonalPattern');
    const rainCorrelation = document.getElementById('rainCorrelation');
    const seasonalVariation = document.getElementById('seasonalVariation');

    // Sidebar and content switching
    const menuItems = document.querySelectorAll('.menu-item');
    const contentAreas = document.querySelectorAll('.content-area');
    const menuToggle = document.getElementById('menuToggle');
    const sidebar = document.getElementById('sidebar');

    // Data Loading
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');
    const loadingProgressBar = document.getElementById('loadingProgressBar');
    const btnRefreshData = document.getElementById('btnRefreshData');
    const toastContainer = document.getElementById('toastContainer');
    
    // Data Update Indicator
    const dataUpdateIndicator = document.getElementById('dataUpdateIndicator');
    const dataUpdateText = document.getElementById('dataUpdateText');

    let customTimeRange = null;
    let currentAlertStatus = 'normal'; // M·∫∑c ƒë·ªãnh l√† 'normal'
    let currentWaterLevel = 56.65; // Gi√° tr·ªã m·∫∑c ƒë·ªãnh ƒë√£ c·∫≠p nh·∫≠t theo th·ª±c t·∫ø
    let alertHistory = []; // L∆∞u tr·ªØ l·ªãch s·ª≠ c·∫£nh b√°o

    const nf0=new Intl.NumberFormat('vi-VN',{maximumFractionDigits:0});
    const nf1=new Intl.NumberFormat('vi-VN',{maximumFractionDigits:1});
    const nf2=new Intl.NumberFormat('vi-VN',{maximumFractionDigits:2});
    const nf3=new Intl.NumberFormat('vi-VN',{maximumFractionDigits:3});

    let allData=[], filtered=[];
    let comboChart, trendChart, predictionChart, patternChart;

    /* c·∫•u h√¨nh ph√¢n trang */
    const ROWS_PER_PAGE = 30;
    let currentPage = 1, totalPages = 1;

    const cell=(v,num=false)=>(v==null||v==="")?"‚Äî":(num?nf3.format(Number(v)):v);
    const fmt2=n=>String(n).padStart(2,'0');
    
    function parseVNDateTime(s){
      if(!s||typeof s!=='string')return null;
      const[dpart,tpart='00:00']=s.split(' ');
      const[dd,mm,yyyy]=dpart.split('/').map(n=>parseInt(n,10));
      if(!dd||!mm||!yyyy)return null;
      const[HH='0',MM='0']=tpart.split(':').map(n=>parseInt(n,10));
      const date=new Date(yyyy,mm-1,dd,HH,MM);
      return Number.isNaN(date.getTime())?null:date;
    }
    const fmtDateVN=d=>`${fmt2(d.getDate())}/${fmt2(d.getMonth()+1)}/${d.getFullYear()}`;
    const fmtTimeVN=d=>`${fmt2(d.getHours())}:${fmt2(d.getMinutes())}`;
    const fmtDateTimeVN=d=>`${fmtDateVN(d)} ${fmtTimeVN(d)}`;

    function getWeekNumber(date) {
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
      const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1)/7);
      return weekNo;
    }
    
    function isDayTime(date) {
      const hour = date.getHours();
      return hour >= 7 && hour < 19;
    }
    
    function isNightTime(date) {
      const hour = date.getHours();
      return hour >= 19 || hour < 7;
    }

    function buildRowHTML(r){
      const dateText=r.__d?fmtDateVN(r.__d):(r.ngayGio?.split(' ')[0]||'‚Äî');
      const timeText=r.__d?fmtTimeVN(r.__d):(r.ngayGio?.split(' ')[1]||'‚Äî');
      return `
        <tr>
          <td class="col-ngay">${cell(dateText)}</td>
          <td class="col-gio">${cell(timeText)}</td>
          <td>${cell(r.mucNuoc,true)}</td>
          <td>${cell(r.dungTich,true)}</td>
          <td>${cell(r.luongMua,true)}</td>
          <td>${cell(r.hTran,true)}</td>
          <td>${cell(r.qTranTuDo,true)}</td>
          <td>${cell(r.a1,true)}</td>
          <td>${cell(r.a2,true)}</td>
          <td>${cell(r.a3,true)}</td>
          <td>${cell(r.qTranSuCo,true)}</td>
          <td>${cell(r.a,true)}</td>
          <td>${cell(r.cotNuocDauKenh,true)}</td>
          <td>${cell(r.qcong,true)}</td>
          <td class="text-left">${cell(r.nguoiVanHanh)}</td>
          <td class="text-left"></td>
        </tr>`;
    }

    function populateYears(list){
      const years=[...new Set(list.map(r=>r.__y).filter(Boolean))].sort((a,b)=>b-a);
      yearSel.innerHTML='<option value="all">T·∫•t c·∫£</option>';
      years.forEach(y=>{
        const op=document.createElement('option');
        op.value=String(y);
        op.textContent=`NƒÉm ${y}`;
        yearSel.appendChild(op);
      });
    }

    function populateWeeks(list) {
      const weeks = new Set();
      list.forEach(r => {
        if (r.__d && r.__y) {
          const weekNum = getWeekNumber(r.__d);
          weeks.add(`${r.__y}-W${String(weekNum).padStart(2, '0')}`);
        }
      });
      
      weekSel.innerHTML = '<option value="all">T·∫•t c·∫£</option>';
      
      [...weeks].sort((a, b) => {
        const [yearA, weekA] = a.split('-W').map(v => parseInt(v, 10));
        const [yearB, weekB] = b.split('-W').map(v => parseInt(v, 10));
        if (yearA !== yearB) return yearB - yearA;
        return weekB - weekA;
      }).forEach(w => {
        const op = document.createElement('option');
        op.value = w;
        const [year, week] = w.split('-W');
        op.textContent = `Tu·∫ßn ${parseInt(week, 10)} (${year})`;
        weekSel.appendChild(op);
      });
    }

    /* Ph√¢n trang thu g·ªçn */
    function renderPager(){
      totalPages = Math.max(1, Math.ceil(filtered.length / ROWS_PER_PAGE));
      if(currentPage > totalPages) currentPage = totalPages;

      const createBtn = (label, page, disabled = false) =>
        `<button class="page-btn ${page===currentPage && !disabled ? 'active' : ''}" data-p="${page}" ${disabled?'disabled':''}>${label}</button>`;

      const createNum = (p) => createBtn(p, p, false);

      let html = '';

      // prev
      html += createBtn('¬´', Math.max(1, currentPage - 1), currentPage === 1);

      const maxNumbers = 7;
      if (totalPages <= maxNumbers){
        for(let p=1;p<=totalPages;p++){
          html += createNum(p);
        }
      } else {
        html += createNum(1);

        let start = Math.max(2, currentPage - 1);
        let end   = Math.min(totalPages - 1, currentPage + 1);

        if (start > 2){
          html += `<span class="page-ellipsis">‚Ä¶</span>`;
        }

        for(let p=start; p<=end; p++){
          html += createNum(p);
        }

        if (end < totalPages - 1){
          html += `<span class="page-ellipsis">‚Ä¶</span>`;
        }

        html += createNum(totalPages);
      }

      // next
      html += createBtn('¬ª', Math.min(totalPages, currentPage + 1), currentPage === totalPages);

      html += `<span class="pager-info">Trang ${currentPage}/${totalPages}</span>`;

      pager.innerHTML = html;

      pager.querySelectorAll('.page-btn').forEach(b=>{
        b.addEventListener('click', e => {
          const p = Number(e.currentTarget.dataset.p);
          if (!Number.isNaN(p) && p >= 1 && p <= totalPages && p !== currentPage){
            currentPage = p;
            renderTablePage();
          }
        });
      });
    }

    function renderTablePage(){
      if(!filtered.length){
        tbody.innerHTML = `<tr><td class="state" colspan="16">Kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>`;
        renderPager();
      } else {
        const start = (currentPage-1)*ROWS_PER_PAGE;
        const end   = start + ROWS_PER_PAGE;
        const rowsHTML = filtered.slice(start, end).map(r=>r.__rowHTML).join('');
        tbody.innerHTML = rowsHTML || `<tr><td class="state" colspan="16">Kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>`;
        renderPager();
      }
    }

    function updateSubtitle() {
      if (customTimeRange) {
        const { fromDate, fromTime, toDate, toTime } = customTimeRange;
        subTitle.textContent = `T·ª´ ${fromDate} ${fromTime || '00:00:00'} ƒë·∫øn ${toDate} ${toTime || '23:59:59'}`;
      } else if (weekSel.value !== 'all') {
        const [year, week] = weekSel.value.split('-W');
        subTitle.textContent = `Tu·∫ßn ${parseInt(week, 10)} nƒÉm ${year}`;
      } else if (dayNightSel.value !== 'all') {
        const label = dayNightSel.value === 'day' ? 'Ng√†y (7h-19h)' : 'ƒê√™m (19h-7h)';
        if (yearSel.value !== 'all' && monthSel.value !== 'all') {
          subTitle.textContent = `${label} - Th√°ng ${monthSel.value} nƒÉm ${yearSel.value}`;
        } else if (yearSel.value !== 'all') {
          subTitle.textContent = `${label} - NƒÉm ${yearSel.value}`;
        } else {
          subTitle.textContent = label;
        }
      } else if (!params.get('thang')) {
        const y=yearSel.value, m=monthSel.value, q=quarterSel.value;
        let sub='';
        if(m!=='all'&&y!=='all') sub=`Th√°ng ${m} nƒÉm ${y}`;
        else if(q!=='all'&&y!=='all') sub=`Qu√Ω ${q} nƒÉm ${y}`;
        else if(y!=='all') sub=`NƒÉm ${y}`;
        else{
          const c=new Date();
          sub=`Th√°ng ${c.getMonth()+1} nƒÉm ${c.getFullYear()}`;
        }
        subTitle.textContent=sub;
      }
    }

    function applyFiltersCore(){
      const y=yearSel.value, q=quarterSel.value, m=monthSel.value;
      const w=weekSel.value, dn=dayNightSel.value;
      
      filtered=allData
        .filter(r=>r.__d)
        .filter(r=>{
          if (customTimeRange) {
            const { fromDate, fromTime, toDate, toTime } = customTimeRange;
            const fromDateTime = new Date(`${fromDate}T${fromTime || '00:00:00'}`);
            const toDateTime = new Date(`${toDate}T${toTime || '23:59:59'}`);
            if (r.__d < fromDateTime || r.__d > toDateTime) return false;
          }
          if (w !== 'all') {
            const weekNum = getWeekNumber(r.__d);
            const rowWeek = `${r.__y}-W${String(weekNum).padStart(2, '0')}`;
            if (rowWeek !== w) return false;
          }
          if (dn !== 'all') {
            if (dn === 'day' && !isDayTime(r.__d)) return false;
            if (dn === 'night' && !isNightTime(r.__d)) return false;
          }
          if (y!=='all' && String(r.__y)!==String(y)) return false;
          if (m!=='all') return r.__m===Number(m);
          if (q!=='all') return r.__q===Number(q);
          return true;
        })
        .sort((a,b)=>a.__d-b.__d);

      updateSubtitle();

      // Only update table and charts if monitoring tab is active
      if (document.getElementById('monitoring-content').classList.contains('active')) {
        currentPage = 1;
        renderTablePage();
        updateKPIAndCharts();
      }
      
      // Always update alert and AI analysis as they might be viewed later
      updateAlertSystem();
      updateAIAnalysis();
    }
    
    const debounce=(fn,d=80)=>{ let t; return(...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),d); }; };
    const applyFilters=debounce(applyFiltersCore,80);

    /* ti·ªán √≠ch l√†m tr√≤n tr·ª•c Y */
    const niceCeil  = (v, step) => (v<=0?0:Math.ceil(v/step)*step);
    const niceFloor = (v, step) => Math.floor(v/step)*step;

    /* Plugin t√¥ nhi·ªÅu v√πng c·∫£nh b√°o tr√™n tr·ª•c m·ª±c n∆∞·ªõc */
    const levelBandsPlugin = {
      id: 'levelBands',
      beforeDraw(chart, args, opts) {
        const bands = opts && opts.bands;
        if (!bands || !bands.length) return;
        const yScale = chart.scales['yLevel'];
        if (!yScale) return;
        const {ctx, chartArea} = chart;
        ctx.save();
        bands.forEach(b=>{
          if (b.from == null || b.to == null) return;
          const y1 = yScale.getPixelForValue(b.from);
          const y2 = yScale.getPixelForValue(b.to);
          const top = Math.min(y1, y2);
          const bottom = Math.max(y1, y2);
          const clippedTop = Math.max(chartArea.top, top);
          const clippedBottom = Math.min(chartArea.bottom, bottom);
          if (clippedBottom <= clippedTop) return;
          ctx.fillStyle = b.color || 'rgba(0,0,0,0.05)';
          ctx.fillRect(chartArea.left, clippedTop, chartArea.right - chartArea.left, clippedBottom - clippedTop);
        });
        ctx.restore();
      }
    };
    Chart.register(levelBandsPlugin);

    function updateKPIAndCharts(){
      const rainByDay=new Map();
      const levelByDay=new Map();
      let maxQTotal=0;
      let maxLevelVal = null; // m·ª±c n∆∞·ªõc l·ªõn nh·∫•t theo t·ª´ng b·∫£n ghi

      filtered.forEach(r=>{
        const d=r.__d;
        const key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;

        // T·ªïng m∆∞a theo ng√†y
        rainByDay.set(key,(rainByDay.get(key)||0)+(Number(r.luongMua)||0));

        // M·ª±c n∆∞·ªõc theo ng√†y + m·ª±c n∆∞·ªõc l·ªõn nh·∫•t theo t·ª´ng b·∫£n ghi
        const lvl=Number(r.mucNuoc); 
        if(!Number.isNaN(lvl)){
          // ·ªü ƒë√¢y anh ƒëang l∆∞u 1 gi√° tr·ªã cho m·ªói ng√†y (c√≥ th·ªÉ coi l√† l·∫ßn ƒëo cu·ªëi)
          levelByDay.set(key,lvl);

          // m·ª±c n∆∞·ªõc l·ªõn nh·∫•t trong to√†n b·ªô k·ª≥ l·ªçc (theo t·ª´ng d√≤ng raw)
          if(maxLevelVal === null || lvl > maxLevelVal){
            maxLevelVal = lvl;
          }
        }

        // Q l·ªõn nh·∫•t (t·ªïng Q tr√†n t·ª± do + s·ª± c·ªë)
        const qtd=(Number(r.qTranTuDo)||0)+(Number(r.qTranSuCo)||0);
        if(qtd>maxQTotal) maxQTotal=qtd;
      });

      const dayKeys=[...new Set([...rainByDay.keys(),...levelByDay.keys()])].sort();
      const labelsDM=dayKeys.map(k=>{ const[y,m,d]=k.split('-'); return `${d}/${m}`; });
      const rainDaily=dayKeys.map(k=>rainByDay.get(k)||0);
      const levelDaily=dayKeys.map(k=> (levelByDay.has(k)?levelByDay.get(k):null) );

      /* KPI */
      const total=rainDaily.reduce((a,b)=>a+(Number(b)||0),0);

      let maxVal=0, maxIdx=-1;
      for(let i=0;i<rainDaily.length;i++){
        const v=Number(rainDaily[i])||0;
        if(v>maxVal){maxVal=v; maxIdx=i;}
      }
      const maxDayLabel=maxIdx>=0?labelsDM[maxIdx]:'';

      kpiTotalRain.textContent   = nf1.format(total);
      kpiMaxRain.textContent     = nf1.format(maxVal);
      kpiMaxRainDay.textContent  = maxDayLabel?`(${maxDayLabel})`:'';
      kpiMaxQ.textContent        = nf2.format(maxQTotal);

            // ===== M·ª±c n∆∞·ªõc l·ªõn nh·∫•t (theo b·∫£n ghi) =====
            kpiMaxLevel.textContent = (maxLevelVal === null) ? '0' : nf2.format(maxLevelVal);

// ===== KPI m·ªõi: M·ª±c n∆∞·ªõc hi·ªán t·∫°i v√† Dung t√≠ch hi·ªán t·∫°i =====
let currentLevel = null;
let currentVolume = null;

if (filtered.length > 0) {
  // L·∫•y b·∫£n ghi m·ªõi nh·∫•t theo th·ªùi gian
  const sortedByDate = [...filtered].sort((a, b) => a.__d - b.__d);
  const latestRecord = sortedByDate[sortedByDate.length - 1];
  
  currentLevel = latestRecord.mucNuoc ? Number(latestRecord.mucNuoc) : null;
  currentVolume = latestRecord.dungTich ? Number(latestRecord.dungTich) : null;
  
  // C·∫≠p nh·∫≠t m·ª±c n∆∞·ªõc hi·ªán t·∫°i cho h·ªá th·ªëng c·∫£nh b√°o
  if (currentLevel !== null) {
    currentWaterLevel = currentLevel;
  }
}

kpiCurrentLevel.textContent = currentLevel !== null ? nf2.format(currentLevel) : '0';
kpiCurrentVolume.textContent = currentVolume !== null ? nf2.format(currentVolume) : '0';

/* C√°c ng∆∞·ª°ng m·ª±c n∆∞·ªõc */
const DEAD        = 50.6;
const LVL_YELLOW  = 58.78; // MN d√¢ng BT
const LVL_ORANGE  = 59.77; // trung gian
const LVL_RED     = 60.76; // MN d√¢ng GC

const deadLine = dayKeys.map(()=>DEAD);
const btLine   = dayKeys.map(()=>LVL_YELLOW);
const gcLine   = dayKeys.map(()=>LVL_RED);

const maxRain = Math.max(0, ...rainDaily);
const stepRain = maxRain > 50 ? 10 : 5;
const yMaxRain = niceCeil(maxRain, stepRain);

const lvlVals = levelDaily.filter(v=>v!=null && !Number.isNaN(v));
const lvlMin = lvlVals.length ? Math.min(...lvlVals) : DEAD;
const lvlMax = lvlVals.length ? Math.max(...lvlVals) : DEAD;
const pad = 0.1;
const yMinLvl = niceFloor(lvlMin - pad, 0.2);
const yMaxLvl = niceCeil(lvlMax + pad, 0.2);

if(comboChart) comboChart.destroy();
const ctx = document.getElementById('comboChart');
if (!ctx) return; // Exit if chart canvas is not in the DOM
const chartCtx = ctx.getContext('2d');

const gradient = chartCtx.createLinearGradient(0,0,0,chartCtx.canvas.height);
gradient.addColorStop(0,'rgba(248,113,113,0.35)');
gradient.addColorStop(1,'rgba(248,113,113,0.00)');

comboChart = new Chart(chartCtx,{
  type:'bar',
  data:{
    labels:labelsDM,
    datasets:[
      {
        type:'bar',
        label:'L∆∞·ª£ng m∆∞a (mm/ng√†y)',
        data:rainDaily,
        yAxisID:'yRain',
        backgroundColor:'rgba(56,189,248,0.55)',
        borderRadius:4,
        maxBarThickness:32
      },
      {
        type:'line',
        label:'M·ª±c n∆∞·ªõc (m/ng√†y)',
        data:levelDaily,
        yAxisID:'yLevel',
        spanGaps:true,
        borderColor:'#ef4444',
        backgroundColor:gradient,
        tension:0.35,
        borderWidth:2.6,
        pointRadius:3,
        pointHoverRadius:5,
        pointBackgroundColor:(ctxPoint)=>{
          const v = ctxPoint.raw;
          if(v==null || Number.isNaN(v)) return '#ef4444';
          if(v>=LVL_RED)    return '#b91c1c';
          if(v>=LVL_ORANGE) return '#ea580c';
          if(v>=LVL_YELLOW) return '#eab308';
          return '#ef4444';
        },
        pointBorderColor:'#ffffff',
        fill:true
      },
      {
        type:'line',
        label:`MN ch·∫øt (${nf2.format(DEAD)} m)`,
        data:deadLine,
        yAxisID:'yLevel',
        borderColor:'rgba(148,163,184,0.9)',
        borderDash:[6,4],
        borderWidth:1.4,
        pointRadius:0,
        fill:false
      },
      {
        type:'line',
        label:`MN d√¢ng BT (${nf2.format(LVL_YELLOW)} m)`,
        data:btLine,
        yAxisID:'yLevel',
        borderColor:'rgba(234,179,8,0.95)',
        borderDash:[6,4],
        borderWidth:1.4,
        pointRadius:0,
        fill:false
      },
      {
        type:'line',
        label:`MN d√¢ng GC (${nf2.format(LVL_RED)} m)`,
        data:gcLine,
        yAxisID:'yLevel',
        borderColor:'rgba(34,197,94,0.95)',
        borderDash:[6,4],
        borderWidth:1.4,
        pointRadius:0,
        fill:false
      }
    ]
  },
  options:{
    responsive:true,
    maintainAspectRatio:false,
    plugins:{
      legend:{
        display:true,
        position:'bottom',
        labels:{
          boxWidth:26,
          padding:16
        }
      },
      tooltip:{
        mode:'index',
        intersect:false,
        callbacks:{
          label(ctx){
            const v = ctx.parsed.y;
            if(ctx.datasetIndex === 0){
              return `L∆∞·ª£ng m∆∞a: ${v.toFixed(1)} mm`;
            }else if(ctx.datasetIndex === 1){
              return `M·ª±c n∆∞·ªõc: ${v.toFixed(2)} m`;
            }else if(ctx.datasetIndex === 2){
              return `MN ch·∫øt: ${DEAD.toFixed(2)} m`;
            }else if(ctx.datasetIndex === 3){
              return `MN d√¢ng BT: ${LVL_YELLOW.toFixed(2)} m`;
            }
            return `MN d√¢ng GC: ${LVL_RED.toFixed(2)} m`;
          }
        }
      },
      levelBands:{
        bands:[
          { from: yMinLvl,    to: DEAD,       color:'rgba(148,163,184,0.14)' },  // d∆∞·ªõi MN ch·∫øt
          { from: DEAD,       to: LVL_YELLOW, color:'rgba(134,239,172,0.26)' },  // an to√†n
          { from: LVL_YELLOW, to: LVL_ORANGE, color:'rgba(252,211,77,0.26)' },   // v√†ng
          { from: LVL_ORANGE, to: LVL_RED,    color:'rgba(253,186,116,0.28)' },  // cam
          { from: LVL_RED,    to: yMaxLvl,    color:'rgba(248,113,113,0.30)' }   // ƒë·ªè
        ]
      }
    },
    interaction:{ mode:'nearest', intersect:false },
    scales:{
      x:{
        grid:{ display:false },
        ticks:{
          maxTicksLimit: Math.min(12, labelsDM.length),
          autoSkip:true,
          maxRotation:0
        }
      },
      yRain:{
        position:'left',
        beginAtZero:true,
        suggestedMax:yMaxRain,
        ticks:{ stepSize:stepRain },
        grid:{ color:'rgba(148,163,184,0.20)' },
        title:{ display:true, text:'L∆∞·ª£ng m∆∞a (mm/ng√†y)' }
      },
      yLevel:{
        position:'right',
        beginAtZero:false,
        suggestedMin:yMinLvl,
        suggestedMax:yMaxLvl,
        grid:{ drawOnChartArea:false },
        title:{ display:true, text:'M·ª±c n∆∞·ªõc TB (m/ng√†y)' }
      }
    }
  }
});

// m√¥ t·∫£ m·ª±c n∆∞·ªõc g·∫ßn nh·∫•t so v·ªõi MN ch·∫øt + v√πng m√†u
let lastVal=null; 
for(let i=levelDaily.length-1;i>=0;i--){
  if(levelDaily[i]!=null){
    lastVal=levelDaily[i];
    break;
  }
}
if(lastVal==null || Number.isNaN(lastVal)){
  waterStatus.textContent='Kh√¥ng c√≥ d·ªØ li·ªáu m·ª±c n∆∞·ªõc.';
}else{
  const diff = Math.abs(lastVal - DEAD);
  const lastStr = nf2.format(lastVal);
  const diffStr = nf2.format(diff);
  const deadStr = nf2.format(DEAD);
  const btStr   = nf2.format(LVL_YELLOW);
  const gcStr   = nf2.format(LVL_RED);

  let baseText;
  if(lastVal>=DEAD){
    baseText = `M·ª±c n∆∞·ªõc g·∫ßn nh·∫•t ${lastStr} m ‚Äî CAO H∆†N m·ª±c n∆∞·ªõc ch·∫øt (${deadStr} m) ${diffStr} m.`;
  }else{
    baseText = `M·ª±c n∆∞·ªõc g·∫ßn nh·∫•t ${lastStr} m ‚Äî TH·∫§P H∆†N m·ª±c n∆∞·ªõc ch·∫øt (${deadStr} m) ${diffStr} m.`;
  }

  let zoneText;
  if(lastVal < DEAD){
    zoneText = 'D∆∞·ªõi MN ch·∫øt, d∆∞·ªõi v√πng l√†m vi·ªác b√¨nh th∆∞·ªùng.';
  }else if(lastVal < LVL_YELLOW){
    zoneText = `V√ôNG AN TO√ÄN ‚Äì d∆∞·ªõi MN d√¢ng b√¨nh th∆∞·ªùng (${btStr} m).`;
  }else if(lastVal < LVL_ORANGE){
    zoneText = `V√ôNG V√ÄNG ‚Äì quanh MN d√¢ng b√¨nh th∆∞·ªùng (${btStr} m), c·∫ßn theo d√µi.`;
  }else if(lastVal < LVL_RED){
    zoneText = `V√ôNG CAM ‚Äì gi·ªØa MN d√¢ng b√¨nh th∆∞·ªùng v√† MN d√¢ng gia c∆∞·ªùng (${gcStr} m), c·∫£nh b√°o cao.`;
  }else{
    zoneText = `V√ôNG ƒê·ªé ‚Äì x·∫•p x·ªâ ho·∫∑c v∆∞·ª£t MN d√¢ng gia c∆∞·ªùng thi·∫øt k·∫ø (${gcStr} m), r·∫•t nguy hi·ªÉm.`;
  }

  waterStatus.textContent = `${baseText} Tr·∫°ng th√°i: ${zoneText}`;
}
}

// --- Toast Notification System ---
function showToast(message, type = 'info', duration = 5000) {
const toast = document.createElement('div');
toast.className = `toast ${type}`;

let icon = '';
switch(type) {
  case 'success':
    icon = '<i class="fas fa-check-circle toast-icon"></i>';
    break;
  case 'warning':
    icon = '<i class="fas fa-exclamation-triangle toast-icon"></i>';
    break;
  case 'error':
    icon = '<i class="fas fa-times-circle toast-icon"></i>';
    break;
  default:
    icon = '<i class="fas fa-info-circle toast-icon"></i>';
}

toast.innerHTML = `
  ${icon}
  <div class="toast-message">${message}</div>
  <div class="toast-close"><i class="fas fa-times"></i></div>
  <div class="toast-progress"></div>
`;

toastContainer.appendChild(toast);

// Auto remove after duration
const timeout = setTimeout(() => {
  removeToast(toast);
}, duration);

// Manual close
toast.querySelector('.toast-close').addEventListener('click', () => {
  clearTimeout(timeout);
  removeToast(toast);
});

return toast;
}

function removeToast(toast) {
toast.style.opacity = '0';
toast.style.transform = 'translateX(100%)';
setTimeout(() => {
  if (toast.parentNode) {
    toast.parentNode.removeChild(toast);
  }
}, 300);
}

// --- IndexedDB for Caching ---
const DB_NAME = 'hoNuocNgotDB';
const DB_VERSION = 1;
const STORE_NAME = 'dataCache';

let db;

function initDB() {
return new Promise((resolve, reject) => {
  const request = indexedDB.open(DB_NAME, DB_VERSION);
  
  request.onerror = (event) => {
    console.error('IndexedDB error:', event.target.error);
    reject(event.target.error);
  };
  
  request.onsuccess = (event) => {
    db = event.target.result;
    resolve(db);
  };
  
  request.onupgradeneeded = (event) => {
    const db = event.target.result;
    
    if (!db.objectStoreNames.contains(STORE_NAME)) {
      const objectStore = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
      objectStore.createIndex('timestamp', 'timestamp', { unique: false });
    }
  };
});
}

function getCachedData() {
return new Promise((resolve, reject) => {
  if (!db) {
    reject(new Error('Database not initialized'));
    return;
  }
  
  const transaction = db.transaction([STORE_NAME], 'readonly');
  const objectStore = transaction.objectStore(STORE_NAME);
  const request = objectStore.get('mainData');
  
  request.onerror = (event) => {
    reject(event.target.error);
  };
  
  request.onsuccess = (event) => {
    const result = event.target.result;
    if (result && result.data) {
      resolve(result.data);
    } else {
      resolve(null);
    }
  };
});
}

function cacheData(data) {
return new Promise((resolve, reject) => {
  if (!db) {
    reject(new Error('Database not initialized'));
    return;
  }
  
  const transaction = db.transaction([STORE_NAME], 'readwrite');
  const objectStore = transaction.objectStore(STORE_NAME);
  
  const cacheEntry = {
    id: 'mainData',
    data: data,
    timestamp: new Date().getTime()
  };
  
  const request = objectStore.put(cacheEntry);
  
  request.onerror = (event) => {
    reject(event.target.error);
  };
  
  request.onsuccess = (event) => {
    resolve();
  };
});
}

// --- Data Loading with Progressive Enhancement ---
function showLoading(show = true, text = 'ƒêang t·∫£i d·ªØ li·ªáu...', progress = 0) {
if (show) {
  loadingOverlay.style.display = 'flex';
  loadingText.textContent = text;
  loadingProgressBar.style.width = `${progress}%`;
} else {
  loadingOverlay.style.display = 'none';
}
}

// Show data update indicator
function showDataUpdateIndicator(show = true, text = 'ƒêang c·∫≠p nh·∫≠t d·ªØ li·ªáu m·ªõi...') {
if (show) {
  dataUpdateText.textContent = text;
  dataUpdateIndicator.classList.add('show');
} else {
  dataUpdateIndicator.classList.remove('show');
}
}

// Combine data without duplicates
function combineData(existingData, newData) {
if (!existingData || existingData.length === 0) {
  return newData || [];
}

if (!newData || newData.length === 0) {
  return existingData;
}

// Create a map of existing data by unique identifier (ngayGio)
const dataMap = new Map();

// Add existing data to map
existingData.forEach(item => {
  if (item.ngayGio) {
    dataMap.set(item.ngayGio, item);
  }
});

// Add new data to map (overwrites duplicates)
newData.forEach(item => {
  if (item.ngayGio) {
    dataMap.set(item.ngayGio, item);
  }
});

// Convert back to array and sort by date (newest first)
return Array.from(dataMap.values()).sort((a, b) => {
  const dateA = parseVNDateTime(a.ngayGio);
  const dateB = parseVNDateTime(b.ngayGio);
  return dateB - dateA;
});
}

// Process raw data into the format used by the application
function processData(rawData) {
return rawData.map(r => {
  const d = parseVNDateTime(r.ngayGio);
  const y = d ? d.getFullYear() : null;
  const m = d ? (d.getMonth() + 1) : null;
  const q = d ? (Math.floor((m - 1) / 3) + 1) : null;
  
  const base = {
    ...r,
    __d: d,
    __y: y,
    __m: m,
    __q: q
  };
  
  base.__rowHTML = buildRowHTML(base);
  return base;
});
}

// Load data with progressive enhancement
async function loadDataWithProgressiveEnhancement() {
try {
  // Initialize IndexedDB
  await initDB();
  
  // Try to get cached data first
  const cachedData = await getCachedData();
  
  if (cachedData && cachedData.length > 0) {
    // Process cached data
    allData = processData(cachedData);
    
    // Populate filters with cached data
    populateYears(allData);
    populateWeeks(allData);
    
    // Apply filters to show cached data immediately
    applyFiltersCore();
    
    showToast('ƒê√£ t·∫£i d·ªØ li·ªáu t·ª´ cache', 'info', 3000);
    
    // Continue to fetch fresh data in background
    fetchFreshDataInBackground();
  } else {
    // No cached data, fetch from server
    fetchFreshData();
  }
} catch (error) {
  console.error('Error loading data:', error);
  showToast(`L·ªói t·∫£i d·ªØ li·ªáu: ${error.message}`, 'error', 5000);
  
  // Fallback to direct fetch if IndexedDB fails
  fetchFreshData();
}
}

// Fetch fresh data from server in background
async function fetchFreshDataInBackground() {
try {
  // Show data update indicator
  showDataUpdateIndicator(true, 'ƒêang ki·ªÉm tra d·ªØ li·ªáu m·ªõi...');
  
  // Fetch data from server
  const response = await fetch(API_URL, { cache: 'no-store' });
  
  if (!response.ok) {
    throw new Error(`HTTP ${response.status}`);
  }
  
  showDataUpdateIndicator(true, 'ƒêang x·ª≠ l√Ω d·ªØ li·ªáu m·ªõi...');
  const data = await response.json();
  
  if (!Array.isArray(data) || !data.length) {
    throw new Error('Kh√¥ng c√≥ d·ªØ li·ªáu m·ªõi t·ª´ m√°y ch·ªß');
  }
  
  // Process new data
  const processedData = processData(data);
  
  // Check if there's actually new data
  let hasNewData = false;
  if (allData.length > 0) {
    const newestExistingDate = allData[0].__d;
    const newestNewDate = processedData[0].__d;
    
    if (newestNewDate > newestExistingDate) {
      hasNewData = true;
    }
  } else {
    hasNewData = true;
  }
  
  if (hasNewData) {
    showDataUpdateIndicator(true, 'ƒêang c·∫≠p nh·∫≠t d·ªØ li·ªáu m·ªõi...');
    
    // Combine with existing data
    const previousDataCount = allData.length;
    allData = combineData(allData, processedData);
    const newDataCount = allData.length - previousDataCount;
    
    // Cache combined data
    await cacheData(allData.map(item => {
      // Create a clean version for caching (without computed properties)
      const { __d, __y, __m, __q, __rowHTML, ...cleanItem } = item;
      return cleanItem;
    }));
    
    // Update UI with fresh data
    populateYears(allData);
    populateWeeks(allData);
    applyFiltersCore();
    
    showDataUpdateIndicator(false);
    
    if (newDataCount > 0) {
      showToast(`ƒê√£ c·∫≠p nh·∫≠t ${newDataCount} b·∫£n ghi m·ªõi`, 'success', 5000);
    } else {
      showToast('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t', 'success', 3000);
    }
  } else {
    showDataUpdateIndicator(false);
    showToast('Kh√¥ng c√≥ d·ªØ li·ªáu m·ªõi', 'info', 3000);
  }
} catch (error) {
  console.error('Error fetching fresh data:', error);
  showDataUpdateIndicator(false);
  showToast(`L·ªói ki·ªÉm tra d·ªØ li·ªáu m·ªõi: ${error.message}`, 'error', 5000);
}
}

// Fetch fresh data from server (blocking version)
async function fetchFreshData() {
try {
  showLoading(true, 'ƒêang t·∫£i d·ªØ li·ªáu t·ª´ m√°y ch·ªß...', 30);
  
  // Fetch data from server
  const response = await fetch(API_URL, { cache: 'no-store' });
  
  if (!response.ok) {
    throw new Error(`HTTP ${response.status}`);
  }
  
  showLoading(true, 'ƒêang x·ª≠ l√Ω d·ªØ li·ªáu...', 60);
  const data = await response.json();
  
  if (!Array.isArray(data) || !data.length) {
    throw new Error('Kh√¥ng c√≥ d·ªØ li·ªáu t·ª´ m√°y ch·ªß');
  }
  
  // Process new data
  const processedData = processData(data);
  
  // Combine with existing data
  allData = combineData(allData, processedData);
  
  // Cache combined data
  showLoading(true, 'ƒêang l∆∞u d·ªØ li·ªáu v√†o cache...', 80);
  await cacheData(allData.map(item => {
    // Create a clean version for caching (without computed properties)
    const { __d, __y, __m, __q, __rowHTML, ...cleanItem } = item;
    return cleanItem;
  }));
  
  // Update UI with fresh data
  showLoading(true, 'C·∫≠p nh·∫≠t giao di·ªán...', 90);
  populateYears(allData);
  populateWeeks(allData);
  applyFiltersCore();
  
  showLoading(false);
  showToast('ƒê√£ t·∫£i d·ªØ li·ªáu m·ªõi nh·∫•t th√†nh c√¥ng', 'success', 3000);
} catch (error) {
  console.error('Error fetching fresh data:', error);
  showLoading(false);
  showToast(`L·ªói t·∫£i d·ªØ li·ªáu m·ªõi: ${error.message}`, 'error', 5000);
  
  // If we have cached data, continue using it
  if (allData && allData.length > 0) {
    showToast('ƒêang s·ª≠ d·ª•ng d·ªØ li·ªáu ƒë√£ l∆∞u', 'warning', 3000);
  } else {
    // Show error in the table
    tbody.innerHTML = `<tr><td class="state" colspan="16">L·ªói t·∫£i d·ªØ li·ªáu: ${error.message || error}</td></tr>`;
  }
}
}

// Refresh data button handler
btnRefreshData.addEventListener('click', () => {
showToast('ƒêang l√†m m·ªõi d·ªØ li·ªáu...', 'info', 3000);
fetchFreshData();
});

// --- Dashboard Settings Logic ---
const DASHBOARD_SETTINGS_KEY = 'dashboardSettings';

function loadDashboardSettings() {
const savedSettings = localStorage.getItem(DASHBOARD_SETTINGS_KEY);
const defaultSettings = {
  kpi_total_rain: true,
  kpi_max_level: true,
  kpi_max_rain: true,
  kpi_max_q: true,
  kpi_current_level: true,
  kpi_current_volume: true,
  chart: true,
  alert_system: true,
  ai_analysis: true,
};
const settings = savedSettings ? { ...defaultSettings, ...JSON.parse(savedSettings) } : defaultSettings;

// Apply settings to checkboxes
Object.keys(settings).forEach(key => {
  const checkbox = document.getElementById(`toggle_${key}`);
  if (checkbox) {
    checkbox.checked = settings[key];
  }
});

// Apply visibility
applyDashboardVisibility(settings);
}

function saveDashboardSettings() {
const settings = {};
const checkboxes = dashboardSettingsModal.querySelectorAll('input[type="checkbox"]');
checkboxes.forEach(cb => {
  const key = cb.id.replace('toggle_', '');
  settings[key] = cb.checked;
});
localStorage.setItem(DASHBOARD_SETTINGS_KEY, JSON.stringify(settings));
applyDashboardVisibility(settings);
}

function applyDashboardVisibility(settings) {
// KPIs visibility
const kpiElements = kpisContainer.querySelectorAll('.kpi');
kpiElements.forEach(kpiEl => {
  const kpiId = kpiEl.dataset.kpiId;
  if (settings.hasOwnProperty(kpiId)) {
    kpiEl.style.display = settings[kpiId] ? 'flex' : 'none';
  }
});

// Chart visibility
chartsContainer.style.display = settings.chart ? 'grid' : 'none';

// Alert system visibility
alertSystem.style.display = settings.alert_system ? 'block' : 'none';

// AI Analysis visibility
aiAnalysis.style.display = settings.ai_analysis ? 'block' : 'none';

// Redraw chart if it becomes visible to handle sizing issues
if (settings.chart && comboChart) {
  setTimeout(() => comboChart.resize(), 100);
}
}

// Event Listeners for Dashboard Settings
btnDashboardSettings.onclick = () => {
dashboardSettingsModal.style.display = 'block';
};

closeSettingsModal.onclick = () => {
dashboardSettingsModal.style.display = 'none';
};

window.onclick = (event) => {
if (event.target == dashboardSettingsModal) {
  dashboardSettingsModal.style.display = 'none';
}
};

dashboardSettingsModal.querySelectorAll('input[type="checkbox"]').forEach(cb => {
cb.addEventListener('change', saveDashboardSettings);
});

// Load settings on page load
document.addEventListener('DOMContentLoaded', loadDashboardSettings);

/* H·ªÜ TH·ªêNG C·∫¢NH B√ÅO TH√îNG MINH (ƒê√É TINH G·ªåN) */
const ALERT_SETTINGS_KEY = 'alertSettings';

// Toggle buttons functionality
toggleSettingsBtn.addEventListener('click', () => {
const isHidden = !settingsContent.classList.contains('show');
if (isHidden) {
  settingsContent.classList.remove('show');
  toggleSettingsBtn.innerHTML = '<i class="fas fa-chevron-down"></i> Hi·ªán';
} else {
  settingsContent.classList.add('show');
  toggleSettingsBtn.innerHTML = '<i class="fas fa-chevron-up"></i> ·∫®n';
}
});

toggleHistoryBtn.addEventListener('click', () => {
const isHidden = !historyContent.classList.contains('show');
if (isHidden) {
  historyContent.classList.remove('show');
  toggleHistoryBtn.innerHTML = '<i class="fas fa-chevron-down"></i> Hi·ªán';
} else {
  historyContent.classList.add('show');
  toggleHistoryBtn.innerHTML = '<i class="fas fa-chevron-up"></i> ·∫®n';
}
});

// Load alert settings from localStorage
function loadAlertSettings() {
const savedSettings = localStorage.getItem(ALERT_SETTINGS_KEY);
const defaultSettings = {
  normal: 56.5,      // B√¨nh th∆∞·ªùng
  monitor: 58.78,    // Theo d√µi (MN d√¢ng b√¨nh th∆∞·ªùng)
  danger: 60.3,      // Nguy hi·ªÉm
  emergency: 60.76   // Kh·∫©n c·∫•p (MN d√¢ng gia c∆∞·ªùng)
};

const settings = savedSettings ? { ...defaultSettings, ...JSON.parse(savedSettings) } : defaultSettings;

// Apply to inputs
normalThreshold.value = settings.normal;
monitorThreshold.value = settings.monitor;
dangerThreshold.value = settings.danger;
emergencyThreshold.value = settings.emergency;

// Update display values
normalValueEl.textContent = nf2.format(settings.normal);
monitorValueEl.textContent = nf2.format(settings.monitor);
dangerValueEl.textContent = nf2.format(settings.danger);
emergencyValueEl.textContent = nf2.format(settings.emergency);

return settings;
}

// Save alert settings to localStorage
function saveAlertSettings() {
const settings = {
  normal: parseFloat(normalThreshold.value),
  monitor: parseFloat(monitorThreshold.value),
  danger: parseFloat(dangerThreshold.value),
  emergency: parseFloat(emergencyThreshold.value)
};

localStorage.setItem(ALERT_SETTINGS_KEY, JSON.stringify(settings));

// Update display values
normalValueEl.textContent = nf2.format(settings.normal);
monitorValueEl.textContent = nf2.format(settings.monitor);
dangerValueEl.textContent = nf2.format(settings.danger);
emergencyValueEl.textContent = nf2.format(settings.emergency);

updateAlertSystem();

// Show success message
alertMessage.className = 'alert-message normal';
alertText.textContent = 'ƒê√£ l∆∞u c√†i ƒë·∫∑t ng∆∞·ª°ng c·∫£nh b√°o th√†nh c√¥ng!';

// Reset to current status after 2 seconds
setTimeout(() => {
  updateAlertSystem();
}, 2000);
}

// Reset alert settings to default
function resetAlertSettings() {
const defaultSettings = {
  normal: 56.5,      // B√¨nh th∆∞·ªùng
  monitor: 58.78,    // Theo d√µi (MN d√¢ng b√¨nh th∆∞·ªùng)
  danger: 60.3,      // Nguy hi·ªÉm
  emergency: 60.76   // Kh·∫©n c·∫•p (MN d√¢ng gia c∆∞·ªùng)
};

normalThreshold.value = defaultSettings.normal;
monitorThreshold.value = defaultSettings.monitor;
dangerThreshold.value = defaultSettings.danger;
emergencyThreshold.value = defaultSettings.emergency;

localStorage.setItem(ALERT_SETTINGS_KEY, JSON.stringify(defaultSettings));

// Update display values
normalValueEl.textContent = nf2.format(defaultSettings.normal);
monitorValueEl.textContent = nf2.format(defaultSettings.monitor);
dangerValueEl.textContent = nf2.format(defaultSettings.danger);
emergencyValueEl.textContent = nf2.format(defaultSettings.emergency);

updateAlertSystem();

// Show success message
alertMessage.className = 'alert-message normal';
alertText.textContent = 'ƒê√£ ƒë·∫∑t l·∫°i c√†i ƒë·∫∑t ng∆∞·ª°ng c·∫£nh b√°o v·ªÅ m·∫∑c ƒë·ªãnh!';

// Reset to current status after 2 seconds
setTimeout(() => {
  updateAlertSystem();
}, 2000);
}

// Add alert to history
function addAlertToHistory(status, message) {
const now = new Date();
const timeStr = fmtDateTimeVN(now);

const historyItem = {
  status: status,
  message: message,
  time: timeStr
};

// Add to beginning of array
alertHistory.unshift(historyItem);

// Keep only last 10 items
if (alertHistory.length > 10) {
  alertHistory = alertHistory.slice(0, 10);
}

// Update history display
updateHistoryDisplay();
}

// Update history display
function updateHistoryDisplay() {
historyList.innerHTML = '';

alertHistory.forEach(item => {
  const historyEl = document.createElement('div');
  historyEl.className = `history-item ${item.status}`;
  historyEl.innerHTML = `
    <span>${item.message}</span>
    <span class="history-time">${item.time}</span>
  `;
  historyList.appendChild(historyEl);
});
}

// Update water level visualization
function updateWaterLevelVisualization() {
const settings = loadAlertSettings();
const minLevel = 45; // Minimum level for visualization
const maxLevel = 65; // Maximum level for visualization

// Calculate percentage position (inverted because bottom is 0)
const percentage = Math.max(0, Math.min(100, ((currentWaterLevel - minLevel) / (maxLevel - minLevel)) * 100));

// Update water level
waterLevelVisual.style.height = `${percentage}%`;

// Update current level indicator
currentLevelIndicator.style.bottom = `${percentage}%`;
currentLevelIndicator.setAttribute('data-label', `${nf2.format(currentWaterLevel)} m`);

// Update water color based on level
if (currentWaterLevel >= settings.emergency) {
  waterLevelVisual.style.background = 'linear-gradient(0deg, #a855f7 0%, #c084fc 100%)';
} else if (currentWaterLevel >= settings.danger) {
  waterLevelVisual.style.background = 'linear-gradient(0deg, #ef4444 0%, #f87171 100%)';
} else if (currentWaterLevel >= settings.monitor) {
  waterLevelVisual.style.background = 'linear-gradient(0deg, #f59e0b 0%, #fbbf24 100%)';
} else {
  waterLevelVisual.style.background = 'linear-gradient(0deg, #0ea5e9 0%, #38bdf8 100%)';
}
}

// Update alert timestamp
function updateAlertTimestamp() {
const now = new Date();
alertTimestamp.textContent = `C·∫≠p nh·∫≠t: ${fmtDateTimeVN(now)}`;
}

// Update alert system based on current water level
function updateAlertSystem() {
const settings = loadAlertSettings();

// Determine alert status based on current water level
let newStatus = 'normal';
let message = '';

if (currentWaterLevel >= settings.emergency) {
  newStatus = 'emergency';
  message = `M·ª±c n∆∞·ªõc (${nf2.format(currentWaterLevel)} m) ƒë√£ v∆∞·ª£t ng∆∞·ª°ng kh·∫©n c·∫•p (${nf2.format(settings.emergency)} m). C·∫ßn h√†nh ƒë·ªông kh·∫©n c·∫•p!`;
} else if (currentWaterLevel >= settings.danger) {
  newStatus = 'danger';
  message = `M·ª±c n∆∞·ªõc (${nf2.format(currentWaterLevel)} m) ƒë√£ v∆∞·ª£t ng∆∞·ª°ng nguy hi·ªÉm (${nf2.format(settings.danger)} m). C·∫ßn c√≥ bi·ªán ph√°p x·ª≠ l√Ω ngay!`;
} else if (currentWaterLevel >= settings.monitor) {
  newStatus = 'monitor';
  message = `M·ª±c n∆∞·ªõc (${nf2.format(currentWaterLevel)} m) ƒë√£ v∆∞·ª£t ng∆∞·ª°ng theo d√µi (${nf2.format(settings.monitor)} m). C·∫ßn tƒÉng c∆∞·ªùng gi√°m s√°t`;
} else {
  newStatus = 'normal';
  message = `M·ª±c n∆∞·ªõc (${nf2.format(currentWaterLevel)} m) trong ng∆∞·ª°ng an to√†n (${nf2.format(settings.normal)} m). Ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng.`;
}

// Check if status changed
if (newStatus !== currentAlertStatus) {
  // Add to history
  addAlertToHistory(newStatus, message);
}

// Update status
currentAlertStatus = newStatus;

// Update UI
alertMessage.className = `alert-message ${currentAlertStatus}`;
alertText.textContent = message;

// Update tabs
alertStatuses.forEach(tab => {
  if (tab.dataset.status === currentAlertStatus) {
    tab.classList.add('active');
  } else {
    tab.classList.remove('active');
  }
});

// Update visualizations
updateWaterLevelVisualization();
updateAlertTimestamp();
}

// Alert tab click handlers
alertStatuses.forEach(tab => {
tab.addEventListener('click', () => {
  // Update active tab
  alertStatuses.forEach(t => t.classList.remove('active'));
  tab.classList.add('active');
  
  // Update status
  currentAlertStatus = tab.dataset.status;
  
  // Update message based on selected tab
  const settings = loadAlertSettings();
  let message = '';
  
  if (currentAlertStatus === 'normal') {
    message = `M·ª±c n∆∞·ªõc (${nf2.format(currentWaterLevel)} m) trong ng∆∞·ª°ng an to√†n (${nf2.format(settings.normal)} m). Ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng.`;
  } else if (currentAlertStatus === 'monitor') {
    message = `M·ª±c n∆∞·ªõc (${nf2.format(currentWaterLevel)} m) ƒë√£ v∆∞·ª£t ng∆∞·ª°ng theo d√µi (${nf2.format(settings.monitor)} m). C·∫ßn tƒÉng c∆∞·ªùng gi√°m s√°t`;
  } else if (currentAlertStatus === 'danger') {
    message = `M·ª±c n∆∞·ªõc (${nf2.format(currentWaterLevel)} m) ƒë√£ v∆∞·ª£t ng∆∞·ª°ng nguy hi·ªÉm (${nf2.format(settings.danger)} m). C·∫ßn c√≥ bi·ªán ph√°p x·ª≠ l√Ω ngay!`;
  } else if (currentAlertStatus === 'emergency') {
    message = `M·ª±c n∆∞·ªõc (${nf2.format(currentWaterLevel)} m) ƒë√£ v∆∞·ª£t ng∆∞·ª°ng kh·∫©n c·∫•p (${nf2.format(settings.emergency)} m). C·∫ßn h√†nh ƒë·ªông kh·∫©n c·∫•p!`;
  }
  
  alertMessage.className = `alert-message ${currentAlertStatus}`;
  alertText.textContent = message;
});
});

// Save and reset button handlers
saveThresholdsBtn.addEventListener('click', saveAlertSettings);
resetThresholdsBtn.addEventListener('click', resetAlertSettings);

// Initialize alert system on page load
document.addEventListener('DOMContentLoaded', () => {
loadAlertSettings();
updateAlertSystem();

// Set up auto-refresh for alerts (every 30 seconds)
setInterval(() => {
  if (filtered.length > 0) {
    updateAlertSystem();
  }
}, 30000);
});

/* AI ANALYSIS */
// Tab switching
aiTabs.forEach(tab => {
tab.addEventListener('click', () => {
  // Remove active class from all tabs and contents
  aiTabs.forEach(t => t.classList.remove('active'));
  aiTabContents.forEach(content => content.classList.remove('active'));
  
  // Add active class to clicked tab and corresponding content
  tab.classList.add('active');
  const tabId = tab.dataset.tab;
  document.getElementById(`${tabId}-tab`).classList.add('active');
});
});

// Update AI timestamp
function updateAITimestamp() {
const now = new Date();
aiTimestamp.textContent = `C·∫≠p nh·∫≠t: ${fmtDateTimeVN(now)}`;
}

// Simple linear regression for trend analysis
function linearRegression(data) {
const n = data.length;
if (n === 0) return { slope: 0, intercept: 0, r2: 0 };

let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0, sumY2 = 0;

for (let i = 0; i < n; i++) {
  sumX += i;
  sumY += data[i];
  sumXY += i * data[i];
  sumX2 += i * i;
  sumY2 += data[i] * data[i];
}

const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
const intercept = (sumY - slope * sumX) / n;

// Calculate R-squared
const meanY = sumY / n;
let ssTotal = 0, ssResidual = 0;

for (let i = 0; i < n; i++) {
  const yPred = slope * i + intercept;
  ssTotal += Math.pow(data[i] - meanY, 2);
  ssResidual += Math.pow(data[i] - yPred, 2);
}

const r2 = 1 - (ssResidual / ssTotal);

return { slope, intercept, r2 };
}

// Simple exponential smoothing for prediction
function exponentialSmoothing(data, alpha = 0.3, periods = 7) {
if (data.length === 0) return [];

const smoothed = [data[0]];

// Smooth existing data
for (let i = 1; i < data.length; i++) {
  smoothed.push(alpha * data[i] + (1 - alpha) * smoothed[i - 1]);
}

// Predict future values
const predictions = [];
let lastValue = smoothed[smoothed.length - 1];

for (let i = 0; i < periods; i++) {
  predictions.push(lastValue);
  lastValue = alpha * lastValue + (1 - alpha) * lastValue;
}

return predictions;
}

// Calculate correlation coefficient
function correlation(x, y) {
if (x.length !== y.length || x.length === 0) return 0;

const n = x.length;
let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0, sumY2 = 0;

for (let i = 0; i < n; i++) {
  sumX += x[i];
  sumY += y[i];
  sumXY += x[i] * y[i];
  sumX2 += x[i] * x[i];
  sumY2 += y[i] * y[i];
}

const numerator = n * sumXY - sumX * sumY;
const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));

return denominator === 0 ? 0 : numerator / denominator;
}

// Update AI Analysis
function updateAIAnalysis() {
if (filtered.length === 0) return;

// Prepare data for analysis
const rainByDay = new Map();
const levelByDay = new Map();

filtered.forEach(r => {
  const d = r.__d;
  const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
  
  // Sum rain by day
  rainByDay.set(key, (rainByDay.get(key) || 0) + (Number(r.luongMua) || 0));
  
  // Store latest water level by day
  const lvl = Number(r.mucNuoc);
  if (!Number.isNaN(lvl)) {
    levelByDay.set(key, lvl);
  }
});

const dayKeys = [...new Set([...rainByDay.keys(), ...levelByDay.keys()])].sort();
const rainData = dayKeys.map(k => rainByDay.get(k) || 0);
const levelData = dayKeys.map(k => levelByDay.has(k) ? levelByDay.get(k) : null).filter(v => v !== null);

// Update Trend Analysis
updateTrendAnalysis(levelData);

// Update Prediction
updatePrediction(levelData);

// Update Recommendations
updateRecommendations(levelData, rainData);

// Update Pattern Analysis
updatePatternAnalysis(rainData, levelData);

// Update timestamp
updateAITimestamp();
}

function updateTrendAnalysis(levelData) {
if (levelData.length < 3) {
  waterLevelTrend.textContent = 'Kh√¥ng ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ ph√¢n t√≠ch xu h∆∞·ªõng.';
  trendDirection.textContent = '--';
  trendRate.textContent = '--';
  trendConsistency.textContent = '--';
  return;
}

// Perform linear regression
const regression = linearRegression(levelData);

// Determine trend direction
let direction, directionIcon;
if (Math.abs(regression.slope) < 0.01) {
  direction = '·ªîn ƒë·ªãnh';
  directionIcon = '‚Üí';
} else if (regression.slope > 0) {
  direction = 'TƒÉng';
  directionIcon = '‚Üë';
} else {
  direction = 'Gi·∫£m';
  directionIcon = '‚Üì';
}

// Calculate consistency (R-squared as percentage)
const consistency = Math.round(regression.r2 * 100);

// Update UI
waterLevelTrend.textContent = `M·ª±c n∆∞·ªõc ƒëang c√≥ xu h∆∞·ªõng ${direction.toLowerCase()} v·ªõi t·ªëc ƒë·ªô ${nf2.format(Math.abs(regression.slope))} m/ng√†y. M·ª©c ƒë·ªô tin c·∫≠y c·ªßa xu h∆∞·ªõng l√† ${consistency}%.`;
trendDirection.textContent = `${directionIcon} ${direction}`;
trendRate.textContent = nf2.format(regression.slope);
trendConsistency.textContent = `${consistency}%`;

// Update trend chart
updateTrendChart(levelData, regression);
}

function updateTrendChart(levelData, regression) {
const ctx = document.getElementById('trendChart');
if (!ctx) return;

if (trendChart) trendChart.destroy();

const labels = levelData.map((_, i) => `Ng√†y ${i + 1}`);
const trendLine = levelData.map((_, i) => regression.slope * i + regression.intercept);

trendChart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: labels,
    datasets: [
      {
        label: 'M·ª±c n∆∞·ªõc th·ª±c t·∫ø',
        data: levelData,
        borderColor: '#6366f1',
        backgroundColor: 'rgba(99, 102, 241, 0.1)',
        borderWidth: 2,
        pointRadius: 3,
        tension: 0.1,
        fill: true
      },
      {
        label: 'Xu h∆∞·ªõng',
        data: trendLine,
        borderColor: '#ef4444',
        borderWidth: 2,
        borderDash: [5, 5],
        pointRadius: 0,
        fill: false
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: 'top',
      }
    },
    scales: {
      y: {
        beginAtZero: false,
        title: {
          display: true,
          text: 'M·ª±c n∆∞·ªõc (m)'
        }
      },
      x: {
        title: {
          display: true,
          text: 'Th·ªùi gian'
        }
      }
    }
  }
});
}

function updatePrediction(levelData) {
if (levelData.length < 5) {
  waterLevelPrediction.textContent = 'Kh√¥ng ƒë·ªß d·ªØ li·ªáu l·ªãch s·ª≠ ƒë·ªÉ ƒë∆∞a ra d·ª± b√°o ch√≠nh x√°c.';
  predictionMin.textContent = '--';
  predictionMax.textContent = '--';
  predictionRisk.textContent = '--';
  return;
}

// Get threshold values
const settings = loadAlertSettings();

// Generate predictions using exponential smoothing
const predictions = exponentialSmoothing(levelData);

// Calculate min and max predictions
const minPred = Math.min(...predictions);
const maxPred = Math.max(...predictions);

// Determine risk level
let riskLevel, riskColor;
if (maxPred >= settings.emergency) {
  riskLevel = 'Cao';
  riskColor = '#ef4444';
} else if (maxPred >= settings.danger) {
  riskLevel = 'Trung b√¨nh';
  riskColor = '#f59e0b';
} else if (maxPred >= settings.monitor) {
  riskLevel = 'Th·∫•p';
  riskColor = '#3b82f6';
} else {
  riskLevel = 'R·∫•t th·∫•p';
  riskColor = '#22c55e';
}

// Update UI
waterLevelPrediction.textContent = `D·ª±a tr√™n d·ªØ li·ªáu l·ªãch s·ª≠, m·ª±c n∆∞·ªõc d·ª± b√°o s·∫Ω dao ƒë·ªông trong kho·∫£ng ${nf2.format(minPred)} m - ${nf2.format(maxPred)} m trong 7 ng√†y t·ªõi.`;
predictionMin.textContent = nf2.format(minPred);
predictionMax.textContent = nf2.format(maxPred);
predictionRisk.innerHTML = `<span style="color: ${riskColor}">${riskLevel}</span>`;

// Update prediction chart
updatePredictionChart(levelData, predictions);
}

function updatePredictionChart(levelData, predictions) {
const ctx = document.getElementById('predictionChart');
if (!ctx) return;

if (predictionChart) predictionChart.destroy();

const historicalLabels = levelData.map((_, i) => `Ng√†y ${i + 1}`);
const predictionLabels = predictions.map((_, i) => `+${i + 1}`);

predictionChart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: [...historicalLabels, ...predictionLabels],
    datasets: [
      {
        label: 'D·ªØ li·ªáu l·ªãch s·ª≠',
        data: [...levelData, ...Array(predictions.length).fill(null)],
        borderColor: '#6366f1',
        backgroundColor: 'rgba(99, 102, 241, 0.1)',
        borderWidth: 2,
        pointRadius: 3,
        tension: 0.1,
        fill: true
      },
      {
        label: 'D·ª± b√°o',
        data: [...Array(levelData.length).fill(null), ...predictions],
        borderColor: '#f59e0b',
        backgroundColor: 'rgba(245, 158, 11, 0.1)',
        borderWidth: 2,
        borderDash: [5, 5],
        pointRadius: 3,
        tension: 0.1,
        fill: true
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: 'top',
      }
    },
    scales: {
      y: {
        beginAtZero: false,
        title: {
          display: true,
          text: 'M·ª±c n∆∞·ªõc (m)'
        }
      },
      x: {
        title: {
          display: true,
          text: 'Th·ªùi gian'
        }
      }
    }
  }
});
}

function updateRecommendations(levelData, rainData) {
if (levelData.length === 0) {
  operationRecommendation.textContent = 'Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ ƒë∆∞a ra ƒë·ªÅ xu·∫•t.';
  dischargeRecommendation.textContent = 'Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ ƒë∆∞a ra khuy·∫øn ngh·ªã.';
  attentionPoints.textContent = 'Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ ph√¢n t√≠ch.';
  return;
}

// Get current and threshold values
const currentLevel = levelData[levelData.length - 1];
const settings = loadAlertSettings();

// Analyze recent rain
const recentRain = rainData.slice(-3).reduce((sum, val) => sum + val, 0);

// Generate operation recommendations
let operationRec = '';
if (currentLevel >= settings.emergency) {
  operationRec = 'M·ª±c n∆∞·ªõc ·ªü m·ª©c kh·∫©n c·∫•p. C·∫ßn m·ªü t·ªëi ƒëa c√°c c·ª≠a x·∫£ v√† th√¥ng b√°o cho c√°c khu v·ª±c h·∫° du. Ki·ªÉm tra th∆∞·ªùng xuy√™n t√¨nh tr·∫°ng ƒë·∫≠p v√† c√°c c√¥ng tr√¨nh ph·ª• tr·ª£.';
} else if (currentLevel >= settings.danger) {
  operationRec = 'M·ª±c n∆∞·ªõc ·ªü m·ª©c nguy hi·ªÉm. N√™n b·∫Øt ƒë·∫ßu x·∫£ n∆∞·ªõc t·ª´ t·ª´, theo d√µi ch·∫∑t ch·∫Ω m·ª±c n∆∞·ªõc v√† l∆∞·ª£ng m∆∞a. Chu·∫©n b·ªã c√°c ph∆∞∆°ng √°n ·ª©ng ph√≥ kh·∫©n c·∫•p.';
} else if (currentLevel >= settings.monitor) {
  operationRec = 'M·ª±c n∆∞·ªõc ·ªü m·ª©c theo d√µi. C·∫ßn tƒÉng c∆∞·ªùng t·∫ßn su·∫•t quan tr·∫Øc v√† ƒë√°nh gi√° xu h∆∞·ªõng. Chu·∫©n b·ªã k·∫ø ho·∫°ch x·∫£ n∆∞·ªõc n·∫øu m·ª±c n∆∞·ªõc ti·∫øp t·ª•c tƒÉng.';
} else {
  operationRec = 'M·ª±c n∆∞·ªõc ·ªü m·ª©c an to√†n. V·∫≠n h√†nh theo ch·∫ø ƒë·ªô b√¨nh th∆∞·ªùng, duy tr√¨ t·∫ßn su·∫•t quan tr·∫Øc ƒë·ªãnh k·ª≥.';
}

// Add rain context
if (recentRain > 50) {
  operationRec += ' L∆∞·ª£ng m∆∞a l·ªõn g·∫ßn ƒë√¢y c√≥ th·ªÉ l√†m m·ª±c n∆∞·ªõc tƒÉng nhanh.';
} else if (recentRain > 20) {
  operationRec += ' C√≥ m∆∞a v·ª´a ph·∫£i g·∫ßn ƒë√¢y, c·∫ßn theo d√µi xu h∆∞·ªõng m·ª±c n∆∞·ªõc.';
}

// Generate discharge recommendations
let dischargeRec = '';
if (currentLevel >= settings.emergency) {
  dischargeRec = 'X·∫£ n∆∞·ªõc kh·∫©n c·∫•p v·ªõi l∆∞u l∆∞·ª£ng l·ªõn nh·∫•t c√≥ th·ªÉ. ∆Øu ti√™n an to√†n c√¥ng tr√¨nh v√† khu v·ª±c h·∫° du.';
} else if (currentLevel >= settings.danger) {
  dischargeRec = 'B·∫Øt ƒë·∫ßu x·∫£ n∆∞·ªõc v·ªõi l∆∞u l∆∞·ª£ng v·ª´a ph·∫£i, tƒÉng d·∫ßn n·∫øu m·ª±c n∆∞·ªõc ti·∫øp t·ª•c tƒÉng. Th√¥ng b√°o cho c√°c b√™n li√™n quan.';
} else if (currentLevel >= settings.monitor) {
  dischargeRec = 'S·∫µn s√†ng x·∫£ n∆∞·ªõc n·∫øu c·∫ßn thi·∫øt. ƒê√°nh gi√° t√°c ƒë·ªông ƒë·∫øn h·∫° du tr∆∞·ªõc khi quy·∫øt ƒë·ªãnh.';
} else {
  dischargeRec = 'Kh√¥ng c·∫ßn x·∫£ n∆∞·ªõc ·ªü th·ªùi ƒëi·ªÉm hi·ªán t·∫°i. Duy tr√¨ m·ª±c n∆∞·ªõc ·ªü m·ª©c t·ªëi ∆∞u cho v·∫≠n h√†nh.';
}

// Generate attention points
let attentionPointsList = [];

if (currentLevel >= settings.monitor) {
  attentionPointsList.push('M·ª±c n∆∞·ªõc cao, c·∫ßn theo d√µi ch·∫∑t ch·∫Ω');
}

if (recentRain > 30) {
  attentionPointsList.push('L∆∞·ª£ng m∆∞a l·ªõn g·∫ßn ƒë√¢y');
}

if (levelData.length > 1) {
  const trend = levelData[levelData.length - 1] - levelData[levelData.length - 2];
  if (trend > 0.5) {
    attentionPointsList.push('M·ª±c n∆∞·ªõc tƒÉng nhanh');
  }
}

// Add seasonal considerations
const currentMonth = new Date().getMonth() + 1;
if (currentMonth >= 6 && currentMonth <= 10) {
  attentionPointsList.push('M√πa m∆∞a, c·∫ßn ƒë·ªÅ ph√≤ng l≈© l·ª•t');
}

// Update UI
operationRecommendation.textContent = operationRec;
dischargeRecommendation.textContent = dischargeRec;
attentionPoints.textContent = attentionPointsList.length > 0 
  ? `C√°c ƒëi·ªÉm c·∫ßn ch√∫ √Ω: ${attentionPointsList.join(', ')}.` 
  : 'Kh√¥ng c√≥ ƒëi·ªÉm ƒë·∫∑c bi·ªát c·∫ßn ch√∫ √Ω ·ªü th·ªùi ƒëi·ªÉm hi·ªán t·∫°i.';
}

function updatePatternAnalysis(rainData, levelData) {
if (rainData.length === 0 || levelData.length === 0) {
  rainPattern.textContent = 'Kh√¥ng ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ ph√¢n t√≠ch m·∫´u m∆∞a.';
  seasonalPattern.textContent = 'Kh√¥ng ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ ph√¢n t√≠ch m·∫´u theo m√πa.';
  rainCorrelation.textContent = '--';
  seasonalVariation.textContent = '--';
  return;
}

// Analyze rain pattern
const avgRain = rainData.reduce((sum, val) => sum + val, 0) / rainData.length;
const maxRain = Math.max(...rainData);
const rainyDays = rainData.filter(val => val > 0).length;
const rainyDayRatio = (rainyDays / rainData.length) * 100;

rainPattern.textContent = `L∆∞·ª£ng m∆∞a trung b√¨nh ${nf1.format(avgRain)} mm/ng√†y, v·ªõi ${rainyDays} ng√†y c√≥ m∆∞a (${nf1.format(rainyDayRatio)}%). L∆∞·ª£ng m∆∞a l·ªõn nh·∫•t trong k·ª≥ l√† ${nf1.format(maxRain)} mm.`;

// Analyze seasonal pattern
const avgLevel = levelData.reduce((sum, val) => sum + val, 0) / levelData.length;
const minLevel = Math.min(...levelData);
const maxLevel = Math.max(...levelData);
const variation = ((maxLevel - minLevel) / avgLevel) * 100;

seasonalPattern.textContent = `M·ª±c n∆∞·ªõc trung b√¨nh ${nf2.format(avgLevel)} m, dao ƒë·ªông t·ª´ ${nf2.format(minLevel)} m ƒë·∫øn ${nf2.format(maxLevel)} m.`;

// Calculate rain-level correlation
const correlationCoeff = correlation(rainData, levelData.slice(-rainData.length));

// Update UI
rainCorrelation.textContent = nf2.format(correlationCoeff);
seasonalVariation.textContent = `${nf1.format(variation)}%`;

// Update pattern chart
updatePatternChart(rainData, levelData);
}

function updatePatternChart(rainData, levelData) {
const ctx = document.getElementById('patternChart');
if (!ctx) return;

if (patternChart) patternChart.destroy();

const labels = rainData.map((_, i) => `Ng√†y ${i + 1}`);

patternChart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: labels,
    datasets: [
      {
        label: 'L∆∞·ª£ng m∆∞a (mm)',
        data: rainData,
        borderColor: '#3b82f6',
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        borderWidth: 2,
        pointRadius: 3,
        yAxisID: 'yRain',
        tension: 0.1,
        fill: true
      },
      {
        label: 'M·ª±c n∆∞·ªõc (m)',
        data: levelData.slice(-rainData.length),
        borderColor: '#ef4444',
        backgroundColor: 'rgba(239, 68, 68, 0.1)',
        borderWidth: 2,
        pointRadius: 3,
        yAxisID: 'yLevel',
        tension: 0.1,
        fill: true
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: 'top',
      }
    },
    scales: {
      yRain: {
        type: 'linear',
        display: true,
        position: 'left',
        title: {
          display: true,
          text: 'L∆∞·ª£ng m∆∞a (mm)'
        }
      },
      yLevel: {
        type: 'linear',
        display: true,
        position: 'right',
        title: {
          display: true,
          text: 'M·ª±c n∆∞·ªõc (m)'
        },
        grid: {
          drawOnChartArea: false
        }
      },
      x: {
        title: {
          display: true,
          text: 'Th·ªùi gian'
        }
      }
    }
  }
});
}

/* Custom Time Range Events */
btnCustomTime.addEventListener('click', () => {
const isVisible = customTimePanel.style.display !== 'none';
customTimePanel.style.display = isVisible ? 'none' : 'block';
btnCustomTime.innerHTML = isVisible ? '<i class="fas fa-clock"></i> Th·ªùi gian t√πy ch·ªânh' : '<i class="fas fa-times"></i> ƒê√≥ng b·ªô l·ªçc';
});

btnApplyCustom.addEventListener('click', () => {
const fromDate = customFromDate.value;
const toDate = customToDate.value;
if (!fromDate || !toDate) {
  showToast('Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß ng√†y b·∫Øt ƒë·∫ßu v√† ng√†y k·∫øt th√∫c', 'warning', 3000);
  return;
}
const fromTime = customFromTime.value || '00:00:00';
const toTime = customToTime.value || '23:59:59';
customTimeRange = { fromDate, fromTime, toDate, toTime };
yearSel.value = 'all';
quarterSel.value = 'all';
monthSel.value = 'all';
weekSel.value = 'all';
dayNightSel.value = 'all';
applyFiltersCore();
showToast('ƒê√£ √°p d·ª•ng b·ªô l·ªçc th·ªùi gian t√πy ch·ªânh', 'success', 3000);
});

btnClearCustom.addEventListener('click', () => {
customFromDate.value = '';
customFromTime.value = '00:00:00';
customToDate.value = '';
customToTime.value = '23:59:59';
customTimeRange = null;
customTimePanel.style.display = 'none';
btnCustomTime.innerHTML = '<i class="fas fa-clock"></i> Th·ªùi gian t√πy ch·ªânh';
applyFiltersCore();
showToast('ƒê√£ x√≥a b·ªô l·ªçc th·ªùi gian t√πy ch·ªânh', 'info', 3000);
});

/* Filter events */
monthSel.addEventListener('change',()=>{ 
if(monthSel.value!=='all') {
  quarterSel.value='all';
  weekSel.value='all';
}
applyFilters(); 
});

quarterSel.addEventListener('change',()=>{ 
if(quarterSel.value!=='all') {
  monthSel.value='all';
  weekSel.value='all';
}
applyFilters(); 
});

weekSel.addEventListener('change', () => {
if(weekSel.value !== 'all') {
  quarterSel.value = 'all';
  monthSel.value = 'all';
}
applyFilters();
});

dayNightSel.addEventListener('change', applyFilters);
yearSel.addEventListener('change', () => {
if(yearSel.value !== 'all') {
  populateWeeks(allData.filter(r => r.__y === parseInt(yearSel.value)));
} else {
  populateWeeks(allData);
}
applyFilters();
});

/* Initialize data loading on page load */
document.addEventListener('DOMContentLoaded', () => {
// Load data with progressive enhancement
loadDataWithProgressiveEnhancement();

// Set up periodic data refresh (every 5 minutes)
setInterval(() => {
  // Only refresh if page is visible
  if (!document.hidden) {
    fetchFreshDataInBackground();
  }
}, 5 * 60 * 1000);
});

/* Xu·∫•t Excel (to√†n b·ªô d·ªØ li·ªáu sau l·ªçc) */
document.getElementById('btnExcel').addEventListener('click',()=>{
if(!filtered.length){ 
  showToast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t.', 'warning', 3000); 
  return; 
}

showToast('ƒêang chu·∫©n b·ªã xu·∫•t Excel...', 'info', 2000);

const H1=["Ng√†y","Gi·ªù","M·ª±c n∆∞·ªõc (m)","Dung t√≠ch (Tri·ªáu m¬≥)","L∆∞·ª£ng m∆∞a (mm)",
  "Th√¥ng s·ªë v·∫≠n h√†nh tr√†n t·ª± do","",
  "Th√¥ng s·ªë v·∫≠n h√†nh tr√†n s·ª± c·ªë","","","",
  "Th√¥ng s·ªë v·∫≠n h√†nh c·ªëng l·∫•y n∆∞·ªõc","","",
  "H·ªç, t√™n ng∆∞·ªùi v·∫≠n h√†nh","Ch·ªØ k√Ω"];
const H2=["","","","","","H tr√†n (cm)","Q tr√†n t·ª± do (m¬≥/s)",
  "a1 (cm)","a2 (cm)","a3 (cm)","Q tr√†n s·ª± c·ªë (m¬≥/s)",
  "a (cm)","C·ªôt n∆∞·ªõc ƒë·∫ßu k√™nh (m)","Q c·ªëng (m¬≥/s)","",""];
const rows=filtered.map(r=>{
  const d=r.__d, dayTxt=d?fmtDateVN(d):(r.ngayGio?.split(' ')[0]||""), timeTxt=d?fmtTimeVN(d):(r.ngayGio?.split(' ')[1]||"");
  return [dayTxt,timeTxt,num(r.mucNuoc),num(r.dungTich),num(r.luongMua),num(r.hTran),num(r.qTranTuDo),
    num(r.a1),num(r.a2),num(r.a3),num(r.qTranSuCo),num(r.a),num(r.cotNuocDauKenh),num(r.qcong),r.nguoiVanHanh||"",""];
});
const wb=XLSX.utils.book_new();
const ws=XLSX.utils.aoa_to_sheet([H1,H2,...rows]);
ws['!merges']=[
  {s:{r:0,c:0},e:{r:1,c:0}},{s:{r:0,c:1},e:{r:1,c:1}},
  {s:{r:0,c:2},e:{r:1,c:2}},{s:{r:0,c:3},e:{r:1,c:3}},
  {s:{r:0,c:4},e:{r:0,c:6}},
  {s:{r:0,c:7},e:{r:0,c:10}},
  {s:{r:0,c:11},e:{r:0,c:13}},
  {s:{r:0,c:14},e:{r:1,c:14}},
  {s:{r:0,c:15},e:{r:1,c:15}},
];
const allForWidth=[H1,H2,...rows.map(r=>r.map(v=>v==null?"":String(v)))];
ws['!cols']=H1.map((_,ci)=>{
  const maxLen=allForWidth.reduce((m,row)=>Math.max(m,(row[ci]||"").toString().length),0);
  return { wch: Math.min(Math.max(10, maxLen+2), 32) };
});
XLSX.utils.book_append_sheet(wb,ws,"NhatKy_HoNuocNgot");
XLSX.writeFile(wb,"NhatKyVanHanh_HoNuocNgot.xlsx");
function num(v){ const n=Number(v); return Number.isNaN(n)?"":n; }

showToast('ƒê√£ xu·∫•t file Excel th√†nh c√¥ng', 'success', 3000);
});

/* Sidebar Navigation Logic */
menuItems.forEach(item => {
item.addEventListener('click', () => {
  const targetContent = item.dataset.content;
  
  // Remove active class from all menu items and content areas
  menuItems.forEach(i => i.classList.remove('active'));
  contentAreas.forEach(area => area.classList.remove('active'));
  
  // Add active class to clicked menu item and corresponding content area
  item.classList.add('active');
  document.getElementById(`${targetContent}-content`).classList.add('active');
  
  // Close sidebar on mobile after selection
  if (window.innerWidth <= 768) {
    sidebar.classList.remove('open');
  }
  
  // Trigger updates for the specific content
  if (targetContent === 'monitoring') {
    // Re-render table and charts when this tab is activated
    currentPage = 1;
    renderTablePage();
    updateKPIAndCharts();
  } else if (targetContent === 'analysis') {
    // Re-render alert and AI analysis when this tab is activated
    updateAlertSystem();
    updateAIAnalysis();
  }
});
});

/* Mobile Menu Toggle Logic */
menuToggle.addEventListener('click', () => {
sidebar.classList.toggle('open');
});

// Close sidebar when clicking outside on mobile
document.addEventListener('click', (event) => {
const isClickInsideSidebar = sidebar.contains(event.target);
const isClickOnToggle = menuToggle.contains(event.target);
const isMobile = window.innerWidth <= 768;

if (isMobile && !isClickInsideSidebar && !isClickOnToggle && sidebar.classList.contains('open')) {
  sidebar.classList.remove('open');
}
});

// Handle page visibility changes
document.addEventListener('visibilitychange', () => {
if (!document.hidden) {
  // Page became visible again, check if we need to refresh data
  const lastRefreshTime = localStorage.getItem('lastDataRefresh');
  const now = new Date().getTime();
  
  // If it's been more than 5 minutes since last refresh, refresh data
  if (!lastRefreshTime || (now - parseInt(lastRefreshTime)) > 5 * 60 * 1000) {
    showToast('ƒêang l√†m m·ªõi d·ªØ li·ªáu...', 'info', 2000);
    fetchFreshDataInBackground();
  }
}
});

// Network status handling
window.addEventListener('online', () => {
showToast('ƒê√£ k·∫øt n·ªëi l·∫°i m·∫°ng', 'success', 3000);
fetchFreshDataInBackground();
});

window.addEventListener('offline', () => {
showToast('M·∫•t k·∫øt n·ªëi m·∫°ng, ƒëang s·ª≠ d·ª•ng d·ªØ li·ªáu ƒë√£ l∆∞u', 'warning', 5000);
});

// Service Worker registration for offline support (optional)
if ('serviceWorker' in navigator) {
window.addEventListener('load', () => {
  navigator.serviceWorker.register('/sw.js')
    .then(registration => {
      console.log('SW registered: ', registration);
    })
    .catch(registrationError => {
      console.log('SW registration failed: ', registrationError);
    });
});
}

// Update last refresh time
function updateLastRefreshTime() {
localStorage.setItem('lastDataRefresh', new Date().getTime().toString());
}

// Enhanced data loading with cache-first approach
async function loadDataWithCacheFirst() {
try {
  // Show initial loading state
  showLoading(true, 'ƒêang t·∫£i d·ªØ li·ªáu...', 10);
  
  // Initialize IndexedDB
  await initDB();
  
  // Try to get cached data first
  showLoading(true, 'Ki·ªÉm tra cache...', 20);
  const cachedData = await getCachedData();
  
  if (cachedData && cachedData.length > 0) {
    // Process and display cached data immediately
    showLoading(true, 'ƒêang t·∫£i d·ªØ li·ªáu t·ª´ cache...', 40);
    allData = processData(cachedData);
    
    // Populate filters with cached data
    populateYears(allData);
    populateWeeks(allData);
    
    // Apply filters to show cached data immediately
    applyFiltersCore();
    
    // Hide loading overlay
    showLoading(false);
    
    showToast('ƒê√£ t·∫£i d·ªØ li·ªáu t·ª´ cache', 'info', 3000);
    
    // Update last refresh time
    updateLastRefreshTime();
    
    // Continue to fetch fresh data in background
    setTimeout(() => {
      fetchFreshDataInBackground();
    }, 1000);
  } else {
    // No cached data, fetch from server
    fetchFreshData();
  }
} catch (error) {
  console.error('Error loading data with cache-first:', error);
  showLoading(false);
  showToast(`L·ªói t·∫£i d·ªØ li·ªáu: ${error.message}`, 'error', 5000);
  
  // Fallback to direct fetch if IndexedDB fails
  fetchFreshData();
}
}

// Initialize the application
document.addEventListener('DOMContentLoaded', () => {
// Load data with cache-first approach
loadDataWithCacheFirst();

// Set up periodic background refresh (every 5 minutes)
setInterval(() => {
  // Only refresh if page is visible
  if (!document.hidden) {
    fetchFreshDataInBackground();
  }
}, 5 * 60 * 1000);
});

// Performance optimization: Debounce scroll events
let scrollTimeout;
window.addEventListener('scroll', () => {
if (scrollTimeout) {
  window.cancelAnimationFrame(scrollTimeout);
}

scrollTimeout = window.requestAnimationFrame(() => {
  // Handle scroll-based lazy loading if needed in the future
});
});

// Performance optimization: Debounce resize events
let resizeTimeout;
window.addEventListener('resize', () => {
if (resizeTimeout) {
  clearTimeout(resizeTimeout);
}

resizeTimeout = setTimeout(() => {
  // Handle responsive layout changes
  if (comboChart) {
    comboChart.resize();
  }
  if (trendChart) {
    trendChart.resize();
  }
  if (predictionChart) {
    predictionChart.resize();
  }
  if (patternChart) {
    patternChart.resize();
  }
}, 250);
});

// Add keyboard shortcuts for better UX
document.addEventListener('keydown', (event) => {
// Ctrl/Cmd + R: Refresh data
if ((event.ctrlKey || event.metaKey) && event.key === 'r') {
event.preventDefault();
fetchFreshData();
}

// Ctrl/Cmd + E: Export to Excel
if ((event.ctrlKey || event.metaKey) && event.key === 'e') {
event.preventDefault();
document.getElementById('btnExcel').click();
}

// Ctrl/Cmd + P: Print
if ((event.ctrlKey || event.metaKey) && event.key === 'p') {
event.preventDefault();
window.print();
}

// Escape: Close modals
if (event.key === 'Escape') {
if (dashboardSettingsModal.style.display === 'block') {
dashboardSettingsModal.style.display = 'none';
}
if (customTimePanel.style.display === 'block') {
customTimePanel.style.display = 'none';
btnCustomTime.innerHTML = '<i class="fas fa-clock"></i> Th·ªùi gian t√πy ch·ªânh';
}
}
});

// Add accessibility improvements
function addAccessibilityFeatures() {
// Add ARIA labels to interactive elements
document.querySelectorAll('button, .btn').forEach(button => {
if (!button.getAttribute('aria-label')) {
button.setAttribute('aria-label', button.textContent.trim());
}
});

// Add keyboard navigation to menu items
menuItems.forEach((item, index) => {
item.setAttribute('tabindex', '0');

item.addEventListener('keydown', (event) => {
if (event.key === 'Enter' || event.key === ' ') {
  event.preventDefault();
  item.click();
} else if (event.key === 'ArrowDown') {
  event.preventDefault();
  const nextItem = menuItems[(index + 1) % menuItems.length];
  nextItem.focus();
} else if (event.key === 'ArrowUp') {
  event.preventDefault();
  const prevItem = menuItems[(index - 1 + menuItems.length) % menuItems.length];
  prevItem.focus();
}
});
});
}

// Initialize accessibility features
document.addEventListener('DOMContentLoaded', addAccessibilityFeatures);

// Add analytics for performance monitoring (optional)
function trackPerformance() {
if ('performance' in window) {
window.addEventListener('load', () => {
setTimeout(() => {
  const perfData = performance.getEntriesByType('navigation')[0];
  if (perfData) {
    console.log('Page load performance:', {
      loadTime: perfData.loadEventEnd - perfData.loadEventStart,
      domContentLoaded: perfData.domContentLoadedEventEnd - perfData.domContentLoadedEventStart,
      firstPaint: performance.getEntriesByType('paint')[0]?.startTime,
      firstContentfulPaint: performance.getEntriesByType('paint')[1]?.startTime
    });
  }
}, 0);
});
}
}

// Initialize performance tracking
trackPerformance();

// Add error boundary for better error handling
window.addEventListener('error', (event) => {
console.error('Global error:', event.error);
showToast('ƒê√£ x·∫£y ra l·ªói kh√¥ng mong mu·ªën', 'error', 5000);
});

// Add unhandled promise rejection handler
window.addEventListener('unhandledrejection', (event) => {
console.error('Unhandled promise rejection:', event.reason);
showToast('ƒê√£ x·∫£y ra l·ªói kh√¥ng mong mu·ªën', 'error', 5000);
});

// Add feature detection for better browser compatibility
function detectFeatures() {
const features = {
indexedDB: 'indexedDB' in window,
serviceWorker: 'serviceWorker' in navigator,
notification: 'Notification' in window,
localStorage: 'localStorage' in window,
sessionStorage: 'sessionStorage' in window
};

console.log('Browser features:', features);

// Show warning if IndexedDB is not supported
if (!features.indexedDB) {
showToast('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ IndexedDB. M·ªôt s·ªë t√≠nh nƒÉng c√≥ th·ªÉ kh√¥ng ho·∫°t ƒë·ªông.', 'warning', 5000);
}
}

// Initialize feature detection
detectFeatures();

// Add dark mode support (optional enhancement)
function initDarkMode() {
const darkModeQuery = window.matchMedia('(prefers-color-scheme: dark)');

function updateDarkMode(e) {
if (e.matches) {
document.body.classList.add('dark-mode');
} else {
document.body.classList.remove('dark-mode');
}
}

darkModeQuery.addListener(updateDarkMode);
updateDarkMode(darkModeQuery);
}

// Initialize dark mode
initDarkMode();

// Add progressive enhancement for better loading experience
function initProgressiveEnhancement() {
// Show a minimal version of the page while JavaScript loads
document.body.classList.add('js-loading');

window.addEventListener('load', () => {
setTimeout(() => {
document.body.classList.remove('js-loading');
document.body.classList.add('js-loaded');
}, 100);
});
}

// Initialize progressive enhancement
initProgressiveEnhancement();
</script>
</body>
</html>
