<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nh·∫≠t k√Ω v·∫≠n h√†nh h·ªì ch·ª©a n∆∞·ªõc ng·ªçt</title>

  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <!-- @page ƒë·ªông cho in d·ªçc/ngang -->
  <style id="printStyle"></style>

  <style>
    :root{
      --ink:#0f172a;
      --muted:#64748b;
      --brand:#1EA48D;
      --line:#1EA48D;
      --bg:#ffffff;
      --radius:12px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Inter,"Segoe UI",Roboto,Arial,sans-serif;
      color:var(--ink);
      background:#fff;
    }

    /* Toolbar */
    .toolbar{
      position:sticky;
      top:0;
      z-index:20;
      display:flex;
      gap:10px;
      align-items:center;
      padding:10px 16px;
      background:#fff;
      border-bottom:1px solid #e5e7eb;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
    }
    .dot{
      width:10px;
      height:10px;
      border-radius:50%;
      background:var(--brand);
      box-shadow:0 0 0 3px rgba(30,164,141,.15);
    }
    .spacer{ flex:1; }
    .btn{
      appearance:none;
      border-radius:10px;
      padding:8px 14px;
      font-weight:700;
      cursor:pointer;
      border:1px solid #e5e7eb;
      background:#fff;
      transition:.15s;
      font-size:13px;
    }
    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 6px 16px rgba(0,0,0,.06);
    }
    .btn.primary{ background:var(--brand); color:#fff; border-color:var(--brand); }

    /* N√∫t t√¥ m√†u */
    #btnCustomTime{ background:#6f42c1; color:#fff; border-color:#6f42c1; }
    #btnCustomTime:hover{ filter:brightness(.95); }
    #btnExcel{ background:#22c55e; color:#fff; border-color:#22c55e; }
    #btnExcel:hover{ filter:brightness(.95); }
    #btnPortrait{ background:#2563eb; color:#fff; border-color:#2563eb; }
    #btnPortrait:hover{ filter:brightness(.95); }
    #btnLandscape{ background:#8b5cf6; color:#fff; border-color:#8b5cf6; }
    #btnLandscape:hover{ filter:brightness(.95); }

    .sheet{
      width:100%;
      min-height:calc(100vh - 56px);
      padding:20px 16px 24px;
      background:#fff;
    }

    h1{
      margin:0 0 6px;
      text-align:center;
      font-size:22pt;
      line-height:1.25;
      font-weight:900;
      color:#0b1b23;
    }
    .subhead{
      text-align:center;
      font-size:12pt;
      color:var(--muted);
      margin-bottom:12px;
    }

    /* Filters */
    .filters{
      display:flex;
      flex-wrap:wrap;
      gap:10px 14px;
      align-items:center;
      border:1px solid var(--brand);
      border-radius:12px;
      padding:10px 12px;
      background:#f5fffb;
      margin-bottom:12px;
      font-size:13px;
    }
    .filters .label{ font-weight:700; color:#0b1b23; }
    .filters select{
      appearance:none;
      padding:6px 10px;
      border:1px solid var(--brand);
      border-radius:10px;
      background:#fff;
      min-width:120px;
      font-weight:600;
      color:#0b1b23;
      font-size:13px;
    }

    /* Custom Time Panel */
    .custom-time-panel{
      display:none;
      padding:16px;
      background:#f8f9fa;
      border:1px solid #e5e7eb;
      border-radius:10px;
      margin-bottom:10px;
      font-size:13px;
    }
    .custom-time-panel .time-inputs{
      display:flex;
      gap:20px;
      align-items:flex-end;
      flex-wrap:wrap;
    }
    .custom-time-panel .input-group{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .custom-time-panel label{
      font-weight:bold;
      font-size:12px;
    }
    .custom-time-panel input{
      padding:6px 8px;
      border:1px solid #d1d5db;
      border-radius:8px;
      font-size:13px;
    }
    .custom-time-panel button{
      padding:8px 16px;
      border:none;
      border-radius:8px;
      cursor:pointer;
      font-weight:bold;
      font-size:13px;
    }
    #btnApplyCustom{ background:#1EA48D; color:#fff; }
    #btnClearCustom{ background:#6c757d; color:#fff; }

    /* KPI */
    .kpis{
      display:grid;
      gap:12px;
      grid-template-columns: repeat(6, minmax(140px,1fr));
      margin:12px 0 14px;
    }
    .kpi{
      border:1px solid #e5e7eb;
      border-radius:14px;
      padding:12px 12px 10px;
      background:#fff;
      position:relative;
      overflow:hidden;
    }
    .kpi .t{
      font-size:12px;
      color:#475569;
      margin-bottom:6px;
      font-weight:600;
    }
    .kpi .v{
      font-size:18px;
      font-weight:800;
      color:#0b1b23;
    }
    .kpi .s{
      font-size:12px;
      color:#64748b;
    }

    /* KPI pastel */
    .kpis .kpi{ border:1px solid transparent; }
    .kpis .kpi::after{
      content:"";
      position:absolute;
      left:0; right:0; bottom:0;
      height:6px;
    }
    .kpis .kpi:nth-child(1){ background:#EAFBF2; border-color:#BFEED7; }
    .kpis .kpi:nth-child(1)::after{ background:#22c55e; }
    .kpis .kpi:nth-child(2){ background:#ECF3FF; border-color:#D4E2FF; }
    .kpis .kpi:nth-child(2)::after{ background:#3b82f6; }
    .kpis .kpi:nth-child(3){ background:#FFF6E9; border-color:#FFE3BD; }
    .kpis .kpi:nth-child(3)::after{ background:#f59e0b; }
    .kpis .kpi:nth-child(4){ background:#FFEAF4; border-color:#FFD1E6; }
    .kpis .kpi:nth-child(4)::after{ background:#ec4899; }
    .kpis .kpi:nth-child(5){ background:#EEF2FF; border-color:#D9DDFC; }
    .kpis .kpi:nth-child(5)::after{ background:#6366f1; }
    .kpis .kpi:nth-child(6){ background:#EAFDFF; border-color:#CFF6FA; }
    .kpis .kpi:nth-child(6)::after{ background:#06b6d4; }

    /* Charts ‚Äì 1 chart full width */
    .charts{
      display:grid;
      grid-template-columns:minmax(0,1fr);
      gap:16px;
      margin-bottom:14px;
      align-items:stretch;
    }
    .card{
      border:1px solid var(--brand);
      border-radius:14px;
      background:#fff;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:12px;
    }
    .card h3{
      margin:0 0 2px;
      font-size:14pt;
      color:#0b1b23;
    }
    .chart-sub{
      font-size:11px;
      color:#6b7280;
    }
    .chart-legend-hint{
      font-size:11px;
      color:#0f172a;
      text-align:right;
      white-space:nowrap;
    }
    #waterStatus{
      margin:0 0 4px;
      font-weight:600;
      font-size:12px;
      color:#0f172a;
    }
    .chart-box{
      position:relative;
      height: clamp(260px, 34vh, 380px);
    }
    .chart-box canvas{
      position:absolute;
      inset:0;
      width:100% !important;
      height:100% !important;
    }

    /* B·∫£ng */
    .table-wrap{
      border-radius:14px;
      overflow:hidden;
    }
    table{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
      font-size:11pt;
      background:#fff;
      border:2px solid #1EA48D;
    }
    thead th{
      background:#1EA48D;
      color:#000;
      font-weight:800;
      padding:10px 8px;
      border:1px solid #fff;
    }
    tbody td{
      padding:8px 8px;
      text-align:center;
      vertical-align:middle;
      border:1px solid #e5e7eb;
    }
    tbody tr:nth-child(even){ background:#fcfffe; }
    tbody tr:hover{ background:#f2fbf8; }
    .state{
      text-align:center;
      padding:24px;
      color:#64748b;
      font-style:italic;
    }

    th.col-ngay, td.col-ngay{ white-space:nowrap; }
    th.col-gio,  td.col-gio { white-space:nowrap; }

    /* Ph√¢n trang thu g·ªçn */
    .pager{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      justify-content:center;
      margin:14px 0 4px;
      align-items:center;
      font-size:12px;
    }
    .page-btn{
      min-width:34px;
      padding:4px 8px;
      border:1px solid #cbd5e1;
      background:#fff;
      border-radius:10px;
      font-weight:700;
      color:#0b1b23;
      cursor:pointer;
      font-size:12px;
    }
    .page-btn:hover{
      border-color:var(--brand);
      box-shadow:0 2px 8px rgba(0,0,0,.06);
    }
    .page-btn.active{
      background:var(--brand);
      color:#fff;
      border-color:var(--brand);
    }
    .page-btn[disabled]{
      opacity:0.4;
      cursor:not-allowed;
      box-shadow:none;
    }
    .page-ellipsis{
      padding:0 4px;
      color:#94a3b8;
    }
    .pager-info{
      margin-left:4px;
      color:#64748b;
    }

    /* ===== PRINT ===== */
    @media print{
      .toolbar,
      .filters,
      .charts,
      .kpis,
      .pager,
      .custom-time-panel {
        display:none !important;
      }
      table{ border:1.2px solid #000; }
      thead th, tbody td{
        border:1px solid #000 !important;
        padding:4px 6px;
        word-wrap:break-word;
        white-space:normal;
      }
      thead th{
        background:#fff !important;
        color:#000 !important;
        font-weight:800 !important;
      }
      th.col-ngay, td.col-ngay,
      th.col-gio,  td.col-gio{
        white-space:nowrap !important;
      }
      tr{
        page-break-inside:avoid;
        page-break-after:auto;
      }
      col.cw-day  { width:28mm; }
      col.cw-time { width:18mm; }
    }

    /* width c·ªôt tr√™n m√†n h√¨nh */
    col.cw-day  { width:120px; }
    col.cw-time { width:80px; }

    @media (min-width:1400px){
      .sheet{ padding-left:40px; padding-right:40px; }
    }

    @media (max-width:1024px){
      .kpis{
        grid-template-columns:repeat(3,minmax(0,1fr));
      }
    }
    @media (max-width:768px){
      .kpis{
        grid-template-columns:repeat(2,minmax(0,1fr));
      }
      .toolbar{
        justify-content:flex-start;
      }
      .chart-legend-hint{
        white-space:normal;
        text-align:left;
      }
    }
  </style>
</head>
<body>
  <div class="toolbar">
    <div class="brand"><span class="dot"></span>Nh·∫≠t k√Ω v·∫≠n h√†nh ‚Äì H·ªì N∆∞·ªõc Ng·ªçt</div>
    <div class="spacer"></div>
    <button class="btn" id="btnCustomTime">‚è±Ô∏è Th·ªùi gian t√πy ch·ªânh</button>
    <button class="btn" id="btnExcel">Xu·∫•t Excel</button>
    <button class="btn" id="btnPortrait">In d·ªçc</button>
    <button class="btn" id="btnLandscape">In ngang</button>
  </div>

  <div id="printArea" class="sheet">
    <h1>NH·∫¨T K√ù V·∫¨N H√ÄNH H·ªí CH·ª®A N∆Ø·ªöC NG·ªåT</h1>
    <div class="subhead" id="subTitle">Th√°ng ‚Ä¶/‚Ä¶</div>

    <!-- Filters -->
    <div class="filters">
      <span class="label">B·ªô l·ªçc:</span>
      <label for="yearSel">NƒÉm</label>
      <select id="yearSel"><option value="all">T·∫•t c·∫£</option></select>

      <label for="quarterSel">Qu√Ω</label>
      <select id="quarterSel">
        <option value="all">T·∫•t c·∫£</option>
        <option value="1">Qu√Ω 1</option>
        <option value="2">Qu√Ω 2</option>
        <option value="3">Qu√Ω 3</option>
        <option value="4">Qu√Ω 4</option>
      </select>

      <label for="monthSel">Th√°ng</label>
      <select id="monthSel">
        <option value="all">T·∫•t c·∫£</option>
        <script>for(let i=1;i<=12;i++) document.write(`<option value="${i}">Th√°ng ${i}</option>`);</script>
      </select>

      <label for="weekSel">Tu·∫ßn</label>
      <select id="weekSel">
        <option value="all">T·∫•t c·∫£</option>
      </select>

      <label for="dayNightSel">Ng√†y/ƒê√™m</label>
      <select id="dayNightSel">
        <option value="all">T·∫•t c·∫£</option>
        <option value="day">Ng√†y (7h-19h)</option>
        <option value="night">ƒê√™m (19h-7h)</option>
      </select>
    </div>

    <!-- Custom Time Panel -->
    <div class="custom-time-panel" id="customTimePanel">
      <div class="time-inputs">
        <div class="input-group">
          <label>T·ª´ ng√†y:</label>
          <input type="date" id="customFromDate">
        </div>
        <div class="input-group">
          <label>Gi·ªù:ph√∫t:gi√¢y</label>
          <input type="time" id="customFromTime" step="1" value="00:00:00">
        </div>
        <div class="input-group">
          <label>ƒê·∫øn ng√†y:</label>
          <input type="date" id="customToDate">
        </div>
        <div class="input-group">
          <label>Gi·ªù:ph√∫t:gi√¢y</label>
          <input type="time" id="customToTime" step="1" value="23:59:59">
        </div>
        <button id="btnApplyCustom">√Åp d·ª•ng</button>
        <button id="btnClearCustom">X√≥a</button>
      </div>
    </div>

    <!-- KPI -->
    <div class="kpis">
      <div class="kpi">
        <div class="t">T·ªïng l∆∞·ª£ng m∆∞a (k·ª≥ l·ªçc) (mm)</div>
        <div class="v" id="kpiTotalRain">0</div>
      </div>
      <div class="kpi">
        <div class="t">Ng√†y c√≥ m∆∞a / T·ªïng ng√†y</div>
        <div class="v"><span id="kpiRainDays">0</span> / <span id="kpiDays">0</span></div>
      </div>
      <div class="kpi">
        <div class="t">TB theo ng√†y trong k·ª≥ (mm/ng√†y)</div>
        <div class="v" id="kpiAvgPerDay">0</div>
      </div>
      <div class="kpi">
        <div class="t">TB theo ng√†y c√≥ m∆∞a</div>
        <div class="v" id="kpiAvgPerRainy">0</div>
      </div>
      <div class="kpi">
        <div class="t">M∆∞a l·ªõn nh·∫•t (mm)</div>
        <div class="v">
          <span id="kpiMaxRain">0</span>
          <span class="s" id="kpiMaxRainDay"></span>
        </div>
      </div>
      <div class="kpi">
        <div class="t">Q l·ªõn nh·∫•t (m¬≥/s)</div>
        <div class="v"><span id="kpiMaxQ">0</span></div>
      </div>
    </div>

    <!-- Chart g·ªôp m∆∞a + m·ª±c n∆∞·ªõc -->
    <div class="charts">
      <div class="card">
        <div class="card-header">
          <div>
            <h3>Bi·ªÉu ƒë·ªì m∆∞a & m·ª±c n∆∞·ªõc</h3>
            <div class="chart-sub">C·ªôt: l∆∞·ª£ng m∆∞a (mm) ¬∑ ƒê∆∞·ªùng: m·ª±c n∆∞·ªõc (m)</div>
          </div>
          <div class="chart-legend-hint">
            üü¢ an to√†n ¬∑ üü° theo d√µi ¬∑ üü† c·∫£nh b√°o ¬∑ üî¥ nguy hi·ªÉm
          </div>
        </div>
        <div id="waterStatus"></div>
        <div class="chart-box"><canvas id="comboChart"></canvas></div>
      </div>
    </div>

    <!-- B·∫£ng -->
    <div class="table-wrap">
      <table id="grid">
        <colgroup><col class="cw-day"><col class="cw-time"></colgroup>
        <thead>
          <tr>
            <th class="col-ngay" rowspan="2">Ng√†y</th>
            <th class="col-gio"  rowspan="2">Gi·ªù</th>
            <th rowspan="2">M·ª±c n∆∞·ªõc<br>(m)</th>
            <th rowspan="2">Dung t√≠ch<br>(Tri·ªáu m¬≥)</th>
            <th rowspan="2">L∆∞·ª£ng m∆∞a<br>(mm)</th>
            <th colspan="2">Th√¥ng s·ªë v·∫≠n h√†nh tr√†n t·ª± do</th>
            <th colspan="4">Th√¥ng s·ªë v·∫≠n h√†nh tr√†n s·ª± c·ªë</th>
            <th colspan="3">Th√¥ng s·ªë v·∫≠n h√†nh c·ªëng l·∫•y n∆∞·ªõc</th>
            <th rowspan="2" style="min-width:180px">H·ªç, t√™n ng∆∞·ªùi v·∫≠n h√†nh</th>
            <th rowspan="2" style="min-width:140px">Ch·ªØ k√Ω</th>
          </tr>
          <tr>
            <th>H tr√†n<br>(cm)</th>
            <th>Q tr√†n t·ª± do<br>(m¬≥/s)</th>
            <th>a1<br>(cm)</th>
            <th>a2<br>(cm)</th>
            <th>a3<br>(cm)</th>
            <th>Q tr√†n s·ª± c·ªë<br>(m¬≥/s)</th>
            <th>a<br>(cm)</th>
            <th>C·ªôt n∆∞·ªõc ƒë·∫ßu k√™nh<br>(m)</th>
            <th>Q c·ªëng<br>(m¬≥/s)</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td class="state" colspan="16">ƒêang t·∫£i d·ªØ li·ªáu‚Ä¶</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Ph√¢n trang -->
    <div id="pager" class="pager"></div>
  </div>

  <script>
    const EXEC_URL = "https://script.google.com/macros/s/AKfycbxphwCkUk01I8TZ4LI_1bzEW1XdRPLLrGnbYGRkKbt8gJ-rmliZRzp_zoy0GpHhdSEv/exec";
    const API_URL  = `${EXEC_URL}?sheet=HoNuocNgot`;

    const printStyleEl = document.getElementById('printStyle');
    function setPage(size){
      printStyleEl.textContent = `@media print{ @page{ size:${size}; margin:8mm; } }`;
    }
    document.getElementById('btnPortrait').onclick  = () => { setPage('A4 portrait');  window.print(); };
    document.getElementById('btnLandscape').onclick = () => { setPage('A4 landscape'); window.print(); };
    setPage('A4 landscape'); // m·∫∑c ƒë·ªãnh

    const params   = new URLSearchParams(location.search);
    const subTitle = document.getElementById('subTitle');
    
    const yearSel    = document.getElementById('yearSel');
    const quarterSel = document.getElementById('quarterSel');
    const monthSel   = document.getElementById('monthSel');
    const weekSel    = document.getElementById('weekSel');
    const dayNightSel= document.getElementById('dayNightSel');
    const tbody      = document.getElementById('tbody');
    const pager      = document.getElementById('pager');

    // KPI DOM
    const kpiTotalRain   = document.getElementById('kpiTotalRain');
    const kpiRainDays    = document.getElementById('kpiRainDays');
    const kpiDays        = document.getElementById('kpiDays');
    const kpiAvgPerDay   = document.getElementById('kpiAvgPerDay');
    const kpiAvgPerRainy = document.getElementById('kpiAvgPerRainy');
    const kpiMaxRain     = document.getElementById('kpiMaxRain');
    const kpiMaxRainDay  = document.getElementById('kpiMaxRainDay');
    const kpiMaxQ        = document.getElementById('kpiMaxQ');
    const waterStatus    = document.getElementById('waterStatus');

    // Custom time
    const customTimePanel = document.getElementById('customTimePanel');
    const customFromDate  = document.getElementById('customFromDate');
    const customFromTime  = document.getElementById('customFromTime');
    const customToDate    = document.getElementById('customToDate');
    const customToTime    = document.getElementById('customToTime');
    const btnCustomTime   = document.getElementById('btnCustomTime');
    const btnApplyCustom  = document.getElementById('btnApplyCustom');
    const btnClearCustom  = document.getElementById('btnClearCustom');

    let customTimeRange = null;

    const nf0=new Intl.NumberFormat('vi-VN',{maximumFractionDigits:0});
    const nf1=new Intl.NumberFormat('vi-VN',{maximumFractionDigits:1});
    const nf2=new Intl.NumberFormat('vi-VN',{maximumFractionDigits:2});
    const nf3=new Intl.NumberFormat('vi-VN',{maximumFractionDigits:3});

    let allData=[], filtered=[];
    let comboChart;

    /* c·∫•u h√¨nh ph√¢n trang */
    const ROWS_PER_PAGE = 30;
    let currentPage = 1, totalPages = 1;

    const cell=(v,num=false)=>(v==null||v==="")?"‚Äî":(num?nf3.format(Number(v)):v);
    const fmt2=n=>String(n).padStart(2,'0');
    
    function parseVNDateTime(s){
      if(!s||typeof s!=='string')return null;
      const[dpart,tpart='00:00']=s.split(' ');
      const[dd,mm,yyyy]=dpart.split('/').map(n=>parseInt(n,10));
      if(!dd||!mm||!yyyy)return null;
      const[HH='0',MM='0']=tpart.split(':').map(n=>parseInt(n,10));
      const date=new Date(yyyy,mm-1,dd,HH,MM);
      return Number.isNaN(date.getTime())?null:date;
    }
    
    const fmtDateVN=d=>`${fmt2(d.getDate())}/${fmt2(d.getMonth()+1)}/${d.getFullYear()}`;
    const fmtTimeVN=d=>`${fmt2(d.getHours())}:${fmt2(d.getMinutes())}`;

    function getWeekNumber(date) {
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
      const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1)/7);
      return weekNo;
    }
    
    function isDayTime(date) {
      const hour = date.getHours();
      return hour >= 7 && hour < 19;
    }
    
    function isNightTime(date) {
      const hour = date.getHours();
      return hour >= 19 || hour < 7;
    }

    function buildRowHTML(r){
      const dateText=r.__d?fmtDateVN(r.__d):(r.ngayGio?.split(' ')[0]||'‚Äî');
      const timeText=r.__d?fmtTimeVN(r.__d):(r.ngayGio?.split(' ')[1]||'‚Äî');
      return `
        <tr>
          <td class="col-ngay">${cell(dateText)}</td>
          <td class="col-gio">${cell(timeText)}</td>
          <td>${cell(r.mucNuoc,true)}</td>
          <td>${cell(r.dungTich,true)}</td>
          <td>${cell(r.luongMua,true)}</td>
          <td>${cell(r.hTran,true)}</td>
          <td>${cell(r.qTranTuDo,true)}</td>
          <td>${cell(r.a1,true)}</td>
          <td>${cell(r.a2,true)}</td>
          <td>${cell(r.a3,true)}</td>
          <td>${cell(r.qTranSuCo,true)}</td>
          <td>${cell(r.a,true)}</td>
          <td>${cell(r.cotNuocDauKenh,true)}</td>
          <td>${cell(r.qcong,true)}</td>
          <td class="text-left">${cell(r.nguoiVanHanh)}</td>
          <td class="text-left"></td>
        </tr>`;
    }

    function populateYears(list){
      const years=[...new Set(list.map(r=>r.__y).filter(Boolean))].sort((a,b)=>b-a);
      yearSel.innerHTML='<option value="all">T·∫•t c·∫£</option>';
      years.forEach(y=>{
        const op=document.createElement('option');
        op.value=String(y);
        op.textContent=`NƒÉm ${y}`;
        yearSel.appendChild(op);
      });
    }

    function populateWeeks(list) {
      const weeks = new Set();
      list.forEach(r => {
        if (r.__d && r.__y) {
          const weekNum = getWeekNumber(r.__d);
          weeks.add(`${r.__y}-W${String(weekNum).padStart(2, '0')}`);
        }
      });
      
      weekSel.innerHTML = '<option value="all">T·∫•t c·∫£</option>';
      
      [...weeks].sort((a, b) => {
        const [yearA, weekA] = a.split('-W').map(v => parseInt(v, 10));
        const [yearB, weekB] = b.split('-W').map(v => parseInt(v, 10));
        if (yearA !== yearB) return yearB - yearA;
        return weekB - weekA;
      }).forEach(w => {
        const op = document.createElement('option');
        op.value = w;
        const [year, week] = w.split('-W');
        op.textContent = `Tu·∫ßn ${parseInt(week, 10)} (${year})`;
        weekSel.appendChild(op);
      });
    }

    /* Ph√¢n trang thu g·ªçn */
    function renderPager(){
      totalPages = Math.max(1, Math.ceil(filtered.length / ROWS_PER_PAGE));
      if(currentPage > totalPages) currentPage = totalPages;

      const createBtn = (label, page, disabled = false) =>
        `<button class="page-btn ${page===currentPage && !disabled ? 'active' : ''}" data-p="${page}" ${disabled?'disabled':''}>${label}</button>`;

      const createNum = (p) => createBtn(p, p, false);

      let html = '';

      // prev
      html += createBtn('¬´', Math.max(1, currentPage - 1), currentPage === 1);

      const maxNumbers = 7;
      if (totalPages <= maxNumbers){
        for(let p=1;p<=totalPages;p++){
          html += createNum(p);
        }
      } else {
        html += createNum(1);

        let start = Math.max(2, currentPage - 1);
        let end   = Math.min(totalPages - 1, currentPage + 1);

        if (start > 2){
          html += `<span class="page-ellipsis">‚Ä¶</span>`;
        }

        for(let p=start; p<=end; p++){
          html += createNum(p);
        }

        if (end < totalPages - 1){
          html += `<span class="page-ellipsis">‚Ä¶</span>`;
        }

        html += createNum(totalPages);
      }

      // next
      html += createBtn('¬ª', Math.min(totalPages, currentPage + 1), currentPage === totalPages);

      html += `<span class="pager-info">Trang ${currentPage}/${totalPages}</span>`;

      pager.innerHTML = html;

      pager.querySelectorAll('.page-btn').forEach(b=>{
        b.addEventListener('click', e => {
          const p = Number(e.currentTarget.dataset.p);
          if (!Number.isNaN(p) && p >= 1 && p <= totalPages && p !== currentPage){
            currentPage = p;
            renderTablePage();
          }
        });
      });
    }

    function renderTablePage(){
      if(!filtered.length){
        tbody.innerHTML = `<tr><td class="state" colspan="16">Kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>`;
        renderPager();
      } else {
        const start = (currentPage-1)*ROWS_PER_PAGE;
        const end   = start + ROWS_PER_PAGE;
        const rowsHTML = filtered.slice(start, end).map(r=>r.__rowHTML).join('');
        tbody.innerHTML = rowsHTML || `<tr><td class="state" colspan="16">Kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>`;
        renderPager();
      }
    }

    function updateSubtitle() {
      if (customTimeRange) {
        const { fromDate, fromTime, toDate, toTime } = customTimeRange;
        subTitle.textContent = `T·ª´ ${fromDate} ${fromTime || '00:00:00'} ƒë·∫øn ${toDate} ${toTime || '23:59:59'}`;
      } else if (weekSel.value !== 'all') {
        const [year, week] = weekSel.value.split('-W');
        subTitle.textContent = `Tu·∫ßn ${parseInt(week, 10)} nƒÉm ${year}`;
      } else if (dayNightSel.value !== 'all') {
        const label = dayNightSel.value === 'day' ? 'Ng√†y (7h-19h)' : 'ƒê√™m (19h-7h)';
        if (yearSel.value !== 'all' && monthSel.value !== 'all') {
          subTitle.textContent = `${label} - Th√°ng ${monthSel.value} nƒÉm ${yearSel.value}`;
        } else if (yearSel.value !== 'all') {
          subTitle.textContent = `${label} - NƒÉm ${yearSel.value}`;
        } else {
          subTitle.textContent = label;
        }
      } else if (!params.get('thang')) {
        const y=yearSel.value, m=monthSel.value, q=quarterSel.value;
        let sub='';
        if(m!=='all'&&y!=='all') sub=`Th√°ng ${m} nƒÉm ${y}`;
        else if(q!=='all'&&y!=='all') sub=`Qu√Ω ${q} nƒÉm ${y}`;
        else if(y!=='all') sub=`NƒÉm ${y}`;
        else{
          const c=new Date();
          sub=`Th√°ng ${c.getMonth()+1} nƒÉm ${c.getFullYear()}`;
        }
        subTitle.textContent=sub;
      }
    }

    function applyFiltersCore(){
      const y=yearSel.value, q=quarterSel.value, m=monthSel.value;
      const w=weekSel.value, dn=dayNightSel.value;
      
      filtered=allData
        .filter(r=>r.__d)
        .filter(r=>{
          if (customTimeRange) {
            const { fromDate, fromTime, toDate, toTime } = customTimeRange;
            const fromDateTime = new Date(`${fromDate}T${fromTime || '00:00:00'}`);
            const toDateTime = new Date(`${toDate}T${toTime || '23:59:59'}`);
            if (r.__d < fromDateTime || r.__d > toDateTime) return false;
          }
          if (w !== 'all') {
            const weekNum = getWeekNumber(r.__d);
            const rowWeek = `${r.__y}-W${String(weekNum).padStart(2, '0')}`;
            if (rowWeek !== w) return false;
          }
          if (dn !== 'all') {
            if (dn === 'day' && !isDayTime(r.__d)) return false;
            if (dn === 'night' && !isNightTime(r.__d)) return false;
          }
          if (y!=='all' && String(r.__y)!==String(y)) return false;
          if (m!=='all') return r.__m===Number(m);
          if (q!=='all') return r.__q===Number(q);
          return true;
        })
        .sort((a,b)=>a.__d-b.__d);

      updateSubtitle();

      currentPage = 1;
      renderTablePage();
      updateKPIAndCharts();
    }
    
    const debounce=(fn,d=80)=>{ let t; return(...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),d); }; };
    const applyFilters=debounce(applyFiltersCore,80);

    /* ti·ªán √≠ch l√†m tr√≤n tr·ª•c Y */
    const niceCeil  = (v, step) => (v<=0?0:Math.ceil(v/step)*step);
    const niceFloor = (v, step) => Math.floor(v/step)*step;

    /* Plugin t√¥ nhi·ªÅu v√πng c·∫£nh b√°o tr√™n tr·ª•c m·ª±c n∆∞·ªõc */
    const levelBandsPlugin = {
      id: 'levelBands',
      beforeDraw(chart, args, opts) {
        const bands = opts && opts.bands;
        if (!bands || !bands.length) return;
        const yScale = chart.scales['yLevel'];
        if (!yScale) return;
        const {ctx, chartArea} = chart;
        ctx.save();
        bands.forEach(b=>{
          if (b.from == null || b.to == null) return;
          const y1 = yScale.getPixelForValue(b.from);
          const y2 = yScale.getPixelForValue(b.to);
          const top = Math.min(y1, y2);
          const bottom = Math.max(y1, y2);
          const clippedTop = Math.max(chartArea.top, top);
          const clippedBottom = Math.min(chartArea.bottom, bottom);
          if (clippedBottom <= clippedTop) return;
          ctx.fillStyle = b.color || 'rgba(0,0,0,0.05)';
          ctx.fillRect(chartArea.left, clippedTop, chartArea.right - chartArea.left, clippedBottom - clippedTop);
        });
        ctx.restore();
      }
    };
    Chart.register(levelBandsPlugin);

    function updateKPIAndCharts(){
      const rainByDay=new Map();
      const levelByDay=new Map();
      let maxQTotal=0;

      filtered.forEach(r=>{
        const d=r.__d;
        const key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        rainByDay.set(key,(rainByDay.get(key)||0)+(Number(r.luongMua)||0));
        const lvl=Number(r.mucNuoc); 
        if(!Number.isNaN(lvl)) levelByDay.set(key,lvl);
        const qtd=(Number(r.qTranTuDo)||0)+(Number(r.qTranSuCo)||0);
        if(qtd>maxQTotal) maxQTotal=qtd;
      });

      const dayKeys=[...new Set([...rainByDay.keys(),...levelByDay.keys()])].sort();
      const labelsDM=dayKeys.map(k=>{ const[y,m,d]=k.split('-'); return `${d}/${m}`; });
      const rainDaily=dayKeys.map(k=>rainByDay.get(k)||0);
      const levelDaily=dayKeys.map(k=> (levelByDay.has(k)?levelByDay.get(k):null) );

      /* KPI */
      const total=rainDaily.reduce((a,b)=>a+(Number(b)||0),0);
      const days=rainDaily.length;
      const rainyDays=rainDaily.filter(v=>Number(v)>0).length;
      const avgPerDay       = days       ? total/days       : 0;
      const avgPerRainyDay  = rainyDays  ? total/rainyDays  : 0;

      let maxVal=0, maxIdx=-1;
      for(let i=0;i<rainDaily.length;i++){
        const v=Number(rainDaily[i])||0;
        if(v>maxVal){maxVal=v; maxIdx=i;}
      }
      const maxDayLabel=maxIdx>=0?labelsDM[maxIdx]:'';

      kpiTotalRain.textContent   = nf1.format(total);
      kpiDays.textContent        = nf0.format(days);
      kpiRainDays.textContent    = nf0.format(rainyDays);
      kpiAvgPerDay.textContent   = nf2.format(avgPerDay);
      kpiAvgPerRainy.textContent = nf2.format(avgPerRainyDay);
      kpiMaxRain.textContent     = nf1.format(maxVal);
      kpiMaxRainDay.textContent  = maxDayLabel?`(${maxDayLabel})`:'';
      kpiMaxQ.textContent        = nf2.format(maxQTotal);

      /* C√°c ng∆∞·ª°ng m·ª±c n∆∞·ªõc:
         - DEAD       = 50,60 m (MN ch·∫øt)
         - LVL_YELLOW = 58,78 m (MN d√¢ng b√¨nh th∆∞·ªùng)
         - LVL_ORANGE = 59,77 m (g·∫ßn MN d√¢ng gia c∆∞·ªùng ‚Äì c·∫£nh b√°o cao)
         - LVL_RED    = 60,76 m (MN d√¢ng gia c∆∞·ªùng thi·∫øt k·∫ø ‚Äì r·∫•t nguy hi·ªÉm)
      */
      const DEAD        = 50.6;
      const LVL_YELLOW  = 58.78;
      const LVL_ORANGE  = 59.77;
      const LVL_RED     = 60.76;

      const deadLine = dayKeys.map(()=>DEAD);

      const maxRain = Math.max(0, ...rainDaily);
      const stepRain = maxRain > 50 ? 10 : 5;
      const yMaxRain = niceCeil(maxRain, stepRain);

      const lvlVals = levelDaily.filter(v=>v!=null && !Number.isNaN(v));
      const lvlMin = lvlVals.length ? Math.min(...lvlVals) : 0;
      const lvlMax = lvlVals.length ? Math.max(...lvlVals) : 1;
      const pad = 0.1;
      const yMinLvl = niceFloor(Math.max(0, lvlMin - pad), 0.2);
      const yMaxLvl = niceCeil(lvlMax + pad, 0.2);

      if(comboChart) comboChart.destroy();
      const ctx = document.getElementById('comboChart').getContext('2d');

      const gradient = ctx.createLinearGradient(0,0,0,ctx.canvas.height);
      gradient.addColorStop(0,'rgba(30,164,141,0.30)');
      gradient.addColorStop(1,'rgba(30,164,141,0.00)');

      comboChart = new Chart(ctx,{
        type:'bar',
        data:{
          labels:labelsDM,
          datasets:[
            {
              type:'bar',
              label:'L∆∞·ª£ng m∆∞a (mm)',
              data:rainDaily,
              yAxisID:'yRain',
              backgroundColor:'rgba(56,189,248,0.55)',
              borderRadius:4,
              maxBarThickness:32
            },
            {
              type:'line',
              label:'M·ª±c n∆∞·ªõc (m)',
              data:levelDaily,
              yAxisID:'yLevel',
              spanGaps:true,
              borderColor:'#1EA48D',
              backgroundColor:gradient,
              tension:0.35,
              borderWidth:2.4,
              pointRadius:3,
              pointHoverRadius:5,
              pointBackgroundColor:(ctxPoint)=>{
                const v = ctxPoint.raw;
                if(v==null || Number.isNaN(v)) return '#1EA48D';
                if(v>=LVL_RED)    return '#b91c1c'; // ƒë·ªè
                if(v>=LVL_ORANGE) return '#ea580c'; // cam
                if(v>=LVL_YELLOW) return '#eab308'; // v√†ng
                return '#1EA48D';                  // an to√†n
              },
              pointBorderColor:'#ffffff',
              fill:true
            },
            {
              type:'line',
              label:'M·ª±c n∆∞·ªõc ch·∫øt (50,6 m)',
              data:deadLine,
              yAxisID:'yLevel',
              borderColor:'rgba(148,163,184,0.9)',
              borderDash:[6,4],
              borderWidth:1.4,
              pointRadius:0,
              fill:false
            }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            legend:{
              display:true,
              position:'bottom',
              labels:{ usePointStyle:true, boxWidth:10, padding:16 }
            },
            tooltip:{
              mode:'index',
              intersect:false,
              callbacks:{
                label(ctx){
                  const v = ctx.parsed.y;
                  if(ctx.datasetIndex === 0){
                    return `L∆∞·ª£ng m∆∞a: ${v.toFixed(1)} mm`;
                  }else if(ctx.datasetIndex === 1){
                    return `M·ª±c n∆∞·ªõc: ${v.toFixed(2)} m`;
                  }
                  return `M·ª±c n∆∞·ªõc ch·∫øt: ${DEAD.toFixed(2)} m`;
                }
              }
            },
            levelBands:{
              bands:[
                { from: LVL_YELLOW, to: LVL_ORANGE, color:'rgba(250,204,21,0.18)' }, // v√†ng
                { from: LVL_ORANGE, to: LVL_RED,   color:'rgba(249,115,22,0.18)' }, // cam
                { from: LVL_RED,    to: yMaxLvl,   color:'rgba(248,113,113,0.20)' } // ƒë·ªè
              ]
            }
          },
          interaction:{ mode:'nearest', intersect:false },
          scales:{
            x:{
              grid:{ display:false },
              ticks:{
                maxTicksLimit: Math.min(12, labelsDM.length),
                autoSkip:true,
                maxRotation:0
              }
            },
            yRain:{
              position:'left',
              beginAtZero:true,
              suggestedMax:yMaxRain,
              ticks:{ stepSize:stepRain },
              grid:{ color:'rgba(148,163,184,0.20)' },
              title:{ display:true, text:'L∆∞·ª£ng m∆∞a (mm)' }
            },
            yLevel:{
              position:'right',
              beginAtZero:false,
              suggestedMin:yMinLvl,
              suggestedMax:yMaxLvl,
              grid:{ drawOnChartArea:false },
              title:{ display:true, text:'M·ª±c n∆∞·ªõc (m)' }
            }
          }
        }
      });

      // m√¥ t·∫£ m·ª±c n∆∞·ªõc g·∫ßn nh·∫•t so v·ªõi MN ch·∫øt + v√πng m√†u so v·ªõi MN d√¢ng BT / gia c∆∞·ªùng
      let lastVal=null; 
      for(let i=levelDaily.length-1;i>=0;i--){
        if(levelDaily[i]!=null){
          lastVal=levelDaily[i];
          break;
        }
      }
      if(lastVal==null || Number.isNaN(lastVal)){
        waterStatus.textContent='Kh√¥ng c√≥ d·ªØ li·ªáu m·ª±c n∆∞·ªõc.';
      }else{
        let baseText;
        if(lastVal>=DEAD){
          baseText = `M·ª±c n∆∞·ªõc g·∫ßn nh·∫•t ${lastVal.toFixed(2)} m ‚Äî CAO H∆†N m·ª±c n∆∞·ªõc ch·∫øt ${(lastVal-DEAD).toFixed(2)} m`;
        }else{
          baseText = `M·ª±c n∆∞·ªõc g·∫ßn nh·∫•t ${lastVal.toFixed(2)} m ‚Äî TH·∫§P H∆†N m·ª±c n∆∞·ªõc ch·∫øt ${(DEAD-lastVal).toFixed(2)} m`;
        }

        let zoneText;
        if(lastVal < DEAD){
          zoneText = 'd∆∞·ªõi MN ch·∫øt, d∆∞·ªõi v√πng l√†m vi·ªác b√¨nh th∆∞·ªùng';
        }else if(lastVal < LVL_YELLOW){
          zoneText = 'V√ôNG AN TO√ÄN ‚Äì d∆∞·ªõi MN d√¢ng b√¨nh th∆∞·ªùng (58,78 m)';
        }else if(lastVal < LVL_ORANGE){
          zoneText = 'V√ôNG V√ÄNG ‚Äì quanh MN d√¢ng b√¨nh th∆∞·ªùng (58,78 m), c·∫ßn theo d√µi';
        }else if(lastVal < LVL_RED){
          zoneText = 'V√ôNG CAM ‚Äì gi·ªØa MN d√¢ng b√¨nh th∆∞·ªùng v√† MN d√¢ng gia c∆∞·ªùng (60,76 m), c·∫£nh b√°o cao';
        }else{
          zoneText = 'V√ôNG ƒê·ªé ‚Äì x·∫•p x·ªâ ho·∫∑c v∆∞·ª£t MN d√¢ng gia c∆∞·ªùng thi·∫øt k·∫ø (60,76 m), r·∫•t nguy hi·ªÉm';
        }

        waterStatus.textContent = `${baseText} ¬∑ Tr·∫°ng th√°i: ${zoneText}.`;
      }
    }

    /* Custom Time Range Events */
    btnCustomTime.addEventListener('click', () => {
      const isVisible = customTimePanel.style.display !== 'none';
      customTimePanel.style.display = isVisible ? 'none' : 'block';
      btnCustomTime.textContent = isVisible ? '‚è±Ô∏è Th·ªùi gian t√πy ch·ªânh' : '‚è±Ô∏è ƒê√≥ng b·ªô l·ªçc';
    });

    btnApplyCustom.addEventListener('click', () => {
      const fromDate = customFromDate.value;
      const toDate = customToDate.value;
      if (!fromDate || !toDate) {
        alert('Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß ng√†y b·∫Øt ƒë·∫ßu v√† ng√†y k·∫øt th√∫c');
        return;
      }
      const fromTime = customFromTime.value || '00:00:00';
      const toTime = customToTime.value || '23:59:59';
      customTimeRange = { fromDate, fromTime, toDate, toTime };
      yearSel.value = 'all';
      quarterSel.value = 'all';
      monthSel.value = 'all';
      weekSel.value = 'all';
      dayNightSel.value = 'all';
      applyFiltersCore();
    });

    btnClearCustom.addEventListener('click', () => {
      customFromDate.value = '';
      customFromTime.value = '00:00:00';
      customToDate.value = '';
      customToTime.value = '23:59:59';
      customTimeRange = null;
      customTimePanel.style.display = 'none';
      btnCustomTime.textContent = '‚è±Ô∏è Th·ªùi gian t√πy ch·ªânh';
      applyFiltersCore();
    });

    /* Filter events */
    monthSel.addEventListener('change',()=>{ 
      if(monthSel.value!=='all') {
        quarterSel.value='all';
        weekSel.value='all';
      }
      applyFilters(); 
    });
    
    quarterSel.addEventListener('change',()=>{ 
      if(quarterSel.value!=='all') {
        monthSel.value='all';
        weekSel.value='all';
      }
      applyFilters(); 
    });
    
    weekSel.addEventListener('change', () => {
      if(weekSel.value !== 'all') {
        quarterSel.value = 'all';
        monthSel.value = 'all';
      }
      applyFilters();
    });
    
    dayNightSel.addEventListener('change', applyFilters);
    yearSel.addEventListener('change', () => {
      if(yearSel.value !== 'all') {
        populateWeeks(allData.filter(r => r.__y === parseInt(yearSel.value)));
      } else {
        populateWeeks(allData);
      }
      applyFilters();
    });

    /* fetch data */
    fetch(API_URL,{ cache:'no-store' })
      .then(res=>res.ok?res.json():Promise.reject(new Error(`HTTP ${res.status}`)))
      .then(data=>{
        if(!Array.isArray(data)||!data.length){ 
          tbody.innerHTML=`<tr><td class="state" colspan="16">Kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>`; 
          return; 
        }
        allData=data.map(r=>{
          const d=parseVNDateTime(r.ngayGio);
          const y=d?d.getFullYear():null, m=d?(d.getMonth()+1):null, q=d?(Math.floor((m-1)/3)+1):null;
          const base={...r,__d:d,__y:y,__m:m,__q:q}; 
          base.__rowHTML=buildRowHTML(base); 
          return base;
        });
        populateYears(allData);
        populateWeeks(allData);
        
        if (params.get('thang') && params.get('nam')) {
          subTitle.textContent = `Th√°ng ${params.get('thang')} nƒÉm ${params.get('nam')}`;
        } else if (params.get('thang')) {
          subTitle.textContent = `Th√°ng ${params.get('thang')}`;
        }
        
        applyFiltersCore();
      })
      .catch(err=>{
        console.error(err);
        tbody.innerHTML=`<tr><td class="state" colspan="16">L·ªói t·∫£i d·ªØ li·ªáu: ${err.message||err}</td></tr>`;
      });

    /* Xu·∫•t Excel (to√†n b·ªô d·ªØ li·ªáu sau l·ªçc) */
    document.getElementById('btnExcel').addEventListener('click',()=>{
      if(!filtered.length){ alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t.'); return; }
      const H1=["Ng√†y","Gi·ªù","M·ª±c n∆∞·ªõc (m)","Dung t√≠ch (Tri·ªáu m¬≥)","L∆∞·ª£ng m∆∞a (mm)",
        "Th√¥ng s·ªë v·∫≠n h√†nh tr√†n t·ª± do","",
        "Th√¥ng s·ªë v·∫≠n h√†nh tr√†n s·ª± c·ªë","","","",
        "Th√¥ng s·ªë v·∫≠n h√†nh c·ªëng l·∫•y n∆∞·ªõc","","",
        "H·ªç, t√™n ng∆∞·ªùi v·∫≠n h√†nh","Ch·ªØ k√Ω"];
      const H2=["","","","","","H tr√†n (cm)","Q tr√†n t·ª± do (m¬≥/s)",
        "a1 (cm)","a2 (cm)","a3 (cm)","Q tr√†n s·ª± c·ªë (m¬≥/s)",
        "a (cm)","C·ªôt n∆∞·ªõc ƒë·∫ßu k√™nh (m)","Q c·ªëng (m¬≥/s)","",""];
      const rows=filtered.map(r=>{
        const d=r.__d, dayTxt=d?fmtDateVN(d):(r.ngayGio?.split(' ')[0]||""), timeTxt=d?fmtTimeVN(d):(r.ngayGio?.split(' ')[1]||"");
        return [dayTxt,timeTxt,num(r.mucNuoc),num(r.dungTich),num(r.luongMua),num(r.hTran),num(r.qTranTuDo),
          num(r.a1),num(r.a2),num(r.a3),num(r.qTranSuCo),num(r.a),num(r.cotNuocDauKenh),num(r.qcong),r.nguoiVanHanh||"",""];
      });
      const wb=XLSX.utils.book_new();
      const ws=XLSX.utils.aoa_to_sheet([H1,H2,...rows]);
      ws['!merges']=[
        {s:{r:0,c:0},e:{r:1,c:0}},{s:{r:0,c:1},e:{r:1,c:1}},
        {s:{r:0,c:2},e:{r:1,c:2}},{s:{r:0,c:3},e:{r:1,c:3}},
        {s:{r:0,c:4},e:{r:1,c:4}},
        {s:{r:0,c:5},e:{r:0,c:6}},
        {s:{r:0,c:7},e:{r:0,c:10}},
        {s:{r:0,c:11},e:{r:0,c:13}},
        {s:{r:0,c:14},e:{r:1,c:14}},
        {s:{r:0,c:15},e:{r:1,c:15}},
      ];
      const allForWidth=[H1,H2,...rows.map(r=>r.map(v=>v==null?"":String(v)))];
      ws['!cols']=H1.map((_,ci)=>{
        const maxLen=allForWidth.reduce((m,row)=>Math.max(m,(row[ci]||"").toString().length),0);
        return { wch: Math.min(Math.max(10, maxLen+2), 32) };
      });
      XLSX.utils.book_append_sheet(wb,ws,"NhatKy_HoNuocNgot");
      XLSX.writeFile(wb,"NhatKyVanHanh_HoNuocNgot.xlsx");
      function num(v){ const n=Number(v); return Number.isNaN(n)?"":n; }
    });
  </script>
</body>
</html>
