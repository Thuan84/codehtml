<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Nh·∫≠t k√Ω v·∫≠n h√†nh h·ªì ch·ª©a - H·ªì Th√†nh S∆°n</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --header-bg:#1EA48D; --border-color:#e5e7eb; --hover-bg:#f1f3f5; --card-bg:#ffffff;
      --teal:#1EA48D; --blue:#2563eb; --indigo:#4f46e5; --purple:#7c3aed; --orange:#ea580c;
      --zone-safe:#22c55e; --zone-yellow:#eab308; --zone-orange:#f97316; --zone-red:#ef4444;
      --sidebar-width: 280px;
      --sidebar-bg: #f8fafc;
      --sidebar-active: #e2e8f0;
      --sidebar-text: #334155;
      --sidebar-hover: #cbd5e1;
    }
    html, body { height:100%; margin:0; padding:0; }
    body{
      font-family:"Times New Roman",Times,serif; background:#fff; color:#0f172a;
      font-size:14pt;
      display: flex;
      overflow: hidden;
    }
    
    /* ===== SIDEBAR ===== */
    .sidebar {
      width: var(--sidebar-width);
      background-color: var(--sidebar-bg);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow-y: auto;
      transition: transform 0.3s ease, margin-left 0.3s ease;
      z-index: 100;
    }
    
    .sidebar.hidden {
      margin-left: calc(-1 * var(--sidebar-width));
    }
    
    .sidebar-header {
      padding: 15px;
      background-color: var(--header-bg);
      color: white;
      text-align: center;
      font-weight: bold;
      font-size: 16pt;
    }
    
    .sidebar-menu {
      flex-grow: 1;
      padding: 10px 0;
    }
    
    .menu-item {
      padding: 12px 20px;
      cursor: pointer;
      transition: background-color 0.2s;
      border-left: 3px solid transparent;
    }
    
    .menu-item:hover {
      background-color: var(--sidebar-hover);
    }
    
    .menu-item.active {
      background-color: var(--sidebar-active);
      border-left: 3px solid var(--header-bg);
      font-weight: bold;
    }
    
    .menu-item-title {
      display: flex;
      align-items: center;
    }
    
    .menu-item-icon {
      margin-right: 10px;
    }
    
    /* ===== MAIN CONTENT ===== */
    .main-content {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
      transition: margin-left 0.3s ease;
    }
    
    .main-content.expanded {
      margin-left: 0;
    }
    
    .content-header {
      padding: 15px 20px;
      background-color: var(--header-bg);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header-left {
      display: flex;
      align-items: center;
    }
    
    .sidebar-toggle-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 4px;
      color: white;
      cursor: pointer;
      font-size: 16px;
      margin-right: 15px;
      padding: 8px;
      transition: background-color 0.2s;
    }
    
    .sidebar-toggle-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .content-body {
      flex-grow: 1;
      padding: 20px;
      overflow-y: auto;
      display: none;
    }
    
    .content-body.active {
      display: block;
    }
    
    .container{
      width:100%; max-width:none; margin:0; background:#fff; padding:0;
      box-sizing:border-box;
    }
    .fullpage .container{ padding:12px 16px; }

    h1{ font-size:16pt; font-weight:bold; text-align:center; text-transform:uppercase; margin:4px 0 6px 0; }
    .subtitle{ text-align:center; font-weight:bold; font-size:14pt; margin:0 0 10px 0; }

    .controls-container{
      display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;
      gap:12px; margin:0 0 10px 0; padding:10px; background:#fdfdff; border-radius:10px; border:1px solid #e5e7eb;
    }
    .filters,.exports{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .filters label{ font-weight:bold; }
    .filters select,.exports button{
      padding:8px 12px; border-radius:8px; border:1px solid #d1d5db; background:#fff;
      font-family:"Times New Roman",Times,serif; font-size:13pt; cursor:pointer;
    }
    .exports button{ font-weight:bold; color:#fff; border:none; transition:transform .08s ease, opacity .2s; }
    .exports button:hover{ opacity:.95; transform: translateY(-1px); }
    #toggle-custom-time{ background:#6f42c1; }
    #export-excel{ background:#218838; }
    #print-page{ background:#c82333; }
    #toggle-fullscreen{ background:#0b5ed7; }

    /* ===== Metrics ===== */
    .metrics{
      display:grid; grid-template-columns: repeat(7, minmax(180px,1fr));
      gap:12px; margin:0 0 8px 0;
    }
    .metric{
      position:relative; overflow:hidden;
      background: linear-gradient(180deg, #ffffff, #fafafa);
      border:1px solid rgba(15,23,42,.06);
      border-radius:14px; padding:16px 14px;
      box-shadow: 0 6px 14px rgba(2,8,23,.06);
      display:flex; flex-direction:column; gap:8px;
      isolation:isolate;
      align-items:center;
      text-align:center;
    }
    .metric::before{
      content:""; position:absolute; inset:-40% -20% auto auto; height:180px; width:280px;
      border-radius:50%;
      background: var(--accent-fade, rgba(30,164,141,.10));
      filter: blur(18px);
      z-index:-1;
    }
    .metric::after{
      content:""; position:absolute; left:0; top:0; bottom:0; width:5px;
      background: var(--accent, #1EA48D); opacity:.9;
    }
    .metric .label{ font-size:12pt; color:#334155; font-weight:700; letter-spacing:.2px; line-height:1.25; }
    .metric .value{
      font-size:24pt; font-weight:800; color:#0f172a; line-height:1.1;
      font-variant-numeric: tabular-nums; word-break:break-word;
    }
    .m-current-level{ --accent:var(--blue);   --accent-fade: rgba(37,99,235,.12); }
    .m-current-volume{ --accent:var(--indigo); --accent-fade: rgba(79,70,229,.12); }
    .m-current-rain{ --accent:var(--purple);  --accent-fade: rgba(124,58,237,.12); }
    .m-total{ --accent:var(--teal);   --accent-fade: rgba(30,164,141,.12); }
    .m-ratio{ --accent:var(--blue);   --accent-fade: rgba(37,99,235,.12); }
    .m-avg-d{ --accent:var(--indigo); --accent-fade: rgba(79,70,229,.12); }
    .m-max  { --accent:var(--orange); --accent-fade: rgba(234,88,12,.12); }

    /* ===== Alert System ===== */
    .alert-container {
      margin-bottom: 15px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .alert-header {
      padding: 10px 15px;
      font-weight: bold;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .alert-content {
      padding: 15px;
      background: #f8f9fa;
    }
    .alert-normal { background: #22c55e; }
    .alert-warning { background: #eab308; }
    .alert-danger { background: #ef4444; }
    .alert-critical { background: #7c3aed; }
    
    .water-level-indicator {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .water-level-bar {
      flex-grow: 1;
      height: 30px;
      background: linear-gradient(to right, #22c55e, #eab308, #f97316, #ef4444, #7c3aed);
      border-radius: 15px;
      position: relative;
      margin: 0 15px;
    }
    .water-level-marker {
      position: absolute;
      top: -5px;
      width: 4px;
      height: 40px;
      background: #0f172a;
      border-radius: 2px;
      transform: translateX(-50%);
      transition: left 0.5s ease;
    }
    .water-level-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 5px;
      font-size: 11pt;
    }
    .alert-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }
    .alert-item {
      padding: 10px;
      border-radius: 8px;
      background: white;
      border-left: 4px solid;
    }
    .alert-item-title {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .alert-item-value {
      font-size: 14pt;
    }
    
    /* ===== Trend Analysis ===== */
    .trend-container {
      margin-top: 15px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 15px;
      background: #fafafa;
    }
    .trend-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .trend-title {
      font-weight: bold;
      font-size: 14pt;
    }
    .trend-controls {
      display: flex;
      gap: 10px;
    }
    .trend-control-btn {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      background: white;
      cursor: pointer;
      font-size: 12pt;
    }
    .trend-control-btn.active {
      background: #1EA48D;
      color: white;
      border-color: #1EA48D;
    }
    .trend-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }
    .trend-stat {
      background: white;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .trend-stat-title {
      font-size: 12pt;
      color: #64748b;
      margin-bottom: 5px;
    }
    .trend-stat-value {
      font-size: 18pt;
      font-weight: bold;
    }
    .trend-stat-change {
      font-size: 12pt;
      margin-top: 5px;
    }
    .trend-stat-up {
      color: #22c55e;
    }
    .trend-stat-down {
      color: #ef4444;
    }
    .trend-chart-container {
      height: 300px;
      margin-top: 15px;
    }

    .charts{ display:grid; grid-template-columns: 1fr; gap:14px; margin-top:4px; }
    .chart-card{ border:1px solid #e5e7eb; border-radius:12px; padding:10px; background:#fafafa; }
    .chart-title{ font-weight:bold; margin:0 0 8px 0; font-size:14pt; text-align:center; }
    .chart-card canvas{ display:block; width:100% !important; height:360px !important; max-height:360px !important; }
    #water-status{ text-align:center; font-weight:bold; margin-bottom:6px; }

    table{ border-collapse:collapse; width:100%; font-size:13pt; margin-top:10px; table-layout:auto; }
    th,td{ border:1px solid var(--border-color); padding:6px 8px; text-align:center; vertical-align:middle; }
    th{ background:var(--header-bg); color:#000; font-weight:bold; position:sticky; top:0; z-index:1; }
    tbody tr:nth-child(even){ background:#fff; }
    tbody tr:hover{ background:var(--hover-bg); }

    .nowrap{ white-space: nowrap; }

    /* ===== Pagination compact ===== */
    .pager-bar{
      display:flex; align-items:center; justify-content:flex-start; gap:8px;
      margin-top:8px; flex-wrap:wrap;
    }
    .pager-info{ font-size:12.5pt; color:#334155; }
    .page-btn{
      padding:6px 12px; border-radius:999px; border:1px solid #d1d5db;
      background:#fff; cursor:pointer; font-size:12.5pt; min-width:40px;
    }
    .page-btn[disabled]{ opacity:.5; cursor:not-allowed; }
    .page-btn.active{
      background:#16a085; color:#fff; border-color:#16a085; font-weight:700;
    }
    .page-dots{
      padding:6px 6px; min-width:24px; text-align:center; color:#94a3b8;
    }

    .status-message{ color:#555; padding:16px; text-align:center; font-style:italic; font-size:14pt; }
    .error-message{ color:#b00020; padding:10px; background:#ffeeee; border:1px solid #ffcccc; margin-top:8px; border-radius:5px; }

    /* ===== Dashboard Customization ===== */
    .dashboard-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .dashboard-widget {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      overflow: hidden;
    }
    
    .widget-header {
      padding: 15px;
      background: var(--header-bg);
      color: white;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .widget-content {
      padding: 15px;
    }
    
    .widget-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .widget-control-btn {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      background: white;
      cursor: pointer;
      font-size: 12pt;
    }
    
    .widget-control-btn.active {
      background: var(--header-bg);
      color: white;
      border-color: var(--header-bg);
    }
    
    .widget-drag-handle {
      cursor: move;
      padding: 5px;
    }
    
    .widget-placeholder {
      background: #f1f5f9;
      border: 2px dashed #cbd5e1;
      border-radius: 12px;
      height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #64748b;
      font-size: 16pt;
    }
    
    /* ===== AI Analysis ===== */
    .ai-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-top: 20px;
    }
    
    .ai-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      overflow: hidden;
    }
    
    .ai-card-header {
      padding: 15px;
      background: var(--header-bg);
      color: white;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .ai-card-content {
      padding: 15px;
    }
    
    .ai-insight {
      margin-bottom: 15px;
      padding: 10px;
      border-radius: 8px;
      background: #f8fafc;
      border-left: 4px solid var(--header-bg);
    }
    
    .ai-insight-title {
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .ai-prediction {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .ai-prediction-label {
      flex: 1;
      font-weight: bold;
    }
    
    .ai-prediction-value {
      font-size: 16pt;
      font-weight: bold;
      color: var(--header-bg);
    }
    
    .ai-confidence {
      font-size: 12pt;
      color: #64748b;
      margin-left: 10px;
    }
    
    .ai-chart-container {
      height: 250px;
      margin-top: 15px;
    }

    /* ===== Notification ===== */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #1EA48D;
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transform: translateX(400px);
      transition: transform 0.3s ease;
      z-index: 1000;
      max-width: 300px;
    }
    .notification.show {
      transform: translateX(0);
    }
    .notification .close-btn {
      float: right;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      margin-left: 15px;
    }

    /* ===== Mobile Toggle ===== */
    .sidebar-toggle {
      display: none;
      position: fixed;
      top: 15px;
      left: 15px;
      z-index: 1001;
      background: var(--header-bg);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 18px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    @media (max-width: 768px) {
      .sidebar-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        transform: translateX(-100%);
        z-index: 1000;
      }
      
      .sidebar.open {
        transform: translateX(0);
      }
      
      .main-content {
        margin-left: 0;
      }
      
      .metrics {
        grid-template-columns: repeat(2, minmax(150px, 1fr));
      }
    }

    @media print {
      @page { size: A4 landscape; margin: 12mm; }

      .sidebar,
      .sidebar-toggle,
      .content-header,
      .controls-container,
      .metrics,
      .charts,
      .error-message,
      .status-message,
      .pager-bar,
      #toggle-fullscreen,
      #print-page,
      #export-excel,
      #toggle-custom-time,
      #custom-time-panel,
      .notification,
      .alert-container,
      .trend-container,
      .dashboard-container,
      .ai-container { display: none !important; }

      body { background: #fff !important; color: #000 !important; }
      .container { padding: 0 !important; }

      h1{
        display:block !important;
        text-align:center;
        text-transform:uppercase;
        font-weight:bold;
        font-size:18pt;
        margin:0 0 4mm 0;
      }
      .subtitle{
        display:block !important;
        text-align:center;
        font-weight:bold;
        font-size:14pt;
        margin:0 0 6mm 0;
      }

      th {
        position: static !important;
        background: #ffffff !important;
        color: #000000 !important;
        font-weight: 700 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      thead { display: table-header-group; }
      tfoot { display: table-footer-group; }

      table { page-break-inside: auto; }
      tr    { page-break-inside: avoid; page-break-after: auto; }

      .chart-card, .metric { box-shadow: none !important; }
    }
  </style>
</head>
<body>
  <!-- Sidebar Toggle Button for Mobile -->
  <button class="sidebar-toggle" id="sidebar-toggle">‚ò∞</button>
  
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      H·ªÜ TH·ªêNG GI√ÅM S√ÅT H·ªí TH√ÄNH S∆†N
    </div>
    <div class="sidebar-menu">
      <div class="menu-item active" data-content="station">
        <div class="menu-item-title">
          <span><span class="menu-item-icon">üìç</span> Tr·∫°m ƒëo</span>
        </div>
      </div>
      
      <div class="menu-item" data-content="monitoring">
        <div class="menu-item-title">
          <span><span class="menu-item-icon">üìä</span> D·ªØ li·ªáu quan tr·∫Øc</span>
        </div>
      </div>
      
      <div class="menu-item" data-content="analysis">
        <div class="menu-item-title">
          <span><span class="menu-item-icon">‚ö†Ô∏è</span> C·∫£nh b√°o v√† ph√¢n t√≠ch</span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Main Content -->
  <div class="main-content" id="main-content">
    <!-- Station Content -->
    <div class="content-body active" id="station-content">
      <div class="container" style="padding: 0; height: 100vh; display: flex; flex-direction: column;">
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 15px; background: #1EA48D; color: white; flex-shrink: 0;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <button class="sidebar-toggle-btn sidebar-toggle-all" id="sidebar-toggle-btn" title="·∫®n/Hi·ªán thanh sidebar" style="margin: 0;">‚ò∞</button>
            <h2 style="margin: 0; font-size: 15pt; font-weight: bold;">B·∫¢N ƒê·ªí TR·∫†M ƒêO H·ªí CH·ª®A TH√ÄNH S∆†N</h2>
          </div>
          <button id="toggle-fullscreen" title="B·∫≠t/T·∫Øt to√†n m√†n h√¨nh" style="padding: 6px 12px; font-size: 12pt;">‚õ∂ To√†n m√†n h√¨nh</button>
        </div>
        
        <div style="flex: 1; margin: 0;">
          <iframe src="https://thuan84.github.io/codehtml/tramdomua.html" 
                  style="width: 100%; height: 100%; border: none; display: block;">
          </iframe>
        </div>
      </div>
    </div>
    
    <!-- Monitoring Data Content -->
<div class="content-body" id="monitoring-content">
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 15px; background: #1EA48D; color: white; flex-shrink: 0;">
      <div style="display: flex; align-items: center; gap: 12px;">
        <button class="sidebar-toggle-btn sidebar-toggle-all" id="sidebar-toggle-btn-2" title="·∫®n/Hi·ªán thanh sidebar" style="margin: 0;">‚ò∞</button>
        <h2 style="margin: 0; font-size: 15pt; font-weight: bold;">NH·∫¨T K√ù V·∫¨N H√ÄNH H·ªí CH·ª®A N∆Ø·ªöC TH√ÄNH S∆†N</h2>
      </div>
      <div style="display: flex; gap: 8px;">
        <button id="toggle-fullscreen-2" title="B·∫≠t/T·∫Øt to√†n m√†n h√¨nh" style="padding: 6px 12px; font-size: 12pt; background:#0b5ed7; color:#fff; border:none; border-radius:6px; cursor:pointer;">‚õ∂ To√†n m√†n h√¨nh</button>
      </div>
    </div>
    <div class="container" style="overflow-y: auto; padding: 20px;">
        <h1>NH·∫¨T K√ù V·∫¨N H√ÄNH H·ªí CH·ª®A N∆Ø·ªöC TH√ÄNH S∆†N</h1>
        <div id="subtitle" class="subtitle"></div>

        <div class="controls-container">
          <div class="filters">
            <label for="year-filter">NƒÉm:</label>
            <select id="year-filter"><option value="all">T·∫•t c·∫£</option></select>
            <label for="quarter-filter">Qu√Ω:</label>
            <select id="quarter-filter">
              <option value="all">T·∫•t c·∫£</option><option value="1">Qu√Ω 1</option>
              <option value="2">Qu√Ω 2</option><option value="3">Qu√Ω 3</option>
              <option value="4">Qu√Ω 4</option>
            </select>
            <label for="month-filter">Th√°ng:</label>
            <select id="month-filter">
              <option value="all">T·∫•t c·∫£</option>
              <script>for(let i=1;i<=12;i++)document.write(`<option value="${i}">Th√°ng ${i}</option>`);</script>
            </select>
            <label for="week-filter">Tu·∫ßn:</label>
            <select id="week-filter">
              <option value="all">T·∫•t c·∫£</option>
            </select>
            <label for="daynight-filter">Ng√†y/ƒê√™m:</label>
            <select id="daynight-filter">
              <option value="all">T·∫•t c·∫£</option>
              <option value="day">Ng√†y (7h-19h)</option>
              <option value="night">ƒê√™m (19h-7h)</option>
            </select>
          </div>
          <div class="exports">
            <button id="toggle-custom-time" title="L·ªçc theo kho·∫£ng th·ªùi gian t√πy ch·ªânh">‚è±Ô∏è Th·ªùi gian t√πy ch·ªânh</button>
            <button id="export-excel">Xu·∫•t Excel</button>
            <button id="print-page">In</button>
          </div>
        </div>

        <!-- Custom Time Range Panel -->
        <div id="custom-time-panel" style="display:none; padding:16px; background:#f8f9fa; border:1px solid #e5e7eb; border-radius:10px; margin-bottom:10px;">
          <div style="display:flex; gap:20px; align-items:end; flex-wrap:wrap;">
            <div>
              <label style="font-weight:bold; display:block; margin-bottom:4px;">T·ª´ ng√†y:</label>
              <input type="date" id="custom-from-date" style="padding:8px; border:1px solid #d1d5db; border-radius:8px; font-size:13pt;">
            </div>
            <div>
              <label style="font-weight:bold; display:block; margin-bottom:4px;">Gi·ªù:ph√∫t:gi√¢y</label>
              <input type="time" id="custom-from-time" step="1" style="padding:8px; border:1px solid #d1d5db; border-radius:8px; font-size:13pt;">
            </div>
            <div>
              <label style="font-weight:bold; display:block; margin-bottom:4px;">ƒê·∫øn ng√†y:</label>
              <input type="date" id="custom-to-date" style="padding:8px; border:1px solid #d1d5db; border-radius:8px; font-size:13pt;">
            </div>
            <div>
              <label style="font-weight:bold; display:block; margin-bottom:4px;">Gi·ªù:ph√∫t:gi√¢y</label>
              <input type="time" id="custom-to-time" step="1" style="padding:8px; border:1px solid #d1d5db; border-radius:8px; font-size:13pt;">
            </div>
            <button id="apply-custom-time" style="padding:8px 16px; background:#1EA48D; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:bold; font-size:13pt;">√Åp d·ª•ng</button>
            <button id="clear-custom-time" style="padding:8px 16px; background:#6c757d; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:bold; font-size:13pt;">X√≥a</button>
          </div>
        </div>

        <!-- Metrics -->
        <div class="metrics">
          <div class="metric m-current-level">
            <div class="label">üíßM·ª±c n∆∞·ªõc hi·ªán t·∫°i</div>
            <div class="value" id="m-current-level">‚Äî</div>
          </div>

          <div class="metric m-current-volume">
            <div class="label">üåä Dung t√≠ch hi·ªán t·∫°i</div>
            <div class="value" id="m-current-volume">‚Äî</div>
          </div>

          <div class="metric m-current-rain">
            <div class="label">üåßÔ∏èL∆∞·ª£ng m∆∞a (Ng√†y)</div>
            <div class="value" id="m-current-rain">‚Äî</div>
          </div>

          <div class="metric m-total">
            <div class="label">T·ªïng l∆∞·ª£ng m∆∞a (k·ª≥ l·ªçc)</div>
            <div class="value" id="m-total">‚Äî</div>
          </div>

          <div class="metric m-ratio">
            <div class="label">Ng√†y c√≥ m∆∞a / T·ªïng ng√†y</div>
            <div class="value">
              <span id="m-rainy-days">‚Äî</span>/<span id="m-days">‚Äî</span>
            </div>
          </div>

          <div class="metric m-avg-d">
            <div class="label">M·ª±c n∆∞·ªõc l·ªõn nh·∫•t (m)</div>
            <div class="value">
              <span id="m-max-level">‚Äî</span>
              <span id="m-max-level-date" style="font-size:12pt;font-weight:600;"></span>
            </div>
          </div>

          <div class="metric m-max">
            <div class="label">M∆∞a l·ªõn nh·∫•t (ng√†y)</div>
            <div class="value">
              <span id="m-max">‚Äî</span>
              <span id="m-max-date" style="font-size:12pt;font-weight:600;"></span>
            </div>
          </div>
        </div>

        <!-- Single combo chart -->
        <div class="charts">
          <div class="chart-card">
            <p class="chart-title">L∆∞·ª£ng m∆∞a & m·ª±c n∆∞·ªõc theo ng√†y ‚Äì v√πng c·∫£nh b√°o m·ª±c n∆∞·ªõc</p>
            <div id="water-status"></div>
            <div id="zone-legend" style="text-align:center; margin:8px 0 14px 0; font-size:13.5pt;">
              <span style="display:inline-flex; align-items:center; margin-right:18px;">
                <span style="width:16px; height:16px; background:#dbeafe; border:1px solid #93c5fd; margin-right:6px;"></span>
                D∆∞·ªõi MN ch·∫øt
              </span>
            
              <span style="display:inline-flex; align-items:center; margin-right:18px;">
                <span style="width:16px; height:16px; background:#bbf7d0; border:1px solid #4ade80; margin-right:6px;"></span>
                V√πng an to√†n
              </span>
            
              <span style="display:inline-flex; align-items:center; margin-right:18px;">
                <span style="width:16px; height:16px; background:#fef9c3; border:1px solid #facc15; margin-right:6px;"></span>
                V√πng theo d√µi
              </span>
            
              <span style="display:inline-flex; align-items:center; margin-right:18px;">
                <span style="width:16px; height:16px; background:#ffedd5; border:1px solid #fb923c; margin-right:6px;"></span>
                V√πng c·∫£nh b√°o cao
              </span>
            
              <span style="display:inline-flex; align-items:center; margin-right:18px;">
                <span style="width:16px; height:16px; background:#fee2e2; border:1px solid #ef4444; margin-right:6px;"></span>
                Nguy hi·ªÉm
              </span>
            </div>
            
            <canvas id="waterComboChart"></canvas>
          </div>
        </div>

        <!-- Table -->
        <table id="data-table">
          <thead>
            <tr>
              <th rowspan="2">STT</th>
              <th rowspan="2" class="nowrap">Ng√†y</th>
              <th rowspan="2" class="nowrap">Gi·ªù</th>
              <th rowspan="2">M·ª±c n∆∞·ªõc (m)</th>
              <th rowspan="2">Dung t√≠ch (Tri·ªáu m¬≥)</th>
              <th rowspan="2">L∆∞·ª£ng m∆∞a (mm)</th>
              <th colspan="2">Th√¥ng s·ªë v·∫≠n h√†nh tr√†n x·∫£ l≈© s·ªë 1</th>
              <th colspan="2">Th√¥ng s·ªë v·∫≠n h√†nh tr√†n x·∫£ l≈© s·ªë 2</th>
              <th colspan="3">Th√¥ng s·ªë v·∫≠n h√†nh c·ªëng l·∫•y n∆∞·ªõc</th>
              <th rowspan="2">H·ªç, t√™n ng∆∞·ªùi v·∫≠n h√†nh</th>
              <th rowspan="2">Ch·ªØ k√Ω</th>
            </tr>
            <tr>
              <th>Htr√†n 1 (cm)</th>
              <th>Qtr√†n 1 (m¬≥/s)</th>
              <th>Htr√†n 2 (cm)</th>
              <th>Qtr√†n 2 (m¬≥/s)</th>
              <th>a (cm)</th>
              <th>C·ªôt n∆∞·ªõc ƒë·∫ßu k√™nh (m)</th>
              <th>Qc·ªëng (m¬≥/s)</th>
            </tr>
          </thead>
          <tbody id="table-body">
            <tr><td colspan="16"><div class="loader">ƒêang t·∫£i d·ªØ li·ªáu...</div></td></tr>
          </tbody>
        </table>

        <!-- Pagination bar -->
        <div class="pager-bar" id="pager-bar" style="display:none;">
          <button class="page-btn" id="btn-prev">¬´</button>
          <div id="page-numbers"></div>
          <button class="page-btn" id="btn-next">¬ª</button>
          <span class="pager-info" id="pager-info">Trang 1/1</span>
        </div>

        <div id="error-message" class="error-message" style="display:none;"></div>
      </div>
    </div>
    
    <!-- Analysis Content -->
<div class="content-body" id="analysis-content">
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 15px; background: #1EA48D; color: white; flex-shrink: 0;">
      <div style="display: flex; align-items: center; gap: 12px;">
        <button class="sidebar-toggle-btn sidebar-toggle-all" id="sidebar-toggle-btn-3" title="·∫®n/Hi·ªán thanh sidebar" style="margin: 0;">‚ò∞</button>
        <h2 style="margin: 0; font-size: 15pt; font-weight: bold;">C·∫¢NH B√ÅO V√Ä PH√ÇN T√çCH</h2>
      </div>
    </div>
    <div class="container">
      <h1>M·ª®C AN TO√ÄN V√Ä PH√ÇN T√çCH XU H∆Ø·ªöNG M·ª∞C N∆Ø·ªöC N√ÇNG CAO</h1>
        <div class="subtitle">Theo d√µi v√† c·∫£nh b√°o c√°c m·ª©c ƒë·ªô nguy hi·ªÉm c·ªßa m·ª±c n∆∞·ªõc h·ªì</div>
        
        <!-- Smart Alert System -->
        <div class="alert-container">
          <div id="alert-header" class="alert-header alert-normal">
            <span id="alert-title">H·ªÜ TH·ªêNG C·∫¢NH B√ÅO TH√îNG MINH</span>
            <span id="alert-time"></span>
          </div>
          <div class="alert-content">
            <div class="water-level-indicator">
              <span>M·ª±c n∆∞·ªõc hi·ªán t·∫°i:</span>
              <div class="water-level-bar">
                <div id="water-level-marker" class="water-level-marker"></div>
              </div>
              <span id="current-water-level-value">‚Äî</span>
            </div>
            <div class="water-level-labels">
              <span>MNC (27.50m)</span>
              <span>MNDBT (30.80m)</span>
              <span>MNLTK (31.96m)</span>
              <span>MNLKT (32.29m)</span>
              <span>ƒê·ªânh ƒë·∫≠p (32.50m)</span>
              <span>TCS (33.00m)</span>
            </div>
            <div class="alert-details">
              <div class="alert-item" style="border-color: #22c55e;">
                <div class="alert-item-title">V√πng an to√†n</div>
                <div class="alert-item-value">D∆∞·ªõi MNDBT (30.80m)</div>
              </div>
              <div class="alert-item" style="border-color: #eab308;">
                <div class="alert-item-title">V√πng theo d√µi</div>
                <div class="alert-item-value">30.80m - 31.96m</div>
              </div>
              <div class="alert-item" style="border-color: #f97316;">
                <div class="alert-item-title">V√πng c·∫£nh b√°o</div>
                <div class="alert-item-value">31.96m - 32.29m</div>
              </div>
              <div class="alert-item" style="border-color: #ef4444;">
                <div class="alert-item-title">V√πng nguy hi·ªÉm</div>
                <div class="alert-item-value">32.29m - 32.50m</div>
              </div>
              <div class="alert-item" style="border-color: #7c3aed;">
                <div class="alert-item-title">V√πng nguy hi·ªÉm ƒë·∫∑c bi·ªát</div>
                <div class="alert-item-value">Tr√™n 32.50m</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Trend Analysis -->
        <div class="trend-container">
          <div class="trend-header">
            <div class="trend-title">PH√ÇN T√çCH XU H∆Ø·ªöNG M·ª∞C N∆Ø·ªöC N√ÇNG CAO</div>
            <div class="trend-controls">
              <button id="trend-7d" class="trend-control-btn active">7 ng√†y</button>
              <button id="trend-30d" class="trend-control-btn">30 ng√†y</button>
              <button id="trend-90d" class="trend-control-btn">90 ng√†y</button>
            </div>
          </div>
          <div class="trend-stats">
            <div class="trend-stat">
              <div class="trend-stat-title">M·ª±c n∆∞·ªõc trung b√¨nh</div>
              <div class="trend-stat-value" id="trend-avg">‚Äî</div>
              <div class="trend-stat-change" id="trend-avg-change">‚Äî</div>
            </div>
            <div class="trend-stat">
              <div class="trend-stat-title">Xu h∆∞·ªõng</div>
              <div class="trend-stat-value" id="trend-direction">‚Äî</div>
              <div class="trend-stat-change" id="trend-direction-change">‚Äî</div>
            </div>
            <div class="trend-stat">
              <div class="trend-stat-title">D·ª± b√°o 24h t·ªõi</div>
              <div class="trend-stat-value" id="trend-forecast">‚Äî</div>
              <div class="trend-stat-change" id="trend-forecast-confidence">‚Äî</div>
            </div>
            <div class="trend-stat">
              <div class="trend-stat-title">Th·ªùi gian ƒë·∫øn MNDBT</div>
              <div class="trend-stat-value" id="trend-time-to-mndbt">‚Äî</div>
              <div class="trend-stat-change" id="trend-time-to-mndbt-change">‚Äî</div>
            </div>
          </div>
          <div class="trend-chart-container">
            <canvas id="trend-chart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Notification -->
  <div id="notification" class="notification">
    <span id="notification-message"></span>
    <span class="close-btn" id="notification-close">&times;</span>
  </div>

  <script>
    /* ================== C·∫§U H√åNH ================== */
    const EXEC_URL = "https://script.google.com/macros/s/AKfycbwCz4UxT1XoFe3nJtVxGn0w6N1Nf8JKZ1B6DjKVPLfzB7jz9CFidYG3Ks0hbOZqI23I/exec";
    const SHEET = "HoThanhSon";

    // Ng∆∞·ª°ng m·ª±c n∆∞·ªõc c·∫≠p nh·∫≠t theo y√™u c·∫ßu
    const DEAD_LEVEL = 27.50;   // M·ª±c n∆∞·ªõc ch·∫øt (MNC)
    const NORMAL_LEVEL = 30.80; // M·ª±c n∆∞·ªõc d√¢ng b√¨nh th∆∞·ªùng (MNDBT)
    const FLOOD_DESIGN_LEVEL = 31.96; // M·ª±c n∆∞·ªõc l≈© thi·∫øt k·∫ø (MNLTK)
    const FLOOD_CHECK_LEVEL = 32.29; // M·ª±c n∆∞·ªõc l≈© ki·ªÉm tra (MNLKT)
    const DAM_CREST_LEVEL = 32.50; // Cao tr√¨nh ƒê·ªânh ƒë·∫≠p ƒë·∫•t
    const WALL_CREST_LEVEL = 33.00; // Cao tr√¨nh ƒê·ªânh t∆∞·ªùng ch·∫Øn s√≥ng (Z TCS)
    
    // C√°c m·ª©c trung b√¨nh ƒë·ªÉ t√≠nh to√°n
    const LVL_BT = NORMAL_LEVEL;
    const LVL_GC = FLOOD_DESIGN_LEVEL;
    const LVL_MID = (LVL_BT + LVL_GC) / 2;

    const ROWS_PER_PAGE = 30;
    const CACHE_EXPIRY_MINUTES = 30; // Th·ªùi gian h·∫øt h·∫°n cache (ph√∫t)

    /* ================== STATE ================== */
    let selectedYear = 'all', selectedQuarter = 'all', selectedMonth = 'all', selectedWeek = 'all', selectedDayNight = 'all';
    let customTimeRange = null; // {fromDate, fromTime, toDate, toTime}
    let allData = [], filteredData = [], currentFetchCtrl = null;
    const cacheByScope = new Map(); // keys: 'all', 'year:YYYY'
    let comboChart = null, trendChart = null, ChartLibLoaded = false;
    let isBackgroundLoading = false;
    let trendPeriod = 7; // M·∫∑c ƒë·ªãnh l√† 7 ng√†y
    let currentContent = 'station'; // N·ªôi dung hi·ªán t·∫°i ƒëang hi·ªÉn th·ªã

    let currentPage = 1;

    /* ================== DOM ================== */
    // Sidebar elements
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebar-toggle');
    const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
    const mainContent = document.getElementById('main-content');
    const contentTitle = document.getElementById('content-title');
    
    // Menu items
    const menuItems = document.querySelectorAll('.menu-item');
    
    // Content bodies
    const contentBodies = document.querySelectorAll('.content-body');
    
    // Original monitoring data elements
    const yearFilter = document.getElementById('year-filter');
    const quarterFilter = document.getElementById('quarter-filter');
    const monthFilter = document.getElementById('month-filter');
    const weekFilter = document.getElementById('week-filter');
    const dayNightFilter = document.getElementById('daynight-filter');
    const tableBody = document.getElementById('table-body');
    const errorDiv = document.getElementById('error-message');
    const subtitleDiv = document.getElementById('subtitle');

    // KPI elements
    const elCurrentLevel = document.getElementById('m-current-level');
    const elCurrentVolume = document.getElementById('m-current-volume');
    const elCurrentRain = document.getElementById('m-current-rain');
    const elTotal      = document.getElementById('m-total');
    const elRainyDays  = document.getElementById('m-rainy-days');
    const elDays       = document.getElementById('m-days');
    const elMaxLevel   = document.getElementById('m-max-level');
    const elMaxLevelDate = document.getElementById('m-max-level-date');
    const elMax        = document.getElementById('m-max');
    const elMaxDate    = document.getElementById('m-max-date');
    const waterStatusEl= document.getElementById('water-status');

    // Alert system elements
    const alertHeader = document.getElementById('alert-header');
    const alertTitle = document.getElementById('alert-title');
    const alertTime = document.getElementById('alert-time');
    const waterLevelMarker = document.getElementById('water-level-marker');
    const currentWaterLevelValue = document.getElementById('current-water-level-value');

    // Trend analysis elements
    const trend7d = document.getElementById('trend-7d');
    const trend30d = document.getElementById('trend-30d');
    const trend90d = document.getElementById('trend-90d');
    const trendAvg = document.getElementById('trend-avg');
    const trendAvgChange = document.getElementById('trend-avg-change');
    const trendDirection = document.getElementById('trend-direction');
    const trendDirectionChange = document.getElementById('trend-direction-change');
    const trendForecast = document.getElementById('trend-forecast');
    const trendForecastConfidence = document.getElementById('trend-forecast-confidence');
    const trendTimeToMndbt = document.getElementById('trend-time-to-mndbt');
    const trendTimeToMndbtChange = document.getElementById('trend-time-to-mndbt-change');

    // Custom time range
    const customTimePanel = document.getElementById('custom-time-panel');
    const customFromDate = document.getElementById('custom-from-date');
    const customFromTime = document.getElementById('custom-from-time');
    const customToDate = document.getElementById('custom-to-date');
    const customToTime = document.getElementById('custom-to-time');
    const btnToggleCustomTime = document.getElementById('toggle-custom-time');
    const btnApplyCustomTime = document.getElementById('apply-custom-time');
    const btnClearCustomTime = document.getElementById('clear-custom-time');

    // Pagination DOM
    const pagerBar = document.getElementById('pager-bar');
    const pagerInfo = document.getElementById('pager-info');
    const pageNumbers = document.getElementById('page-numbers');
    const btnPrev = document.getElementById('btn-prev');
    const btnNext = document.getElementById('btn-next');

    // Notification DOM
    const notification = document.getElementById('notification');
    const notificationMessage = document.getElementById('notification-message');
    const notificationClose = document.getElementById('notification-close');

    /* ================== SIDEBAR NAVIGATION ================== */
    // Toggle sidebar on mobile
    sidebarToggle.addEventListener('click', () => {
      sidebar.classList.toggle('open');
    });

    

    // Restore sidebar state from localStorage
    function restoreSidebarState() {
      const isHidden = localStorage.getItem('sidebar-hidden') === 'true';
      if (isHidden) {
        sidebar.classList.add('hidden');
        mainContent.classList.add('expanded');
      }
    }

    // Handle menu item clicks
        // Handle menu item clicks
        menuItems.forEach(item => {
      item.addEventListener('click', () => {
        const content = item.getAttribute('data-content');
        
        // Remove active class from all menu items
        menuItems.forEach(mi => mi.classList.remove('active'));
        // Add active class to clicked item
        item.classList.add('active');
        
        // Hide all content bodies
        contentBodies.forEach(body => body.classList.remove('active'));
        
        // Show selected content
        document.getElementById(`${content}-content`).classList.add('active');
        
        // Update content title
        const titleText = item.querySelector('.menu-item-title span:first-child').textContent;
        contentTitle.textContent = titleText;
        
        // Update current content
        currentContent = content;
        
        // Initialize specific content based on the selected tab
        if (content === 'analysis') {
          updateAlertSystem(getCurrentWaterLevel());
          updateTrendAnalysis();
        } else if (content === 'monitoring') {
          // Khi chuy·ªÉn sang tab D·ªØ li·ªáu quan tr·∫Øc, v·∫Ω l·∫°i bi·ªÉu ƒë·ªì v√† c·∫≠p nh·∫≠t ch·ªâ s·ªë
          // D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c t·∫£i s·∫µn trong h√†m init(), gi·ªù ch·ªâ c·∫ßn hi·ªÉn th·ªã
          if (filteredData.length > 0) {
            renderRainStats();
            // S·ª≠ d·ª•ng requestAnimationFrame ƒë·ªÉ ƒë·∫£m b·∫£o DOM ƒë√£ s·∫µn s√†ng
            requestAnimationFrame(() => setTimeout(updateCharts, 0));
          } else {
            // N·∫øu ch∆∞a c√≥ d·ªØ li·ªáu (tr∆∞·ªùng h·ª£p hi·∫øm), g·ªçi l·∫°i h√†m t·∫£i
            fetchAndRender();
          }
        }
        
        // Close sidebar on mobile
        if (window.innerWidth <= 768) {
          sidebar.classList.remove('open');
        }
      });
    });

    /* ================== HELPER FUNCTIONS ================== */
    function getCurrentWaterLevel() {
      // Find the latest record
      let latestRecord = null;
      filteredData.forEach(r => {
        if (r._dt && (!latestRecord || r._dt > latestRecord._dt)) {
          latestRecord = r;
        }
      });
      
      return latestRecord ? Number(latestRecord.mucNuoc) : null;
    }
    
    function getCurrentVolume() {
      // Find the latest record
      let latestRecord = null;
      filteredData.forEach(r => {
        if (r._dt && (!latestRecord || r._dt > latestRecord._dt)) {
          latestRecord = r;
        }
      });
      
      return latestRecord ? Number(latestRecord.dungTich) : null;
    }
    
    function getCurrentRain() {
      // Find the latest record
      let latestRecord = null;
      filteredData.forEach(r => {
        if (r._dt && (!latestRecord || r._dt > latestRecord._dt)) {
          latestRecord = r;
        }
      });
      
      if (!latestRecord) return null;
      
      // Get rain for the day of the latest record
      const today = ymd(latestRecord._dt);
      const todayData = filteredData.filter(r => r._dt && ymd(r._dt) === today);
      return todayData.reduce((sum, r) => sum + (Number(r.luongMua) || 0), 0);
    }

    /* ================== CACHE MANAGEMENT ================== */
        /* ================== CACHE MANAGEMENT ================== */
        function saveToLocalStorage(key, data) {
      try {
        const cacheData = {
          data: data,
          timestamp: new Date().getTime()
        };
        localStorage.setItem(key, JSON.stringify(cacheData));
      } catch (e) {
        console.warn('Kh√¥ng th·ªÉ l∆∞u v√†o localStorage:', e);
      }
    }

    function loadFromLocalStorage(key) {
      try {
        const cachedItem = localStorage.getItem(key);
        if (!cachedItem) return null;
        
        const cacheData = JSON.parse(cachedItem);
        const now = new Date().getTime();
        const expiryTime = CACHE_EXPIRY_MINUTES * 60 * 1000;
        
        if (now - cacheData.timestamp > expiryTime) {
          localStorage.removeItem(key);
          return null;
        }
        
        return cacheData.data;
      } catch (e) {
        console.warn('Kh√¥ng th·ªÉ t·∫£i t·ª´ localStorage:', e);
        return null;
      }
    }

    function clearLocalStorage() {
      try {
        localStorage.removeItem('hoThanhSon_all');
        localStorage.removeItem('hoThanhSon_year:' + new Date().getFullYear());
      } catch (e) {
        console.warn('Kh√¥ng th·ªÉ x√≥a localStorage:', e);
      }
    }

    /* ================== NOTIFICATION ================== */
    function showNotification(message, duration = 5000) {
      notificationMessage.textContent = message;
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, duration);
    }

    notificationClose.addEventListener('click', () => {
      notification.classList.remove('show');
    });

    /* ================== SMART ALERT SYSTEM ================== */
    function updateAlertSystem(currentLevel) {
      if (currentLevel === null || isNaN(currentLevel)) return;
      
      // C·∫≠p nh·∫≠t th·ªùi gian
      const now = new Date();
      alertTime.textContent = `${pad2(now.getHours())}:${pad2(now.getMinutes())}:${pad2(now.getSeconds())} ${pad2(now.getDate())}/${pad2(now.getMonth()+1)}/${now.getFullYear()}`;
      
      // C·∫≠p nh·∫≠t gi√° tr·ªã m·ª±c n∆∞·ªõc hi·ªán t·∫°i
      currentWaterLevelValue.textContent = formatFixedVN(currentLevel, 2) + 'm';
      
      // T√≠nh to√°n v·ªã tr√≠ c·ªßa marker tr√™n thanh ch·ªâ b√°o
        const minLevel = DEAD_LEVEL;     // 27.50
        const maxLevel = WALL_CREST_LEVEL; // 33.00
        const range = maxLevel - minLevel; // 5.50m
        const position = Math.max(0, Math.min(100, ((currentLevel - minLevel) / range) * 100));
        waterLevelMarker.style.left = `${position}%`;
        console.log(`M·ª±c n∆∞·ªõc: ${currentLevel}m, V·ªã tr√≠ marker: ${position}%`); // Debug
      
      // X√°c ƒë·ªãnh m·ª©c c·∫£nh b√°o v√† c·∫≠p nh·∫≠t giao di·ªán
      let alertClass, alertMessage, alertTitleText;
      
      if (currentLevel < NORMAL_LEVEL) {
        alertClass = 'alert-normal';
        alertTitleText = 'M·ª®C AN TO√ÄN';
        alertMessage = `M·ª±c n∆∞·ªõc hi·ªán t·∫°i ${formatFixedVN(currentLevel, 2)}m, n·∫±m trong v√πng an to√†n (d∆∞·ªõi MNDBT)`;
      } else if (currentLevel < FLOOD_DESIGN_LEVEL) {
        alertClass = 'alert-warning';
        alertTitleText = 'C·∫¢NH B√ÅO V√ÄNG';
        alertMessage = `M·ª±c n∆∞·ªõc hi·ªán t·∫°i ${formatFixedVN(currentLevel, 2)}m, n·∫±m trong v√πng theo d√µi (gi·ªØa MNDBT v√† MNLTK)`;
      } else if (currentLevel < FLOOD_CHECK_LEVEL) {
        alertClass = 'alert-danger';
        alertTitleText = 'C·∫¢NH B√ÅO ƒê·ªé';
        alertMessage = `M·ª±c n∆∞·ªõc hi·ªán t·∫°i ${formatFixedVN(currentLevel, 2)}m, n·∫±m trong v√πng c·∫£nh b√°o (gi·ªØa MNLTK v√† MNLKT)`;
      } else if (currentLevel < DAM_CREST_LEVEL) {
        alertClass = 'alert-critical';
        alertTitleText = 'C·∫¢NH B√ÅO NGUY HI·ªÇM ƒê·∫∂C BI·ªÜT';
        alertMessage = `M·ª±c n∆∞·ªõc hi·ªán t·∫°i ${formatFixedVN(currentLevel, 2)}m, n·∫±m trong v√πng nguy hi·ªÉm (gi·ªØa MNLKT v√† ƒë·ªânh ƒë·∫≠p)`;
      } else {
        alertClass = 'alert-critical';
        alertTitleText = 'C·∫¢NH B√ÅO KH·∫®N C·∫§P';
        alertMessage = `M·ª±c n∆∞·ªõc hi·ªán t·∫°i ${formatFixedVN(currentLevel, 2)}m, v∆∞·ª£t ƒë·ªânh ƒë·∫≠p, nguy c∆° v·ª° ƒë·∫≠p r·∫•t cao!`;
      }
      
      // C·∫≠p nh·∫≠t giao di·ªán c·∫£nh b√°o
      alertHeader.className = `alert-header ${alertClass}`;
      alertTitle.textContent = alertTitleText;
      
      // Hi·ªÉn th·ªã th√¥ng b√°o n·∫øu m·ª©c ƒë·ªô c·∫£nh b√°o thay ƒë·ªïi
      if (window.lastAlertClass !== alertClass) {
        window.lastAlertClass = alertClass;
        showNotification(alertMessage, 8000);
      }
    }

    /* ================== TREND ANALYSIS ================== */
    function updateTrendAnalysis() {
      if (!filteredData.length) return;
      
      // L·∫•y d·ªØ li·ªáu theo kho·∫£ng th·ªùi gian ƒë√£ ch·ªçn
      const now = new Date();
      const startDate = new Date();
      startDate.setDate(now.getDate() - trendPeriod);
      
      const trendData = filteredData.filter(r => r._dt && r._dt >= startDate && r._dt <= now);
      
      if (!trendData.length) {
        trendAvg.textContent = '‚Äî';
        trendAvgChange.textContent = 'Kh√¥ng ƒë·ªß d·ªØ li·ªáu';
        trendDirection.textContent = '‚Äî';
        trendDirectionChange.textContent = 'Kh√¥ng ƒë·ªß d·ªØ li·ªáu';
        trendForecast.textContent = '‚Äî';
        trendForecastConfidence.textContent = 'Kh√¥ng ƒë·ªß d·ªØ li·ªáu';
        trendTimeToMndbt.textContent = '‚Äî';
        trendTimeToMndbtChange.textContent = 'Kh√¥ng ƒë·ªß d·ªØ li·ªáu';
        return;
      }
      
      // S·∫Øp x·∫øp d·ªØ li·ªáu theo th·ªùi gian
      trendData.sort((a, b) => a._dt - b._dt);
      
      // T√≠nh to√°n c√°c ch·ªâ s·ªë
      const waterLevels = trendData.map(r => Number(r.mucNuoc)).filter(l => !isNaN(l));
      if (!waterLevels.length) return;
      
      const avgLevel = waterLevels.reduce((sum, level) => sum + level, 0) / waterLevels.length;
      const firstLevel = waterLevels[0];
      const lastLevel = waterLevels[waterLevels.length - 1];
      const change = lastLevel - firstLevel;
      
      // T√≠nh to√°n xu h∆∞·ªõng (ƒë∆°n gi·∫£n)
      let trendText, trendChangeText;
      if (Math.abs(change) < 0.1) {
        trendText = '·ªîn ƒë·ªãnh';
        trendChangeText = 'Thay ƒë·ªïi kh√¥ng ƒë√°ng k·ªÉ';
      } else if (change > 0) {
        trendText = 'TƒÉng';
        trendChangeText = `TƒÉng ${formatFixedVN(change, 2)}m trong ${trendPeriod} ng√†y`;
      } else {
        trendText = 'Gi·∫£m';
        trendChangeText = `Gi·∫£m ${formatFixedVN(Math.abs(change), 2)}m trong ${trendPeriod} ng√†y`;
      }
      
      // D·ª± b√°o ƒë∆°n gi·∫£n (d·ª±a tr√™n xu h∆∞·ªõng g·∫ßn nh·∫•t)
      const recentLevels = waterLevels.slice(-Math.min(7, waterLevels.length));
      let forecast = lastLevel;
      let confidence = 'Th·∫•p';
      
      if (recentLevels.length >= 3) {
        // T√≠nh to√°n xu h∆∞·ªõng g·∫ßn ƒë√¢y
        let recentTrend = 0;
        for (let i = 1; i < recentLevels.length; i++) {
          recentTrend += recentLevels[i] - recentLevels[i-1];
        }
        recentTrend /= (recentLevels.length - 1);
        
        // D·ª± b√°o cho 24h t·ªõi
        forecast = lastLevel + recentTrend;
        
        // ƒê·ªô tin c·∫≠y d·ª±a tr√™n s·ª± ·ªïn ƒë·ªãnh c·ªßa xu h∆∞·ªõng
        const variance = recentLevels.reduce((sum, level) => {
          return sum + Math.pow(level - avgLevel, 2);
        }, 0) / recentLevels.length;
        
        if (variance < 0.1) {
          confidence = 'Cao';
        } else if (variance < 0.5) {
          confidence = 'Trung b√¨nh';
        }
      }
      
      // T√≠nh th·ªùi gian ƒë·∫øn MNDBT
      let timeToMndbt = '‚Äî';
      let timeToMndbtChange = 'Kh√¥ng √°p d·ª•ng';
      
      if (lastLevel < NORMAL_LEVEL && change > 0) {
        const daysToMndbt = (NORMAL_LEVEL - lastLevel) / (change / trendPeriod);
        if (daysToMndbt > 0 && daysToMndbt < 100) {
          timeToMndbt = `${Math.ceil(daysToMndbt)} ng√†y`;
          timeToMndbtChange = `D·ª±a tr√™n xu h∆∞·ªõng hi·ªán t·∫°i`;
        }
      } else if (lastLevel >= NORMAL_LEVEL) {
        timeToMndbt = 'ƒê√£ ƒë·∫°t';
        timeToMndbtChange = `M·ª±c n∆∞·ªõc ƒë√£ v∆∞·ª£t MNDBT`;
      }
      
      // C·∫≠p nh·∫≠t giao di·ªán
      trendAvg.textContent = formatFixedVN(avgLevel, 2) + 'm';
      trendAvgChange.textContent = `Thay ƒë·ªïi ${formatFixedVN(change, 2)}m trong ${trendPeriod} ng√†y`;
      trendAvgChange.className = change > 0 ? 'trend-stat-change trend-stat-up' : 'trend-stat-change trend-stat-down';
      
      trendDirection.textContent = trendText;
      trendDirectionChange.textContent = trendChangeText;
      
      trendForecast.textContent = formatFixedVN(forecast, 2) + 'm';
      trendForecastConfidence.textContent = `ƒê·ªô tin c·∫≠y: ${confidence}`;
      
      trendTimeToMndbt.textContent = timeToMndbt;
      trendTimeToMndbtChange.textContent = timeToMndbtChange;
      
      // V·∫Ω bi·ªÉu ƒë·ªì xu h∆∞·ªõng
      drawTrendChart(trendData);
    }

    function drawTrendChart(data) {
      if (!data.length) return;
      
      ensureChartJs().then(() => {
        // Chu·∫©n b·ªã d·ªØ li·ªáu cho bi·ªÉu ƒë·ªì
        const labels = data.map(r => {
          const d = r._dt;
          return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}`;
        });
        
        const waterLevels = data.map(r => Number(r.mucNuoc));
        const rainData = data.map(r => Number(r.luongMua) || 0);
        
        // N·∫øu bi·ªÉu ƒë·ªì ƒë√£ t·ªìn t·∫°i, h·ªßy n√≥
        if (trendChart) {
          trendChart.destroy();
          trendChart = null;
        }
        
        // T·∫°o bi·ªÉu ƒë·ªì m·ªõi
        const ctx = document.getElementById('trend-chart').getContext('2d');
        trendChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              {
                label: 'M·ª±c n∆∞·ªõc (m)',
                data: waterLevels,
                borderColor: '#1EA48D',
                backgroundColor: 'rgba(30, 164, 141, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                yAxisID: 'y-water'
              },
              {
                label: 'L∆∞·ª£ng m∆∞a (mm)',
                data: rainData,
                type: 'bar',
                backgroundColor: 'rgba(37, 99, 235, 0.5)',
                borderColor: '#2563eb',
                borderWidth: 1,
                yAxisID: 'y-rain'
              },
              // C√°c ƒë∆∞·ªùng ng∆∞·ª°ng
              {
                label: 'MNDBT',
                data: Array(labels.length).fill(NORMAL_LEVEL),
                borderColor: '#eab308',
                borderWidth: 2,
                borderDash: [5, 5],
                fill: false,
                pointRadius: 0,
                yAxisID: 'y-water'
              },
              {
                label: 'MNLTK',
                data: Array(labels.length).fill(FLOOD_DESIGN_LEVEL),
                borderColor: '#ef4444',
                borderWidth: 2,
                borderDash: [5, 5],
                fill: false,
                pointRadius: 0,
                yAxisID: 'y-water'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: 'index',
              intersect: false
            },
            scales: {
              x: {
                display: true,
                title: {
                  display: true,
                  text: 'Ng√†y'
                }
              },
              'y-water': {
                type: 'linear',
                display: true,
                position: 'left',
                title: {
                  display: true,
                  text: 'M·ª±c n∆∞·ªõc (m)'
                },
                min: DEAD_LEVEL - 1,
                max: DAM_CREST_LEVEL + 1
              },
              'y-rain': {
                type: 'linear',
                display: true,
                position: 'right',
                title: {
                  display: true,
                  text: 'L∆∞·ª£ng m∆∞a (mm)'
                },
                grid: {
                  drawOnChartArea: false
                }
              }
            },
            plugins: {
              tooltip: {
                mode: 'index',
                intersect: false
              }
            }
          }
        });
      });
    }

    // X·ª≠ l√Ω s·ª± ki·ªán thay ƒë·ªïi kho·∫£ng th·ªùi gian ph√¢n t√≠ch
    trend7d.addEventListener('click', () => {
      trendPeriod = 7;
      trend7d.classList.add('active');
      trend30d.classList.remove('active');
      trend90d.classList.remove('active');
      updateTrendAnalysis();
    });

    trend30d.addEventListener('click', () => {
      trendPeriod = 30;
      trend7d.classList.remove('active');
      trend30d.classList.add('active');
      trend90d.classList.remove('active');
      updateTrendAnalysis();
    });

    trend90d.addEventListener('click', () => {
      trendPeriod = 90;
      trend7d.classList.remove('active');
      trend30d.classList.remove('active');
      trend90d.classList.add('active');
      updateTrendAnalysis();
    });

    /* ================== UTIL ================== */
    function parseVNDateTime(s){
      if (!s || typeof s !== 'string') return null;
      const [dpart, tpart='00:00'] = s.split(' ');
      const [dd, mm, yyyy] = dpart.split('/').map(n=>parseInt(n,10));
      if (!dd || !mm || !yyyy) return null;
      const [HH='0', MM='0'] = tpart.split(':').map(n=>parseInt(n,10));
      const d = new Date(yyyy, mm-1, dd, HH, MM);
      return Number.isNaN(d.getTime()) ? null : d;
    }
    function pad2(n){ return String(n).padStart(2,'0'); }
    function formatVNDate(d){ return d ? `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}` : ''; }
    function formatVNTime(d){ return d ? `${pad2(d.getHours())}:${pad2(d.getMinutes())}` : ''; }
    function ymd(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
    function formatNum(v, max=3){
      if (v === null || v === undefined || v === '') return '';
      const n = Number(v); if (Number.isNaN(n)) return v;
      return n.toLocaleString('vi-VN', { maximumFractionDigits:max });
    }
    function formatFixedVN(num, digits = 2) {
      const n = Number(num);
      if (!Number.isFinite(n)) return '';
      return n.toLocaleString('vi-VN', {
        minimumFractionDigits: digits,
        maximumFractionDigits: digits
      });
    }
    function formatLabelToVNDate(label){
        if (!label) return '';
      const parts = String(label).split('-');
      if (parts.length !== 3) return label;
      const [y,m,d] = parts;
      return `${d}/${m}/${y}`;
    }
    function buildApiUrl(year='all', month='all', quarter='all') {
      const p = new URLSearchParams({ sheet: SHEET });
      if (year !== 'all') p.set('year', year);
      if (year !== 'all') {
        if (month !== 'all')   p.set('month', month);
        else if (quarter !== 'all') p.set('quarter', quarter);
      }
      return `${EXEC_URL}?${p.toString()}`;
    }
    function loadScript(src){
      return new Promise((resolve, reject)=>{
        const s = document.createElement('script');
        s.src = src; s.async = true; s.crossOrigin = "anonymous";
        s.onload = () => resolve();
        s.onerror = () => reject(new Error(`Kh√¥ng t·∫£i ƒë∆∞·ª£c script: ${src}`));
        document.head.appendChild(s);
      });
    }
    function showError(message){
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      tableBody.innerHTML = `<tr><td colspan="16" class="status-message">${message}</td></tr>`;
    }
    
    function getWeekNumber(date) {
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
      const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1)/7);
      return weekNo;
    }
    function isDayTime(date) {
      const hour = date.getHours();
      return hour >= 7 && hour < 19;
    }
    function isNightTime(date) {
      const hour = date.getHours();
      return hour >= 19 || hour < 7;
    }

    /* ================== TABLE ================== */
    function renderTable(data, baseIndex=0){
      if (!Array.isArray(data) || data.length === 0){
        tableBody.innerHTML = `<tr><td colspan="16" class="status-message">Kh√¥ng c√≥ d·ªØ li·ªáu ph√π h·ª£p v·ªõi b·ªô l·ªçc.</td></tr>`;
        return;
      }
      let html = '';
      for (let i=0;i<data.length;i++){
        const r = data[i];
        html += `<tr>
          <td>${baseIndex + i + 1}</td>
          <td class="nowrap">${r._ngay || ''}</td>
          <td class="nowrap">${r._gio || ''}</td>
          <td>${formatNum(r.mucNuoc)}</td>
          <td>${formatNum(r.dungTich)}</td>
          <td>${formatNum(r.luongMua)}</td>
          <td>${formatNum(r.hTran1)}</td>
          <td>${formatNum(r.qtran1)}</td>
          <td>${formatNum(r.hTran2)}</td>
          <td>${formatNum(r.qtran2)}</td>
          <td>${formatNum(r.a)}</td>
          <td>${formatNum(r.cotNuocDauKenh)}</td>
          <td>${formatNum(r.qCong)}</td>
          <td>${r.nguoiVanHanh || ''}</td>
          <td></td>
        </tr>`;
      }
      tableBody.innerHTML = html;
    }

    /* ================== YEAR & WEEK DROPDOWN ================== */
    function populateYearFilter(data){
      const years = [...new Set(data.map(r => r._y).filter(v => v!=null))].sort((a,b)=>b-a);
      const prev = yearFilter.value;
      yearFilter.innerHTML = '<option value="all">T·∫•t c·∫£</option>';
      years.forEach(y => {
        const op = document.createElement('option');
        op.value = String(y);
        op.textContent = `NƒÉm ${y}`;
        yearFilter.appendChild(op);
      });
      if (prev && (prev === 'all' || years.includes(Number(prev)))) {
        yearFilter.value = prev;
      } else if (years.includes(Number(selectedYear))) {
        yearFilter.value = selectedYear;
      } else {
        yearFilter.value = 'all';
        selectedYear = 'all';
      }
    }
    
    function populateWeekFilter(data) {
      const weeks = new Set();
      data.forEach(r => {
        if (r._dt && r._y) {
          const weekNum = getWeekNumber(r._dt);
          weeks.add(`${r._y}-W${String(weekNum).padStart(2, '0')}`);
        }
      });
      
      const prev = weekFilter.value;
      weekFilter.innerHTML = '<option value="all">T·∫•t c·∫£</option>';
      
      [...weeks].sort((a, b) => {
        const [yearA, weekA] = a.split('-W').map(v => parseInt(v, 10));
        const [yearB, weekB] = b.split('-W').map(v => parseInt(v, 10));
        if (yearA !== yearB) return yearB - yearA;
        return weekB - weekA;
      }).forEach(w => {
        const op = document.createElement('option');
        op.value = w;
        const [year, week] = w.split('-W');
        op.textContent = `Tu·∫ßn ${parseInt(week, 10)} (${year})`;
        weekFilter.appendChild(op);
      });
      
      if (prev && (prev === 'all' || weeks.has(prev))) {
        weekFilter.value = prev;
      } else {
        weekFilter.value = 'all';
        selectedWeek = 'all';
      }
    }

    /* ================== AGGREGATE & METRICS ================== */
    function aggregateDaily(data){
      const map = new Map();
      for (const r of data){
        const d = r._dt;
        if (!d) continue;
        const key = ymd(d);
        const rain = Number(r.luongMua) || 0;
        const wl   = Number(r.mucNuoc);
        const vol  = Number(r.dungTich);
        const prev = map.get(key) || { rainSum:0, wlSum:0, wlCount:0, volSum:0, volCount:0, lastDate:d };
        prev.rainSum += rain;
        if (!Number.isNaN(wl)) { prev.wlSum += wl; prev.wlCount++; }
        if (!Number.isNaN(vol)) { prev.volSum += vol; prev.volCount++; }
        if (d > prev.lastDate) prev.lastDate = d;
        map.set(key, prev);
      }
      const labels = Array.from(map.keys()).sort((a,b)=> new Date(a)-new Date(b));
      const rainPerDay = labels.map(k => map.get(k).rainSum);
      const wlAvgPerDay = labels.map(k => {
        const o = map.get(k); return o.wlCount ? o.wlSum/o.wlCount : null;
      });
      const volAvgPerDay = labels.map(k => {
        const o = map.get(k); return o.volCount ? o.volSum/o.volCount : null;
      });
      return { labels, rainPerDay, wlAvgPerDay, volAvgPerDay };
    }

    function renderRainStats(){
      const { labels, rainPerDay, wlAvgPerDay, volAvgPerDay } = aggregateDaily(filteredData);

      const total = rainPerDay.reduce((s,v)=>s+(Number(v)||0),0);
      const days = labels.length;
      const rainyDays = rainPerDay.filter(v => (Number(v)||0) > 0).length;

      let maxVal = 0, maxDateRaw = '';
      rainPerDay.forEach((v,i)=>{
        const num = Number(v) || 0;
        if (num > maxVal){
          maxVal = num;
          maxDateRaw = labels[i]; // d·∫°ng YYYY-MM-DD
        }
      });

      // T√≠nh m·ª±c n∆∞·ªõc l·ªõn nh·∫•t (theo t·ª´ng b·∫£n ghi) + ng√†y l·ªõn nh·∫•t
      let maxLevel = null;
      let maxLevelDate = '';
      filteredData.forEach(r => {
        const lvl = Number(r.mucNuoc);
        if (!Number.isNaN(lvl)){
          if (maxLevel === null || lvl > maxLevel){
            maxLevel = lvl;
            if (r._dt){
              maxLevelDate = formatVNDate(r._dt);
            } else if (r._ngay){
              maxLevelDate = r._ngay;
            } else {
              maxLevelDate = '';
            }
          }
        }
      });

      // L·∫•y gi√° tr·ªã hi·ªán t·∫°i (gi√° tr·ªã m·ªõi nh·∫•t)
      let currentLevel = null;
      let currentVolume = null;
      let currentRain = null;
      
      // T√¨m b·∫£n ghi m·ªõi nh·∫•t
      let latestRecord = null;
      filteredData.forEach(r => {
        if (r._dt && (!latestRecord || r._dt > latestRecord._dt)) {
          latestRecord = r;
        }
      });
      
      if (latestRecord) {
        currentLevel = Number(latestRecord.mucNuoc);
        currentVolume = Number(latestRecord.dungTich);
        
        // L·∫•y l∆∞·ª£ng m∆∞a c·ªßa ng√†y m·ªõi nh·∫•t
        const today = ymd(latestRecord._dt);
        const todayData = filteredData.filter(r => r._dt && ymd(r._dt) === today);
        currentRain = todayData.reduce((sum, r) => sum + (Number(r.luongMua) || 0), 0);
      }

      // G√°n KPI cho trang D·ªØ li·ªáu quan tr·∫Øc
      elCurrentLevel.textContent = currentLevel !== null ? formatFixedVN(currentLevel, 2) : '‚Äî';
      elCurrentVolume.textContent = currentVolume !== null ? formatFixedVN(currentVolume, 2) : '‚Äî';
      elCurrentRain.textContent = currentRain !== null ? formatFixedVN(currentRain, 1) : '‚Äî';
      
      elTotal.textContent = total.toLocaleString('vi-VN', {maximumFractionDigits:1});
      elDays.textContent = String(days);
      elRainyDays.textContent = String(rainyDays);

      if (maxLevel === null){
        elMaxLevel.textContent = '‚Äî';
        elMaxLevelDate.textContent = '';
      } else {
        elMaxLevel.textContent = maxLevel.toLocaleString('vi-VN', {maximumFractionDigits:2});
        elMaxLevelDate.textContent = maxLevelDate ? `(${maxLevelDate})` : '';
      }

      elMax.textContent = maxVal.toLocaleString('vi-VN', {maximumFractionDigits:1});
      const maxDateVN = maxDateRaw ? formatLabelToVNDate(maxDateRaw) : '';
      elMaxDate.textContent = maxDateVN ? `(${maxDateVN})` : '';
      
      // C·∫≠p nh·∫≠t h·ªá th·ªëng c·∫£nh b√°o th√¥ng minh v√† ph√¢n t√≠ch n·∫øu ƒëang ·ªü trang ƒë√≥
      if (currentContent === 'analysis') {
        updateAlertSystem(currentLevel);
        updateTrendAnalysis();
      }
    }

    /* ================== CHARTS ================== */
    async function ensureChartJs(){
      if (!ChartLibLoaded){
        await loadScript('https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js');
        ChartLibLoaded = true;
      }
    }
    function niceMax(val){
      if (!isFinite(val) || val <= 0) return 10;
      const mags = [5,10,20,25,50,100,200,250,500,1000];
      const target = val * 1.1;
      for (const m of mags){ if (target <= m) return m; }
      return Math.ceil(target/100)*100;
    }

    async function updateCharts(){
      if (currentContent !== 'monitoring') return; // Only update if on monitoring page
      
      await ensureChartJs();
      const { labels, rainPerDay, wlAvgPerDay } = aggregateDaily(filteredData);

      if (!labels.length){
        if (comboChart){ comboChart.destroy(); comboChart=null; }
        waterStatusEl.textContent = 'Kh√¥ng c√≥ d·ªØ li·ªáu m·ª±c n∆∞·ªõc.';
        return;
      }

      const shortLabels = labels.map(s => {
        const [y,m,d] = s.split('-');
        return `${d}/${m}`;
      });

      if (comboChart) { comboChart.destroy(); comboChart = null; }

      const maxRain = rainPerDay.reduce((m,v)=>Math.max(m, v||0), 0);
      const yMaxRain = niceMax(maxRain);

      const wlVals = wlAvgPerDay.filter(v=>v!=null && Number.isFinite(v));
      const wlMin = wlVals.length ? Math.min(...wlVals) : DEAD_LEVEL;
      const wlMax = wlVals.length ? Math.max(...wlVals) : DEAD_LEVEL;
      const minForScale = Math.min(wlMin, DEAD_LEVEL) - 0.3;
      const maxForScale = Math.max(wlMax, FLOOD_DESIGN_LEVEL) + 0.3;
      const yMinWL = Math.floor(minForScale*10)/10;
      const yMaxWL = Math.ceil(maxForScale*10)/10;

      // Plugin t√¥ v√πng c·∫£nh b√°o theo tr·ª•c m·ª±c n∆∞·ªõc (yLevel)
      const levelZonesPlugin = {
        id:'levelZones',
        beforeDraw(chart){
          const {ctx, chartArea, scales} = chart;
          if (!chartArea) return;
          const y = scales.yLevel;
          if (!y) return;
          const zones = [
            { from: yMinWL,  to: DEAD_LEVEL, color:'rgba(148,163,184,0.14)' },
            { from: DEAD_LEVEL, to: NORMAL_LEVEL,   color:'rgba(34,197,94,0.15)' },
            { from: NORMAL_LEVEL,   to: (NORMAL_LEVEL + FLOOD_DESIGN_LEVEL) / 2,  color:'rgba(250,204,21,0.16)' },
            { from: (NORMAL_LEVEL + FLOOD_DESIGN_LEVEL) / 2,  to: FLOOD_DESIGN_LEVEL,   color:'rgba(249,115,22,0.16)' },
            { from: FLOOD_DESIGN_LEVEL,   to: FLOOD_CHECK_LEVEL,   color:'rgba(239,68,68,0.16)' },
            { from: FLOOD_CHECK_LEVEL,   to: yMaxWL,   color:'rgba(124,58,237,0.16)' }
          ];
          ctx.save();
          zones.forEach(z=>{
            const yTop = y.getPixelForValue(z.to);
            const yBottom = y.getPixelForValue(z.from);
            const top = Math.min(yTop, yBottom);
            const height = Math.abs(yBottom - yTop);
            ctx.fillStyle = z.color;
            ctx.fillRect(chartArea.left, top, chartArea.right - chartArea.left, height);
          });
          ctx.restore();
        }
      };

      if (typeof Chart !== 'undefined') {
        if (!Chart.registry.plugins.get('levelZones')) {
          Chart.register(levelZonesPlugin);
        }
      }

      // ƒê·∫£m b·∫£o canvas t·ªìn t·∫°i
const canvasEl = document.getElementById('waterComboChart');
if (!canvasEl) {
  console.error('Canvas element not found');
  return;
}

comboChart = new Chart(canvasEl.getContext('2d'), {
        type:'bar',
        data:{
          labels: shortLabels,
          datasets:[
            { type:'bar', label:'L∆∞·ª£ng m∆∞a (mm)', data: rainPerDay, yAxisID:'yRain', borderWidth:1 },
            { type:'line', label:'M·ª±c n∆∞·ªõc (m)', data: wlAvgPerDay, yAxisID:'yLevel', spanGaps:true, tension:0.25, pointRadius:3 },
            { type:'line', label:'MN Ch·∫øt (m)', data: labels.map(()=>DEAD_LEVEL), yAxisID:'yLevel', borderDash:[6,4], pointRadius:0 },
            { type:'line', label:'MN B√¨nh th∆∞·ªùng (m)', data: labels.map(()=>NORMAL_LEVEL), yAxisID:'yLevel', borderDash:[6,4], pointRadius:0 },
            { type:'line', label:'MN L≈© thi·∫øt k·∫ø (m)', data: labels.map(()=>FLOOD_DESIGN_LEVEL), yAxisID:'yLevel', borderDash:[6,4], pointRadius:0 },
            { type:'line', label:'MN L≈© ki·ªÉm tra (m)', data: labels.map(()=>FLOOD_CHECK_LEVEL), yAxisID:'yLevel', borderDash:[6,4], pointRadius:0 },
            { type:'line', label:'ƒê·ªânh ƒë·∫≠p (m)', data: labels.map(()=>DAM_CREST_LEVEL), yAxisID:'yLevel', borderDash:[6,4], pointRadius:0 }
          ]
        },
        options:{
          responsive:true, maintainAspectRatio:false, interaction:{ mode:'index', intersect:false },
          plugins:{ legend:{ display:true }, tooltip:{ mode:'index', intersect:false } },
          scales:{
            x:{ title:{ display:true, text:'Ng√†y' }, ticks:{ autoSkip:true, maxRotation:0 } },
            yRain:{ type:'linear', position:'left', beginAtZero:true, suggestedMax:yMaxRain, title:{ display:true, text:'L∆∞·ª£ng m∆∞a (mm)' } },
            yLevel:{ type:'linear', position:'right', min:yMinWL, max:yMaxWL, title:{ display:true, text:'M·ª±c n∆∞·ªõc (m)' }, grid:{ drawOnChartArea:false } }
          }
        },
        plugins:['levelZones']
      });

      // ===== Tr·∫°ng th√°i m·ª±c n∆∞·ªõc g·∫ßn nh·∫•t =====
      let lastVal = null;
      for (let i = wlAvgPerDay.length - 1; i >= 0; i--){
        if (wlAvgPerDay[i] != null && Number.isFinite(wlAvgPerDay[i])){
          lastVal = wlAvgPerDay[i];
          break;
        }
      }

      if(lastVal == null || Number.isNaN(lastVal)){
        waterStatusEl.textContent = 'Kh√¥ng c√≥ d·ªØ li·ªáu m·ª±c n∆∞·ªõc.';
      }else{
        const lastStr = formatFixedVN(lastVal, 2);
        const diffAboveDead = formatFixedVN(lastVal - DEAD_LEVEL, 2);
        const diffBelowDead = formatFixedVN(DEAD_LEVEL - lastVal, 2);
        const normalStr   = formatFixedVN(NORMAL_LEVEL, 2);
        const designStr   = formatFixedVN(FLOOD_DESIGN_LEVEL, 2);

        let baseText;
        if(lastVal >= DEAD_LEVEL){
          baseText = `M·ª±c n∆∞·ªõc g·∫ßn nh·∫•t ${lastStr} m ‚Äî cao h∆°n m·ª±c n∆∞·ªõc ch·∫øt ${diffAboveDead} m.`;
        }else{
          baseText = `M·ª±c n∆∞·ªõc g·∫ßn nh·∫•t ${lastStr} m ‚Äî th·∫•p h∆°n m·ª±c n∆∞·ªõc ch·∫øt ${diffBelowDead} m.`;
        }

        let zoneText;
        if(lastVal < DEAD_LEVEL){
          zoneText = 'ƒêang d∆∞·ªõi m·ª±c n∆∞·ªõc ch·∫øt, d∆∞·ªõi v√πng l√†m vi·ªác b√¨nh th∆∞·ªùng.';
        }else if(lastVal < NORMAL_LEVEL){
          zoneText = `V√ôNG AN TO√ÄN ‚Äì d∆∞·ªõi m·ª±c n∆∞·ªõc d√¢ng b√¨nh th∆∞·ªùng (${normalStr} m).`;
        }else if(lastVal < (NORMAL_LEVEL + FLOOD_DESIGN_LEVEL) / 2){
          zoneText = `V√ôNG V√ÄNG ‚Äì quanh ng∆∞·ª°ng m·ª±c n∆∞·ªõc d√¢ng b√¨nh th∆∞·ªùng (${normalStr} m), c·∫ßn theo d√µi.`;
        }else if(lastVal < FLOOD_DESIGN_LEVEL){
          zoneText = `V√ôNG CAM ‚Äì gi·ªØa m·ª±c n∆∞·ªõc d√¢ng b√¨nh th∆∞·ªùng v√† m·ª±c n∆∞·ªõc d√¢ng gia c∆∞·ªùng (${designStr} m), m·ª©c c·∫£nh b√°o cao.`;
        }else if(lastVal < FLOOD_CHECK_LEVEL){
          zoneText = `V√ôNG ƒê·ªé ‚Äì x·∫•p x·ªâ ho·∫∑c v∆∞·ª£t m·ª±c n∆∞·ªõc l≈© thi·∫øt k·∫ø (${designStr} m), r·∫•t nguy hi·ªÉm.`;
        } else {
          zoneText = `V√ôNG T√çM ‚Äì v∆∞·ª£t m·ª±c n∆∞·ªõc l≈© ki·ªÉm tra, nguy c∆° c·ª±c k·ª≥ nghi√™m tr·ªçng.`;
        }

        waterStatusEl.textContent = `${baseText} Tr·∫°ng th√°i: ${zoneText}`;
      }
    }

    /* ================== SUBTITLE ================== */
    function setSubtitle(){
      if (customTimeRange) {
        const { fromDate, fromTime, toDate, toTime } = customTimeRange;
        subtitleDiv.textContent = `T·ª´ ${fromDate} ${fromTime || '00:00:00'} ƒë·∫øn ${toDate} ${toTime || '23:59:59'}`;
      } else if (selectedWeek !== 'all') {
        const [year, week] = selectedWeek.split('-W');
        subtitleDiv.textContent = `Tu·∫ßn ${week} nƒÉm ${year}`;
      } else if (selectedDayNight !== 'all') {
        const label = selectedDayNight === 'day' ? 'Ng√†y (7h-19h)' : 'ƒê√™m (19h-7h)';
        if (selectedYear !== 'all' && selectedMonth !== 'all') {
          subtitleDiv.textContent = `${label} - Th√°ng ${selectedMonth} nƒÉm ${selectedYear}`;
        } else if (selectedYear !== 'all') {
          subtitleDiv.textContent = `${label} - NƒÉm ${selectedYear}`;
        } else {
          subtitleDiv.textContent = label;
        }
      } else if (selectedYear !== 'all' && selectedMonth !== 'all') {
        subtitleDiv.textContent = `Th√°ng ${selectedMonth} nƒÉm ${selectedYear}`;
      } else if (selectedYear !== 'all' && selectedQuarter !== 'all') {
        subtitleDiv.textContent = `Qu√Ω ${selectedQuarter} nƒÉm ${selectedYear}`;
      } else if (selectedYear !== 'all') {
        subtitleDiv.textContent = `NƒÉm ${selectedYear}`;
      } else {
        const c = new Date();
        subtitleDiv.textContent = `Th√°ng ${c.getMonth()+1} nƒÉm ${c.getFullYear()}`;
      }
    }

    /* ================== FILTER ================== */
    function clientFilter(data){
      return data.filter(r=>{
        if (customTimeRange) {
          if (!r._dt) return false;
          const { fromDate, fromTime, toDate, toTime } = customTimeRange;
          const fromDateTime = new Date(`${fromDate}T${fromTime || '00:00:00'}`);
          const toDateTime = new Date(`${toDate}T${toTime || '23:59:59'}`);
          if (r._dt < fromDateTime || r._dt > toDateTime) return false;
        }
        if (selectedWeek !== 'all') {
          if (!r._dt) return false;
          const weekNum = getWeekNumber(r._dt);
          const rowWeek = `${r._y}-W${String(weekNum).padStart(2, '0')}`;
          if (rowWeek !== selectedWeek) return false;
        }
        if (selectedDayNight !== 'all') {
          if (!r._dt) return false;
          if (selectedDayNight === 'day' && !isDayTime(r._dt)) return false;
          if (selectedDayNight === 'night' && !isNightTime(r._dt)) return false;
        }
        if (selectedYear !== 'all' && String(r._y) !== selectedYear) return false;
        if (selectedMonth !== 'all' && r._m !== Number(selectedMonth)) return false;
        if (selectedQuarter !== 'all' && r._q !== Number(selectedQuarter)) return false;
        return true;
      });
    }

    /* ================== LOAD & CACHE ================== */
        /* ================== LOAD & CACHE ================== */
        function normalizeRows(rows){
      for (const r of rows){
        const d = parseVNDateTime(r.ngayGio);
        r._dt = d;
        if (d){
          r._y = d.getFullYear(); r._m = d.getMonth()+1; r._q = Math.floor(d.getMonth()/3)+1;
          r._ngay = formatVNDate(d);
          r._gio  = formatVNTime(d);
        } else {
          r._y = r._m = r._q = null;
          if (typeof r.ngayGio === 'string'){
            const [dp='', tp=''] = r.ngayGio.split(' ');
            r._ngay = dp; r._gio = tp;
          } else {
            r._ngay = ''; r._gio = '';
          }
        }
      }
      return rows;
    }
    function scopeKey(y){ return (y === 'all') ? 'all' : `year:${y}`; }

    function indexYearsAndWarmCache(allRows){
      const buckets = new Map();
      for (const r of allRows){
        if (r._y == null) continue;
        const k = `year:${r._y}`;
        if (!buckets.has(k)) buckets.set(k, []);
        buckets.get(k).push(r);
      }
      for (const [k, rows] of buckets){
        if (!cacheByScope.has(k)) cacheByScope.set(k, rows);
      }
    }

    async function loadScope(y, isBackground = false) {
      const key = scopeKey(y);
      
      // ∆Øu ti√™n t·∫£i t·ª´ cache tr∆∞·ªõc ti√™n
      if (!isBackground) {
        const cachedData = loadFromLocalStorage(`hoThanhSon_${key}`);
        if (cachedData) {
          console.log(`ƒê√£ t·∫£i d·ªØ li·ªáu t·ª´ cache cho ${key}`);
          const normalizedData = normalizeRows(cachedData);
          cacheByScope.set(key, normalizedData);
          if (y === 'all') {
            indexYearsAndWarmCache(normalizedData);
          }
          return normalizedData;
        }
      }

      // N·∫øu ƒë√£ c√≥ trong cacheByScope, tr·∫£ v·ªÅ lu√¥n
      if (cacheByScope.has(key)) return cacheByScope.get(key);

      // N·∫øu c√≥ d·ªØ li·ªáu all v√† c·∫ßn d·ªØ li·ªáu theo nƒÉm, l·ªçc t·ª´ all
      if (cacheByScope.has('all') && y !== 'all') {
        const allRows = cacheByScope.get('all');
        indexYearsAndWarmCache(allRows);
        return cacheByScope.get(key) || [];
      }

      // N·∫øu kh√¥ng, t·∫£i t·ª´ server
      const url = (y==='all') ? buildApiUrl('all','all','all') : buildApiUrl(y,'all','all');
      if (currentFetchCtrl) currentFetchCtrl.abort();
      currentFetchCtrl = new AbortController();
      
      try {
        const res = await fetch(url, { cache:'no-store', signal: currentFetchCtrl.signal });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();
        if (!Array.isArray(json)) throw new Error('D·ªØ li·ªáu tr·∫£ v·ªÅ kh√¥ng h·ª£p l·ªá');
        const norm = normalizeRows(json);

        cacheByScope.set(key, norm);
        saveToLocalStorage(`hoThanhSon_${key}`, norm);

        if (y === 'all') indexYearsAndWarmCache(norm);

        return norm;
      } catch (err) {
        if (err.name === 'AbortError') return [];
        console.error('L·ªói t·∫£i d·ªØ li·ªáu:', err);
        throw err;
      }
    }

    async function loadNewDataInBackground() {
      if (isBackgroundLoading) return;
      
      isBackgroundLoading = true;
      try {
        // T·∫£i d·ªØ li·ªáu m·ªõi t·ª´ server
        const freshData = await loadScope('all', true);
        const currentData = cacheByScope.get('all') || [];
        
        // So s√°nh ƒë·ªÉ xem c√≥ thay ƒë·ªïi kh√¥ng
        const hasChanges = freshData.length !== currentData.length || 
                          JSON.stringify(freshData) !== JSON.stringify(currentData);
        
        if (hasChanges) {
          // C·∫≠p nh·∫≠t cache
          cacheByScope.set('all', freshData);
          saveToLocalStorage('hoThanhSon_all', freshData);
          indexYearsAndWarmCache(freshData);
          
          // N·∫øu ƒëang ·ªü ch·∫ø ƒë·ªô xem t·∫•t c·∫£, c·∫≠p nh·∫≠t giao di·ªán
          if (selectedYear === 'all') {
            allData = freshData;
            populateYearFilter(allData);
            populateWeekFilter(allData);
            filteredData = clientFilter(allData);
            drawTableWithPagination();
        renderRainStats();

// Ch·ªâ v·∫Ω chart n·∫øu ƒëang ·ªü tab monitoring
if (currentContent === 'monitoring') {
  setTimeout(() => {
    updateCharts();
  }, 100);
}
          }
          
          // Th√¥ng b√°o cho ng∆∞·ªùi d√πng
          showNotification('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t!');
        }
      } catch (err) {
        console.error('L·ªói khi t·∫£i d·ªØ li·ªáu ng·∫ßm:', err);
      } finally {
        isBackgroundLoading = false;
        // L√™n l·ªãch ki·ªÉm tra l·∫°i sau 5 ph√∫t
        setTimeout(loadNewDataInBackground, 5 * 60 * 1000);
      }
    }

    /* ================== PAGINATION ================== */
    function getTotalPages(){
      return Math.max(1, Math.ceil(filteredData.length / ROWS_PER_PAGE));
    }
    function clampPage(p){
      const tp = getTotalPages();
      return Math.min(Math.max(1, p), tp);
    }
    function getPagedSlice(){
      const tp = getTotalPages();
      currentPage = clampPage(currentPage);
      const start = (currentPage-1) * ROWS_PER_PAGE;
      const end = Math.min(start + ROWS_PER_PAGE, filteredData.length);
      return { start, end, slice: filteredData.slice(start, end), totalPages: tp };
    }
    function buildPageList(current, total){
      const pages = [];
      if (total <= 7){
        for (let p=1;p<=total;p++) pages.push(p);
      } else {
        pages.push(1);
        let start = Math.max(2, current-1);
        let end   = Math.min(total-1, current+1);
        if (start > 2) pages.push('...');
        for (let p=start;p<=end;p++) pages.push(p);
        if (end < total-1) pages.push('...');
        pages.push(total);
      }
      return pages;
    }
    function renderPaginationBar(){
      const { start, end, totalPages } = getPagedSlice();
      if (!filteredData.length){
        pagerBar.style.display = 'none';
        return;
      }
      pagerBar.style.display = 'flex';

      btnPrev.disabled = currentPage <= 1;
      btnNext.disabled = currentPage >= totalPages;

      pageNumbers.innerHTML = '';
      const list = buildPageList(currentPage, totalPages);
      list.forEach(item=>{
        if (item === '...'){
          const span = document.createElement('span');
          span.className = 'page-dots';
          span.textContent = '‚Ä¶';
          pageNumbers.appendChild(span);
        } else {
          const b = document.createElement('button');
          b.className = 'page-btn' + (item===currentPage ? ' active' : '');
          b.textContent = item;
          b.addEventListener('click', () => {
            if (currentPage !== item){
              currentPage = item;
              drawTableWithPagination();
            }
          });
          pageNumbers.appendChild(b);
        }
      });

      pagerInfo.textContent = `Trang ${currentPage}/${totalPages}`;
    }
    function drawTableWithPagination(){
      // TH√äM D√íNG N√ÄY TR∆Ø·ªöC KHI G·ªåI getPagedSlice():
  filteredData.sort((a, b) => {
    if (!a._dt || !b._dt) return 0;
    return b._dt - a._dt; // S·∫Øp x·∫øp gi·∫£m d·∫ßn (m·ªõi nh·∫•t tr∆∞·ªõc)
  });
        const { start, slice } = getPagedSlice();
      renderTable(slice, start);
      renderPaginationBar();
    }

    btnPrev.addEventListener('click', () => {
      currentPage = clampPage(currentPage - 1);
      drawTableWithPagination();
    });
    btnNext.addEventListener('click', () => {
      currentPage = clampPage(currentPage + 1);
      drawTableWithPagination();
    });

    /* ================== APPLY (debounce) ================== */
    let filterTimer = null;
    function scheduleApply(){ clearTimeout(filterTimer); filterTimer = setTimeout(applyFiltersAndRender, 80); }
    function applyFiltersAndRender(){
      const y = yearFilter.value;
      let q = quarterFilter.value;
      let m = monthFilter.value;
      const w = weekFilter.value;
      const dn = dayNightFilter.value;
      
      if (m !== 'all') q = 'all';
      if (q !== 'all') m = 'all';
      if (w !== 'all') { q = 'all'; m = 'all'; }
      
      selectedYear = y; 
      selectedQuarter = q; 
      selectedMonth = m;
      selectedWeek = w;
      selectedDayNight = dn;
      
      currentPage = 1;
      fetchAndRender();
    }
    
    yearFilter.addEventListener('change', scheduleApply);
    quarterFilter.addEventListener('change', () => { 
      if (quarterFilter.value !== 'all') {
        monthFilter.value = 'all'; 
        weekFilter.value = 'all';
      }
      scheduleApply(); 
    });
    monthFilter.addEventListener('change', () => { 
      if (monthFilter.value !== 'all') {
        quarterFilter.value = 'all';
        weekFilter.value = 'all';
      }
      scheduleApply(); 
    });
    weekFilter.addEventListener('change', () => {
      if (weekFilter.value !== 'all') {
        quarterFilter.value = 'all';
        monthFilter.value = 'all';
      }
      scheduleApply();
    });
    dayNightFilter.addEventListener('change', scheduleApply);

    /* ================== FETCH & RENDER ================== */
    async function fetchAndRender(){
      setSubtitle();
      errorDiv.style.display = 'none';
      tableBody.innerHTML = `<tr><td colspan="16"><div class="loader">ƒêang t·∫£i d·ªØ li·ªáu...</div></td></tr>`;
      try{
        const scopeData = await loadScope(selectedYear);

        if (!allData.length && cacheByScope.has('all')) {
          allData = cacheByScope.get('all');
          populateYearFilter(allData);
          populateWeekFilter(allData);
        } else if (selectedYear === 'all' && !allData.length) {
          allData = scopeData;
          populateYearFilter(allData);
          populateWeekFilter(allData);
        } else if (selectedYear === 'all') {
          populateYearFilter(allData);
          populateWeekFilter(allData);
        } else {
          populateWeekFilter(scopeData);
        }

        filteredData = clientFilter(scopeData);

        drawTableWithPagination();
        renderRainStats();
        requestAnimationFrame(()=> setTimeout(updateCharts, 0));
      }catch(err){
        if (err.name === 'AbortError') return;
        console.error('L·ªói t·∫£i d·ªØ li·ªáu:', err);
        showError(`Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. L·ªói: ${err.message || err}`);
      }
    }

    /* ================== EXPORT EXCEL ================== */
    document.getElementById('export-excel').addEventListener('click', async () => {
      if (!filteredData.length) return alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t.');
      await loadScript('https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js');
      const headers = [
        "STT","Ng√†y","Gi·ªù","M·ª±c n∆∞·ªõc (m)","Dung t√≠ch (Tri·ªáu m¬≥)","L∆∞·ª£ng m∆∞a (mm)",
        "Htr√†n 1 (cm)","Qtr√†n 1 (m¬≥/s)","Htr√†n 2 (cm)","Qtr√†n 2 (m¬≥/s)",
        "a (cm)","C·ªôt n∆∞·ªõc ƒë·∫ßu k√™nh (m)","Qc·ªëng (m¬≥/s)","H·ªç, t√™n ng∆∞·ªùi v·∫≠n h√†nh"
      ];
      const rows = filteredData.map((r,i)=>[
        i+1, r._ngay||'', r._gio||'', r.mucNuoc??'', r.dungTich??'', r.luongMua??'',
        r.hTran1??'', r.qtran1??'', r.hTran2??'', r.qtran2??'',
        r.a??'', r.cotNuocDauKenh??'', r.qCong??'', r.nguoiVanHanh||''
      ]);
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
      ws['!cols'] = headers.map((_, ci) => {
        const maxLen = [headers, ...rows].reduce((m, row) => Math.max(m, String(row[ci] ?? '').length), 0);
        return { wch: Math.min(Math.max(10, maxLen + 2), 40) };
      });
      XLSX.utils.book_append_sheet(wb, ws, "NhatKyHoThanhSon");
      XLSX.writeFile(wb, "NhatKyVanHanh_HoThanhSon.xlsx");
    });

    /* ================== IN ================== */
    document.getElementById('print-page').addEventListener('click', () => {
      setSubtitle();
      window.print();
    });

    /* ================== FULLSCREEN ================== */
    const btnFs = document.getElementById('toggle-fullscreen');
    btnFs.addEventListener('click', async () => {
      const docEl = document.documentElement;
      if (!document.fullscreenElement) {
        try{
          await docEl.requestFullscreen();
          document.body.classList.add('fullpage');
          btnFs.textContent = 'Tho√°t to√†n m√†n h√¨nh';
        }catch(e){ console.warn('Kh√¥ng th·ªÉ v√†o fullscreen:', e); }
      } else {
        try{ await document.exitFullscreen(); }catch(e){}
        document.body.classList.remove('fullpage');
        btnFs.textContent = 'To√†n m√†n h√¨nh';
      }
    });
    document.addEventListener('fullscreenchange', () => {
      if (!document.fullscreenElement) {
        document.body.classList.remove('fullpage');
        btnFs.textContent = 'To√†n m√†n h√¨nh';
      }
    });

    /* ================== CUSTOM TIME RANGE ================== */
    btnToggleCustomTime.addEventListener('click', () => {
      const isVisible = customTimePanel.style.display !== 'none';
      customTimePanel.style.display = isVisible ? 'none' : 'block';
      btnToggleCustomTime.textContent = isVisible ? '‚è±Ô∏è Th·ªùi gian t√πy ch·ªânh' : '‚è±Ô∏è ƒê√≥ng b·ªô l·ªçc';
    });

    btnApplyCustomTime.addEventListener('click', () => {
      const fromDate = customFromDate.value;
      const toDate = customToDate.value;
      
      if (!fromDate || !toDate) {
        alert('Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß ng√†y b·∫Øt ƒë·∫ßu v√† ng√†y k·∫øt th√∫c');
        return;
      }
      
      const fromTime = customFromTime.value || '00:00:00';
      const toTime = customToTime.value || '23:59:59';
      
      customTimeRange = { fromDate, fromTime, toDate, toTime };
      
      yearFilter.value = 'all';
      quarterFilter.value = 'all';
      monthFilter.value = 'all';
      weekFilter.value = 'all';
      dayNightFilter.value = 'all';
      
      selectedYear = 'all';
      selectedQuarter = 'all';
      selectedMonth = 'all';
      selectedWeek = 'all';
      selectedDayNight = 'all';
      
      currentPage = 1;
      fetchAndRender();
    });

    btnClearCustomTime.addEventListener('click', () => {
      customFromDate.value = '';
      customFromTime.value = '';
      customToDate.value = '';
      customToTime.value = '';
      customTimeRange = null;
      customTimePanel.style.display = 'none';
      btnToggleCustomTime.textContent = '‚è±Ô∏è Th·ªùi gian t√πy ch·ªânh';
      
      currentPage = 1;
      fetchAndRender();
    });

    /* ================== INIT ================== */
        /* ================== INIT ================== */
        (function init(){
  yearFilter.value = 'all';
  quarterFilter.value = 'all';
  monthFilter.value = 'all';
  weekFilter.value = 'all';
  dayNightFilter.value = 'all';
  
  customFromTime.value = '00:00:00';
  customToTime.value = '23:59:59';
  
  currentPage = 1;
  
  // Kh√¥i ph·ª•c tr·∫°ng th√°i sidebar
  restoreSidebarState();
  // === TH√äM CODE M·ªöI T·∫†I ƒê√ÇY ===
  // Toggle sidebar button for desktop and mobile - √°p d·ª•ng cho t·∫•t c·∫£ c√°c n√∫t
  function toggleSidebar() {
    sidebar.classList.toggle('hidden');
    mainContent.classList.toggle('expanded');
    
    // Save state to localStorage
    const isHidden = sidebar.classList.contains('hidden');
    localStorage.setItem('sidebar-hidden', isHidden);
  }

  // ƒêƒÉng k√Ω s·ª± ki·ªán cho t·∫•t c·∫£ c√°c n√∫t c√≥ class "sidebar-toggle-all"
  document.querySelectorAll('.sidebar-toggle-all').forEach(btn => {
    btn.addEventListener('click', toggleSidebar);
  });
  // === K·∫æT TH√öC CODE M·ªöI ===
  
  // ƒê·∫∑t tab m·∫∑c ƒë·ªãnh l√† "D·ªØ li·ªáu quan tr·∫Øc"
  currentContent = 'monitoring';

  // ƒê·∫∑t tab m·∫∑c ƒë·ªãnh l√† "D·ªØ li·ªáu quan tr·∫Øc"
  currentContent = 'monitoring';
  
  // C·∫≠p nh·∫≠t UI
  menuItems.forEach(item => {
    if (item.getAttribute('data-content') === 'monitoring') {
      item.classList.add('active');
    } else {
      item.classList.remove('active');
    }
  });
  
  contentBodies.forEach(body => {
    if (body.id === 'monitoring-content') {
      body.classList.add('active');
    } else {
      body.classList.remove('active');
    }
  });
  
  // T·∫£i d·ªØ li·ªáu ban ƒë·∫ßu
  fetchAndRender();
      
      // B·∫Øt ƒë·∫ßu t·∫£i d·ªØ li·ªáu m·ªõi ng·∫ßm sau 10 gi√¢y
      setTimeout(loadNewDataInBackground, 10 * 1000);
      
      // Thi·∫øt l·∫≠p t·ª± ƒë·ªông l√†m m·ªõi cache m·ªói 30 ph√∫t
      setInterval(() => {
        if (!isBackgroundLoading) {
          loadNewDataInBackground();
        }
      }, 30 * 60 * 1000);
    })();
  </script>
</body>
</html>
