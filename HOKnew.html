<script>
    // ====== C·∫§U H√åNH API ======
    const EXEC_URL = "https://script.google.com/macros/s/AKfycbw9Qof6w7zv5b_gMv09aG-0GoR75TTmx7-RY1JVnoSwDXWeg3H8XncLf2VnhrcRnQQm/exec";
    
    // T√™n Sheet: "HoOngKinh" (Kh√¥ng d·∫•u)
    const SHEET = "HoOngKinh"; 
    const API_URL = `${EXEC_URL}?sheet=${encodeURIComponent(SHEET)}`;
    const CACHE_KEY = "HoOngKinh_Cache_V4_Final"; 

    // ====== C·∫§U H√åNH C·ªòT (IDX) - ƒê√É S·ª¨A THEO C·ªòT C ======
    // Quy t·∫Øc: C·ªôt A=0, B=1, C=2, D=3, E=4...
    const IDX = {
      DATE: 2,       // C·ªôt C: Ng√†y Gi·ªù
      LEVEL: 3,      // C·ªôt D: M·ª±c n∆∞·ªõc
      VOL: 4,        // C·ªôt E: Dung t√≠ch
      RAIN: 5,       // C·ªôt F: L∆∞·ª£ng m∆∞a
      HTRAN: 6,      // C·ªôt G: H tr√†n
      QTRAN: 7,      // C·ªôt H: Q tr√†n t·ª± do
      OPERATOR: 16   // C·ªôt Q: Ng∆∞·ªùi v·∫≠n h√†nh (Th∆∞·ªùng d·ªãch 1 c·ªôt so v·ªõi c≈© l√† 15)
    };

    // Ng∆∞·ª°ng m·ª±c n∆∞·ªõc H·ªì √îng Kinh
    const LVL_DEAD = 42.50; const LVL_BT = 47.70; const LVL_GC = 49.35;
    const LVL_MID  = (LVL_BT + LVL_GC) / 2;
    const LVL_DEAD_TXT = formatMeter(LVL_DEAD,2);
    const LVL_BT_TXT = formatMeter(LVL_BT,2);
    const LVL_GC_TXT = formatMeter(LVL_GC,2);

    // DOM Elements
    const yearFilter = document.getElementById('year-filter');
    const quarterFilter = document.getElementById('quarter-filter');
    const monthFilter = document.getElementById('month-filter');
    const weekFilter = document.getElementById('week-filter');
    const dayNightFilter = document.getElementById('daynight-filter');
    const qFilter = document.getElementById('q-filter');
    const tableBody = document.getElementById('table-body');
    const printTbody = document.getElementById('print-tbody');
    const errorDiv = document.getElementById('error-message');
    const subtitleDiv = document.getElementById('subtitle');
    const waterStatusEl = document.getElementById('water-status');
    const syncIndicator = document.getElementById('sync-indicator');
    const pageSizeEl = document.getElementById('page-size');
    const pageInfoEl = document.getElementById('page-info');
    const prevBtn = document.getElementById('prev-page');
    const nextBtn = document.getElementById('next-page');
    
    // Custom Time DOM
    const customTimePanel = document.getElementById('custom-time-panel');
    const btnCustomTime = document.getElementById('btn-custom-time');
    const btnApplyCustom = document.getElementById('btn-apply-custom');
    const btnClearCustom = document.getElementById('btn-clear-custom');

    // State
    let allData = [];
    let filteredData = [];
    let customTimeRange = null;
    let isFirstLoad = true;
    let page = 1;
    let pageSize = Number(pageSizeEl.value);
    let comboChart;

    // ====== Helpers ======
    function formatNumber(v, d=1){ return (v==null||v===''||isNaN(Number(v))) ? '0' : Number(v).toLocaleString('vi-VN',{maximumFractionDigits:d}); }
    function formatNumberFlexible(v){ return (v==null||v===''||isNaN(Number(v))) ? '' : Number(v).toLocaleString('vi-VN',{minimumFractionDigits:0, maximumFractionDigits:3}); }
    function formatMeter(v, d=2){ return (v==null||isNaN(Number(v))) ? '' : Number(v).toLocaleString('vi-VN',{minimumFractionDigits:d, maximumFractionDigits:d}); }
    function safeNum(v){ return (v && typeof v==='string') ? (Number(v.replace(/,/g,'.'))||0) : (Number(v)||0); }

    function parseVNDateTime(s) {
      if (!s || typeof s !== 'string') return null;
      // X·ª≠ l√Ω linh ho·∫°t: "19/11/2025" ho·∫∑c "19/11/2025 07:00:00" ho·∫∑c "Tue Nov 19..."
      // N·∫øu l√† string chu·∫©n ISO ho·∫∑c Date string c·ªßa Google Sheet
      let d = new Date(s);
      if(!isNaN(d.getTime())) return d;

      // N·∫øu l√† ƒë·ªãnh d·∫°ng VN dd/mm/yyyy
      const parts = s.trim().split(/\s+/); 
      const dPart = parts[0];
      const tPart = parts[1] || '00:00';

      const dcomp = dPart.split('/');
      if (dcomp.length < 3) return null;

      const tcomp = tPart.split(':');
      d = new Date(
        parseInt(dcomp[2], 10),
        parseInt(dcomp[1], 10) - 1,
        parseInt(dcomp[0], 10),
        parseInt(tcomp[0] || 0, 10),
        parseInt(tcomp[1] || 0, 10)
      );
      return isNaN(d.getTime()) ? null : d;
    }

    function getWeekNumber(d) {
      d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
      var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
      return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
    }

    // ====== CORE LOGIC ======
    function processArrayData(rawData) {
      if (!Array.isArray(rawData) || rawData.length === 0) return [];

      // --- DEBUG: In ra d√≤ng ƒë·∫ßu ti√™n ƒë·ªÉ ki·ªÉm tra n·∫øu v·∫´n l·ªói ---
      console.log("üîç D·ªÆ LI·ªÜU D√íNG ƒê·∫¶U (Raw):", rawData[0]);
      // --------------------------------------------------------

      return rawData.map(row => {
        // ƒê·ªçc c·ªôt Ng√†y (Index 2 - C·ªôt C)
        const dateStr = row[IDX.DATE]; 
        const d = parseVNDateTime(dateStr);
        
        let y=null,m=null,q=null,weekKey=null,dayStr='',timeStr='';
        if(d){
          y = d.getFullYear(); m = d.getMonth()+1; q = Math.ceil(m/3);
          weekKey = `${y}-W${String(getWeekNumber(d)).padStart(2,'0')}`;
          dayStr = `${String(d.getDate()).padStart(2,'0')}/${String(m).padStart(2,'0')}/${y}`;
          timeStr = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        } else {
          dayStr = dateStr; 
        }

        return {
          __d: d, __y: y, __m: m, __q: q, __weekKey: weekKey,
          __dayStr: dayStr, __timeStr: timeStr, __dayKey: dayStr,
          
          mucNuoc:    row[IDX.LEVEL],
          dungTich:   row[IDX.VOL],
          luongMua:   row[IDX.RAIN],
          hTran:      row[IDX.HTRAN],
          qTranTuDo:  row[IDX.QTRAN],
          nguoiVanHanh: row[IDX.OPERATOR],

          _mucNuoc:   safeNum(row[IDX.LEVEL]),
          _luongMua:  safeNum(row[IDX.RAIN]),
          _qTranTuDo: safeNum(row[IDX.QTRAN])
        };
      }).filter(r => r.__d !== null); // L·ªçc b·ªè d√≤ng kh√¥ng c√≥ ng√†y gi·ªù h·ª£p l·ªá
    }

    // ====== RENDER & FILTER ======
    function rowHtml(r, i){
      return `<td>${i}</td><td>${r.__dayStr}</td><td>${r.__timeStr}</td>
        <td>${formatNumberFlexible(r.mucNuoc)}</td><td>${formatNumberFlexible(r.dungTich)}</td>
        <td>${formatNumberFlexible(r.luongMua)}</td><td>${formatNumberFlexible(r.hTran)}</td>
        <td>${formatNumberFlexible(r.qTranTuDo)}</td><td>${r.nguoiVanHanh||''}</td><td></td>`;
    }

    function renderTablePaged(data){
      const total = data.length;
      const totalPages = Math.max(1, Math.ceil(total/pageSize));
      if(page>totalPages) page=totalPages;
      const start = (page-1)*pageSize; 
      const end = Math.min(start+pageSize, total);

      if(total===0){
        tableBody.innerHTML = `<tr><td colspan="${totalColumns}" class="status-message">
          Kh√¥ng c√≥ d·ªØ li·ªáu ph√π h·ª£p.<br>
          <small style="color:red">Ki·ªÉm tra Console (F12) ƒë·ªÉ xem d·ªØ li·ªáu th√¥.</small>
        </td></tr>`;
      } else {
        const rows = [];
        for(let i=start; i<end; i++) rows.push(`<tr>${rowHtml(data[i], i+1)}</tr>`);
        tableBody.innerHTML = rows.join('');
      }
      pageInfoEl.textContent = `Trang ${page}/${totalPages} ‚Äî ${total} d√≤ng`;
      prevBtn.disabled = page<=1; nextBtn.disabled = page>=totalPages;
    }

    function applyFiltersAndRender(){
      const y=yearFilter.value, q=quarterFilter.value, m=monthFilter.value, w=weekFilter.value, dn=dayNightFilter.value, qMode=qFilter.value;
      let fromDT=null, toDT=null;
      if(customTimeRange){
        fromDT = new Date(`${customTimeRange.fromDate}T${customTimeRange.fromTime||'00:00:00'}`);
        toDT = new Date(`${customTimeRange.toDate}T${customTimeRange.toTime||'23:59:59'}`);
      }

      filteredData = allData.filter(r => {
        if(!r.__d) return false;
        if(fromDT && (r.__d<fromDT || r.__d>toDT)) return false;
        if(w!=='all' && r.__weekKey!==w) return false;
        const h = r.__d.getHours();
        if(dn==='day' && (h<7||h>=19)) return false;
        if(dn==='night' && (h>=7&&h<19)) return false;
        if(y!=='all' && String(r.__y)!==y) return false;
        if(m!=='all') { if(r.__m!=m) return false; }
        else if(q!=='all') { if(r.__q!=q) return false; }
        if(qMode==='zero' && r._qTranTuDo!==0) return false;
        if(qMode==='positive' && !(r._qTranTuDo>0)) return false;
        return true;
      });

      updateSubtitle();
      if(isFirstLoad) page=1;
      renderTablePaged(filteredData);
      updateChartsAndKPIs();
      isFirstLoad=false;
    }
    
    function updateSubtitle() {
      const c = new Date();
      let txt = `Th√°ng ${c.getMonth()+1} nƒÉm ${c.getFullYear()}`;
      if (customTimeRange) txt = `T·ª´ ${customTimeRange.fromDate} ƒë·∫øn ${customTimeRange.toDate}`;
      else if (weekFilter.value !== 'all') { const [Yr, Wk] = weekFilter.value.split('-W'); txt = `Tu·∫ßn ${parseInt(Wk)} nƒÉm ${Yr}`; }
      else if (monthFilter.value !== 'all') txt = `Th√°ng ${monthFilter.value} nƒÉm ${yearFilter.value !== 'all' ? yearFilter.value : c.getFullYear()}`;
      else if (quarterFilter.value !== 'all') txt = `Qu√Ω ${quarterFilter.value} nƒÉm ${yearFilter.value !== 'all' ? yearFilter.value : c.getFullYear()}`;
      else if (yearFilter.value !== 'all') txt = `NƒÉm ${yearFilter.value}`;
      subtitleDiv.textContent = txt;
    }

    function populateFilters(data){
      const years = [...new Set(data.map(r=>r.__y).filter(Boolean))].sort((a,b)=>b-a);
      const oldY = yearFilter.value;
      yearFilter.innerHTML = '<option value="all">T·∫•t c·∫£</option>';
      years.forEach(y=>yearFilter.add(new Option(`NƒÉm ${y}`, y)));
      if(years.includes(Number(oldY))) yearFilter.value=oldY;
      populateWeekFilter(data);
    }
    function populateWeekFilter(data){
      const weeks = [...new Set(data.map(r=>r.__weekKey).filter(Boolean))].sort().reverse();
      const oldW = weekFilter.value;
      weekFilter.innerHTML = '<option value="all">T·∫•t c·∫£</option>';
      weeks.forEach(w=>{ const [Yr, Wk]=w.split('-W'); weekFilter.add(new Option(`Tu·∫ßn ${parseInt(Wk)} (${Yr})`, w)); });
      if(weeks.includes(oldW)) weekFilter.value=oldW;
    }

    // ====== CHART & KPI ======
    Chart.register({
      id: 'levelBands',
      beforeDraw(chart, args, opts) {
        const bands = opts && opts.bands;
        if (!bands) return;
        const yScale = chart.scales['yLevel'];
        if (!yScale) return;
        const {ctx, chartArea} = chart;
        ctx.save();
        bands.forEach(b=>{
          const y1 = yScale.getPixelForValue(b.from);
          const y2 = yScale.getPixelForValue(b.to);
          const top = Math.min(Math.max(chartArea.top, Math.min(y1, y2)), chartArea.bottom);
          const bottom = Math.min(Math.max(chartArea.top, Math.max(y1, y2)), chartArea.bottom);
          if (bottom > top) { ctx.fillStyle = b.color || 'rgba(0,0,0,0.05)'; ctx.fillRect(chartArea.left, top, chartArea.right - chartArea.left, bottom - top); }
        });
        ctx.restore();
      }
    });

    function updateChartsAndKPIs(){
      const map = new Map();
      filteredData.forEach(r=>{
        const key = r.__dayKey;
        if(!map.has(key)) map.set(key, { rain:0, lastLevel:null, lastD:r.__d });
        const obj = map.get(key);
        obj.rain += r._luongMua;
        if(!Number.isNaN(r._mucNuoc) && r.__d>=obj.lastD){ obj.lastLevel = r._mucNuoc; obj.lastD = r.__d; }
      });
      const sorted = [...map.entries()].sort((a,b)=> a[1].lastD - b[1].lastD);
      const labels = sorted.map(x=>x[0]);
      const dRain = sorted.map(x=>x[1].rain);
      const dLevel = sorted.map(x=>x[1].lastLevel);

      // KPI
      const totalRain = dRain.reduce((s,v)=>s+(v||0),0);
      const daysRain = dRain.filter(v=>v>0).length;
      const maxRain = dRain.length ? Math.max(...dRain) : 0;
      const qVals = filteredData.map(r=>r._qTranTuDo).filter(Number.isFinite);
      const maxQ = qVals.length ? Math.max(...qVals) : 0;

      document.getElementById('kpi-total').textContent = formatNumber(totalRain,1);
      document.getElementById('kpi-days').textContent = `${daysRain} / ${labels.length}`;
      document.getElementById('kpi-max').textContent = maxRain > 0 ? `${formatNumber(maxRain)} mm` : '0';
      document.getElementById('kpi-qmax').textContent = formatNumber(maxQ,3);

      // Chart
      const deadLine = labels.map(()=>LVL_DEAD);
      const maxR = Math.max(0, ...dRain);
      const yMaxR = maxR ? Math.ceil(maxR/(maxR>50?10:5))*(maxR>50?10:5) : 5;
      const lvls = dLevel.filter(v=>v!=null && !Number.isNaN(v));
      const minL = lvls.length ? Math.min(...lvls) : LVL_DEAD;
      const maxL = lvls.length ? Math.max(...lvls) : LVL_GC+1;
      const yMinL = Math.floor(Math.min(LVL_DEAD,minL)-0.5);
      const yMaxL = Math.ceil(maxL+0.5);

      const ctx = document.getElementById('waterChart').getContext('2d');
      if(comboChart) comboChart.destroy();
      const gradient = ctx.createLinearGradient(0,0,0,400);
      gradient.addColorStop(0,'rgba(30,164,141,0.3)'); gradient.addColorStop(1,'rgba(30,164,141,0.0)');

      comboChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { type:'bar', label:'L∆∞·ª£ng m∆∞a (mm)', data:dRain, yAxisID:'yRain', backgroundColor:'rgba(56,189,248,0.6)', maxBarThickness:30 },
            { type:'line', label:'M·ª±c n∆∞·ªõc (m)', data:dLevel, yAxisID:'yLevel', borderColor:'#1EA48D', backgroundColor:gradient, fill:true, tension:0.3, borderWidth:2, pointRadius:2 },
            { type:'line', label:'MN ch·∫øt', data:deadLine, yAxisID:'yLevel', borderColor:'#94a3b8', borderDash:[5,5], pointRadius:0, fill:false, borderWidth:1 }
          ]
        },
        options: {
          responsive:true, maintainAspectRatio:false, animation:false,
          interaction:{ mode:'index', intersect:false },
          plugins: {
            legend:{ position:'bottom' },
            levelBands:{ bands:[
              { from: LVL_BT, to: LVL_MID, color:'rgba(250,204,21,0.15)' },
              { from: LVL_MID, to: LVL_GC, color:'rgba(249,115,22,0.15)' },
              { from: LVL_GC, to: yMaxL, color:'rgba(248,113,113,0.2)' }
            ]}
          },
          scales: {
            x: { ticks:{ autoSkip:true, maxTicksLimit:15 } },
            yRain: { position:'left', beginAtZero:true, suggestedMax:yMaxR, grid:{color:'#f1f5f9'}, title:{display:true,text:'L∆∞·ª£ng m∆∞a'} },
            yLevel: { position:'right', min:yMinL, max:yMaxL, grid:{display:false}, title:{display:true,text:'M·ª±c n∆∞·ªõc'} }
          }
        }
      });

      if(dLevel.length && dLevel[dLevel.length-1]!=null){
        const last = dLevel[dLevel.length-1];
        let stt = 'B√¨nh th∆∞·ªùng';
        if(last<LVL_DEAD) stt = 'D∆∞·ªõi MN Ch·∫øt'; else if(last<LVL_BT) stt = 'An to√†n'; else if(last<LVL_GC) stt = 'C·∫£nh b√°o'; else stt = 'Nguy hi·ªÉm';
        waterStatusEl.textContent = `M·ª±c n∆∞·ªõc g·∫ßn nh·∫•t: ${formatMeter(last)} m - Tr·∫°ng th√°i: ${stt}`;
      } else waterStatusEl.textContent = 'Ch∆∞a c√≥ d·ªØ li·ªáu m·ª±c n∆∞·ªõc.';
    }

    // ====== INIT & EVENTS ======
    function initApp(){
      // Load Cache
      try {
        const cached = localStorage.getItem(CACHE_KEY);
        if(cached){
          const parsed = JSON.parse(cached);
          if(Array.isArray(parsed) && parsed.length > 0){
            allData = processArrayData(parsed);
            populateFilters(allData);
            applyFiltersAndRender();
            console.log("Loaded from Cache");
          }
        }
      } catch(e) {}

      syncIndicator.style.display = 'flex';
      fetch(API_URL)
        .then(r => r.json())
        .then(json => {
          if(json.error) throw new Error(json.message);
          allData = processArrayData(json);
          localStorage.setItem(CACHE_KEY, JSON.stringify(json));
          populateFilters(allData);
          applyFiltersAndRender();
          syncIndicator.style.display = 'none';
          console.log("Data Synced. Rows:", allData.length);
        })
        .catch(err => {
          console.error(err);
          syncIndicator.style.display = 'none';
          if(!allData.length) showError("L·ªói: " + err.message);
        });
    }

    function showError(msg){ errorDiv.textContent=msg; errorDiv.style.display='block'; tableBody.innerHTML=`<tr><td colspan="${totalColumns}">${msg}</td></tr>`; }

    yearFilter.addEventListener('change', ()=>{ 
      if(yearFilter.value!=='all') populateWeekFilter(allData.filter(r=>r.__y==yearFilter.value));
      else populateWeekFilter(allData);
      applyFiltersAndRender(); 
    });
    [quarterFilter, monthFilter, weekFilter, dayNightFilter, qFilter].forEach(el => el.addEventListener('change', applyFiltersAndRender));
    pageSizeEl.addEventListener('change', ()=>{ pageSize=Number(pageSizeEl.value); page=1; renderTablePaged(filteredData); });
    prevBtn.addEventListener('click', ()=>{ if(page>1){ page--; renderTablePaged(filteredData); } });
    nextBtn.addEventListener('click', ()=>{ page++; renderTablePaged(filteredData); });
    
    btnCustomTime.addEventListener('click', ()=>{ customTimePanel.style.display = customTimePanel.style.display==='none'?'block':'none'; });
    btnApplyCustom.addEventListener('click', ()=>{
      if(!document.getElementById('custom-from-date').value) return alert("Ch·ªçn ng√†y b·∫Øt ƒë·∫ßu");
      customTimeRange = { fromDate: document.getElementById('custom-from-date').value, fromTime: document.getElementById('custom-from-time').value, toDate: document.getElementById('custom-to-date').value, toTime: document.getElementById('custom-to-time').value };
      ['year','quarter','month','week','daynight'].forEach(id=>document.getElementById(id+'-filter').value='all');
      applyFiltersAndRender();
    });
    btnClearCustom.addEventListener('click', ()=>{ customTimeRange=null; customTimePanel.style.display='none'; applyFiltersAndRender(); });

    // Excel & Print
    document.getElementById('export-excel').addEventListener('click', () => {
      if (!filteredData.length) return alert('Kh√¥ng c√≥ d·ªØ li·ªáu.');
      const headers = ["STT","Ng√†y","Gi·ªù","M·ª±c n∆∞·ªõc (m)","Dung t√≠ch (Tri·ªáu m¬≥)","L∆∞·ª£ng m∆∞a (mm)","H tr√†n (cm)","Q tr√†n t·ª± do (m¬≥/s)","H·ªç, t√™n ng∆∞·ªùi v·∫≠n h√†nh","K√Ω t√™n"];
      const rows = filteredData.map((r, i) => [ i+1, r.__dayStr, r.__timeStr, r.mucNuoc, r.dungTich, r.luongMua, r.hTran, r.qTranTuDo, r.nguoiVanHanh, '' ]);
      const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]); ws['!cols'] = headers.map(()=>({wch:15}));
      const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "NhatKy_HoOngKinh"); XLSX.writeFile(wb, "NhatKyVanHanh.xlsx");
    });

    const printStyle = document.createElement('style'); document.head.appendChild(printStyle);
    function doPrint(ori){
      if(!filteredData.length) return;
      printTbody.innerHTML = filteredData.map((r,i)=>`<tr>${rowHtml(r,i+1)}</tr>`).join('');
      printStyle.textContent = `@media print{ @page{ size: A4 ${ori}; margin: 12mm; } }`;
      window.print();
    }
    document.getElementById('btn-print-portrait').addEventListener('click', ()=>doPrint('portrait'));
    document.getElementById('btn-print-landscape').addEventListener('click', ()=>doPrint('landscape'));

    initApp();
</script>
