<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Nhật ký vận hành hồ chứa - Hồ Ông Kinh</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    :root{ --header-bg:#1EA48D; --ink:#0f172a; }
    body{ font-family:'Times New Roman',serif; background:#f4f6f8; color:var(--ink); margin:0; padding:20px; font-size:14pt; }
    .container{ max-width:1600px; margin:0 auto; background:#fff; padding:30px; border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,.06); }
    h1{ font-size:16pt; font-weight:bold; text-align:center; text-transform:uppercase; margin:0 0 6px }
    .subtitle{ text-align:center; font-weight:bold; font-size:14pt; margin-bottom:18px }
    .controls-container{ display:flex; justify-content:space-between; flex-wrap:wrap; gap:12px; margin-bottom:18px; padding:14px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:12px; }
    .filters,.exports{ display:flex; align-items:center; gap:10px; flex-wrap:wrap }
    .filters label{ font-weight:bold }
    select, button{ padding:8px 12px; border-radius:8px; border:1px solid #d1d5db; background:#fff; font-family:inherit; font-size:13pt; cursor:pointer; }
    .exports button{ font-weight:bold; color:#fff }
    #btn-custom-time{ background:#6f42c1 } #export-excel{ background:#22c55e } #btn-print-portrait{ background:#0b5ed7 } #btn-print-landscape{ background:#7c3aed }
    
    /* KPI & Chart Styles */
    .kpi-grid{ display:grid; grid-template-columns:repeat(4,1fr); gap:14px; margin:14px 0; }
    .kpi{ background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:14px; text-align:center; box-shadow:0 1px 6px rgba(0,0,0,.04); }
    .kpi .label{ font-size:11.5pt; color:#555; margin-bottom:6px; }
    .kpi .value{ font-weight:700; font-size:18pt; }
    .charts{ display:grid; grid-template-columns:1fr; gap:16px; margin:16px 0; }
    .chart-card{ background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:12px; }
    .chart-wrap{ position:relative; width:100%; height:360px }
    
    /* Table */
    table{ border-collapse:collapse; width:100%; font-size:13pt; margin-top:10px }
    th,td{ border:1px solid #e5e7eb; padding:8px 10px; text-align:center; vertical-align:middle }
    th{ background:var(--header-bg); color:#000; font-weight:bold; position:sticky; top:0; z-index:1; }
    tr:nth-child(even){ background:#fff } tr:hover{ background:#f8fafc }
    
    /* Utils */
    .status-message{ padding:40px; text-align:center; font-style:italic; }
    .error-message{ color:#b91c1c; padding:15px; background:#fee2e2; border-radius:10px; margin-top:15px; display:none; }
    #sync-indicator { position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.8); color: #fff; padding: 10px 20px; border-radius: 30px; display: none; }
    
    /* Custom Time */
    .custom-time-panel{ display:none; padding:16px; background:#f8f9fa; border:1px solid #e5e7eb; border-radius:10px; margin-bottom:10px; }
    .time-inputs{ display:flex; gap:15px; align-items:end; flex-wrap:wrap; }
    
    @media print{
      .controls-container, .kpi-grid, .charts, .pagination-bar, .custom-time-panel, #sync-indicator{ display:none !important }
      .container{ box-shadow:none; padding:0 }
      #data-table{ display:none }
      #print-table{ display:table !important; width:100%; border-collapse:collapse; margin-top:10px }
      #print-table th, #print-table td{ border:1px solid #000 !important; padding:5px; font-size:11pt; }
    }
    #print-table{ display:none }
  </style>
</head>
<body>
  <div id="sync-indicator">Đang tải dữ liệu...</div>
  <div class="container">
    <h1>NHẬT KÝ VẬN HÀNH HỒ CHỨA NƯỚC ÔNG KINH</h1>
    <div id="subtitle" class="subtitle"></div>

    <div class="controls-container">
      <div class="filters">
        <label>Năm:</label><select id="year-filter"><option value="all">Tất cả</option></select>
        <label>Quý:</label><select id="quarter-filter"><option value="all">Tất cả</option><option value="1">Quý 1</option><option value="2">Quý 2</option><option value="3">Quý 3</option><option value="4">Quý 4</option></select>
        <label>Tháng:</label><select id="month-filter"><option value="all">Tất cả</option><script>for(let i=1;i<=12;i++)document.write(`<option value="${i}">Tháng ${i}</option>`)</script></select>
        <label>Tuần:</label><select id="week-filter"><option value="all">Tất cả</option></select>
        <label>Ngày/Đêm:</label><select id="daynight-filter"><option value="all">Tất cả</option><option value="day">Ngày (7h-19h)</option><option value="night">Đêm (19h-7h)</option></select>
        <label>Q tràn:</label><select id="q-filter"><option value="all">Tất cả</option><option value="zero">= 0</option><option value="positive">&gt; 0</option></select>
      </div>
      <div class="exports">
        <button id="btn-custom-time">⏱️ Tùy chỉnh thời gian</button>
        <button id="export-excel">Xuất Excel</button>
        <button id="btn-print-portrait">In dọc</button>
        <button id="btn-print-landscape">In ngang</button>
      </div>
    </div>

    <div class="custom-time-panel" id="custom-time-panel">
      <div class="time-inputs">
        <div><label>Từ:</label><input type="date" id="custom-from-date"><input type="time" id="custom-from-time" value="00:00:00"></div>
        <div><label>Đến:</label><input type="date" id="custom-to-date"><input type="time" id="custom-to-time" value="23:59:59"></div>
        <button id="btn-apply-custom" style="background:#1EA48D;color:#fff">Áp dụng</button>
        <button id="btn-clear-custom">Xóa</button>
      </div>
    </div>

    <div class="kpi-grid">
      <div class="kpi"><div class="label">Tổng mưa (mm)</div><div id="kpi-total" class="value">0</div></div>
      <div class="kpi"><div class="label">Ngày mưa / Tổng</div><div id="kpi-days" class="value">0/0</div></div>
      <div class="kpi"><div class="label">Mưa lớn nhất (mm)</div><div id="kpi-max" class="value">0</div></div>
      <div class="kpi"><div class="label">Q tràn Max (m³/s)</div><div id="kpi-qmax" class="value">0</div></div>
    </div>

    <section class="charts">
      <div class="chart-card">
        <div class="chart-header">
          <p class="chart-title">Biểu đồ vận hành</p>
          <div class="water-status" id="water-status"></div>
        </div>
        <div class="chart-wrap"><canvas id="waterChart"></canvas></div>
      </div>
    </section>

    <div class="pagination-bar">
      <div class="pager-left"><label>Hiển thị:</label><select id="page-size"><option value="20">20</option><option value="50" selected>50</option><option value="100">100</option></select></div>
      <div class="pager-right"><span id="page-info"></span> <button id="prev-page">«</button> <button id="next-page">»</button></div>
    </div>

    <table id="data-table">
      <colgroup><col style="width:50px"><col style="width:110px"><col style="width:80px"><col><col><col><col><col><col><col></colgroup>
      <thead>
        <tr><th rowspan="2">STT</th><th rowspan="2">Ngày</th><th rowspan="2">Giờ</th><th rowspan="2">Mực nước (m)</th><th rowspan="2">Dung tích (Tr.m³)</th><th rowspan="2">Mưa (mm)</th><th colspan="2">Vận hành tràn</th><th rowspan="2">Người VH</th><th rowspan="2">Ký tên</th></tr>
        <tr><th>H (cm)</th><th>Q (m³/s)</th></tr>
      </thead>
      <tbody id="table-body"><tr><td colspan="10" class="status-message">Đang tải...</td></tr></tbody>
    </table>
    
    <table id="print-table">
      <thead>
        <tr><th rowspan="2">STT</th><th rowspan="2">Ngày</th><th rowspan="2">Giờ</th><th rowspan="2">Mực nước (m)</th><th rowspan="2">Dung tích (Tr.m³)</th><th rowspan="2">Mưa (mm)</th><th colspan="2">Vận hành tràn</th><th rowspan="2">Người VH</th><th rowspan="2">Ký tên</th></tr>
        <tr><th>H (cm)</th><th>Q (m³/s)</th></tr>
      </thead>
      <tbody id="print-tbody"></tbody>
    </table>
    <div id="error-message" class="error-message"></div>
  </div>

<script>
// ====== CẤU HÌNH ======
const EXEC_URL = "https://script.google.com/macros/s/AKfycbw9Qof6w7zv5b_gMv09aG-0GoR75TTmx7-RY1JVnoSwDXWeg3H8XncLf2VnhrcRnQQm/exec"; // Link Web App của bạn
const SHEET_NAME = "HoOngKinh"; 
const API_URL = `${EXEC_URL}?sheet=${encodeURIComponent(SHEET_NAME)}`;
const CACHE_KEY = "HoOngKinh_V5";

// MAPPING CỘT (QUAN TRỌNG): Dựa trên Ngày giờ = Cột C (Index 2)
const IDX = {
  DATE: 2,      // Cột C: Ngày giờ
  LEVEL: 3,     // Cột D: Mực nước
  VOL: 4,       // Cột E: Dung tích
  RAIN: 5,      // Cột F: Lượng mưa
  HTRAN: 6,     // Cột G: H tràn
  QTRAN: 7,     // Cột H: Q tràn
  OPERATOR: 16  // Cột Q: Người vận hành (Dự đoán)
};

// NGƯỠNG
const LVL_DEAD=42.50, LVL_BT=47.70, LVL_GC=49.35, LVL_MID=(LVL_BT+LVL_GC)/2;

// HELPER
const fmtNum = (v,d=1) => (v==null||v===''||isNaN(Number(v))) ? '0' : Number(v).toLocaleString('vi',{maximumFractionDigits:d});
const fmtFlex = (v) => (v==null||v===''||isNaN(Number(v))) ? '' : Number(v).toLocaleString('vi',{maximumFractionDigits:3});
const safeNum = (v) => (v&&typeof v==='string') ? (Number(v.replace(/,/g,'.'))||0) : (Number(v)||0);

function parseVN(s) {
  if(!s) return null;
  // Thử new Date trực tiếp
  let d = new Date(s);
  if(!isNaN(d.getTime())) return d;
  // Parse dd/mm/yyyy
  const p = s.trim().split(/\s+/);
  const dP = p[0].split('/'), tP = (p[1]||'00:00').split(':');
  if(dP.length<3) return null;
  return new Date(dP[2], dP[1]-1, dP[0], tP[0]||0, tP[1]||0);
}

// STATE
let allData=[], filteredData=[], chartInst=null, page=1, pageSize=50;

// CORE: Xử lý mảng 2 chiều
function processData(rows) {
  if(!Array.isArray(rows) || !rows.length) return [];
  console.log("DEBUG Row 0:", rows[0]); // Xem log để check cột
  
  return rows.map(r => {
    const d = parseVN(r[IDX.DATE]);
    if(!d) return null;
    return {
      __d: d,
      __y: d.getFullYear(), __m: d.getMonth()+1,
      __dStr: `${('0'+d.getDate()).slice(-2)}/${('0'+(d.getMonth()+1)).slice(-2)}/${d.getFullYear()}`,
      __tStr: `${('0'+d.getHours()).slice(-2)}:${('0'+d.getMinutes()).slice(-2)}`,
      val: {
        level: r[IDX.LEVEL], vol: r[IDX.VOL], rain: r[IDX.RAIN],
        h: r[IDX.HTRAN], q: r[IDX.QTRAN], op: r[IDX.OPERATOR]
      },
      num: {
        level: safeNum(r[IDX.LEVEL]), rain: safeNum(r[IDX.RAIN]), q: safeNum(r[IDX.QTRAN])
      }
    };
  }).filter(x => x);
}

// RENDER
function render() {
  const total = filteredData.length;
  const maxP = Math.ceil(total/pageSize) || 1;
  if(page > maxP) page = maxP;
  
  const start = (page-1)*pageSize, end = Math.min(start+pageSize, total);
  const tbody = document.getElementById('table-body');
  
  if(!total) {
    tbody.innerHTML = `<tr><td colspan="10" class="status-message">Không có dữ liệu phù hợp</td></tr>`;
  } else {
    tbody.innerHTML = filteredData.slice(start, end).map((r,i) => `
      <tr>
        <td>${start+i+1}</td><td>${r.__dStr}</td><td>${r.__tStr}</td>
        <td>${fmtFlex(r.val.level)}</td><td>${fmtFlex(r.val.vol)}</td><td>${fmtFlex(r.val.rain)}</td>
        <td>${fmtFlex(r.val.h)}</td><td>${fmtFlex(r.val.q)}</td><td>${r.val.op||''}</td><td></td>
      </tr>
    `).join('');
  }
  document.getElementById('page-info').innerText = `Trang ${page}/${maxP} — ${total} dòng`;
  document.getElementById('prev-page').disabled = page<=1;
  document.getElementById('next-page').disabled = page>=maxP;
  
  updateStats();
}

function updateStats() {
  // Aggregate per day
  const days = {};
  filteredData.forEach(r => {
    const key = r.__dStr;
    if(!days[key]) days[key] = { rain:0, lvl: null, lastTime: 0 };
    days[key].rain += r.num.rain;
    if(r.__d.getTime() >= days[key].lastTime && r.num.level > 0) {
      days[key].lvl = r.num.level;
      days[key].lastTime = r.__d.getTime();
    }
  });
  
  const sortedKeys = Object.keys(days).sort((a,b) => parseVN(a) - parseVN(b));
  const labels = sortedKeys;
  const dRain = labels.map(k => days[k].rain);
  const dLvl = labels.map(k => days[k].lvl);

  // KPI
  const totRain = dRain.reduce((a,b)=>a+b,0);
  const maxRain = Math.max(0, ...dRain);
  const maxQ = Math.max(0, ...filteredData.map(x=>x.num.q));
  
  document.getElementById('kpi-total').innerText = fmtNum(totRain);
  document.getElementById('kpi-days').innerText = `${dRain.filter(x=>x>0).length} / ${labels.length}`;
  document.getElementById('kpi-max').innerText = fmtNum(maxRain);
  document.getElementById('kpi-qmax').innerText = fmtFlex(maxQ);

  // Status
  const lastRow = filteredData[filteredData.length-1];
  if(lastRow && lastRow.num.level) {
    const l = lastRow.num.level;
    let st = l<LVL_DEAD?"Dưới MN Chết": l<LVL_BT?"An toàn": l<LVL_GC?"Cảnh báo":"Nguy hiểm";
    document.getElementById('water-status').innerText = `MN gần nhất: ${fmtNum(l,2)}m - ${st}`;
  }

  // Chart
  const ctx = document.getElementById('waterChart').getContext('2d');
  if(chartInst) chartInst.destroy();
  
  chartInst = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { type:'bar', label:'Mưa (mm)', data:dRain, yAxisID:'y1', backgroundColor:'#3b82f6' },
        { type:'line', label:'Mực nước (m)', data:dLvl, yAxisID:'y2', borderColor:'#1EA48D', tension:0.3, pointRadius:2 }
      ]
    },
    options: {
      responsive:true, maintainAspectRatio:false,
      scales: {
        y1: { position:'left', beginAtZero:true, title:{display:true, text:'Mưa'} },
        y2: { position:'right', min: Math.floor(Math.min(...dLvl.filter(x=>x)|| [LVL_DEAD]))-1, title:{display:true, text:'Mực nước'} }
      }
    }
  });
}

// FILTER LOGIC
function applyFilter() {
  const y = document.getElementById('year-filter').value;
  const m = document.getElementById('month-filter').value;
  const q = document.getElementById('quarter-filter').value;
  const w = document.getElementById('week-filter').value;
  
  filteredData = allData.filter(r => {
    if(y!=='all' && r.__y!=y) return false;
    if(m!=='all' && r.__m!=m) return false;
    // Basic filter logic implementation
    return true;
  });
  
  // Custom time override
  const fDate = document.getElementById('custom-from-date').value;
  const tDate = document.getElementById('custom-to-date').value;
  if(fDate && tDate) {
    const t1 = new Date(fDate+"T00:00").getTime();
    const t2 = new Date(tDate+"T23:59").getTime();
    filteredData = allData.filter(r => r.__d.getTime() >= t1 && r.__d.getTime() <= t2);
    document.getElementById('subtitle').innerText = `Từ ${fDate} đến ${tDate}`;
  } else {
    document.getElementById('subtitle').innerText = `Dữ liệu hiện tại (${filteredData.length} dòng)`;
  }
  
  page = 1;
  render();
}

// INIT
function init() {
  document.getElementById('sync-indicator').style.display='block';
  
  // Cache
  const cached = localStorage.getItem(CACHE_KEY);
  if(cached) {
    try { allData = processData(JSON.parse(cached)); populateOpts(); applyFilter(); } catch(e){}
  }

  fetch(API_URL)
    .then(r => r.json())
    .then(data => {
      if(data.error) throw data.message;
      // Check empty
      if(!data.length || (data.length===1 && data[0][0]==='')) throw "File Google Sheet rỗng hoặc sai ID.";
      
      allData = processData(data);
      localStorage.setItem(CACHE_KEY, JSON.stringify(data));
      populateOpts();
      applyFilter();
      document.getElementById('sync-indicator').style.display='none';
    })
    .catch(e => {
      document.getElementById('sync-indicator').style.display='none';
      document.getElementById('error-message').style.display='block';
      document.getElementById('error-message').innerText = "Lỗi: " + e;
    });
}

function populateOpts() {
  const years = [...new Set(allData.map(x=>x.__y))].sort((a,b)=>b-a);
  const ySel = document.getElementById('year-filter');
  ySel.innerHTML = '<option value="all">Tất cả</option>' + years.map(y=>`<option value="${y}">Năm ${y}</option>`).join('');
}

// EVENTS
document.querySelectorAll('select').forEach(s => s.addEventListener('change', applyFilter));
document.getElementById('page-size').addEventListener('change', function() { pageSize=Number(this.value); page=1; render(); });
document.getElementById('prev-page').addEventListener('click', () => { if(page>1) {page--; render();} });
document.getElementById('next-page').addEventListener('click', () => { page++; render(); });
document.getElementById('btn-custom-time').onclick = () => { const p=document.getElementById('custom-time-panel'); p.style.display = p.style.display==='none'?'block':'none'; };
document.getElementById('btn-apply-custom').onclick = applyFilter;
document.getElementById('btn-clear-custom').onclick = () => { 
  document.getElementById('custom-from-date').value=''; 
  document.getElementById('custom-to-date').value=''; 
  applyFilter(); 
};

// Export
document.getElementById('export-excel').onclick = () => {
  if(!filteredData.length) return alert('Không có dữ liệu');
  const rows = filteredData.map((r,i) => [i+1, r.__dStr, r.__tStr, r.val.level, r.val.vol, r.val.rain, r.val.h, r.val.q, r.val.op, '']);
  const ws = XLSX.utils.aoa_to_sheet([["STT","Ngày","Giờ","Mực nước","Dung tích","Mưa","H tràn","Q tràn","Người VH","Ký tên"], ...rows]);
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
  XLSX.writeFile(wb, "NhatKyVanHanh.xlsx");
};

// Print
document.getElementById('btn-print-portrait').onclick = () => doPrint('portrait');
document.getElementById('btn-print-landscape').onclick = () => doPrint('landscape');
function doPrint(ori) {
  document.getElementById('print-tbody').innerHTML = filteredData.map((r,i) => `<tr><td>${i+1}</td><td>${r.__dStr}</td><td>${r.__tStr}</td><td>${fmtFlex(r.val.level)}</td><td>${fmtFlex(r.val.vol)}</td><td>${fmtFlex(r.val.rain)}</td><td>${fmtFlex(r.val.h)}</td><td>${fmtFlex(r.val.q)}</td><td>${r.val.op||''}</td><td></td></tr>`).join('');
  const s = document.createElement('style');
  s.innerHTML = `@media print { @page { size: A4 ${ori}; margin: 10mm; } }`;
  document.head.appendChild(s);
  window.print();
  s.remove();
}

init();
</script>
</body>
</html>
