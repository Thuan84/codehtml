<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Nhật ký vận hành hồ chứa - Hồ Thành Sơn</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --header-bg:#1EA48D; --border-color:#e5e7eb; --hover-bg:#f1f3f5; --card-bg:#ffffff;
      --teal:#1EA48D; --blue:#2563eb; --indigo:#4f46e5; --purple:#7c3aed; --orange:#ea580c;
    }
    html, body { height:100%; }
    body{
      font-family:"Times New Roman",Times,serif; background:#fff; color:#0f172a;
      margin:0; padding:0; font-size:14pt;
    }
    .container{
      width:100%; max-width:none; margin:0; background:#fff; padding:20px 24px;
      box-sizing:border-box;
    }
    .fullpage .container{ padding:12px 16px; }

    h1{ font-size:16pt; font-weight:bold; text-align:center; text-transform:uppercase; margin:4px 0 6px 0; }
    .subtitle{ text-align:center; font-weight:bold; font-size:14pt; margin:0 0 10px 0; }

    .controls-container{
      display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;
      gap:12px; margin:0 0 10px 0; padding:10px; background:#fdfdff; border-radius:10px; border:1px solid #e5e7eb;
    }
    .filters,.exports{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .filters label{ font-weight:bold; }
    .filters select,.exports button{
      padding:8px 12px; border-radius:8px; border:1px solid #d1d5db; background:#fff;
      font-family:"Times New Roman",Times,serif; font-size:13pt; cursor:pointer;
    }
    .exports button{ font-weight:bold; color:#fff; border:none; transition:transform .08s ease, opacity .2s; }
    .exports button:hover{ opacity:.95; transform: translateY(-1px); }
    #export-excel{ background:#218838; }
    #print-page{ background:#c82333; }
    #toggle-fullscreen{ background:#0b5ed7; }

    /* ===== Metrics ===== */
    .metrics{
      display:grid; grid-template-columns: repeat(5, minmax(220px,1fr));
      gap:12px; margin:0 0 8px 0;
    }
    .metric{
      position:relative; overflow:hidden;
      background: linear-gradient(180deg, #ffffff, #fafafa);
      border:1px solid rgba(15,23,42,.06);
      border-radius:14px; padding:16px 14px;
      box-shadow: 0 6px 14px rgba(2,8,23,.06);
      display:flex; flex-direction:column; gap:8px;
      isolation:isolate;
      align-items:center;
      text-align:center;
    }
    .metric::before{
      content:""; position:absolute; inset:-40% -20% auto auto; height:180px; width:280px;
      border-radius:50%;
      background: var(--accent-fade, rgba(30,164,141,.10));
      filter: blur(18px);
      z-index:-1;
    }
    .metric::after{
      content:""; position:absolute; left:0; top:0; bottom:0; width:5px;
      background: var(--accent, #1EA48D); opacity:.9;
    }
    .metric .label{ font-size:12pt; color:#334155; font-weight:700; letter-spacing:.2px; line-height:1.25; }
    .metric .value{
      font-size:24pt; font-weight:800; color:#0f172a; line-height:1.1;
      font-variant-numeric: tabular-nums; word-break:break-word;
    }
    .m-total{ --accent:var(--teal);   --accent-fade: rgba(30,164,141,.12); }
    .m-ratio{ --accent:var(--blue);   --accent-fade: rgba(37,99,235,.12); }
    .m-avg-d{ --accent:var(--indigo); --accent-fade: rgba(79,70,229,.12); }
    .m-avg-r{ --accent:var(--purple); --accent-fade: rgba(124,58,237,.12); }
    .m-max  { --accent:var(--orange); --accent-fade: rgba(234,88,12,.12); }

    .charts{ display:grid; grid-template-columns: 1fr; gap:14px; margin-top:4px; }
    .chart-card{ border:1px solid #e5e7eb; border-radius:12px; padding:10px; background:#fafafa; }
    .chart-title{ font-weight:bold; margin:0 0 8px 0; font-size:14pt; text-align:center; }
    .chart-card canvas{ display:block; width:100% !important; height:380px !important; max-height:380px !important; }

    table{ border-collapse:collapse; width:100%; font-size:13pt; margin-top:10px; table-layout:auto; }
    th,td{ border:1px solid var(--border-color); padding:6px 8px; text-align:center; vertical-align:middle; }
    th{ background:var(--header-bg); color:#000; font-weight:bold; position:sticky; top:0; z-index:1; }
    tbody tr:nth-child(even){ background:#fff; }
    tbody tr:hover{ background:var(--hover-bg); }

    /* tránh xuống dòng cho Ngày/Giờ */
    .nowrap{ white-space: nowrap; }

    /* ===== Pagination (view chính) ===== */
    .pager-bar{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      margin-top:8px; flex-wrap:wrap;
    }
    .pager-left{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .pager-right{ display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
    .pager-info{ font-size:12.5pt; color:#334155; }
    .pager-select{
      padding:6px 10px; border:1px solid #d1d5db; border-radius:8px; background:#fff; font-size:12.5pt;
    }
    .page-btn{
      padding:6px 10px; border:1px solid #d1d5db; background:#fff; border-radius:8px; cursor:pointer;
      min-width:40px; text-align:center; font-size:12.5pt;
    }
    .page-btn[disabled]{ opacity:.5; cursor:not-allowed; }
    .page-btn.active{
      background: var(--header-bg);
      color:#000; font-weight:700; border-color:#cbd5e1;
    }

    .status-message{ color:#555; padding:16px; text-align:center; font-style:italic; font-size:14pt; }
    .error-message{ color:#b00020; padding:10px; background:#ffeeee; border:1px solid #ffcccc; margin-top:8px; border-radius:5px; }

    @media (max-width: 1500px){ .metrics{ grid-template-columns: 1fr 1fr; } }

    /* ===== PRINT: giữ nguyên, không áp dụng phân trang màn hình ===== */
    @media print {
      @page { size: A4 landscape; margin: 12mm; }

      .controls-container,
      .metrics,
      .charts,
      .error-message,
      .status-message,
      .pager-bar,
      #toggle-fullscreen,
      #print-page,
      #export-excel { display: none !important; }

      body { background: #fff !important; color: #000 !important; }
      .container { padding: 0 !important; }

      h1{
        display:block !important;
        text-align:center;
        text-transform:uppercase;
        font-weight:bold;
        font-size:18pt;
        margin:0 0 4mm 0;
      }
      .subtitle{
        display:block !important;
        text-align:center;
        font-weight:bold;
        font-size:14pt;
        margin:0 0 6mm 0;
      }

      th {
        position: static !important;
        background: #ffffff !important;
        color: #000000 !important;
        font-weight: 700 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      thead { display: table-header-group; }
      tfoot { display: table-footer-group; }

      table { page-break-inside: auto; }
      tr    { page-break-inside: avoid; page-break-after: auto; }

      .chart-card, .metric { box-shadow: none !important; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>NHẬT KÝ VẬN HÀNH HỒ CHỨA NƯỚC THÀNH SƠN</h1>
    <div id="subtitle" class="subtitle"></div>

    <div class="controls-container">
      <div class="filters">
        <label for="year-filter">Năm:</label>
        <select id="year-filter"><option value="all">Tất cả</option></select>
        <label for="quarter-filter">Quý:</label>
        <select id="quarter-filter">
          <option value="all">Tất cả</option><option value="1">Quý 1</option>
          <option value="2">Quý 2</option><option value="3">Quý 3</option>
          <option value="4">Quý 4</option>
        </select>
        <label for="month-filter">Tháng:</label>
        <select id="month-filter">
          <option value="all">Tất cả</option>
          <script>for(let i=1;i<=12;i++)document.write(`<option value="${i}">Tháng ${i}</option>`);</script>
        </select>
      </div>
      <div class="exports">
        <button id="toggle-fullscreen" title="Bật/Tắt toàn màn hình">Toàn màn hình</button>
        <button id="export-excel">Xuất Excel</button>
        <button id="print-page">In</button>
      </div>
    </div>

    <!-- Metrics -->
    <div class="metrics">
      <div class="metric m-total"><div class="label">Tổng lượng mưa (kỳ lọc)</div><div class="value" id="m-total">—</div></div>
      <div class="metric m-ratio"><div class="label">Ngày có mưa / Tổng ngày</div><div class="value"><span id="m-rainy-days">—</span>/<span id="m-days">—</span></div></div>
      <div class="metric m-avg-d"><div class="label">TB theo ngày trong kỳ</div><div class="value" id="m-avg-day">—</div></div>
      <div class="metric m-avg-r"><div class="label">TB theo ngày có mưa</div><div class="value" id="m-avg-rainy">—</div></div>
      <div class="metric m-max"><div class="label">Mưa lớn nhất (ngày)</div><div class="value"><span id="m-max">—</span> <span id="m-max-date" style="font-size:12pt;font-weight:600;"></span></div></div>
    </div>

    <!-- Charts -->
    <div class="charts">
      <div class="chart-card">
        <p class="chart-title">Lượng mưa theo từng ngày (tổng mm/ngày)</p>
        <canvas id="rainChart"></canvas>
      </div>
      <div class="chart-card">
        <p class="chart-title">Mực nước theo từng ngày (TB m/ngày) & đường tham chiếu mực nước chết (27.5 m)</p>
        <canvas id="waterLevelChart"></canvas>
      </div>
    </div>

    <!-- Table -->
    <table id="data-table">
      <thead>
        <tr>
          <th rowspan="2">STT</th>
          <th rowspan="2" class="nowrap">Ngày</th>
          <th rowspan="2" class="nowrap">Giờ</th>
          <th rowspan="2">Mực nước (m)</th>
          <th rowspan="2">Dung tích (Triệu m³)</th>
          <th rowspan="2">Lượng mưa (mm)</th>
          <th colspan="2">Thông số vận hành tràn xả lũ số 1</th>
          <th colspan="2">Thông số vận hành tràn xả lũ số 2</th>
          <th colspan="3">Thông số vận hành cống lấy nước</th>
          <th rowspan="2">Họ, tên người vận hành</th>
          <th rowspan="2">Chữ ký</th>
        </tr>
        <tr>
          <th>Htràn 1 (cm)</th>
          <th>Qtràn 1 (m³/s)</th>
          <th>Htràn 2 (cm)</th>
          <th>Qtràn 2 (m³/s)</th>
          <th>a (cm)</th>
          <th>Cột nước đầu kênh (m)</th>
          <th>Qcống (m³/s)</th>
        </tr>
      </thead>
      <tbody id="table-body">
        <tr><td colspan="16"><div class="loader">Đang tải dữ liệu...</div></td></tr>
      </tbody>
    </table>

    <!-- Pagination bar (view chính) -->
    <div class="pager-bar" id="pager-bar" style="display:none;">
      <div class="pager-left">
        <span class="pager-info" id="pager-info">—</span>
      </div>
      <div class="pager-right">
        <button class="page-btn" id="btn-prev">«</button>
        <div id="page-numbers"></div>
        <button class="page-btn" id="btn-next">»</button>
        <span style="margin-left:10px;">Hiển thị:</span>
        <select id="page-size" class="pager-select">
          <option value="20" selected>20</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
        <span>dòng/trang</span>
      </div>
    </div>

    <div id="error-message" class="error-message" style="display:none;"></div>
  </div>

  <script>
    /* ================== CẤU HÌNH ================== */
    const EXEC_URL = "https://script.google.com/macros/s/AKfycbxphwCkUk01I8TZ4LI_1bzEW1XdRPLLrGnbYGRkKbt8gJ-rmliZRzp_zoy0GpHhdSEv/exec";
    const SHEET = "HoThanhSon";
    const DEAD_LEVEL = 27.5;

    /* ================== STATE ================== */
    let selectedYear = 'all', selectedQuarter = 'all', selectedMonth = 'all';
    let allData = [], filteredData = [], currentFetchCtrl = null;
    const cacheByScope = new Map(); // keys: 'all', 'year:YYYY'
    let rainChart = null, waterLevelChart = null, ChartLibLoaded = false;

    // Phân trang (view chính)
    let pageSize = 20;
    let currentPage = 1;

    /* ================== DOM ================== */
    const yearFilter = document.getElementById('year-filter');
    const quarterFilter = document.getElementById('quarter-filter');
    const monthFilter = document.getElementById('month-filter');
    const tableBody = document.getElementById('table-body');
    const errorDiv = document.getElementById('error-message');
    const subtitleDiv = document.getElementById('subtitle');
    const elTotal = document.getElementById('m-total');
    const elRainyDays = document.getElementById('m-rainy-days');
    const elDays = document.getElementById('m-days');
    const elAvgDay = document.getElementById('m-avg-day');
    const elAvgRainy = document.getElementById('m-avg-rainy');
    const elMax = document.getElementById('m-max');
    const elMaxDate = document.getElementById('m-max-date');

    // DOM phân trang
    const pagerBar = document.getElementById('pager-bar');
    const pagerInfo = document.getElementById('pager-info');
    const pageNumbers = document.getElementById('page-numbers');
    const btnPrev = document.getElementById('btn-prev');
    const btnNext = document.getElementById('btn-next');
    const pageSizeSelect = document.getElementById('page-size');

    /* ================== UTIL ================== */
    function parseVNDateTime(s){
      if (!s || typeof s !== 'string') return null;
      const [dpart, tpart='00:00'] = s.split(' ');
      const [dd, mm, yyyy] = dpart.split('/').map(n=>parseInt(n,10));
      if (!dd || !mm || !yyyy) return null;
      const [HH='0', MM='0'] = tpart.split(':').map(n=>parseInt(n,10));
      const d = new Date(yyyy, mm-1, dd, HH, MM);
      return Number.isNaN(d.getTime()) ? null : d;
    }
    function pad2(n){ return String(n).padStart(2,'0'); }
    function formatVNDate(d){ return d ? `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}` : ''; }
    function formatVNTime(d){ return d ? `${pad2(d.getHours())}:${pad2(d.getMinutes())}` : ''; }
    function ymd(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
    function formatNum(v, max=3){
      if (v === null || v === undefined || v === '') return '';
      const n = Number(v); if (Number.isNaN(n)) return v;
      return n.toLocaleString('vi-VN', { maximumFractionDigits:max });
    }
    function buildApiUrl(year='all', month='all', quarter='all') {
      const p = new URLSearchParams({ sheet: SHEET });
      if (year !== 'all') p.set('year', year);
      if (year !== 'all') {
        if (month !== 'all')   p.set('month', month);
        else if (quarter !== 'all') p.set('quarter', quarter);
      }
      return `${EXEC_URL}?${p.toString()}`;
    }
    function loadScript(src){
      return new Promise((resolve, reject)=>{
        const s = document.createElement('script');
        s.src = src; s.async = true; s.crossOrigin = "anonymous";
        s.onload = () => resolve();
        s.onerror = () => reject(new Error(`Không tải được script: ${src}`));
        document.head.appendChild(s);
      });
    }
    function showError(message){
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      tableBody.innerHTML = `<tr><td colspan="16" class="status-message">${message}</td></tr>`;
    }

    /* ================== TABLE (có phân trang) ================== */
    function renderTable(data, baseIndex=0){
      if (!Array.isArray(data) || data.length === 0){
        tableBody.innerHTML = `<tr><td colspan="16" class="status-message">Không có dữ liệu phù hợp với bộ lọc.</td></tr>`;
        return;
      }
      let html = '';
      for (let i=0;i<data.length;i++){
        const r = data[i];
        html += `<tr>
          <td>${baseIndex + i + 1}</td>
          <td class="nowrap">${r._ngay || ''}</td>
          <td class="nowrap">${r._gio || ''}</td>
          <td>${formatNum(r.mucNuoc)}</td>
          <td>${formatNum(r.dungTich)}</td>
          <td>${formatNum(r.luongMua)}</td>
          <td>${formatNum(r.hTran1)}</td>
          <td>${formatNum(r.qtran1)}</td>
          <td>${formatNum(r.hTran2)}</td>
          <td>${formatNum(r.qtran2)}</td>
          <td>${formatNum(r.a)}</td>
          <td>${formatNum(r.cotNuocDauKenh)}</td>
          <td>${formatNum(r.qCong)}</td>
          <td>${r.nguoiVanHanh || ''}</td>
          <td></td>
        </tr>`;
      }
      tableBody.innerHTML = html;
    }

    /* ================== YEAR DROPDOWN ================== */
    function populateYearFilter(data){
      const years = [...new Set(data.map(r => r._y).filter(v => v!=null))].sort((a,b)=>b-a);
      const prev = yearFilter.value;
      yearFilter.innerHTML = '<option value="all">Tất cả</option>';
      years.forEach(y => {
        const op = document.createElement('option');
        op.value = String(y);
        op.textContent = `Năm ${y}`;
        yearFilter.appendChild(op);
      });
      if (prev && (prev === 'all' || years.includes(Number(prev)))) {
        yearFilter.value = prev;
      } else if (years.includes(Number(selectedYear))) {
        yearFilter.value = selectedYear;
      } else {
        yearFilter.value = 'all';
        selectedYear = 'all';
      }
    }

    /* ================== AGGREGATE & METRICS ================== */
    function aggregateDaily(data){
      const map = new Map();
      for (const r of data){
        const d = r._dt;
        if (!d) continue;
        const key = ymd(d);
        const rain = Number(r.luongMua) || 0;
        const wl   = Number(r.mucNuoc);
        const prev = map.get(key) || { rainSum:0, wlSum:0, wlCount:0 };
        prev.rainSum += rain;
        if (!Number.isNaN(wl)) { prev.wlSum += wl; prev.wlCount++; }
        map.set(key, prev);
      }
      const labels = Array.from(map.keys()).sort((a,b)=> new Date(a)-new Date(b));
      const rainPerDay = labels.map(k => map.get(k).rainSum);
      const wlAvgPerDay = labels.map(k => {
        const o = map.get(k); return o.wlCount ? o.wlSum/o.wlCount : null;
      });
      return { labels, rainPerDay, wlAvgPerDay };
    }
    function renderRainStats(){
      const { labels, rainPerDay } = aggregateDaily(filteredData);
      const total = rainPerDay.reduce((s,v)=>s+(Number(v)||0),0);
      const days = labels.length;
      const rainyDays = rainPerDay.filter(v => (Number(v)||0) > 0).length;
      const avgPerDay = days ? total/days : 0;
      const avgPerRainy = rainyDays ? total/rainyDays : 0;

      let maxVal = 0, maxDate = '';
      rainPerDay.forEach((v,i)=>{ if ((Number(v)||0) > maxVal){ maxVal = Number(v)||0; maxDate = labels[i]; } });

      elTotal.textContent = total.toLocaleString('vi-VN', {maximumFractionDigits:1});
      elDays.textContent = String(days);
      elRainyDays.textContent = String(rainyDays);
      elAvgDay.textContent = avgPerDay.toLocaleString('vi-VN', {maximumFractionDigits:2});
      elAvgRainy.textContent = avgPerRainy.toLocaleString('vi-VN', {maximumFractionDigits:2});
      elMax.textContent = maxVal.toLocaleString('vi-VN', {maximumFractionDigits:1});
      elMaxDate.textContent = maxDate ? `(${maxDate})` : '';
    }

    /* ================== CHARTS ================== */
    async function ensureChartJs(){
      if (!ChartLibLoaded){
        await loadScript('https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js');
        ChartLibLoaded = true;
      }
    }
    function niceMax(val){
      if (!isFinite(val) || val <= 0) return 10;
      const mags = [5,10,20,25,50,100,200,250,500,1000];
      const target = val * 1.1;
      for (const m of mags){ if (target <= m) return m; }
      return Math.ceil(target/100)*100;
    }
    async function updateCharts(){
      await ensureChartJs();
      const { labels, rainPerDay, wlAvgPerDay } = aggregateDaily(filteredData);

      if (rainChart) { rainChart.destroy(); rainChart = null; }
      if (waterLevelChart) { waterLevelChart.destroy(); waterLevelChart = null; }

      const maxRain = rainPerDay.reduce((m,v)=>Math.max(m, v||0), 0);
      const yMaxRain = niceMax(maxRain);

      const wlVals = wlAvgPerDay.filter(v=>Number.isFinite(v));
      const wlMin = wlVals.length ? Math.min(...wlVals) : 0;
      const wlMax = wlVals.length ? Math.max(...wlVals) : 0;
      const yMinWL = wlVals.length ? Math.floor((wlMin - 0.5)*10)/10 : undefined;
      const yMaxWL = wlVals.length ? Math.ceil((wlMax + 0.5)*10)/10 : undefined;

      // eslint-disable-next-line no-undef
      rainChart = new Chart(document.getElementById('rainChart').getContext('2d'), {
        type: 'bar',
        data: { labels, datasets: [{ label:'Lượng mưa (mm/ngày)', data: rainPerDay, borderWidth:1 }] },
        options: {
          responsive:true, maintainAspectRatio:false, animation:false,
          plugins:{ legend:{ display:true } },
          scales:{
            x:{ title:{ display:true, text:'Ngày' }, ticks:{ autoSkip:true, maxRotation:0 } },
            y:{ title:{ display:true, text:'mm' }, beginAtZero:true, suggestedMax:yMaxRain }
          }
        }
      });

      const deadLine = labels.map(()=>DEAD_LEVEL);
      // eslint-disable-next-line no-undef
      waterLevelChart = new Chart(document.getElementById('waterLevelChart').getContext('2d'), {
        type:'line',
        data:{
          labels,
          datasets:[
            { label:'Mực nước TB (m/ngày)', data: wlAvgPerDay, tension:0.3, fill:false, pointRadius:3 },
            { label:`Mực nước chết (${DEAD_LEVEL} m)`, data: deadLine, borderDash:[6,6], tension:0, fill:false, pointRadius:0 }
          ]
        },
        options:{
          responsive:true, maintainAspectRatio:false, animation:false,
          plugins:{ legend:{ display:true } },
          scales:{
            x:{ title:{ display:true, text:'Ngày' }, ticks:{ autoSkip:true, maxRotation:0 } },
            y:{ title:{ display:true, text:'m' }, beginAtZero:false, suggestedMin:yMinWL, suggestedMax:yMaxWL }
          }
        }
      });
    }

    /* ================== SUBTITLE ================== */
    function setSubtitle(){
      if (selectedYear !== 'all' && selectedMonth !== 'all') {
        subtitleDiv.textContent = `Tháng ${selectedMonth} năm ${selectedYear}`;
      } else if (selectedYear !== 'all' && selectedQuarter !== 'all') {
        subtitleDiv.textContent = `Quý ${selectedQuarter} năm ${selectedYear}`;
      } else if (selectedYear !== 'all') {
        subtitleDiv.textContent = `Năm ${selectedYear}`;
      } else {
        const c = new Date();
        subtitleDiv.textContent = `Tháng ${c.getMonth()+1} năm ${c.getFullYear()}`;
      }
    }

    /* ================== FILTER ================== */
    function clientFilter(data){
      return data.filter(r=>{
        if (selectedYear !== 'all' && String(r._y) !== selectedYear) return false;
        if (selectedMonth !== 'all' && r._m !== Number(selectedMonth)) return false;
        if (selectedQuarter !== 'all' && r._q !== Number(selectedQuarter)) return false;
        return true;
      });
    }

    /* ================== LOAD & CACHE ================== */
    function normalizeRows(rows){
      for (const r of rows){
        const d = parseVNDateTime(r.ngayGio);
        r._dt = d;
        if (d){
          r._y = d.getFullYear(); r._m = d.getMonth()+1; r._q = Math.floor(d.getMonth()/3)+1;
          r._ngay = formatVNDate(d);
          r._gio  = formatVNTime(d);
        } else {
          r._y = r._m = r._q = null;
          if (typeof r.ngayGio === 'string'){
            const [dp='', tp=''] = r.ngayGio.split(' ');
            r._ngay = dp; r._gio = tp;
          } else {
            r._ngay = ''; r._gio = '';
          }
        }
      }
      return rows;
    }
    function scopeKey(y){ return (y === 'all') ? 'all' : `year:${y}`; }

    function indexYearsAndWarmCache(allRows){
      const buckets = new Map();
      for (const r of allRows){
        if (r._y == null) continue;
        const k = `year:${r._y}`;
        if (!buckets.has(k)) buckets.set(k, []);
        buckets.get(k).push(r);
      }
      for (const [k, rows] of buckets){
        if (!cacheByScope.has(k)) cacheByScope.set(k, rows);
      }
    }

    async function loadScope(y){
      const key = scopeKey(y);

      if (cacheByScope.has(key)) return cacheByScope.get(key);

      if (cacheByScope.has('all') && y !== 'all') {
        const allRows = cacheByScope.get('all');
        indexYearsAndWarmCache(allRows);
        return cacheByScope.get(key) || [];
      }

      const url = (y==='all') ? buildApiUrl('all','all','all') : buildApiUrl(y,'all','all');
      if (currentFetchCtrl) currentFetchCtrl.abort();
      currentFetchCtrl = new AbortController();
      const res = await fetch(url, { cache:'no-store', signal: currentFetchCtrl.signal });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const json = await res.json();
      if (!Array.isArray(json)) throw new Error('Dữ liệu trả về không hợp lệ');
      const norm = normalizeRows(json);

      cacheByScope.set(key, norm);

      if (y === 'all') indexYearsAndWarmCache(norm);

      return norm;
    }

    /* ================== PAGINATION HELPERS ================== */
    function getTotalPages(){
      return Math.max(1, Math.ceil(filteredData.length / pageSize));
    }
    function clampPage(p){
      const tp = getTotalPages();
      return Math.min(Math.max(1, p), tp);
    }
    function getPagedSlice(){
      const tp = getTotalPages();
      currentPage = clampPage(currentPage);
      const start = (currentPage-1) * pageSize;
      const end = Math.min(start + pageSize, filteredData.length);
      return { start, end, slice: filteredData.slice(start, end), totalPages: tp };
    }
    function renderPaginationBar(){
      const { start, end, totalPages } = getPagedSlice();
      // Info
      pagerInfo.textContent = `Trang ${currentPage}/${totalPages} — Hiển thị ${filteredData.length ? (start+1) : 0}–${end} / ${filteredData.length} dòng`;
      pagerBar.style.display = 'flex';

      // Prev/Next
      btnPrev.disabled = currentPage <= 1;
      btnNext.disabled = currentPage >= totalPages;

      // Page numbers: 1..N (đơn giản theo yêu cầu)
      pageNumbers.innerHTML = '';
      for (let p=1; p<=totalPages; p++){
        const b = document.createElement('button');
        b.className = 'page-btn' + (p===currentPage ? ' active' : '');
        b.textContent = p;
        b.addEventListener('click', () => {
          if (currentPage !== p){
            currentPage = p;
            drawTableWithPagination();
          }
        });
        pageNumbers.appendChild(b);
      }
    }
    function drawTableWithPagination(){
      const { start, slice } = getPagedSlice();
      renderTable(slice, start);
      renderPaginationBar();
    }

    // Events for pagination controls
    btnPrev.addEventListener('click', () => { currentPage = clampPage(currentPage-1); drawTableWithPagination(); });
    btnNext.addEventListener('click', () => { currentPage = clampPage(currentPage+1); drawTableWithPagination(); });
    pageSizeSelect.addEventListener('change', () => {
      pageSize = parseInt(pageSizeSelect.value, 10) || 20;
      currentPage = 1;
      drawTableWithPagination();
    });

    /* ================== APPLY (debounce) ================== */
    let filterTimer = null;
    function scheduleApply(){ clearTimeout(filterTimer); filterTimer = setTimeout(applyFiltersAndRender, 80); }
    function applyFiltersAndRender(){
      const y = yearFilter.value;
      let q = quarterFilter.value;
      let m = monthFilter.value;
      if (m !== 'all') q = 'all';
      if (q !== 'all') m = 'all';
      selectedYear = y; selectedQuarter = q; selectedMonth = m;
      currentPage = 1; // reset trang khi đổi bộ lọc
      fetchAndRender();
    }
    yearFilter.addEventListener('change', scheduleApply);
    quarterFilter.addEventListener('change', () => { if (quarterFilter.value !== 'all') monthFilter.value = 'all'; scheduleApply(); });
    monthFilter.addEventListener('change', () => { if (monthFilter.value !== 'all') quarterFilter.value = 'all'; scheduleApply(); });

    /* ================== FETCH & RENDER ================== */
    async function fetchAndRender(){
      setSubtitle();
      errorDiv.style.display = 'none';
      tableBody.innerHTML = `<tr><td colspan="16"><div class="loader">Đang tải dữ liệu...</div></td></tr>`;
      try{
        const scopeData = await loadScope(selectedYear);

        if (!allData.length && cacheByScope.has('all')) {
          allData = cacheByScope.get('all');
          populateYearFilter(allData);
        } else if (selectedYear === 'all' && !allData.length) {
          allData = scopeData;
          populateYearFilter(allData);
        } else if (selectedYear === 'all') {
          populateYearFilter(allData);
        }

        filteredData = clientFilter(scopeData);

        // Bảng: dùng phân trang; KPI + Biểu đồ vẫn dựa trên filteredData (toàn bộ kỳ)
        drawTableWithPagination();
        renderRainStats();
        requestAnimationFrame(()=> setTimeout(updateCharts, 0));
      }catch(err){
        if (err.name === 'AbortError') return;
        console.error('Lỗi tải dữ liệu:', err);
        showError(`Không thể tải dữ liệu. Lỗi: ${err.message || err}`);
      }
    }

    /* ================== EXPORT EXCEL ================== */
    document.getElementById('export-excel').addEventListener('click', async () => {
      if (!filteredData.length) return alert('Không có dữ liệu để xuất.');
      await loadScript('https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js');
      const headers = [
        "STT","Ngày","Giờ","Mực nước (m)","Dung tích (Triệu m³)","Lượng mưa (mm)",
        "Htràn 1 (cm)","Qtràn 1 (m³/s)","Htràn 2 (cm)","Qtràn 2 (m³/s)",
        "a (cm)","Cột nước đầu kênh (m)","Qcống (m³/s)","Họ, tên người vận hành"
      ];
      const rows = filteredData.map((r,i)=>[
        i+1, r._ngay||'', r._gio||'', r.mucNuoc??'', r.dungTich??'', r.luongMua??'',
        r.hTran1??'', r.qtran1??'', r.hTran2??'', r.qtran2??'',
        r.a??'', r.cotNuocDauKenh??'', r.qCong??'', r.nguoiVanHanh||''
      ]);
      // eslint-disable-next-line no-undef
      const wb = XLSX.utils.book_new();
      // eslint-disable-next-line no-undef
      const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
      ws['!cols'] = headers.map((_, ci) => {
        const maxLen = [headers, ...rows].reduce((m, row) => Math.max(m, String(row[ci] ?? '').length), 0);
        return { wch: Math.min(Math.max(10, maxLen + 2), 40) };
      });
      // eslint-disable-next-line no-undef
      XLSX.utils.book_append_sheet(wb, ws, "NhatKyHoThanhSon");
      // eslint-disable-next-line no-undef
      XLSX.writeFile(wb, "NhatKyVanHanh_HoThanhSon.xlsx");
    });

    /* ================== IN (chỉ in bảng) ================== */
    document.getElementById('print-page').addEventListener('click', () => {
      setSubtitle();
      window.print();
    });

    /* ================== FULLSCREEN ================== */
    const btnFs = document.getElementById('toggle-fullscreen');
    btnFs.addEventListener('click', async () => {
      const docEl = document.documentElement;
      if (!document.fullscreenElement) {
        try{
          await docEl.requestFullscreen();
          document.body.classList.add('fullpage');
          btnFs.textContent = 'Thoát toàn màn hình';
        }catch(e){ console.warn('Không thể vào fullscreen:', e); }
      } else {
        try{ await document.exitFullscreen(); }catch(e){}
        document.body.classList.remove('fullpage');
        btnFs.textContent = 'Toàn màn hình';
      }
    });
    document.addEventListener('fullscreenchange', () => {
      if (!document.fullscreenElement) {
        document.body.classList.remove('fullpage');
        btnFs.textContent = 'Toàn màn hình';
      }
    });

    /* ================== INIT ================== */
    (function init(){
      yearFilter.value = 'all';
      quarterFilter.value = 'all';
      monthFilter.value = 'all';
      pageSizeSelect.value = '20';
      pageSize = 20;
      currentPage = 1;
      fetchAndRender();
    })();
  </script>
</body>
</html>
