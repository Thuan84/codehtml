<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Nhật ký vận hành hồ chứa - Hồ Thành Sơn</title>

  <!-- Thư viện xuất file -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

  <!-- Chart.js cho biểu đồ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <!-- Font Việt cho jsPDF -->
  <script src="https://raw.githack.com/MrRio/jsPDF/master/src/libs/raw-fonts/LiberationSerif-Regular.js"></script>
  <script src="https://raw.githack.com/MrRio/jsPDF/master/src/libs/raw-fonts/LiberationSerif-Bold.js"></script>
  <script src="https://raw.githack.com/MrRio/jsPDF/master/src/libs/raw-fonts/LiberationSerif-Italic.js"></script>

  <style>
    :root { --header-bg:#1EA48D; --border-color:#ccc; --hover-bg:#f1f3f5; }
    body{
      font-family:"Times New Roman",Times,serif; background:#f4f4f4; color:#000;
      margin:0; padding:20px; font-size:14pt;
    }
    .container{
      max-width:1600px; margin:0 auto; background:#fff; padding:30px; border-radius:5px;
      box-shadow:0 2px 5px rgba(0,0,0,0.1);
    }
    h1{ font-size:16pt; font-weight:bold; text-align:center; text-transform:uppercase; margin-bottom:5px; }
    .subtitle{ text-align:center; font-weight:bold; font-size:14pt; margin-bottom:20px; }
    .controls-container{
      display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;
      gap:15px; margin-bottom:20px; padding:15px; background:#fdfdff; border-radius:6px; border:1px solid #ccc;
    }
    .filters,.exports{ display:flex; gap:15px; align-items:center; }
    .filters label{ font-weight:bold; }
    .filters select,.exports button{
      padding:8px 12px; border-radius:5px; border:1px solid #ccc; background:#fff;
      font-family:"Times New Roman",Times,serif; font-size:13pt; cursor:pointer;
    }
    .exports button{ font-weight:bold; color:#fff; border:none; transition:opacity .2s; }
    .exports button:hover{ opacity:.9; }
    #export-excel{ background:#218838; }
    #export-pdf{ background:#c82333; }

    .charts{
      display:grid; grid-template-columns: 1fr; gap:20px; margin-top:10px;
    }
    .chart-card{
      border:1px solid #ddd; border-radius:8px; padding:16px; background:#fafafa;
    }
    .chart-title{ font-weight:bold; margin:0 0 12px 0; font-size:14pt; text-align:center; }
    canvas{ width:100%; height:380px; }

    table{ border-collapse:collapse; width:100%; font-size:13pt; margin-top:15px; }
    th,td{ border:1px solid var(--border-color); padding:8px 10px; text-align:center; vertical-align:middle; }
    th{ background:var(--header-bg); color:#000; font-weight:bold; position:sticky; top:0; z-index:1; }
    tbody tr:nth-child(even){ background:#fff; }
    tbody tr:hover{ background:var(--hover-bg); }

    .status-message{ color:#555; padding:40px; text-align:center; font-style:italic; font-size:14pt; }
    .error-message{ color:red; padding:15px; background:#ffeeee; border:1px solid #ffcccc; margin-top:15px; border-radius:5px; }
    .loader-container{ padding:50px; text-align:center; }
    .spinner{
      border:5px solid #f3f3f3; border-top:5px solid #3498db; border-radius:50%;
      width:40px; height:40px; animation:spin 1s linear infinite; display:inline-block; margin-bottom:10px;
    }
    @keyframes spin{ 0%{ transform:rotate(0deg);} 100%{ transform:rotate(360deg);} }

    /* Mở rộng hơn trên màn hình lớn */
    @media (min-width: 1600px){
      .container{ max-width: 1800px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>NHẬT KÝ VẬN HÀNH HỒ CHỨA NƯỚC THÀNH SƠN</h1>
    <div id="subtitle" class="subtitle"></div>

    <div class="controls-container">
      <div class="filters">
        <label for="year-filter">Năm:</label>
        <select id="year-filter"><option value="all">Tất cả</option></select>
        <label for="quarter-filter">Quý:</label>
        <select id="quarter-filter">
          <option value="all">Tất cả</option><option value="1">Quý 1</option>
          <option value="2">Quý 2</option><option value="3">Quý 3</option>
          <option value="4">Quý 4</option>
        </select>
        <label for="month-filter">Tháng:</label>
        <select id="month-filter">
          <option value="all">Tất cả</option>
          <script>for(let i=1;i<=12;i++)document.write(`<option value="${i}">Tháng ${i}</option>`);</script>
        </select>
      </div>
      <div class="exports">
        <button id="export-excel">Xuất Excel</button>
        <button id="export-pdf">Xuất PDF</button>
      </div>
    </div>

    <!-- KHU VỰC BIỂU ĐỒ -->
    <div class="charts">
      <div class="chart-card">
        <p class="chart-title">Lượng mưa theo từng ngày (tổng mm/ngày)</p>
        <canvas id="rainChart"></canvas>
      </div>
      <div class="chart-card">
        <p class="chart-title">Mực nước theo từng ngày (TB m/ngày) & đường tham chiếu mực nước chết (27.5 m)</p>
        <canvas id="waterLevelChart"></canvas>
      </div>
    </div>

    <table id="data-table">
      <thead>
        <tr>
          <th rowspan="2">STT</th>
          <th rowspan="2">Ngày, giờ</th>
          <th rowspan="2">Mực nước (m)</th>
          <th rowspan="2">Dung tích (Triệu m³)</th>
          <th rowspan="2">Lượng mưa (mm)</th>
          <th colspan="2">Thông số vận hành tràn xả lũ số 1</th>
          <th colspan="2">Thông số vận hành tràn xả lũ số 2</th>
          <th colspan="3">Thông số vận hành cống lấy nước</th>
          <th rowspan="2">Họ, tên người vận hành</th>
          <th rowspan="2">Họ, tên người kiểm tra</th>
          <th rowspan="2">Chữ ký</th>
        </tr>
        <tr>
          <th>Htràn 1 (cm)</th>
          <th>Qtràn 1 (m³/s)</th>
          <th>Htràn 2 (cm)</th>
          <th>Qtràn 2 (m³/s)</th>
          <th>a (cm)</th>
          <th>Cột nước đầu kênh (m)</th>
          <th>Qcống (m³/s)</th>
        </tr>
      </thead>
      <tbody id="table-body">
        <tr><td colspan="15">
          <div class="loader-container">
            <div class="spinner"></div>
            <div class="status-message">Đang tải dữ liệu...</div>
          </div>
        </td></tr>
      </tbody>
    </table>
    <div id="error-message" class="error-message" style="display:none;"></div>
  </div>

  <script>
    // ======== CẤU HÌNH API ========
    const EXEC_URL = "https://script.google.com/macros/s/AKfycbxphwCkUk01I8TZ4LI_1bzEW1XdRPLLrGnbYGRkKbt8gJ-rmliZRzp_zoy0GpHhdSEv/exec";
    const SHEET = "HoThanhSon";
    const API_URL = `${EXEC_URL}?sheet=${encodeURIComponent(SHEET)}`;

    // ======== BIẾN TOÀN CỤC ========
    let allData = [];
    let filteredData = [];

    const yearFilter    = document.getElementById('year-filter');
    const quarterFilter = document.getElementById('quarter-filter');
    const monthFilter   = document.getElementById('month-filter');
    const tableBody     = document.getElementById('table-body');
    const errorDiv      = document.getElementById('error-message');
    const subtitleDiv   = document.getElementById('subtitle');
    const totalColumns  = 15;

    // Biểu đồ (Chart instances)
    let rainChart = null;
    let waterLevelChart = null;

    // Tham chiếu mực nước chết
    const DEAD_LEVEL = 27.5;

    // ======== HÀM PHỤ TRỢ ========
    function showError(message){
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      tableBody.innerHTML = `<tr><td colspan="${totalColumns}" class="status-message error-message">${message}</td></tr>`;
    }

    function formatNumberWithComma(value){
      if (value === null || value === undefined || value === '') return '';
      const num = Number(value);
      if (Number.isNaN(num)) return value;
      return num.toLocaleString('vi-VN', { minimumFractionDigits: 0, maximumFractionDigits: 3 });
    }

    // Parse dd/MM/yyyy HH:mm an toàn, trả về Date hoặc null
    function parseVNDateTime(s){
      if (!s || typeof s !== 'string') return null;
      const [dpart, tpart='00:00'] = s.split(' ');
      const [dd, mm, yyyy] = dpart.split('/').map(n=>parseInt(n,10));
      if (!dd || !mm || !yyyy) return null;
      const [HH='0', MM='0'] = tpart.split(':').map(n=>parseInt(n,10));
      const date = new Date(yyyy, mm-1, dd, HH, MM);
      return Number.isNaN(date.getTime()) ? null : date;
    }

    // Chuẩn hóa về chuỗi ngày yyyy-mm-dd
    function ymd(d){
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }

    function renderTable(data){
      tableBody.innerHTML = '';
      if (!Array.isArray(data) || data.length === 0){
        tableBody.innerHTML = `<tr><td colspan="${totalColumns}" class="status-message">Không có dữ liệu phù hợp với bộ lọc.</td></tr>`;
        return;
      }

      data.forEach((row, index) => {
        // Các field: ngayGio, mucNuoc, dungTich, luongMua, hTran1, qtran1, hTran2, qtran2, a, cotNuocDauKenh, qCong, nguoiVanHanh, nguoiKiemTra
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${row.ngayGio || ''}</td>
          <td>${formatNumberWithComma(row.mucNuoc)}</td>
          <td>${formatNumberWithComma(row.dungTich)}</td>
          <td>${formatNumberWithComma(row.luongMua)}</td>
          <td>${formatNumberWithComma(row.hTran1)}</td>
          <td>${formatNumberWithComma(row.qtran1)}</td>
          <td>${formatNumberWithComma(row.hTran2)}</td>
          <td>${formatNumberWithComma(row.qtran2)}</td>
          <td>${formatNumberWithComma(row.a)}</td>
          <td>${formatNumberWithComma(row.cotNuocDauKenh)}</td>
          <td>${formatNumberWithComma(row.qCong)}</td>
          <td>${row.nguoiVanHanh || ''}</td>
          <td>${row.nguoiKiemTra || ''}</td>
          <td></td>
        `;
        tableBody.appendChild(tr);
      });
    }

    function populateYearFilter(data){
      const years = [...new Set(
        data.map(r => {
          const d = parseVNDateTime(r.ngayGio);
          return d ? d.getFullYear() : null;
        }).filter(Boolean)
      )].sort((a,b)=>b-a);

      yearFilter.innerHTML = '<option value="all">Tất cả</option>';
      years.forEach(y => {
        const op = document.createElement('option');
        op.value = String(y);
        op.textContent = `Năm ${y}`;
        yearFilter.appendChild(op);
      });
    }

    function applyFiltersAndRender(){
      const y = yearFilter.value;
      const q = quarterFilter.value;
      const m = monthFilter.value;

      filteredData = allData.filter(r => {
        const d = parseVNDateTime(r.ngayGio);
        if (!d) return false;
        if (y !== 'all' && String(d.getFullYear()) !== String(y)) return false;

        if (m !== 'all'){
          if ((d.getMonth()+1) !== Number(m)) return false;
        } else if (q !== 'all'){
          const quarter = Math.floor(d.getMonth()/3)+1; // 1..4
          if (quarter !== Number(q)) return false;
        }
        return true;
      });

      // Subtitle
      let subtitleText = '';
      if (m !== 'all' && y !== 'all') subtitleText = `Tháng ${m} năm ${y}`;
      else if (y !== 'all')          subtitleText = `Năm ${y}`;
      else {
        const c = new Date();
        subtitleText = `Tháng ${c.getMonth()+1} năm ${c.getFullYear()}`;
      }
      subtitleDiv.textContent = subtitleText;

      renderTable(filteredData);
      updateCharts(); // Cập nhật biểu đồ sau khi render bảng
    }

    [yearFilter, quarterFilter, monthFilter].forEach(el => el.addEventListener('change', applyFiltersAndRender));
    monthFilter.addEventListener('change', () => { if (monthFilter.value !== 'all') quarterFilter.value = 'all'; });
    quarterFilter.addEventListener('change', () => { if (quarterFilter.value !== 'all') monthFilter.value = 'all'; });

    // ======== TẠO DỮ LIỆU NGÀY: Tổng mưa/ngày, TB mực nước/ngày ========
    function aggregateDaily(data){
      const map = new Map(); // key: yyyy-mm-dd -> { rainSum, wlSum, wlCount }

      data.forEach(r => {
        const d = parseVNDateTime(r.ngayGio);
        if (!d) return;
        const key = ymd(d);

        const rain = Number(r.luongMua) || 0;
        const wl   = Number(r.mucNuoc);
        const prev = map.get(key) || { rainSum:0, wlSum:0, wlCount:0 };

        prev.rainSum += rain;
        if (!Number.isNaN(wl)) { prev.wlSum += wl; prev.wlCount += 1; }

        map.set(key, prev);
      });

      const labels = Array.from(map.keys()).sort((a,b) => new Date(a) - new Date(b));
      const rainPerDay = labels.map(k => map.get(k).rainSum);
      const wlAvgPerDay = labels.map(k => {
        const o = map.get(k);
        return o.wlCount ? o.wlSum / o.wlCount : null;
      });

      return { labels, rainPerDay, wlAvgPerDay };
    }

    // ======== VẼ/CẬP NHẬT BIỂU ĐỒ ========
    function updateCharts(){
      const { labels, rainPerDay, wlAvgPerDay } = aggregateDaily(filteredData);

      // Hủy chart cũ nếu có
      if (rainChart) { rainChart.destroy(); rainChart = null; }
      if (waterLevelChart) { waterLevelChart.destroy(); waterLevelChart = null; }

      // Biểu đồ lượng mưa theo ngày (cột)
      const rainCtx = document.getElementById('rainChart').getContext('2d');
      rainChart = new Chart(rainCtx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Lượng mưa (mm/ngày)',
            data: rainPerDay,
            backgroundColor: 'rgba(54, 162, 235, 0.6)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true },
            tooltip: {
              callbacks: {
                label: (ctx) => ` ${ctx.parsed.y?.toLocaleString('vi-VN')} mm`
              }
            }
          },
          scales: {
            x: {
              title: { display: true, text: 'Ngày' },
              ticks: { autoSkip: true, maxRotation: 0 }
            },
            y: {
              title: { display: true, text: 'mm' },
              beginAtZero: true
            }
          }
        }
      });

      // Biểu đồ mực nước TB theo ngày + đường tham chiếu 27.5 m
      const wlCtx = document.getElementById('waterLevelChart').getContext('2d');
      const deadLine = labels.map(() => DEAD_LEVEL);

      waterLevelChart = new Chart(wlCtx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Mực nước TB (m/ngày)',
              data: wlAvgPerDay,
              tension: 0.3,
              fill: false,
              pointRadius: 3
            },
            {
              label: `Mực nước chết (${DEAD_LEVEL} m)`,
              data: deadLine,
              borderDash: [6, 6],
              tension: 0,
              fill: false,
              pointRadius: 0
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const val = ctx.parsed.y;
                  return ctx.datasetIndex === 0
                    ? ` ${val?.toLocaleString('vi-VN', {maximumFractionDigits:3})} m`
                    : ` ${val} m`;
                }
              }
            }
          },
          scales: {
            x: {
              title: { display: true, text: 'Ngày' },
              ticks: { autoSkip: true, maxRotation: 0 }
            },
            y: {
              title: { display: true, text: 'm' },
              beginAtZero: false
            }
          }
        }
      });
    }

    // ======== TẢI DỮ LIỆU (không dùng localStorage để tránh quota) ========
    function processData(data){
      if (!Array.isArray(data) || data.length === 0){
        tableBody.innerHTML = `<tr><td colspan="${totalColumns}" class="status-message">Không có dữ liệu để hiển thị.</td></tr>`;
        return;
      }
      allData = data;
      populateYearFilter(allData);
      applyFiltersAndRender();
    }

    fetch(API_URL, { cache: 'no-store' })
      .then(res => res.ok ? res.json() : Promise.reject(new Error(`HTTP ${res.status}`)))
      .then(json => {
        if (json && json.error) throw new Error(json.message || 'Lỗi từ API');
        processData(json);
      })
      .catch(err => {
        console.error('Lỗi tải dữ liệu:', err);
        showError(`Không thể tải dữ liệu. Lỗi: ${err.message || err}`);
      });

    // ======== XUẤT EXCEL ========
    document.getElementById('export-excel').addEventListener('click', () => {
      if (!filteredData.length) return alert('Không có dữ liệu để xuất.');
      const headers = [
        "STT","Ngày, giờ","Mực nước (m)","Dung tích (Triệu m³)","Lượng mưa (mm)",
        "Htràn 1 (cm)","Qtràn 1 (m³/s)","Htràn 2 (cm)","Qtràn 2 (m³/s)",
        "a (cm)","Cột nước đầu kênh (m)","Qcống (m³/s)",
        "Họ, tên người vận hành","Họ, tên người kiểm tra"
      ];

      const rows = filteredData.map((r, i) => ([
        i+1,
        r.ngayGio || '',
        r.mucNuoc ?? '',
        r.dungTich ?? '',
        r.luongMua ?? '',
        r.hTran1 ?? '',
        r.qtran1 ?? '',
        r.hTran2 ?? '',
        r.qtran2 ?? '',
        r.a ?? '',
        r.cotNuocDauKenh ?? '',
        r.qCong ?? '',
        r.nguoiVanHanh || '',
        r.nguoiKiemTra || ''
      ]));

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);

      // Auto width
      ws['!cols'] = headers.map((_, ci) => {
        const maxLen = [headers, ...rows].reduce((max, row) => {
          const v = row[ci] == null ? '' : String(row[ci]);
          return Math.max(max, v.length);
        }, 0);
        return { wch: Math.min(Math.max(10, maxLen + 2), 40) };
      });

      XLSX.utils.book_append_sheet(wb, ws, "NhatKyHoThanhSon");
      XLSX.writeFile(wb, "NhatKyVanHanh_HoThanhSon.xlsx");
    });

    // ======== XUẤT PDF ========
    document.getElementById('export-pdf').addEventListener('click', () => {
      if (!filteredData.length) return alert('Không có dữ liệu để xuất.');
      try{
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('landscape', 'pt', 'a4');
        const FONT = "LiberationSerif";

        doc.setFont(FONT);
        doc.setFontSize(16);
        doc.setFont(FONT, 'bold');
        doc.text("NHẬT KÝ VẬN HÀNH HỒ CHỨA NƯỚC THÀNH SƠN", doc.internal.pageSize.getWidth()/2, 40, { align:'center' });

        doc.setFontSize(14);
        doc.setFont(FONT, 'bold');
        const subtitle = (document.getElementById('subtitle').textContent || '').trim();
        doc.text(subtitle, doc.internal.pageSize.getWidth()/2, 60, { align:'center' });

        doc.autoTable({
          html: '#data-table',
          startY: 80,
          theme: 'grid',
          headStyles: {
            font: FONT, fontStyle: 'bold', fillColor: [242,242,242], textColor:[0,0,0],
            lineColor:[0,0,0], lineWidth:0.5, fontSize:8, halign:'center', valign:'middle'
          },
          styles: { font: FONT, fontStyle:'normal', lineColor:[0,0,0], lineWidth:0.5, fontSize:8, cellPadding:4 },
          alternateRowStyles: { fillColor:[255,255,255] },
          margin: { top:80 }
        });

        doc.save(`NhatKyVanHanh_HoThanhSon_${subtitle.replace(/\s+/g,'_').replace(/:/g,'')}.pdf`);
      }catch(e){
        console.error("Lỗi tạo PDF:", e);
        alert("Có lỗi khi tạo PDF: " + e.message);
      }
    });
  </script>
</body>
</html>
