<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Nh·∫≠t k√Ω v·∫≠n h√†nh h·ªì ch·ª©a - H·ªì Th√†nh S∆°n</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --header-bg:#1EA48D; --border-color:#e5e7eb; --hover-bg:#f1f3f5; --card-bg:#ffffff;
      --teal:#1EA48D; --blue:#2563eb; --indigo:#4f46e5; --purple:#7c3aed; --orange:#ea580c;
    }
    html, body { height:100%; }
    body{
      font-family:"Times New Roman",Times,serif; background:#fff; color:#0f172a;
      margin:0; padding:0; font-size:14pt;
    }
    .container{
      width:100%; max-width:none; margin:0; background:#fff; padding:20px 24px;
      box-sizing:border-box;
    }
    .fullpage .container{ padding:12px 16px; }

    h1{ font-size:16pt; font-weight:bold; text-align:center; text-transform:uppercase; margin:4px 0 6px 0; }
    .subtitle{ text-align:center; font-weight:bold; font-size:14pt; margin:0 0 10px 0; }

    .controls-container{
      display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;
      gap:12px; margin:0 0 10px 0; padding:10px; background:#fdfdff; border-radius:10px; border:1px solid #e5e7eb;
    }
    .filters,.exports{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .filters label{ font-weight:bold; }
    .filters select,.exports button{
      padding:8px 12px; border-radius:8px; border:1px solid #d1d5db; background:#fff;
      font-family:"Times New Roman",Times,serif; font-size:13pt; cursor:pointer;
    }
    .exports button{ font-weight:bold; color:#fff; border:none; transition:transform .08s ease, opacity .2s; }
    .exports button:hover{ opacity:.95; transform: translateY(-1px); }
    #toggle-custom-time{ background:#6f42c1; }
    #export-excel{ background:#218838; }
    #print-page{ background:#c82333; }
    #toggle-fullscreen{ background:#0b5ed7; }

    /* ===== Metrics ===== */
    .metrics{
      display:grid; grid-template-columns: repeat(5, minmax(220px,1fr));
      gap:12px; margin:0 0 8px 0;
    }
    .metric{
      position:relative; overflow:hidden;
      background: linear-gradient(180deg, #ffffff, #fafafa);
      border:1px solid rgba(15,23,42,.06);
      border-radius:14px; padding:16px 14px;
      box-shadow: 0 6px 14px rgba(2,8,23,.06);
      display:flex; flex-direction:column; gap:8px;
      isolation:isolate;
      align-items:center;
      text-align:center;
    }
    .metric::before{
      content:""; position:absolute; inset:-40% -20% auto auto; height:180px; width:280px;
      border-radius:50%;
      background: var(--accent-fade, rgba(30,164,141,.10));
      filter: blur(18px);
      z-index:-1;
    }
    .metric::after{
      content:""; position:absolute; left:0; top:0; bottom:0; width:5px;
      background: var(--accent, #1EA48D); opacity:.9;
    }
    .metric .label{ font-size:12pt; color:#334155; font-weight:700; letter-spacing:.2px; line-height:1.25; }
    .metric .value{
      font-size:24pt; font-weight:800; color:#0f172a; line-height:1.1;
      font-variant-numeric: tabular-nums; word-break:break-word;
    }
    .m-total{ --accent:var(--teal);   --accent-fade: rgba(30,164,141,.12); }
    .m-ratio{ --accent:var(--blue);   --accent-fade: rgba(37,99,235,.12); }
    .m-avg-d{ --accent:var(--indigo); --accent-fade: rgba(79,70,229,.12); }
    .m-avg-r{ --accent:var(--purple); --accent-fade: rgba(124,58,237,.12); }
    .m-max  { --accent:var(--orange); --accent-fade: rgba(234,88,12,.12); }

    /* ===== Charts ===== */
    .charts{ display:grid; grid-template-columns: 1fr; gap:14px; margin-top:4px; }
    .chart-card{ border:1px solid #e5e7eb; border-radius:12px; padding:10px; background:#fafafa; }
    .chart-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:12px;
    }
    .chart-title{ font-weight:bold; margin:0 0 2px 0; font-size:14pt; }
    .chart-sub{ font-size:11pt; color:#6b7280; }
    .chart-legend-hint{
      font-size:11pt; color:#0f172a; text-align:right; white-space:nowrap;
    }
    .water-status{
      font-size:11.5pt; font-weight:bold; color:#111827;
      margin:2px 0 4px;
    }
    .chart-card canvas{ display:block; width:100% !important; height:380px !important; max-height:380px !important; }

    table{ border-collapse:collapse; width:100%; font-size:13pt; margin-top:10px; table-layout:auto; }
    th,td{ border:1px solid var(--border-color); padding:6px 8px; text-align:center; vertical-align:middle; }
    th{ background:var(--header-bg); color:#000; font-weight:bold; position:sticky; top:0; z-index:1; }
    tbody tr:nth-child(even){ background:#fff; }
    tbody tr:hover{ background:var(--hover-bg); }

    /* tr√°nh xu·ªëng d√≤ng cho Ng√†y/Gi·ªù */
    .nowrap{ white-space: nowrap; }

    /* ===== Pagination (view ch√≠nh) ===== */
    .pager-bar{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      margin-top:8px; flex-wrap:wrap;
    }
    .pager-left{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .pager-right{ display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
    .pager-info{ font-size:12.5pt; color:#334155; }
    .pager-select{
      padding:6px 10px; border:1px solid #d1d5db; border-radius:8px; background:#fff; font-size:12.5pt;
    }
    .page-btn{
      padding:6px 10px; border:1px solid #d1d5db; background:#fff; border-radius:8px; cursor:pointer;
      min-width:40px; text-align:center; font-size:12.5pt;
    }
    .page-btn[disabled]{ opacity:.5; cursor:not-allowed; }
    .page-btn.active{
      background: var(--header-bg);
      color:#000; font-weight:700; border-color:#cbd5e1;
    }

    .status-message{ color:#555; padding:16px; text-align:center; font-style:italic; font-size:14pt; }
    .error-message{ color:#b00020; padding:10px; background:#ffeeee; border:1px solid #ffcccc; margin-top:8px; border-radius:5px; }

    @media (max-width: 1500px){ .metrics{ grid-template-columns: 1fr 1fr; } }

    @media (max-width:768px){
      .chart-legend-hint{
        white-space:normal;
        text-align:left;
      }
    }

    /* ===== PRINT: gi·ªØ nguy√™n, kh√¥ng √°p d·ª•ng ph√¢n trang m√†n h√¨nh ===== */
    @media print {
      @page { size: A4 landscape; margin: 12mm; }

      .controls-container,
      .metrics,
      .charts,
      .error-message,
      .status-message,
      .pager-bar,
      #toggle-fullscreen,
      #print-page,
      #export-excel,
      #toggle-custom-time,
      #custom-time-panel { display: none !important; }

      body { background: #fff !important; color: #000 !important; }
      .container { padding: 0 !important; }

      h1{
        display:block !important;
        text-align:center;
        text-transform:uppercase;
        font-weight:bold;
        font-size:18pt;
        margin:0 0 4mm 0;
      }
      .subtitle{
        display:block !important;
        text-align:center;
        font-weight:bold;
        font-size:14pt;
        margin:0 0 6mm 0;
      }

      th {
        position: static !important;
        background: #ffffff !important;
        color: #000000 !important;
        font-weight: 700 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      thead { display: table-header-group; }
      tfoot { display: table-footer-group; }

      table { page-break-inside: auto; }
      tr    { page-break-inside: avoid; page-break-after: auto; }

      .chart-card, .metric { box-shadow: none !important; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>NH·∫¨T K√ù V·∫¨N H√ÄNH H·ªí CH·ª®A N∆Ø·ªöC TH√ÄNH S∆†N</h1>
    <div id="subtitle" class="subtitle"></div>

    <div class="controls-container">
      <div class="filters">
        <label for="year-filter">NƒÉm:</label>
        <select id="year-filter"><option value="all">T·∫•t c·∫£</option></select>
        <label for="quarter-filter">Qu√Ω:</label>
        <select id="quarter-filter">
          <option value="all">T·∫•t c·∫£</option><option value="1">Qu√Ω 1</option>
          <option value="2">Qu√Ω 2</option><option value="3">Qu√Ω 3</option>
          <option value="4">Qu√Ω 4</option>
        </select>
        <label for="month-filter">Th√°ng:</label>
        <select id="month-filter">
          <option value="all">T·∫•t c·∫£</option>
          <script>for(let i=1;i<=12;i++)document.write(`<option value="${i}">Th√°ng ${i}</option>`);</script>
        </select>
        <label for="week-filter">Tu·∫ßn:</label>
        <select id="week-filter">
          <option value="all">T·∫•t c·∫£</option>
        </select>
        <label for="daynight-filter">Ng√†y/ƒê√™m:</label>
        <select id="daynight-filter">
          <option value="all">T·∫•t c·∫£</option>
          <option value="day">Ng√†y (7h-19h)</option>
          <option value="night">ƒê√™m (19h-7h)</option>
        </select>
      </div>
      <div class="exports">
        <button id="toggle-custom-time" title="L·ªçc theo kho·∫£ng th·ªùi gian t√πy ch·ªânh">‚è±Ô∏è Th·ªùi gian t√πy ch·ªânh</button>
        <button id="toggle-fullscreen" title="B·∫≠t/T·∫Øt to√†n m√†n h√¨nh">To√†n m√†n h√¨nh</button>
        <button id="export-excel">Xu·∫•t Excel</button>
        <button id="print-page">In</button>
      </div>
    </div>

    <!-- Custom Time Range Panel -->
    <div id="custom-time-panel" style="display:none; padding:16px; background:#f8f9fa; border:1px solid #e5e7eb; border-radius:10px; margin-bottom:10px;">
      <div style="display:flex; gap:20px; align-items:end; flex-wrap:wrap;">
        <div>
          <label style="font-weight:bold; display:block; margin-bottom:4px;">T·ª´ ng√†y:</label>
          <input type="date" id="custom-from-date" style="padding:8px; border:1px solid #d1d5db; border-radius:8px; font-size:13pt;">
        </div>
        <div>
          <label style="font-weight:bold; display:block; margin-bottom:4px;">Gi·ªù:ph√∫t:gi√¢y</label>
          <input type="time" id="custom-from-time" step="1" style="padding:8px; border:1px solid #d1d5db; border-radius:8px; font-size:13pt;">
        </div>
        <div>
          <label style="font-weight:bold; display:block; margin-bottom:4px;">ƒê·∫øn ng√†y:</label>
          <input type="date" id="custom-to-date" style="padding:8px; border:1px solid #d1d5db; border-radius:8px; font-size:13pt;">
        </div>
        <div>
          <label style="font-weight:bold; display:block; margin-bottom:4px;">Gi·ªù:ph√∫t:gi√¢y</label>
          <input type="time" id="custom-to-time" step="1" style="padding:8px; border:1px solid #d1d5db; border-radius:8px; font-size:13pt;">
        </div>
        <button id="apply-custom-time" style="padding:8px 16px; background:#1EA48D; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:bold; font-size:13pt;">√Åp d·ª•ng</button>
        <button id="clear-custom-time" style="padding:8px 16px; background:#6c757d; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:bold; font-size:13pt;">X√≥a</button>
      </div>
    </div>

    <!-- Metrics -->
    <div class="metrics">
      <div class="metric m-total"><div class="label">T·ªïng l∆∞·ª£ng m∆∞a (k·ª≥ l·ªçc)</div><div class="value" id="m-total">‚Äî</div></div>
      <div class="metric m-ratio"><div class="label">Ng√†y c√≥ m∆∞a / T·ªïng ng√†y</div><div class="value"><span id="m-rainy-days">‚Äî</span>/<span id="m-days">‚Äî</span></div></div>
      <div class="metric m-avg-d"><div class="label">TB theo ng√†y trong k·ª≥</div><div class="value" id="m-avg-day">‚Äî</div></div>
      <div class="metric m-avg-r"><div class="label">TB theo ng√†y c√≥ m∆∞a</div><div class="value" id="m-avg-rainy">‚Äî</div></div>
      <div class="metric m-max"><div class="label">M∆∞a l·ªõn nh·∫•t (ng√†y)</div><div class="value"><span id="m-max">‚Äî</span> <span id="m-max-date" style="font-size:12pt;font-weight:600;"></span></div></div>
    </div>

    <!-- Chart g·ªôp m∆∞a + m·ª±c n∆∞·ªõc -->
    <div class="charts">
      <div class="chart-card">
        <div class="chart-header">
          <div>
            <p class="chart-title">Bi·ªÉu ƒë·ªì m∆∞a & m·ª±c n∆∞·ªõc h·ªì Th√†nh S∆°n</p>
            <div class="chart-sub">C·ªôt: l∆∞·ª£ng m∆∞a (mm) ¬∑ ƒê∆∞·ªùng: m·ª±c n∆∞·ªõc (m)</div>
          </div>
          <div class="chart-legend-hint">
            üü¢ an to√†n ¬∑ üü° theo d√µi ¬∑ üü† c·∫£nh b√°o ¬∑ üî¥ nguy hi·ªÉm
          </div>
        </div>
        <div id="water-status" class="water-status"></div>
        <canvas id="waterChart"></canvas>
      </div>
    </div>

    <!-- Table -->
    <table id="data-table">
      <thead>
        <tr>
          <th rowspan="2">STT</th>
          <th rowspan="2" class="nowrap">Ng√†y</th>
          <th rowspan="2" class="nowrap">Gi·ªù</th>
          <th rowspan="2">M·ª±c n∆∞·ªõc (m)</th>
          <th rowspan="2">Dung t√≠ch (Tri·ªáu m¬≥)</th>
          <th rowspan="2">L∆∞·ª£ng m∆∞a (mm)</th>
          <th colspan="2">Th√¥ng s·ªë v·∫≠n h√†nh tr√†n x·∫£ l≈© s·ªë 1</th>
          <th colspan="2">Th√¥ng s·ªë v·∫≠n h√†nh tr√†n x·∫£ l≈© s·ªë 2</th>
          <th colspan="3">Th√¥ng s·ªë v·∫≠n h√†nh c·ªëng l·∫•y n∆∞·ªõc</th>
          <th rowspan="2">H·ªç, t√™n ng∆∞·ªùi v·∫≠n h√†nh</th>
          <th rowspan="2">Ch·ªØ k√Ω</th>
        </tr>
        <tr>
          <th>Htr√†n 1 (cm)</th>
          <th>Qtr√†n 1 (m¬≥/s)</th>
          <th>Htr√†n 2 (cm)</th>
          <th>Qtr√†n 2 (m¬≥/s)</th>
          <th>a (cm)</th>
          <th>C·ªôt n∆∞·ªõc ƒë·∫ßu k√™nh (m)</th>
          <th>Qc·ªëng (m¬≥/s)</th>
        </tr>
      </thead>
      <tbody id="table-body">
        <tr><td colspan="16"><div class="loader">ƒêang t·∫£i d·ªØ li·ªáu...</div></td></tr>
      </tbody>
    </table>

    <!-- Pagination bar (view ch√≠nh) -->
    <div class="pager-bar" id="pager-bar" style="display:none;">
      <div class="pager-left">
        <span class="pager-info" id="pager-info">‚Äî</span>
      </div>
      <div class="pager-right">
        <button class="page-btn" id="btn-prev">¬´</button>
        <div id="page-numbers"></div>
        <button class="page-btn" id="btn-next">¬ª</button>
        <span style="margin-left:10px;">Hi·ªÉn th·ªã:</span>
        <select id="page-size" class="pager-select">
          <option value="20" selected>20</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
        <span>d√≤ng/trang</span>
      </div>
    </div>

    <div id="error-message" class="error-message" style="display:none;"></div>
  </div>

  <script>
    /* ================== C·∫§U H√åNH ================== */
    const EXEC_URL = "https://script.google.com/macros/s/AKfycbxphwCkUk01I8TZ4LI_1bzEW1XdRPLLrGnbYGRkKbt8gJ-rmliZRzp_zoy0GpHhdSEv/exec";
    const SHEET = "HoThanhSon";

    // Ng∆∞·ª°ng m·ª±c n∆∞·ªõc h·ªì Th√†nh S∆°n
    const DEAD_LEVEL = 27.5;   // MN ch·∫øt
    const LVL_BT     = 30.8;   // MN d√¢ng b√¨nh th∆∞·ªùng
    const LVL_GC     = 31.96;  // MN d√¢ng gia c∆∞·ªùng thi·∫øt k·∫ø
    const LVL_MID    = (LVL_BT + LVL_GC) / 2; // trung gian v√†ng/cam

    /* ================== STATE ================== */
    let selectedYear = 'all', selectedQuarter = 'all', selectedMonth = 'all', selectedWeek = 'all', selectedDayNight = 'all';
    let customTimeRange = null; // {fromDate, fromTime, toDate, toTime}
    let allData = [], filteredData = [], currentFetchCtrl = null;
    const cacheByScope = new Map(); // keys: 'all', 'year:YYYY'
    let comboChart = null, ChartLibLoaded = false;

    // Ph√¢n trang (view ch√≠nh)
    let pageSize = 20;
    let currentPage = 1;

    /* ================== DOM ================== */
    const yearFilter = document.getElementById('year-filter');
    const quarterFilter = document.getElementById('quarter-filter');
    const monthFilter = document.getElementById('month-filter');
    const weekFilter = document.getElementById('week-filter');
    const dayNightFilter = document.getElementById('daynight-filter');
    const tableBody = document.getElementById('table-body');
    const errorDiv = document.getElementById('error-message');
    const subtitleDiv = document.getElementById('subtitle');
    const elTotal = document.getElementById('m-total');
    const elRainyDays = document.getElementById('m-rainy-days');
    const elDays = document.getElementById('m-days');
    const elAvgDay = document.getElementById('m-avg-day');
    const elAvgRainy = document.getElementById('m-avg-rainy');
    const elMax = document.getElementById('m-max');
    const elMaxDate = document.getElementById('m-max-date');
    const waterStatusEl = document.getElementById('water-status');

    // Custom time range
    const customTimePanel = document.getElementById('custom-time-panel');
    const customFromDate = document.getElementById('custom-from-date');
    const customFromTime = document.getElementById('custom-from-time');
    const customToDate = document.getElementById('custom-to-date');
    const customToTime = document.getElementById('custom-to-time');
    const btnToggleCustomTime = document.getElementById('toggle-custom-time');
    const btnApplyCustomTime = document.getElementById('apply-custom-time');
    const btnClearCustomTime = document.getElementById('clear-custom-time');

    // DOM ph√¢n trang
    const pagerBar = document.getElementById('pager-bar');
    const pagerInfo = document.getElementById('pager-info');
    const pageNumbers = document.getElementById('page-numbers');
    const btnPrev = document.getElementById('btn-prev');
    const btnNext = document.getElementById('btn-next');
    const pageSizeSelect = document.getElementById('page-size');

    /* ================== UTIL ================== */
    function parseVNDateTime(s){
      if (!s || typeof s !== 'string') return null;
      const [dpart, tpart='00:00'] = s.split(' ');
      const [dd, mm, yyyy] = dpart.split('/').map(n=>parseInt(n,10));
      if (!dd || !mm || !yyyy) return null;
      const [HH='0', MM='0'] = tpart.split(':').map(n=>parseInt(n,10));
      const d = new Date(yyyy, mm-1, dd, HH, MM);
      return Number.isNaN(d.getTime()) ? null : d;
    }
    function pad2(n){ return String(n).padStart(2,'0'); }
    function formatVNDate(d){ return d ? `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}` : ''; }
    function formatVNTime(d){ return d ? `${pad2(d.getHours())}:${pad2(d.getMinutes())}` : ''; }
    function ymd(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
    function formatNum(v, max=3){
      if (v === null || v === undefined || v === '') return '';
      const n = Number(v); if (Number.isNaN(n)) return v;
      return n.toLocaleString('vi-VN', { maximumFractionDigits:max });
    }
    function buildApiUrl(year='all', month='all', quarter='all') {
      const p = new URLSearchParams({ sheet: SHEET });
      if (year !== 'all') p.set('year', year);
      if (year !== 'all') {
        if (month !== 'all')   p.set('month', month);
        else if (quarter !== 'all') p.set('quarter', quarter);
      }
      return `${EXEC_URL}?${p.toString()}`;
    }
    function loadScript(src){
      return new Promise((resolve, reject)=>{
        const s = document.createElement('script');
        s.src = src; s.async = true; s.crossOrigin = "anonymous";
        s.onload = () => resolve();
        s.onerror = () => reject(new Error(`Kh√¥ng t·∫£i ƒë∆∞·ª£c script: ${src}`));
        document.head.appendChild(s);
      });
    }
    function showError(message){
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      tableBody.innerHTML = `<tr><td colspan="16" class="status-message">${message}</td></tr>`;
      waterStatusEl.textContent = 'Kh√¥ng th·ªÉ x√°c ƒë·ªãnh tr·∫°ng th√°i m·ª±c n∆∞·ªõc do l·ªói d·ªØ li·ªáu.';
    }
    
    // L·∫•y s·ªë tu·∫ßn trong nƒÉm
    function getWeekNumber(date) {
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
      const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1)/7);
      return weekNo;
    }
    
    // Ki·ªÉm tra gi·ªù thu·ªôc ng√†y hay ƒë√™m
    function isDayTime(date) {
      const hour = date.getHours();
      return hour >= 7 && hour < 19;
    }
    
    function isNightTime(date) {
      const hour = date.getHours();
      return hour >= 19 || hour < 7;
    }

    /* ================== TABLE (c√≥ ph√¢n trang) ================== */
    function renderTable(data, baseIndex=0){
      if (!Array.isArray(data) || data.length === 0){
        tableBody.innerHTML = `<tr><td colspan="16" class="status-message">Kh√¥ng c√≥ d·ªØ li·ªáu ph√π h·ª£p v·ªõi b·ªô l·ªçc.</td></tr>`;
        return;
      }
      let html = '';
      for (let i=0;i<data.length;i++){
        const r = data[i];
        html += `<tr>
          <td>${baseIndex + i + 1}</td>
          <td class="nowrap">${r._ngay || ''}</td>
          <td class="nowrap">${r._gio || ''}</td>
          <td>${formatNum(r.mucNuoc)}</td>
          <td>${formatNum(r.dungTich)}</td>
          <td>${formatNum(r.luongMua)}</td>
          <td>${formatNum(r.hTran1)}</td>
          <td>${formatNum(r.qtran1)}</td>
          <td>${formatNum(r.hTran2)}</td>
          <td>${formatNum(r.qtran2)}</td>
          <td>${formatNum(r.a)}</td>
          <td>${formatNum(r.cotNuocDauKenh)}</td>
          <td>${formatNum(r.qCong)}</td>
          <td>${r.nguoiVanHanh || ''}</td>
          <td></td>
        </tr>`;
      }
      tableBody.innerHTML = html;
    }

    /* ================== YEAR DROPDOWN & WEEK DROPDOWN ================== */
    function populateYearFilter(data){
      const years = [...new Set(data.map(r => r._y).filter(v => v!=null))].sort((a,b)=>b-a);
      const prev = yearFilter.value;
      yearFilter.innerHTML = '<option value="all">T·∫•t c·∫£</option>';
      years.forEach(y => {
        const op = document.createElement('option');
        op.value = String(y);
        op.textContent = `NƒÉm ${y}`;
        yearFilter.appendChild(op);
      });
      if (prev && (prev === 'all' || years.includes(Number(prev)))) {
        yearFilter.value = prev;
      } else if (years.includes(Number(selectedYear))) {
        yearFilter.value = selectedYear;
      } else {
        yearFilter.value = 'all';
        selectedYear = 'all';
      }
    }
    
    function populateWeekFilter(data) {
      const weeks = new Set();
      data.forEach(r => {
        if (r._dt && r._y) {
          const weekNum = getWeekNumber(r._dt);
          weeks.add(`${r._y}-W${String(weekNum).padStart(2, '0')}`);
        }
      });
      
      const prev = weekFilter.value;
      weekFilter.innerHTML = '<option value="all">T·∫•t c·∫£</option>';
      
      [...weeks].sort((a, b) => {
        const [yearA, weekA] = a.split('-W').map(v => parseInt(v, 10));
        const [yearB, weekB] = b.split('-W').map(v => parseInt(v, 10));
        if (yearA !== yearB) return yearB - yearA;
        return weekB - weekA;
      }).forEach(w => {
        const op = document.createElement('option');
        op.value = w;
        const [year, week] = w.split('-W');
        op.textContent = `Tu·∫ßn ${parseInt(week, 10)} (${year})`;
        weekFilter.appendChild(op);
      });
      
      if (prev && (prev === 'all' || weeks.has(prev))) {
        weekFilter.value = prev;
      } else {
        weekFilter.value = 'all';
        selectedWeek = 'all';
      }
    }

    /* ================== AGGREGATE & METRICS ================== */
    function aggregateDaily(data){
      const map = new Map();
      for (const r of data){
        const d = r._dt;
        if (!d) continue;
        const key = ymd(d);
        const rain = Number(r.luongMua) || 0;
        const wl   = Number(r.mucNuoc);
        const prev = map.get(key) || { rainSum:0, wlSum:0, wlCount:0 };
        prev.rainSum += rain;
        if (!Number.isNaN(wl)) { prev.wlSum += wl; prev.wlCount++; }
        map.set(key, prev);
      }
      const labels = Array.from(map.keys()).sort((a,b)=> new Date(a)-new Date(b));
      const rainPerDay = labels.map(k => map.get(k).rainSum);
      const wlAvgPerDay = labels.map(k => {
        const o = map.get(k); return o.wlCount ? o.wlSum/o.wlCount : null;
      });
      return { labels, rainPerDay, wlAvgPerDay };
    }
    function renderRainStats(){
      const { labels, rainPerDay } = aggregateDaily(filteredData);
      const total = rainPerDay.reduce((s,v)=>s+(Number(v)||0),0);
      const days = labels.length;
      const rainyDays = rainPerDay.filter(v => (Number(v)||0) > 0).length;
      const avgPerDay = days ? total/days : 0;
      const avgPerRainy = rainyDays ? total/rainyDays : 0;

      let maxVal = 0, maxDate = '';
      rainPerDay.forEach((v,i)=>{ if ((Number(v)||0) > maxVal){ maxVal = Number(v)||0; maxDate = labels[i]; } });

      elTotal.textContent = total.toLocaleString('vi-VN', {maximumFractionDigits:1});
      elDays.textContent = String(days);
      elRainyDays.textContent = String(rainyDays);
      elAvgDay.textContent = avgPerDay.toLocaleString('vi-VN', {maximumFractionDigits:2});
      elAvgRainy.textContent = avgPerRainy.toLocaleString('vi-VN', {maximumFractionDigits:2});
      elMax.textContent = maxVal.toLocaleString('vi-VN', {maximumFractionDigits:1});
      elMaxDate.textContent = maxDate ? `(${maxDate})` : '';
    }

    /* ================== CHARTS (combo + plugin bands) ================== */
    const levelBandsPlugin = {
      id: 'levelBands',
      beforeDraw(chart, args, opts) {
        const bands = opts && opts.bands;
        if (!bands || !bands.length) return;
        const yScale = chart.scales['yLevel'];
        if (!yScale) return;
        const {ctx, chartArea} = chart;
        ctx.save();
        bands.forEach(b=>{
          if (b.from == null || b.to == null) return;
          const y1 = yScale.getPixelForValue(b.from);
          const y2 = yScale.getPixelForValue(b.to);
          const top = Math.min(y1, y2);
          const bottom = Math.max(y1, y2);
          const clippedTop = Math.max(chartArea.top, top);
          const clippedBottom = Math.min(chartArea.bottom, bottom);
          if (clippedBottom <= clippedTop) return;
          ctx.fillStyle = b.color || 'rgba(0,0,0,0.05)';
          ctx.fillRect(chartArea.left, clippedTop, chartArea.right - chartArea.left, clippedBottom - clippedTop);
        });
        ctx.restore();
      }
    };

    async function ensureChartJs(){
      if (!ChartLibLoaded){
        await loadScript('https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js');
        if (typeof Chart !== 'undefined') {
          Chart.register(levelBandsPlugin);
        }
        ChartLibLoaded = true;
      }
    }

    function niceMax(val){
      if (!isFinite(val) || val <= 0) return 10;
      const mags = [5,10,20,25,50,100,200,250,500,1000];
      const target = val * 1.1;
      for (const m of mags){ if (target <= m) return m; }
      return Math.ceil(target/100)*100;
    }

    async function updateCharts(){
      await ensureChartJs();
      const { labels, rainPerDay, wlAvgPerDay } = aggregateDaily(filteredData);

      if (comboChart) { comboChart.destroy(); comboChart = null; }

      const maxRain = rainPerDay.reduce((m,v)=>Math.max(m, v||0), 0);
      const yMaxRain = niceMax(maxRain);
      const stepRain = (yMaxRain > 50 ? 10 : 5);

      const wlVals = wlAvgPerDay.filter(v=>v!=null && !Number.isNaN(v));
      const lvlMin = wlVals.length ? Math.min(...wlVals) : DEAD_LEVEL;
      const lvlMax = wlVals.length ? Math.max(...wlVals) : LVL_GC + 0.5;
      const pad = 0.1;
      const yMinLvl = Math.floor((Math.min(DEAD_LEVEL, lvlMin) - pad) * 10) / 10;
      const yMaxLvl = Math.ceil((lvlMax + pad) * 10) / 10;

      const canvas = document.getElementById('waterChart');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');

      const gradient = ctx.createLinearGradient(0,0,0,ctx.canvas.height);
      gradient.addColorStop(0,'rgba(30,164,141,0.30)');
      gradient.addColorStop(1,'rgba(30,164,141,0.00)');

      const deadLine = labels.map(()=>DEAD_LEVEL);

      // eslint-disable-next-line no-undef
      comboChart = new Chart(ctx,{
        type:'bar',
        data:{
          labels,
          datasets:[
            {
              type:'bar',
              label:'L∆∞·ª£ng m∆∞a (mm)',
              data:rainPerDay,
              yAxisID:'yRain',
              backgroundColor:'rgba(56,189,248,0.55)',
              borderRadius:4,
              maxBarThickness:32
            },
            {
              type:'line',
              label:'M·ª±c n∆∞·ªõc (m)',
              data:wlAvgPerDay,
              yAxisID:'yLevel',
              spanGaps:true,
              borderColor:'#1EA48D',
              backgroundColor:gradient,
              tension:0.35,
              borderWidth:2.4,
              pointRadius:3,
              pointHoverRadius:5,
              pointBackgroundColor:(ctxPoint)=>{
                const v = ctxPoint.raw;
                if(v==null || Number.isNaN(v)) return '#1EA48D';
                if(v>=LVL_GC)    return '#b91c1c'; // ƒë·ªè
                if(v>=LVL_MID)   return '#ea580c'; // cam
                if(v>=LVL_BT)    return '#eab308'; // v√†ng
                return '#1EA48D';                  // an to√†n
              },
              pointBorderColor:'#ffffff',
              fill:true
            },
            {
              type:'line',
              label:`M·ª±c n∆∞·ªõc ch·∫øt (${DEAD_LEVEL.toFixed(2)} m)`,
              data:deadLine,
              yAxisID:'yLevel',
              borderColor:'rgba(148,163,184,0.9)',
              borderDash:[6,4],
              borderWidth:1.4,
              pointRadius:0,
              fill:false
            }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            legend:{
              display:true,
              position:'bottom',
              labels:{ usePointStyle:true, boxWidth:10, padding:16 }
            },
            tooltip:{
              mode:'index',
              intersect:false,
              callbacks:{
                label(ctx){
                  const v = ctx.parsed.y;
                  if(ctx.datasetIndex === 0){
                    return `L∆∞·ª£ng m∆∞a: ${v.toFixed(1)} mm`;
                  }else if(ctx.datasetIndex === 1){
                    return `M·ª±c n∆∞·ªõc: ${v.toFixed(2)} m`;
                  }
                  return `M·ª±c n∆∞·ªõc ch·∫øt: ${DEAD_LEVEL.toFixed(2)} m`;
                }
              }
            },
            levelBands:{
              bands:[
                { from: LVL_BT,  to: LVL_MID, color:'rgba(250,204,21,0.18)' }, // v√†ng
                { from: LVL_MID, to: LVL_GC,  color:'rgba(249,115,22,0.18)' }, // cam
                { from: LVL_GC,  to: yMaxLvl, color:'rgba(248,113,113,0.20)' } // ƒë·ªè
              ]
            }
          },
          interaction:{ mode:'nearest', intersect:false },
          scales:{
            x:{
              grid:{ display:false },
              ticks:{
                autoSkip:true,
                maxTicksLimit: Math.min(12, labels.length),
                maxRotation:0
              },
              title:{ display:false }
            },
            yRain:{
              position:'left',
              beginAtZero:true,
              suggestedMax:yMaxRain,
              ticks:{ stepSize:stepRain },
              grid:{ color:'rgba(148,163,184,0.20)' },
              title:{ display:true, text:'L∆∞·ª£ng m∆∞a (mm)' }
            },
            yLevel:{
              position:'right',
              beginAtZero:false,
              suggestedMin:yMinLvl,
              suggestedMax:yMaxLvl,
              grid:{ drawOnChartArea:false },
              title:{ display:true, text:'M·ª±c n∆∞·ªõc (m)' }
            }
          }
        }
      });

      // ===== Tr·∫°ng th√°i m·ª±c n∆∞·ªõc g·∫ßn nh·∫•t =====
      let lastVal = null;
      for (let i = wlAvgPerDay.length - 1; i >= 0; i--){
        if (wlAvgPerDay[i] != null){
          lastVal = wlAvgPerDay[i];
          break;
        }
      }

      if(lastVal == null || Number.isNaN(lastVal)){
        waterStatusEl.textContent = 'Kh√¥ng c√≥ d·ªØ li·ªáu m·ª±c n∆∞·ªõc.';
      }else{
        let baseText;
        if(lastVal >= DEAD_LEVEL){
          baseText = `M·ª±c n∆∞·ªõc g·∫ßn nh·∫•t ${lastVal.toFixed(2)} m ‚Äî CAO H∆†N m·ª±c n∆∞·ªõc ch·∫øt ${(lastVal - DEAD_LEVEL).toFixed(2)} m.`;
        }else{
          baseText = `M·ª±c n∆∞·ªõc g·∫ßn nh·∫•t ${lastVal.toFixed(2)} m ‚Äî TH·∫§P H∆†N m·ª±c n∆∞·ªõc ch·∫øt ${(DEAD_LEVEL - lastVal).toFixed(2)} m.`;
        }

        let zoneText;
        if(lastVal < DEAD_LEVEL){
          zoneText = 'ƒêang d∆∞·ªõi m·ª±c n∆∞·ªõc ch·∫øt, d∆∞·ªõi v√πng l√†m vi·ªác b√¨nh th∆∞·ªùng.';
        }else if(lastVal < LVL_BT){
          zoneText = `V√ôNG AN TO√ÄN ‚Äì d∆∞·ªõi m·ª±c n∆∞·ªõc d√¢ng b√¨nh th∆∞·ªùng (${LVL_BT.toFixed(2)} m).`;
        }else if(lastVal < LVL_MID){
          zoneText = `V√ôNG V√ÄNG ‚Äì quanh ng∆∞·ª°ng m·ª±c n∆∞·ªõc d√¢ng b√¨nh th∆∞·ªùng (${LVL_BT.toFixed(2)} m), c·∫ßn theo d√µi.`;
        }else if(lastVal < LVL_GC){
          zoneText = `V√ôNG CAM ‚Äì gi·ªØa m·ª±c n∆∞·ªõc d√¢ng b√¨nh th∆∞·ªùng v√† m·ª±c n∆∞·ªõc d√¢ng gia c∆∞·ªùng (${LVL_GC.toFixed(2)} m), m·ª©c c·∫£nh b√°o cao.`;
        }else{
          zoneText = `V√ôNG ƒê·ªé ‚Äì x·∫•p x·ªâ ho·∫∑c v∆∞·ª£t m·ª±c n∆∞·ªõc d√¢ng gia c∆∞·ªùng thi·∫øt k·∫ø (${LVL_GC.toFixed(2)} m), r·∫•t nguy hi·ªÉm.`;
        }

        waterStatusEl.textContent = `${baseText} Tr·∫°ng th√°i: ${zoneText}`;
      }
    }

    /* ================== SUBTITLE ================== */
    function setSubtitle(){
      if (customTimeRange) {
        const { fromDate, fromTime, toDate, toTime } = customTimeRange;
        subtitleDiv.textContent = `T·ª´ ${fromDate} ${fromTime || '00:00:00'} ƒë·∫øn ${toDate} ${toTime || '23:59:59'}`;
      } else if (selectedWeek !== 'all') {
        const [year, week] = selectedWeek.split('-W');
        subtitleDiv.textContent = `Tu·∫ßn ${week} nƒÉm ${year}`;
      } else if (selectedDayNight !== 'all') {
        const label = selectedDayNight === 'day' ? 'Ng√†y (7h-19h)' : 'ƒê√™m (19h-7h)';
        if (selectedYear !== 'all' && selectedMonth !== 'all') {
          subtitleDiv.textContent = `${label} - Th√°ng ${selectedMonth} nƒÉm ${selectedYear}`;
        } else if (selectedYear !== 'all') {
          subtitleDiv.textContent = `${label} - NƒÉm ${selectedYear}`;
        } else {
          subtitleDiv.textContent = label;
        }
      } else if (selectedYear !== 'all' && selectedMonth !== 'all') {
        subtitleDiv.textContent = `Th√°ng ${selectedMonth} nƒÉm ${selectedYear}`;
      } else if (selectedYear !== 'all' && selectedQuarter !== 'all') {
        subtitleDiv.textContent = `Qu√Ω ${selectedQuarter} nƒÉm ${selectedYear}`;
      } else if (selectedYear !== 'all') {
        subtitleDiv.textContent = `NƒÉm ${selectedYear}`;
      } else {
        const c = new Date();
        subtitleDiv.textContent = `Th√°ng ${c.getMonth()+1} nƒÉm ${c.getFullYear()}`;
      }
    }

    /* ================== FILTER ================== */
    function clientFilter(data){
      return data.filter(r=>{
        if (customTimeRange) {
          if (!r._dt) return false;
          const { fromDate, fromTime, toDate, toTime } = customTimeRange;
          const fromDateTime = new Date(`${fromDate}T${fromTime || '00:00:00'}`);
          const toDateTime = new Date(`${toDate}T${toTime || '23:59:59'}`);
          if (r._dt < fromDateTime || r._dt > toDateTime) return false;
        }
        
        if (selectedWeek !== 'all') {
          if (!r._dt) return false;
          const weekNum = getWeekNumber(r._dt);
          const rowWeek = `${r._y}-W${weekNum}`;
          if (rowWeek !== selectedWeek) return false;
        }
        
        if (selectedDayNight !== 'all') {
          if (!r._dt) return false;
          if (selectedDayNight === 'day' && !isDayTime(r._dt)) return false;
          if (selectedDayNight === 'night' && !isNightTime(r._dt)) return false;
        }
        
        if (selectedYear !== 'all' && String(r._y) !== selectedYear) return false;
        if (selectedMonth !== 'all' && r._m !== Number(selectedMonth)) return false;
        if (selectedQuarter !== 'all' && r._q !== Number(selectedQuarter)) return false;
        
        return true;
      });
    }

    /* ================== LOAD & CACHE ================== */
    function normalizeRows(rows){
      for (const r of rows){
        const d = parseVNDateTime(r.ngayGio);
        r._dt = d;
        if (d){
          r._y = d.getFullYear(); r._m = d.getMonth()+1; r._q = Math.floor(d.getMonth()/3)+1;
          r._ngay = formatVNDate(d);
          r._gio  = formatVNTime(d);
        } else {
          r._y = r._m = r._q = null;
          if (typeof r.ngayGio === 'string'){
            const [dp='', tp=''] = r.ngayGio.split(' ');
            r._ngay = dp; r._gio = tp;
          } else {
            r._ngay = ''; r._gio = '';
          }
        }
      }
      return rows;
    }
    function scopeKey(y){ return (y === 'all') ? 'all' : `year:${y}`; }

    function indexYearsAndWarmCache(allRows){
      const buckets = new Map();
      for (const r of allRows){
        if (r._y == null) continue;
        const k = `year:${r._y}`;
        if (!buckets.has(k)) buckets.set(k, []);
        buckets.get(k).push(r);
      }
      for (const [k, rows] of buckets){
        if (!cacheByScope.has(k)) cacheByScope.set(k, rows);
      }
    }

    async function loadScope(y){
      const key = scopeKey(y);

      if (cacheByScope.has(key)) return cacheByScope.get(key);

      if (cacheByScope.has('all') && y !== 'all') {
        const allRows = cacheByScope.get('all');
        indexYearsAndWarmCache(allRows);
        return cacheByScope.get(key) || [];
      }

      const url = (y==='all') ? buildApiUrl('all','all','all') : buildApiUrl(y,'all','all');
      if (currentFetchCtrl) currentFetchCtrl.abort();
      currentFetchCtrl = new AbortController();
      const res = await fetch(url, { cache:'no-store', signal: currentFetchCtrl.signal });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const json = await res.json();
      if (!Array.isArray(json)) throw new Error('D·ªØ li·ªáu tr·∫£ v·ªÅ kh√¥ng h·ª£p l·ªá');
      const norm = normalizeRows(json);

      cacheByScope.set(key, norm);

      if (y === 'all') indexYearsAndWarmCache(norm);

      return norm;
    }

    /* ================== PAGINATION HELPERS ================== */
    function getTotalPages(){
      return Math.max(1, Math.ceil(filteredData.length / pageSize));
    }
    function clampPage(p){
      const tp = getTotalPages();
      return Math.min(Math.max(1, p), tp);
    }
    function getPagedSlice(){
      const tp = getTotalPages();
      currentPage = clampPage(currentPage);
      const start = (currentPage-1) * pageSize;
      const end = Math.min(start + pageSize, filteredData.length);
      return { start, end, slice: filteredData.slice(start, end), totalPages: tp };
    }
    function renderPaginationBar(){
      const { start, end, totalPages } = getPagedSlice();
      pagerInfo.textContent = `Trang ${currentPage}/${totalPages} ‚Äî Hi·ªÉn th·ªã ${filteredData.length ? (start+1) : 0}‚Äì${end} / ${filteredData.length} d√≤ng`;
      pagerBar.style.display = 'flex';

      btnPrev.disabled = currentPage <= 1;
      btnNext.disabled = currentPage >= totalPages;

      pageNumbers.innerHTML = '';
      for (let p=1; p<=totalPages; p++){
        const b = document.createElement('button');
        b.className = 'page-btn' + (p===currentPage ? ' active' : '');
        b.textContent = p;
        b.addEventListener('click', () => {
          if (currentPage !== p){
            currentPage = p;
            drawTableWithPagination();
          }
        });
        pageNumbers.appendChild(b);
      }
    }
    function drawTableWithPagination(){
      const { start, slice } = getPagedSlice();
      renderTable(slice, start);
      renderPaginationBar();
    }

    btnPrev.addEventListener('click', () => { currentPage = clampPage(currentPage-1); drawTableWithPagination(); });
    btnNext.addEventListener('click', () => { currentPage = clampPage(currentPage+1); drawTableWithPagination(); });
    pageSizeSelect.addEventListener('change', () => {
      pageSize = parseInt(pageSizeSelect.value, 10) || 20;
      currentPage = 1;
      drawTableWithPagination();
    });

    /* ================== APPLY (debounce) ================== */
    let filterTimer = null;
    function scheduleApply(){ clearTimeout(filterTimer); filterTimer = setTimeout(applyFiltersAndRender, 80); }
    function applyFiltersAndRender(){
      const y = yearFilter.value;
      let q = quarterFilter.value;
      let m = monthFilter.value;
      const w = weekFilter.value;
      const dn = dayNightFilter.value;
      
      if (m !== 'all') q = 'all';
      if (q !== 'all') m = 'all';
      if (w !== 'all') { q = 'all'; m = 'all'; }
      
      selectedYear = y; 
      selectedQuarter = q; 
      selectedMonth = m;
      selectedWeek = w;
      selectedDayNight = dn;
      
      currentPage = 1;
      fetchAndRender();
    }
    
    yearFilter.addEventListener('change', scheduleApply);
    quarterFilter.addEventListener('change', () => { 
      if (quarterFilter.value !== 'all') {
        monthFilter.value = 'all'; 
        weekFilter.value = 'all';
      }
      scheduleApply(); 
    });
    monthFilter.addEventListener('change', () => { 
      if (monthFilter.value !== 'all') {
        quarterFilter.value = 'all';
        weekFilter.value = 'all';
      }
      scheduleApply(); 
    });
    weekFilter.addEventListener('change', () => {
      if (weekFilter.value !== 'all') {
        quarterFilter.value = 'all';
        monthFilter.value = 'all';
      }
      scheduleApply();
    });
    dayNightFilter.addEventListener('change', scheduleApply);

    /* ================== FETCH & RENDER ================== */
    async function fetchAndRender(){
      setSubtitle();
      errorDiv.style.display = 'none';
      tableBody.innerHTML = `<tr><td colspan="16"><div class="loader">ƒêang t·∫£i d·ªØ li·ªáu...</div></td></tr>`;
      try{
        const scopeData = await loadScope(selectedYear);

        if (!allData.length && cacheByScope.has('all')) {
          allData = cacheByScope.get('all');
          populateYearFilter(allData);
          populateWeekFilter(allData);
        } else if (selectedYear === 'all' && !allData.length) {
          allData = scopeData;
          populateYearFilter(allData);
          populateWeekFilter(allData);
        } else if (selectedYear === 'all') {
          populateYearFilter(allData);
          populateWeekFilter(allData);
        } else {
          populateWeekFilter(scopeData);
        }

        filteredData = clientFilter(scopeData);

        drawTableWithPagination();
        renderRainStats();
        requestAnimationFrame(()=> setTimeout(updateCharts, 0));
      }catch(err){
        if (err.name === 'AbortError') return;
        console.error('L·ªói t·∫£i d·ªØ li·ªáu:', err);
        showError(`Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. L·ªói: ${err.message || err}`);
      }
    }

    /* ================== EXPORT EXCEL ================== */
    document.getElementById('export-excel').addEventListener('click', async () => {
      if (!filteredData.length) return alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t.');
      await loadScript('https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js');
      const headers = [
        "STT","Ng√†y","Gi·ªù","M·ª±c n∆∞·ªõc (m)","Dung t√≠ch (Tri·ªáu m¬≥)","L∆∞·ª£ng m∆∞a (mm)",
        "Htr√†n 1 (cm)","Qtr√†n 1 (m¬≥/s)","Htr√†n 2 (cm)","Qtr√†n 2 (m¬≥/s)",
        "a (cm)","C·ªôt n∆∞·ªõc ƒë·∫ßu k√™nh (m)","Qc·ªëng (m¬≥/s)","H·ªç, t√™n ng∆∞·ªùi v·∫≠n h√†nh"
      ];
      const rows = filteredData.map((r,i)=>[
        i+1, r._ngay||'', r._gio||'', r.mucNuoc??'', r.dungTich??'', r.luongMua??'',
        r.hTran1??'', r.qtran1??'', r.hTran2??'', r.qtran2??'',
        r.a??'', r.cotNuocDauKenh??'', r.qCong??'', r.nguoiVanHanh||''
      ]);
      // eslint-disable-next-line no-undef
      const wb = XLSX.utils.book_new();
      // eslint-disable-next-line no-undef
      const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
      ws['!cols'] = headers.map((_, ci) => {
        const maxLen = [headers, ...rows].reduce((m, row) => Math.max(m, String(row[ci] ?? '').length), 0);
        return { wch: Math.min(Math.max(10, maxLen + 2), 40) };
      });
      // eslint-disable-next-line no-undef
      XLSX.utils.book_append_sheet(wb, ws, "NhatKyHoThanhSon");
      // eslint-disable-next-line no-undef
      XLSX.writeFile(wb, "NhatKyVanHanh_HoThanhSon.xlsx");
    });

    /* ================== IN (ch·ªâ in b·∫£ng) ================== */
    document.getElementById('print-page').addEventListener('click', () => {
      setSubtitle();
      window.print();
    });

    /* ================== FULLSCREEN ================== */
    const btnFs = document.getElementById('toggle-fullscreen');
    btnFs.addEventListener('click', async () => {
      const docEl = document.documentElement;
      if (!document.fullscreenElement) {
        try{
          await docEl.requestFullscreen();
          document.body.classList.add('fullpage');
          btnFs.textContent = 'Tho√°t to√†n m√†n h√¨nh';
        }catch(e){ console.warn('Kh√¥ng th·ªÉ v√†o fullscreen:', e); }
      } else {
        try{ await document.exitFullscreen(); }catch(e){}
        document.body.classList.remove('fullpage');
        btnFs.textContent = 'To√†n m√†n h√¨nh';
      }
    });
    document.addEventListener('fullscreenchange', () => {
      if (!document.fullscreenElement) {
        document.body.classList.remove('fullpage');
        btnFs.textContent = 'To√†n m√†n h√¨nh';
      }
    });

    /* ================== CUSTOM TIME RANGE ================== */
    btnToggleCustomTime.addEventListener('click', () => {
      const isVisible = customTimePanel.style.display !== 'none';
      customTimePanel.style.display = isVisible ? 'none' : 'block';
      btnToggleCustomTime.textContent = isVisible ? '‚è±Ô∏è Th·ªùi gian t√πy ch·ªânh' : '‚è±Ô∏è ƒê√≥ng b·ªô l·ªçc';
    });

    btnApplyCustomTime.addEventListener('click', () => {
      const fromDate = customFromDate.value;
      const toDate = customToDate.value;
      
      if (!fromDate || !toDate) {
        alert('Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß ng√†y b·∫Øt ƒë·∫ßu v√† ng√†y k·∫øt th√∫c');
        return;
      }
      
      const fromTime = customFromTime.value || '00:00:00';
      const toTime = customToTime.value || '23:59:59';
      
      customTimeRange = { fromDate, fromTime, toDate, toTime };
      
      yearFilter.value = 'all';
      quarterFilter.value = 'all';
      monthFilter.value = 'all';
      weekFilter.value = 'all';
      dayNightFilter.value = 'all';
      
      selectedYear = 'all';
      selectedQuarter = 'all';
      selectedMonth = 'all';
      selectedWeek = 'all';
      selectedDayNight = 'all';
      
      currentPage = 1;
      fetchAndRender();
    });

    btnClearCustomTime.addEventListener('click', () => {
      customFromDate.value = '';
      customFromTime.value = '';
      customToDate.value = '';
      customToTime.value = '';
      customTimeRange = null;
      customTimePanel.style.display = 'none';
      btnToggleCustomTime.textContent = '‚è±Ô∏è Th·ªùi gian t√πy ch·ªânh';
      
      currentPage = 1;
      fetchAndRender();
    });

    /* ================== INIT ================== */
    (function init(){
      yearFilter.value = 'all';
      quarterFilter.value = 'all';
      monthFilter.value = 'all';
      weekFilter.value = 'all';
      dayNightFilter.value = 'all';
      pageSizeSelect.value = '20';
      pageSize = 20;
      currentPage = 1;
      
      customFromTime.value = '00:00:00';
      customToTime.value = '23:59:59';
      
      fetchAndRender();
    })();
  </script>
</body>
</html>
