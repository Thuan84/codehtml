<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base target="_top">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <title>Báo Cáo Quan Trắc Mực Nước Hồ Thành Sơn</title>
    <style>
        body { font-family: 'Inter', sans-serif; }
        @media print {
            @page { size: A4; margin: 1.2cm; }
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; background: #fff; font-size: 9.5pt; }
            .no-print { display: none; }
            .container { width: 100%!important; max-width: 100%!important; margin: 0!important; padding: 0!important; border: none!important; box-shadow: none!important; }
            section { box-shadow: none!important; border: 1px solid #e2e8f0!important; page-break-inside: avoid; }
            header h1 { font-size: 16pt; }
            section h2 { font-size: 12pt; }
            .grid p.text-lg { font-size: 10pt; }
            .grid p.text-sm { font-size: 8.5pt; }
            .grid > div { page-break-inside: avoid; }
            footer { font-size: 8pt; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-sky-50 via-slate-100 to-slate-200 min-h-screen text-slate-800">

    <div class="container mx-auto max-w-4xl p-4 sm:p-8 lg:p-10 print:p-0">

        <!-- Header -->
        <header class="mb-10 text-center print:mb-4">
            <div class="inline-block px-8 py-2 rounded-full bg-gradient-to-r from-sky-200 to-sky-400 shadow-lg mb-3 border border-sky-300">
                <p class="text-lg font-semibold text-sky-800 uppercase tracking-widest drop-shadow">TRẠM THỦY NÔNG NINH HẢI</p>
            </div>
            <h1 class="text-4xl sm:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-sky-700 via-sky-500 to-sky-700 mt-2 drop-shadow-lg tracking-tight">BÁO CÁO QUAN TRẮC MỰC NƯỚC</h1>
            <p class="text-xl font-medium text-slate-600 mt-2 tracking-wide">HỒ NƯỚC NGỌT</p>
        </header>

        <main class="space-y-12 print:space-y-3">

            <!-- Thông tin mực nước -->
            <section class="bg-white/95 p-8 rounded-3xl shadow-2xl border border-slate-200 print:p-4 transition hover:shadow-2xl">
                <div class="flex items-center gap-3 mb-8 print:mb-3">
                    <div class="bg-sky-200 p-3 rounded-xl shadow">
                        <svg xmlns="http://www.w3.org/2000/svg" class="text-sky-600" width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-700 tracking-wide">Thông tin mực nước</h2>
                    <span class="ml-auto bg-sky-100 text-sky-700 px-3 py-1 rounded-full text-xs font-semibold shadow">Cập nhật mới nhất</span>
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 print:grid-cols-3 print:gap-3">
                    <div class="info-card"><span class="info-label">Ngày cập nhật</span><span class="info-value">{{ngayCapNhat}}</span></div>
                    <div class="info-card border-sky-200"><span class="info-label">Cao trình mực nước hiện tại (m)</span><span class="info-value text-sky-600">{{caoTrinhMucNuoc}}</span></div>
                    <div class="info-card border-green-200"><span class="info-label">Dung tích hiện tại (Tr.m³)</span><span class="info-value text-sky-700">{{dungTichHienTai}}</span></div>
                    <div class="info-card border-blue-200"><span class="info-label">Lượng mưa (mm)</span><span class="info-value text-blue-700">{{luongMua}}</span></div>
                    <div class="info-card border-yellow-200"><span class="info-label">Van đầu mối (m)</span><span class="info-value text-yellow-700">{{VanDauMoi}}</span></div>
                    <div class="info-card border-yellow-200"><span class="info-label">Van lúa (m)</span><span class="info-value text-green-700">{{VanLua}}</span></div>
                    <div class="info-card border-yellow-200"><span class="info-label">Van số 3 (van màu) (m)</span><span class="info-value text-yellow-700">{{VanMau}}</span></div>
                    <div class="info-card border-indigo-200"><span class="info-label">Hn Kênh chính (m)</span><span class="info-value text-indigo-700">{{HKenhChinh}}</span></div>
                    <div class="info-card border-pink-200"><span class="info-label">Chênh lệch ∆V (m³)</span><span class="info-value text-pink-700">{{ChenhLech}}</span></div>
                    <div class="info-card border-green-200"><span class="info-label">Tỷ lệ so với Thiết kế (%)</span><span class="info-value text-green-600">{{TyLeTK}}</span></div>
                    <div class="info-card border-sky-200"><span class="info-label">Cao trình MN cùng kỳ (m)</span><span class="info-value text-sky-600">{{CTMNCK}}</span></div>
                    <div class="info-card border-green-200"><span class="info-label">Dung tích cùng kỳ (Tr.m³)</span><span class="info-value text-sky-700">{{DTMNCK}}</span></div>
                    <div class="info-card border-red-200"><span class="info-label">Cao trình MN chết (m)</span><span class="info-value text-red-700">{{CTMNC}}</span></div>
                    <div class="info-card border-red-200"><span class="info-label">Dung tích MN chết (Tr.m³)</span><span class="info-value text-red-700">{{DTMNC}}</span></div>
                    <div class="info-card border-yellow-200"><span class="info-label">Cao trình MN thiết kế (m)</span><span class="info-value text-yellow-700">{{CTMNTK}}</span></div>
                    <div class="info-card border-yellow-200"><span class="info-label">Dung tích MN thiết kế (Tr.m³)</span><span class="info-value text-yellow-700">{{DTMNTK}}</span></div>
                 </div>
            </section>

            <!-- Biểu đồ so sánh mực nước -->
            <section class="bg-white/95 p-8 rounded-3xl shadow-2xl border border-slate-200 mb-8">
                <h2 class="text-2xl font-bold text-slate-700 mb-4 flex items-center gap-2">
                    <svg class="text-blue-500" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 12h8M12 8v8"/></svg>
                    Biểu đồ so sánh mực nước
                </h2>
                <div class="w-full max-w-xl mx-auto">
                    <canvas id="chartMucNuoc" height="200"></canvas>
                </div>
            </section>

            <!-- Thông tin xả lũ -->
            <section class="bg-white/95 p-8 rounded-3xl shadow-2xl border border-slate-200 print:p-4 transition hover:shadow-2xl">
                <div class="flex items-center gap-3 mb-8 print:mb-3">
                    <div class="bg-orange-200 p-3 rounded-xl shadow">
                        <svg xmlns="http://www.w3.org/2000/svg" class="text-orange-600" width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/><path d="M12 2v20"/><path d="M2 12h20"/></svg>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-700 tracking-wide">Thông tin xả lũ</h2>
                    <span class="ml-auto bg-orange-100 text-orange-700 px-3 py-1 rounded-full text-xs font-semibold shadow">Cảnh báo</span>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 print:grid-cols-4 print:gap-3">
                    <div class="info-card border-orange-200"><span class="info-label">Htrn (cm)</span><span class="info-value text-orange-700">{{htrn}}</span></div>
                    <div class="info-card border-orange-200"><span class="info-label">Qtd (m³/s)</span><span class="info-value text-orange-700">{{qtd}}</span></div>
                    <div class="info-card border-orange-200"><span class="info-label">Qcv1 (m³/s)</span><span class="info-value text-green-700">{{qcv1}}</span></div>
                    <div class="info-card border-orange-200"><span class="info-label">Qcv2 (m³/s)</span><span class="info-value text-green-700">{{qcv2}}</span></div>
                    <div class="info-card border-orange-200"><span class="info-label">Qcv3 (m³/s)</span><span class="info-value text-green-700">{{qcv3}}</span></div>
                    <div class="info-card border-orange-200"><span class="info-label">Q (m³/s)</span><span class="info-value text-red-700">{{qt}}</span></div>
                </div>
            </section>

            <!-- Lịch sử cập nhật -->
            <section class="bg-white/95 p-8 rounded-3xl shadow-2xl border border-slate-200 print:p-4 transition hover:shadow-2xl">
                <div class="flex items-center gap-3 mb-8 print:mb-3">
                    <div class="bg-indigo-200 p-3 rounded-xl shadow">
                        <svg xmlns="http://www.w3.org/2000/svg" class="text-indigo-600" width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M12 6v6l4 2"/><circle cx="12" cy="12" r="10"/></svg>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-700 tracking-wide">Lịch sử cập nhật</h2>
                    <span class="ml-auto bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-semibold shadow">Lịch sử</span>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 print:grid-cols-2 print:gap-3">
                    <div class="info-card border-indigo-200"><span class="info-label">Trạng thái</span><span class="info-value text-indigo-700">{{trangThai}}</span></div>
                    <div class="info-card border-indigo-200"><span class="info-label">Thời gian kiểm tra</span><span class="info-value text-indigo-700">{{thoiGianKiemTra}}</span></div>
                    <div class="info-card border-indigo-200"><span class="info-label">Người cập nhật</span><span class="info-value text-indigo-700">{{nguoiCapNhat}}</span></div>
                    <div class="info-card border-indigo-200"><span class="info-label">Ghi chú</span><span class="info-value text-indigo-700">{{GhiChu}}</span></div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="mt-12 pt-8 border-t border-slate-200 text-center print:mt-5 print:pt-3 bg-gradient-to-r from-sky-50 to-slate-100 rounded-b-3xl shadow-inner">
            <p class="text-base text-slate-500 font-medium">
                Báo cáo được tạo tự động lúc {{now}}
            </p>
            <p class="text-xs text-slate-400 mt-1">© 2024 Trạm Thủy Nông Ninh Hải</p>
        </footer>
    </div>

    <!-- Custom Card Style -->
    <style>
        .info-card {
            background: linear-gradient(135deg, #fff 60%, #f8fafc 100%);
            padding: 1.25rem;
            border-radius: 1.25rem;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 8px 0 rgba(30,41,59,0.06);
            margin-bottom: 0;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            transition: box-shadow 0.2s, transform 0.2s;
        }
        .info-card:hover {
            box-shadow: 0 8px 32px 0 rgba(30,41,59,0.12);
            transform: scale(1.03);
        }
        .info-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #64748b;
            letter-spacing: 0.04em;
        }
        .info-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-top: 0.25rem;
        }
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        // Hàm cải tiến để lấy giá trị từ các thẻ đã render
        function getValueByLabel(label) {
            var cards = document.querySelectorAll('.info-card');
            for (var i = 0; i < cards.length; i++) {
                var lbl = cards[i].querySelector('.info-label');
                var val = cards[i].querySelector('.info-value');
                if (lbl && val && lbl.textContent.replace(/\s+/g, ' ').trim() === label) {
                    // Xử lý chuỗi số có dấu phẩy hoặc dấu chấm
                    var textValue = val.textContent.trim();
                    var num = parseFloat(textValue.replace(/[,]/g, '.'));
                    return isNaN(num) ? 0 : num;
                }
            }
            return 0;
        }

        // Lấy dữ liệu từ template variables trực tiếp (fallback)
        function getTemplateValue(variableName) {
            // Tìm element có chứa template variable
            var elements = document.querySelectorAll('*');
            for (var i = 0; i < elements.length; i++) {
                var text = elements[i].textContent;
                if (text.includes('{{' + variableName + '}}')) {
                    var match = text.match(new RegExp('\\{\\{' + variableName + '\\}\\}'));
                    if (match) {
                        // Thử lấy giá trị từ data attribute hoặc content
                        var value = elements[i].getAttribute('data-value') || elements[i].textContent;
                        var num = parseFloat(value.replace(/[,]/g, '.'));
                        return isNaN(num) ? 0 : num;
                    }
                }
            }
            return 0;
        }

        // Lấy dữ liệu với fallback
        var mucNuocHienTai = getValueByLabel("Cao trình mực nước hiện tại (m)") || getTemplateValue("caoTrinhMucNuoc");
        var mucNuocCungKy = getValueByLabel("Cao trình MN cùng kỳ (m)") || getTemplateValue("CTMNCK");
        var mucNuocChet = getValueByLabel("Cao trình MN chết (m)") || getTemplateValue("CTMNC");
        var mucNuocThietKe = getValueByLabel("Cao trình MN thiết kế (m)") || getTemplateValue("CTMNTK");

        // Debug: Log các giá trị để kiểm tra
        console.log("Mực nước hiện tại:", mucNuocHienTai);
        console.log("Mực nước cùng kỳ:", mucNuocCungKy);
        console.log("Mực nước chết:", mucNuocChet);
        console.log("Mực nước thiết kế:", mucNuocThietKe);

        var labels = [
            "Hiện tại",
            "Cùng kỳ", 
            "Mực nước chết",
            "Thiết kế"
        ];
        
        var data = [mucNuocHienTai, mucNuocCungKy, mucNuocChet, mucNuocThietKe];
        
        var bgColors = [
            "rgba(56,189,248,0.7)",   // xanh dương - hiện tại
            "rgba(34,197,94,0.7)",    // xanh lá - cùng kỳ
            "rgba(239,68,68,0.7)",    // đỏ - chết
            "rgba(253,224,71,0.7)"    // vàng - thiết kế
        ];
        
        var borderColors = [
            "rgba(56,189,248,1)",
            "rgba(34,197,94,1)",
            "rgba(239,68,68,1)",
            "rgba(253,224,71,1)"
        ];

        var ctx = document.getElementById('chartMucNuoc').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: "Cao trình mực nước (m)",
                    data: data,
                    backgroundColor: bgColors,
                    borderColor: borderColors,
                    borderWidth: 2,
                    borderRadius: 8,
                    maxBarThickness: 60
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    title: { 
                        display: true, 
                        text: 'So sánh mực nước hồ (m)',
                        font: { size: 16, weight: 'bold' }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ": " + context.parsed.y.toFixed(2) + " m";
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        title: { 
                            display: true, 
                            text: "Cao trình (m)",
                            font: { size: 14, weight: 'bold' }
                        },
                        ticks: {
                            font: { size: 12 },
                            callback: function(value) {
                                return value.toFixed(2) + " m";
                            }
                        }
                    },
                    x: {
                        ticks: {
                            font: { size: 12, weight: '500' }
                        }
                    }
                }
            }
        });
    });
    </script>
</body>
</html> 
