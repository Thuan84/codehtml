<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quản Lý Văn Kiện - Trạm Thủy Nông Ninh Hải</title>

<!-- Libraries CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">

<style>
:root { --primary-color:#2c3e50; --secondary-color:#3498db; --light-bg:#f8f9fa; --border-color:#e9ecef; --hover-bg:#e7f3ff; }
body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color:var(--light-bg); }
.app-header { background:linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color:#fff; padding:2rem 0; box-shadow:0 4px 12px rgba(0,0,0,.1); }
.main-card { border-radius:12px; box-shadow:0 4px 25px rgba(0,0,0,.08); border:none; }

/* Loading */
.loading-container{ min-height:300px; display:flex; flex-direction:column; align-items:center; justify-content:center; }
.spinner{ width:3rem;height:3rem;border:.3em solid rgba(52,152,219,.3);border-top-color:var(--secondary-color);border-radius:50%;animation:spin 1s linear infinite; }
@keyframes spin{ to{ transform:rotate(360deg);} }

/* Filters & table */
.filter-section{ background:#f1f3f5; border-radius:8px; border:1px solid var(--border-color); }
#data-table{ border-collapse:separate; border-spacing:0; width:100%!important; }
#data-table thead th{ background:var(--primary-color); color:#fff; border:none; font-weight:600; text-transform:uppercase; font-size:.85rem; letter-spacing:.5px; white-space:nowrap; }
#data-table tbody td{ padding:1rem .9rem; vertical-align:middle; border-bottom:1px solid var(--border-color); }
#data-table tbody tr:last-child td{ border-bottom:none; }
#data-table tbody tr:hover{ background:var(--hover-bg); box-shadow:0 4px 12px rgba(0,0,0,.08); transform:translateY(-2px); transition:all .2s ease; z-index:10; position:relative; }
.so-hieu-col{ font-weight:700; color:var(--secondary-color); font-family:'Courier New', Courier, monospace; font-size:1.02rem; }
.action-buttons .btn{ margin:0 3px; border-radius:50px; width:36px; height:36px; display:inline-flex; align-items:center; justify-content:center; transition:all .2s ease; }
.action-buttons .btn:hover{ transform:scale(1.1); }

/* ====== Card thống kê - phiên bản compact (gọn) ====== */
.stat-grid.row { --bs-gutter-x:.5rem; --bs-gutter-y:.5rem; }       /* thu nhỏ khoảng cách */
.stat-card-item{
  background:#fff; border:1px solid var(--border-color);
  border-radius:10px; padding:.65rem .8rem; display:flex; align-items:center;
  gap:.7rem; transition:transform .15s ease, box-shadow .15s ease; min-height:64px;
}
.stat-card-item:hover{ transform:translateY(-2px); box-shadow:0 6px 14px rgba(0,0,0,.06); }
.stat-card-item .icon{
  width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center;
  font-size:1rem; color:#fff; flex:0 0 36px;
}
.stat-card-item .stat-info{ line-height:1; }
.stat-card-item .stat-info .stat-number{ font-size:1.1rem; font-weight:800; color:var(--primary-color); }
.stat-card-item .stat-info .stat-label{
  font-size:.78rem; color:#6c757d; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:160px;
}

/* Tối ưu ở màn nhỏ */
@media (max-width: 575.98px){
  .stat-card-item{ padding:.55rem .7rem; }
  .stat-card-item .icon{ width:32px; height:32px; font-size:.95rem; }
  .stat-card-item .stat-info .stat-number{ font-size:1.05rem; }
  .stat-card-item .stat-info .stat-label{ max-width:120px; }
}
</style>
</head>
<body>
<!-- Header -->
<header class="app-header mb-4">
  <div class="container text-center">
    <h1 class="mb-2 display-5 fw-bold">QUẢN LÝ VĂN BẢN CÔNG TÁC ĐẢNG</h1>
    <p class="mb-3 opacity-75 fs-4">Chi bộ Trạm thủy nông Ninh Hải</p>
    <div class="d-inline-block bg-white text-dark px-3 py-1 rounded-pill shadow-sm">
      <i class="fas fa-calendar-day me-2 text-primary"></i><span id="current-date"></span>
    </div>
  </div>
</header>

<!-- Main Content -->
<main class="container">
  <section class="main-card card overflow-hidden">
    <div class="card-body p-lg-4">
      <!-- Khu vực thống kê động -->
      <section id="statistics-section" class="mb-3">
        <!-- dùng row-cols để tự căn 2-6 cột/ hàng, khoảng cách g-1/2 -->
        <div id="stats-container" class="stat-grid row row-cols-2 row-cols-sm-3 row-cols-lg-4 row-cols-xxl-6 g-2"></div>
      </section>

      <!-- Toolbar -->
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3">
        <h5 class="card-title mb-3 mb-md-0"><i class="fas fa-list-ul me-2"></i>Danh sách văn bản</h5>
        <div class="d-flex gap-2 flex-wrap justify-content-center justify-content-md-end">
          <button id="print-portrait-btn" class="btn btn-info text-white" title="In A4 dọc"><i class="fas fa-print me-1"></i> In dọc</button>
          <button id="print-landscape-btn" class="btn btn-secondary" title="In A4 ngang"><i class="fas fa-print me-1"></i> In ngang</button>
          <input type="text" id="search-input" class="form-control" placeholder="Tìm kiếm nhanh..." style="width: 200px;">
          <button id="refresh-btn" class="btn btn-primary" title="Làm mới dữ liệu"><i class="fas fa-sync-alt"></i></button>
        </div>
      </div>

      <!-- Filter Section -->
      <section class="filter-section p-3 mb-4">
        <div class="row g-3 align-items-end">
          <div class="col-xl-2 col-lg-4 col-md-6"><label for="filter-doc-type" class="form-label fw-bold small">Loại văn bản</label><select id="filter-doc-type" class="form-select form-select-sm"><option value="" selected>Tất cả</option></select></div>
          <div class="col-xl-2 col-lg-4 col-md-6"><label for="filter-material-type" class="form-label fw-bold small">Loại tài liệu</label><select id="filter-material-type" class="form-select form-select-sm"><option value="" selected>Tất cả</option></select></div>
          <div class="col-xl-2 col-lg-4 col-md-6"><label for="filter-dispatch-type" class="form-label fw-bold small">Loại công văn</label><select id="filter-dispatch-type" class="form-select form-select-sm"><option value="" selected>Tất cả</option></select></div>
          <div class="col-xl-2 col-lg-4 col-md-6"><label for="filter-agency" class="form-label fw-bold small">Cơ quan BH</label><select id="filter-agency" class="form-select form-select-sm"><option value="" selected>Tất cả</option></select></div>
          <div class="col-xl-2 col-lg-4 col-md-6"><label for="filter-term" class="form-label fw-bold small">Nhiệm kỳ</label><select id="filter-term" class="form-select form-select-sm"><option value="" selected>Tất cả</option></select></div>
          <div class="col-xl-2 col-lg-4 col-md-6"><label for="filter-year" class="form-label fw-bold small">Năm ban hành</label><select id="filter-year" class="form-select form-select-sm"><option value="" selected>Tất cả</option></select></div>
          <div class="col-xl-3 col-lg-6 col-md-6"><label class="form-label fw-bold small">Ngày ban hành (Từ - Đến)</label><div class="input-group input-group-sm"><input type="date" id="filter-start-date" class="form-control"><input type="date" id="filter-end-date" class="form-control"></div></div>
          <div class="col-xl-1 col-lg-2 col-md-12"><button id="reset-filter-btn" class="btn btn-sm btn-outline-secondary w-100" title="Xóa bộ lọc"><i class="fas fa-times me-1 me-lg-0"></i><span class="d-lg-none ms-1"> Đặt lại</span></button></div>
        </div>
      </section>

      <div id="loading-indicator" class="loading-container"><div class="spinner"></div><p class="mt-3 text-muted">Đang tải dữ liệu...</p></div>
      <div id="error-alert" class="alert alert-danger d-none error-card" role="alert"><i class="fas fa-exclamation-triangle me-2"></i><span id="error-message"></span><button type="button" class="btn btn-sm btn-outline-danger ms-3" id="retry-btn"><i class="fas fa-redo me-1"></i> Thử lại</button></div>

      <div id="data-container" class="table-responsive d-none">
        <table id="data-table" class="table">
          <thead>
            <tr>
              <th>STT</th>
              <th>Số hiệu</th>
              <th>Trích yếu</th>
              <th>Ngày ban hành</th>
              <th>Cơ quan BH</th>
              <th>Ghi chú</th>
              <th class="text-center" title="Hành động"><i class="fas fa-tools"></i></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>
</main>

<!-- Modals -->
<div class="modal fade detail-modal" id="detailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title"><i class="fas fa-file-invoice me-2"></i>Chi tiết văn bản</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button></div>
      <div class="modal-body" id="modal-body-content"></div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times me-1"></i> Đóng</button></div>
    </div>
  </div>
</div>

<!-- Libraries JS -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
const CONFIG = {
  API_URL: 'https://script.google.com/macros/s/AKfycby2lXhZMCQ6gyTMCvbcC20K4eW4iLLqL9L89uFPowzTau6ualedUx9nOJ--CXjPE0BQ/exec',
  DATE_FORMAT_OPTIONS: { day: '2-digit', month: '2-digit', year: 'numeric' }
};

const STAT_COLORS = ['primary','success','danger','warning','info','secondary','dark'];
const STAT_ICONS  = ['fa-file-alt','fa-file-invoice','fa-file-signature','fa-gavel','fa-bullhorn','fa-clipboard-list','fa-folder'];

let dataTable;
let allData = [];
let TERM_FIELD = null;

function normalizeKeyName(s){ return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/[^a-z0-9]/g,''); }
function normalizeTermValue(s){ return String(s||'').replace(/[\u00A0\s]+/g,'').replace(/[–—−]/g,'-').trim(); }
function detectTermFieldName(sampleRow){
  const TARGET='nhiemky'; if(!sampleRow) return null;
  const keys=Object.keys(sampleRow); let found=keys.find(k=>normalizeKeyName(k)===TARGET);
  if(found) return found;
  found=keys.find(k=>{ const n=normalizeKeyName(k); return n.includes('nhiem')&&n.includes('ky'); });
  return found||null;
}
function getTermRaw(item){ if(!item||!TERM_FIELD) return ''; const v=item[TERM_FIELD]; return (v===undefined||v===null)?'':String(v).trim(); }

$(document).ready(function(){ updateCurrentDate(); initializeDataTable(); loadData(); setupEventListeners(); });

function setupEventListeners(){
  $('#refresh-btn, #retry-btn').on('click',()=>loadData(true));
  $('#search-input').on('keyup',function(){ dataTable.search(this.value).draw(); });
  $('#filter-doc-type, #filter-agency, #filter-material-type, #filter-dispatch-type, #filter-term, #filter-year, #filter-start-date, #filter-end-date').on('change', applyFilters);
  $('#reset-filter-btn').on('click', resetFilters);
  $('#print-portrait-btn').on('click',()=>printFilteredData(false));
  $('#print-landscape-btn').on('click',()=>printFilteredData(true));
  $('#data-table tbody').on('click','button.view-detail',function(){ showDocumentDetail($(this).data('id')); });
}

function initializeDataTable(){
  dataTable = $('#data-table').DataTable({
    data: [],
    columns: [
      { data:null, width:'5%' }, { data:'soHieu', width:'12%' }, { data:'trichYeu', width:'35%' },
      { data:'ngayBanHanh', width:'12%' }, { data:'coQuanBanHanh', width:'15%' }, { data:'ghiChu', width:'16%' }, { data:'stt', width:'5%' }
    ],
    columnDefs: [
      { targets:0, orderable:false, className:'text-center', render:(_,__,___,meta)=> meta.row+1 },
      { targets:1, className:'so-hieu-col' },
      { targets:3, className:'text-nowrap', render:function(data,type){ if(type==='sort'||type==='type'){ if(!data) return 0; const dt=new Date(data); return isNaN(dt.getTime())?0:dt.getTime(); } return formatDateForDisplay(data); } },
      { targets:6, orderable:false, className:'text-center action-buttons', render:(_,__,row)=> `<button class="btn btn-sm btn-outline-primary view-detail" data-id="${row.stt}" title="Xem chi tiết"><i class="fas fa-eye"></i></button>` }
    ],
    order:[[3,'desc'],[1,'desc']],
    language:{ url:'//cdn.datatables.net/plug-ins/1.13.6/i18n/vi.json' },
    pageLength:25,
    dom:'rt<"d-flex justify-content-between align-items-center mt-3"ip<"ms-3"l>>'
  });
}

function loadData(forceRefresh=false){
  showLoading();
  let url=CONFIG.API_URL; if(forceRefresh){ url+=(url.includes('?')?'&':'?')+'cache_bust='+Date.now(); }
  $.ajax({
    url, method:'GET', dataType:'jsonp',
    success:function(response){
      if(response.status==='error'||!response.data){ showError(response.message||'Lỗi không xác định hoặc không có dữ liệu.'); return; }
      allData = response.data||[];
      TERM_FIELD = detectTermFieldName(allData[0]);
      populateFilters(allData);
      updateStatistics(allData);
      resetFilters();
    },
    error:(_,status)=>showError(`Lỗi tải dữ liệu: ${status}. Vui lòng kiểm tra lại URL API và quyền truy cập Web App.`)
  });
}

function renderData(data){ dataTable.clear().rows.add(data).draw(); showDataContainer(); }

function applyFilters(){
  const docType=$('#filter-doc-type').val();
  const agency=$('#filter-agency').val();
  const materialType=$('#filter-material-type').val();
  const dispatchType=$('#filter-dispatch-type').val();
  const termKey=$('#filter-term').val();
  const selectedYear=$('#filter-year').val();

  const startDate=$('#filter-start-date').val()?new Date($('#filter-start-date').val()):null;
  const endDate=$('#filter-end-date').val()?new Date($('#filter-end-date').val()):null;
  if(startDate) startDate.setHours(0,0,0,0);
  if(endDate) endDate.setHours(23,59,59,999);

  const filteredData = allData.filter(item=>{
    const itemDate=item.ngayBanHanh?new Date(item.ngayBanHanh):null;
    if(docType && item.loaiVanBan!==docType) return false;
    if(agency && item.coQuanBanHanh!==agency) return false;
    if(materialType && item.loaiTaiLieu!==materialType) return false;
    if(dispatchType && item.loaiCongVan!==dispatchType) return false;
    if(termKey && TERM_FIELD){ const itemTermKey=normalizeTermValue(getTermRaw(item)); if(itemTermKey!==termKey) return false; }
    if(selectedYear && (!itemDate || itemDate.getFullYear().toString()!==selectedYear)) return false;
    if(startDate && (!itemDate || itemDate<startDate)) return false;
    if(endDate && (!itemDate || itemDate>endDate)) return false;
    return true;
  });

  renderData(filteredData);
  updateStatistics(filteredData);
}

function resetFilters(){
  $('section.filter-section select, section.filter-section input').val('');
  $('#search-input').val('');
  dataTable.search('').draw();
  renderData(allData);
  updateStatistics(allData);
}

function populateFilters(data){
  const docTypes=new Set(), agencies=new Set(), materialTypes=new Set(), dispatchTypes=new Set(), years=new Set();
  const termMap=new Map();

  data.forEach(item=>{
    if(item.loaiVanBan) docTypes.add(item.loaiVanBan);
    if(item.coQuanBanHanh) agencies.add(item.coQuanBanHanh);
    if(item.loaiTaiLieu) materialTypes.add(item.loaiTaiLieu);
    if(item.loaiCongVan) dispatchTypes.add(item.loaiCongVan);

    if(TERM_FIELD){
      const raw=getTermRaw(item);
      if(raw){ const key=normalizeTermValue(raw); if(key && !termMap.has(key)) termMap.set(key, raw.trim()); }
    }

    if(item.ngayBanHanh){ const date=new Date(item.ngayBanHanh); if(!isNaN(date.getTime())) years.add(date.getFullYear()); }
  });

  populateSelect('#filter-doc-type',[...docTypes].sort());
  populateSelect('#filter-agency',[...agencies].sort());
  populateSelect('#filter-material-type',[...materialTypes].sort());
  populateSelect('#filter-dispatch-type',[...dispatchTypes].sort());
  populateSelect('#filter-year',[...years].sort((a,b)=>b-a));

  const termSelect=$('#filter-term'); termSelect.find('option:not(:first)').remove();
  [...termMap.entries()].sort((a,b)=>String(a[1]).localeCompare(String(b[1]),'vi')).forEach(([key,label])=> termSelect.append(`<option value="${key}">${label}</option>`));

  if(!TERM_FIELD){ console.warn('Không xác định được cột "Nhiệm kỳ" trong JSON.'); }
}

function populateSelect(selector, options){
  const select=$(selector); select.find('option:not(:first)').remove();
  options.forEach(opt=> select.append(`<option value="${opt}">${opt}</option>`));
}

function showDocumentDetail(stt){
  const doc=allData.find(item=>item.stt==stt);
  if(!doc){ alert('Lỗi: Không tìm thấy văn bản!'); return; }
  const createRow=(label,val)=>`<tr><th scope="row" class="w-25 bg-light">${label}:</th><td>${val||'---'}</td></tr>`;
  let filesHtml='<p class="text-muted fst-italic">Không có tệp đính kèm.</p>';
  if(doc.dinhKem){
    const files=doc.dinhKem.split(',').filter(i=>i.trim());
    if(files.length>0){ filesHtml = files.map(url=>`<a href="${url.trim()}" target="_blank" class="btn btn-sm btn-outline-primary me-2 mb-2"><i class="fas fa-paperclip me-1"></i> ${decodeURIComponent(url.trim().split('/').pop())}</a>`).join(''); }
  }
  $('#modal-body-content').html(`
    <div class="row">
      <div class="col-md-6">
        <h6 class="border-bottom pb-2 mb-3">Thông tin cơ bản</h6>
        <table class="table table-bordered table-sm">
          <tbody>
            ${createRow('Số hiệu', `<span class="fw-bold text-primary">${doc.soHieu}</span>`)}
            ${createRow('Trích yếu', doc.trichYeu)}
            ${createRow('Loại VB', doc.loaiVanBan)}
            ${createRow('Loại Tài liệu', doc.loaiTaiLieu)}
            ${createRow('Loại Công văn', doc.loaiCongVan)}
            ${createRow('Ngày BH', formatDateForDisplay(doc.ngayBanHanh))}
            ${createRow('Cơ quan BH', doc.coQuanBanHanh)}
            ${createRow('Nhiệm kỳ', TERM_FIELD ? (getTermRaw(doc) || '---') : '---')}
          </tbody>
        </table>
      </div>
      <div class="col-md-6">
        <h6 class="border-bottom pb-2 mb-3">Thông tin bổ sung</h6>
        <table class="table table-bordered table-sm">
          <tbody>
            ${createRow('Người ký', doc.nguoiKy)}
            ${createRow('Người thảo', doc.nguoiThaoVanBan)}
            ${createRow('Ngày tạo', formatDateForDisplay(doc.thoiGianTao))}
            ${createRow('Cập nhật', formatDateForDisplay(doc.thoiGianCapNhat))}
            ${createRow('Ghi chú', doc.ghiChu)}
          </tbody>
        </table>
      </div>
    </div>
    <hr><h6 class="mb-3">Tệp đính kèm</h6><div>${filesHtml}</div>
  `);
  new bootstrap.Modal(document.getElementById('detailModal')).show();
}

/* In */
function printFilteredData(isLandscape=false){
  const filteredData=dataTable.rows({search:'applied'}).data().toArray();
  if(filteredData.length===0){ Swal.fire('Không có dữ liệu','Không có dữ liệu nào để in theo bộ lọc hiện tại.','warning'); return; }
  filteredData.sort((a,b)=>{
    if(a.soHieu&&b.soHieu){ const cmp=a.soHieu.localeCompare(b.soHieu,'vi',{numeric:true}); if(cmp!==0) return cmp; }
    const A=a.ngayBanHanh?new Date(a.ngayBanHanh):new Date(0);
    const B=b.ngayBanHanh?new Date(b.ngayBanHanh):new Date(0);
    return A.getTime()-B.getTime();
  });
  let rowsHtml=''; filteredData.forEach((item,idx)=>{ rowsHtml+=`
    <tr>
      <td>${idx+1}</td><td>${item.soHieu||''}</td><td>${item.trichYeu||''}</td>
      <td>${formatDateForDisplay(item.ngayBanHanh)}</td><td>${item.coQuanBanHanh||''}</td><td>${item.ghiChu||''}</td>
    </tr>`; });
  const pageSizeRule=isLandscape?'A4 landscape':'A4';
  const colStyles=isLandscape?['6%','12%','44%','10%','16%','12%']:['4%','8%','42%','8%','20%','18%'];
  const w=window.open('','_blank');
  w.document.write(`
    <html><head><title>Danh sách văn bản</title>
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
      <style>@page{size:${pageSizeRule};margin:16mm;} body{font-family:"Times New Roman", Times, serif;}
      h1,h2{text-align:center;margin:0;} h1{font-size:20pt;font-weight:700;} h2{font-size:14pt;margin-top:6px;margin-bottom:14px;}
      table{width:100%;border-collapse:collapse;table-layout:fixed;} th,td{border:1px solid #000;padding:6px 8px;vertical-align:top;}
      thead th{background:#f2f2f2;font-weight:700;} th,td{white-space:normal;word-break:break-word;overflow-wrap:anywhere;}</style>
    </head><body>
      <h1>SỔ THEO DÕI CÔNG VĂN</h1><h2>Chi bộ Trạm thủy nông Ninh Hải</h2>
      <table class="table table-bordered">
        <colgroup>
          <col style="width:${colStyles[0]}"><col style="width:${colStyles[1]}"><col style="width:${colStyles[2]}">
          <col style="width:${colStyles[3]}"><col style="width:${colStyles[4]}"><col style="width:${colStyles[5]}">
        </colgroup>
        <thead><tr><th>STT</th><th>Số hiệu</th><th>Trích yếu</th><th>Ngày ban hành</th><th>Cơ quan ban hành</th><th>Ghi chú</th></tr></thead>
        <tbody>${rowsHtml}</tbody>
      </table>
    </body></html>
  `);
  w.document.close(); w.focus(); setTimeout(()=>{ try{ w.print(); }catch(e){} },300);
}

/* Tiện ích */
function showLoading(){ $('#loading-indicator').removeClass('d-none'); $('#error-alert,#data-container').addClass('d-none'); }
function showError(msg){ $('#loading-indicator,#data-container').addClass('d-none'); $('#error-message').text(msg); $('#error-alert').removeClass('d-none'); }
function showDataContainer(){ $('#loading-indicator,#error-alert').addClass('d-none'); $('#data-container').removeClass('d-none'); }
function updateCurrentDate(){ $('#current-date').text(new Date().toLocaleDateString('vi-VN',{ weekday:'long', ...CONFIG.DATE_FORMAT_OPTIONS })); }
function formatDateForDisplay(d){ if(!d) return ''; try{ const dt=new Date(d); return isNaN(dt.getTime())?d:dt.toLocaleDateString('vi-VN', CONFIG.DATE_FORMAT_OPTIONS); }catch(e){ return d; } }

/* ====== Thống kê (đÃ làm gọn) ====== */
function updateStatistics(data){
  const container = $('#stats-container');
  container.empty();

  // Đếm theo loại VB
  const typeCounts = data.reduce((acc, item)=>{
    if(item.loaiVanBan){ const type=item.loaiVanBan.trim(); acc[type]=(acc[type]||0)+1; }
    return acc;
  },{});
  const sortedTypes = Object.keys(typeCounts).sort();

  // Tổng
  container.append(`
    <div class="col">
      <div class="stat-card-item" style="border-left:3px solid #0d6efd;">
        <div class="icon bg-primary"><i class="fas fa-file-alt fa-fw"></i></div>
        <div class="stat-info">
          <div class="stat-number">${data.length.toLocaleString('vi-VN')}</div>
          <div class="stat-label">Tổng văn bản</div>
        </div>
      </div>
    </div>
  `);

  // Các loại
  sortedTypes.forEach((type, idx)=>{
    const count = typeCounts[type];
    const color = STAT_COLORS[(idx+1)%STAT_COLORS.length];
    const icon  = STAT_ICONS[(idx+1)%STAT_ICONS.length];
    container.append(`
      <div class="col">
        <div class="stat-card-item" style="border-left:3px solid var(--bs-${color});">
          <div class="icon bg-${color}"><i class="fas ${icon} fa-fw"></i></div>
          <div class="stat-info">
            <div class="stat-number">${count.toLocaleString('vi-VN')}</div>
            <div class="stat-label" title="${type}">${type}</div>
          </div>
        </div>
      </div>
    `);
  });
}
</script>
</body>
</html>
